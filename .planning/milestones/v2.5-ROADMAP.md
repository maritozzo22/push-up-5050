# Milestone v2.5: Engagement & Retention

**Status:** ✅ SHIPPED 2026-01-27
**Phases:** 03.1-03.5
**Total Plans:** 19

## Overview

Milestone v2.5 focuses on increasing user engagement and retention through personalized experiences, enhanced gamification, weekly goals, challenges, and smart notifications. The milestone delivers a comprehensive set of features designed to keep users motivated and coming back daily.

## Phases

### Phase 03.1: Personalized Onboarding

**Goal:** New users receive personalized workout recommendations based on their fitness level

**Depends on:** Nothing (first phase of milestone)

**Requirements:** ONBD-01, ONBD-02, ONBD-03, ONBD-04

**Plans:** 3 plans

Plans:

- [x] 03.1-01: Create OnboardingData model and first two screen widgets (Activity Level, Capacity)
- [x] 03.1-02: Create remaining onboarding widgets (Frequency, Daily Goal)
- [x] 03.1-03: Create main PersonalizedOnboardingScreen with PageView and integrate with main.dart

**Details:**

4-screen onboarding flow (activity level, capacity assessment, frequency preference, daily goal target) with calculated recommendations for starting series (1/2/5/10 based on max capacity), recovery time (30-60s based on activity level), and daily/monthly goals. Values persist via StorageService and integrate with GoalsProvider.

**Key Decisions:**
- PageView pattern for single-screen state management
- Dot indicator with animated sizing (24px active, 8px inactive)
- Preset slider values for better UX (discrete choices vs free-form input)
- Graceful i18n fallback with try/catch for development safety

---

### Phase 03.2: Enhanced Points System & Anti-Cheat

**Goal:** Points system redesigned for aggressive progression while preventing abuse

**Depends on:** Phase 03.1 (onboarding sets user's baseline capacity)

**Requirements:** POINTS-01, POINTS-02, POINTS-03, POINTS-04, POINTS-05, ANTCHEAT-01, ANTCHEAT-02

**Plans:** 4 plans

Plans:

- [x] 03.2-01: Implement new aggressive points formula in Calculator
- [x] 03.2-02: Add pointsEarned and multiplier fields to DailyRecord model with JSON persistence
- [x] 03.2-03: Wire points calculation into workout flow, display totalPoints in statistics
- [x] 03.2-04: Implement daily cap calculation and anti-cheat enforcement

**Details:**

Aggressive points formula: Base × (RepMult + SeriesMult) × StreakMult where RepMult = push-ups × 0.3, SeriesMult = series × 0.8. Daily cap enforcement based on user level: Level 1-3 (1.5x), Level 4 (2.0x), Level 5+ (2.5x). Excess push-ups tracked but not rewarded.

**Key Decisions:**
- Level-based cap scaling prevents excessive farming
- Partial series points when cap reached within series
- Excess push-ups tracked for statistics but not rewarded
- Localization for cap-reached messages

---

### Phase 03.3: Weekly Goals System

**Goal:** Users work toward weekly targets with Sunday review and goal progression

**Depends on:** Phase 03.2 (points system required for weekly bonuses)

**Requirements:** WEEKLY-01, WEEKLY-02, WEEKLY-03, WEEKLY-04, WEEKLY-05

**Plans:** 4 plans

Plans:

- [x] 03.3-01: Weekly state tracking infrastructure (week utilities, flag tracking, weekly streak)
- [x] 03.3-02: Weekly target calculation (daily goal × 5) with persistence and display
- [x] 03.3-03: Weekly review popup UI with bonus calculation and goal adjustment
- [x] 03.3-04: HomeScreen integration with popup trigger and provider registration

**Details:**

Weekly target = daily goal × 5 (5 workout days). Sunday popup shows progress percentage and awards 500-point bonus when target reached. Popup offers goal increase (+10%/+20%) or decrease (-10%/-20%/-30%) options. Weekly streak preserves if any push-ups completed (less strict than daily requirement). Popup triggers on Sunday OR immediately when target reached.

**Key Decisions:**
- 5 workout days per week (allows 2 rest days)
- Monday week boundaries using ISO weekday
- Sunday OR early-achievement trigger for immediate feedback
- Dual streak display (daily + weekly) on home screen
- Mandatory popup with barrierDismissible: false

---

### Phase 03.4: Challenges & Streak Freeze

**Goal:** Weekly challenges provide additional motivation with streak protection

**Depends on:** Phase 03.3 (weekly goals system required for challenges)

**Requirements:** CHAL-01, CHAL-02, CHAL-03

**Plans:** 5 plans

Plans:

- [x] 03.4-01: Weekly challenge tracking infrastructure (completion flags, target calculation, bonus award)
- [x] 03.4-02: Weekly challenge UI (WeeklyChallengeCard widget, localization, popup notification)
- [x] 03.4-03: Streak freeze system (1 per month, auto-activation, snowflake indicator)
- [x] 03.4-04: Wire autoActivateStreakFreezeIfNeeded() into StatisticsScreen initialization
- [x] 03.4-05: Ensure bonus points display refreshes immediately after award

**Details:**

Weekly challenge target = daily goal × 7 (harder than weekly goal, requires hitting daily goal every day). Completion awards 200 bonus points with trophy popup. Streak freeze: 1 per month, auto-activates when weeklyTotal > 0 but < weeklyGoal, protects entire week (Mon-Sun). Blue snowflake icon (Icons.ac_unit_rounded) shows when active.

**Key Decisions:**
- Challenge target ×7 vs weekly goal ×5 (true challenge)
- Fixed 200-point bonus (vs variable weekly bonus)
- Auto-activation only for users with activity (weeklyTotal > 0)
- setState() after loadStats() for immediate UI refresh
- Snowflake visual indicator for active freeze

---

### Phase 03.5: Smart Notifications

**Goal:** Contextual notifications keep users engaged without spamming

**Depends on:** Phase 03.3 (weekly goals), Phase 03.4 (challenges), Phase 03.1 (workout patterns)

**Requirements:** NOTIF-01, NOTIF-02, NOTIF-03, NOTIF-04

**Plans:** 3 plans

Plans:

- [x] 03.5-01: Workout time tracking and personalization infrastructure (NotificationTimeSlot, WorkoutTimeAnalyzer, StorageService methods, NotificationPreferencesProvider)
- [x] 03.5-02: NotificationService smart notification methods and localization (scheduleStreakAtRiskNotification, scheduleProgressNotification, scheduleWeeklyChallengeNotification, IT/EN strings)
- [x] 03.5-03: NotificationScheduler and wiring (condition checking, scheduling logic, deep link navigation, provider registration, HomeScreen triggers)

**Details:**

Three notification types: (1) Streak at risk after 2 missed days, (2) Progress encouragement when at 50%+ and within 5 of daily goal, (3) Weekly challenge announcement Sunday 8:00 AM. Personalized timing based on 2-hour window binning of workout completion times (7-day minimum data required). Notifications cancel when conditions no longer met. Deep link navigation: streak/progress → Home, weekly challenge → Statistics.

**Key Decisions:**
- 2-hour window binning for workout time patterns
- 90-day retention limit for workout time history
- 7-day minimum before switching from 9:00 AM default to personalized time
- BuildContext parameter for AppLocalizations access in service layer
- Direct StorageService access for missed days (avoids UserStatsProvider circular dependency)
- Explicit 50% threshold documentation for progress notification
- Sunday 8:00 AM fixed time (not personalized) for weekly challenge

---

## Milestone Summary

**Decimal Phases:** None

**Key Decisions:**

- **Onboarding First:** Phase 03.1 prioritized for first-launch user experience impact
- **Anti-Cheat with Points:** Combined into Phase 03.2 to ensure points system ships with protection from day one
- **5 Workout Days Per Week:** Weekly target uses ×5 multiplier (allows 2 rest days) vs ×7 for challenge target
- **Sunday OR Early Achievement:** Popup triggers immediately when target reached for instant gratification
- **Dual Streak Display:** Both daily and weekly streaks shown on home screen
- **BuildContext for Localization:** Service layer receives context for AppLocalizations access
- **Cancel Stale Notifications:** All notification types cancel when conditions no longer apply

**Issues Resolved:**

- All 19 requirements satisfied (100%)
- 16/16 integration points confirmed working
- 6/6 end-to-end flows verified complete
- DailyRecord constructor parameters fixed (removed non-existent goalReached, durationSeconds)
- NotificationDetails const/fixed issue resolved
- Localization parameter type mismatches corrected

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- Minor: Onboarding saves dailyGoal/monthlyGoal but weeklyGoal calculated dynamically (getWeeklyGoal() returns dailyGoal * 5)
- Human verification required: Sunday popup timing, bonus points credited, goal adjustment persistence, weekly streak display, popup non-dismissibility (require physical Android device)
- Human verification required: Challenge completion badge, streak freeze activation, snowflake icon display (require physical Android device)
- Human verification required: All 7 notification scenarios require physical Android device testing (delivery, channels, personalized time, localization, deep link navigation)

---

_For current project status, see .planning/ROADMAP.md_

---

*Archived: 2026-01-27 as part of v2.5 milestone completion*
