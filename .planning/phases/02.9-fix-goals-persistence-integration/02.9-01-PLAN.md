---
phase: 02.9-fix-goals-persistence-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/providers/goals_provider.dart
  - push_up_5050/test/providers/goals_provider_test.dart
autonomous: true

must_haves:
  truths:
    - "User-configured daily goal loads on app startup"
    - "User-configured monthly goal loads on app startup"
    - "Weekly goal auto-calculates as daily * 7"
    - "Goals fall back to defaults (50/1500) when first launched"
    - "Custom goals appear in Statistics screen"
  artifacts:
    - path: "push_up_5050/lib/providers/goals_provider.dart"
      provides: "Goals provider with goal loading from StorageService"
      min_lines: 100
      contains: "_loadSavedGoals", "getDailyGoal", "getMonthlyGoal"
    - path: "push_up_5050/test/providers/goals_provider_test.dart"
      provides: "Tests for goal persistence loading"
      exports: ["main", "loadGoals"]
  key_links:
    - from: "push_up_5050/lib/providers/goals_provider.dart"
      to: "push_up_5050/lib/repositories/storage_service.dart"
      via: "method call in _loadSavedGoals()"
      pattern: "_storage\\.get(Daily|Monthly)Goal\\(\\)"
    - from: "push_up_5050/lib/providers/goals_provider.dart"
      to: "push_up_5050/lib/screens/statistics/statistics_screen.dart"
      via: "GoalsProvider.weeklyGoals and monthlyGoals getters"
      pattern: "context\\.watch<GoalsProvider>\\(\\)"
---

<objective>
Wire user-configured goals from onboarding to GoalsProvider so custom daily/monthly goals persist across app restarts.

Purpose: Fix integration bug where goals saved during onboarding are never loaded - app always uses hardcoded PredefinedGoals (350/1500). User should see their custom goals throughout the app.

Output: GoalsProvider._loadSavedGoals() reads from StorageService, creates Goal objects with custom target values, with fallback to defaults.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Code files to modify
@push_up_5050/lib/providers/goals_provider.dart
@push_up_5050/lib/repositories/storage_service.dart
@push_up_5050/lib/models/goal.dart
@push_up_5050/lib/screens/onboarding/onboarding_screen.dart
</context>

<tasks>

<task type="auto">
  <name>Update GoalsProvider._loadSavedGoals() to load user goals from StorageService</name>
  <files>push_up_5050/lib/providers/goals_provider.dart</files>
  <action>
In push_up_5050/lib/providers/goals_provider.dart, replace the _loadSavedGoals() method (lines 92-96) to load custom goals from StorageService:

Current code returns hardcoded PredefinedGoals.all. New code must:

1. Call _storage.getDailyGoal() to get user's custom daily goal (defaults to 50)
2. Call _storage.getMonthlyGoal() to get user's custom monthly goal (defaults to 1500)
3. Calculate weekly goal as daily * 7
4. Create Goal objects using the custom target values:
   - Weekly goal: use calculated weekly target (daily * 7)
   - Monthly goal: use custom monthly target from storage
   - Keep challenge and total goals from PredefinedGoals (centurion, perfectWeek, programComplete, total)
5. Return list of all goals

Implementation pattern:
```dart
Future<List<Goal>> _loadSavedGoals() async {
  final dailyGoal = _storage.getDailyGoal(); // defaults to 50
  final monthlyGoal = _storage.getMonthlyGoal(); // defaults to 1500
  final weeklyGoal = dailyGoal * 7;

  return [
    // Weekly goal with custom target
    Goal(
      id: 'weekly_custom',
      title: PredefinedGoals.weekly.title,
      description: PredefinedGoals.weekly.description,
      type: GoalType.weekly,
      target: weeklyGoal,
      iconName: PredefinedGoals.weekly.iconName,
    ),
    // Monthly goal with custom target
    Goal(
      id: 'monthly_custom',
      title: PredefinedGoals.monthly.title,
      description: PredefinedGoals.monthly.description,
      type: GoalType.monthly,
      target: monthlyGoal,
      iconName: PredefinedGoals.monthly.iconName,
    ),
    // Keep predefined challenge and total goals
    PredefinedGoals.total,
    PredefinedGoals.centurion,
    PredefinedGoals.perfectWeek,
    PredefinedGoals.programComplete,
  ];
}
```

Key points:
- PredefinedGoals.weekly and PredefinedGoals.monthly have hardcoded targets (350/1500) - DO NOT use these
- Create NEW Goal objects with custom targets from storage
- Reuse title, description, iconName from PredefinedGoals for localization consistency
- Challenge goals (centurion, perfectWeek, programComplete) remain unchanged
- Total goal (5050) remains unchanged
</action>
  <verify>flutter test push_up_5050/test/providers/goals_provider_test.dart</verify>
  <done>_loadSavedGoals() calls storage.getDailyGoal() and storage.getMonthlyGoal(), creates Goal objects with custom targets, weekly = daily * 7</done>
</task>

<task type="auto">
  <name>Write tests for goal loading persistence</name>
  <files>push_up_5050/test/providers/goals_provider_test.dart</files>
  <action>
Create or update push_up_5050/test/providers/goals_provider_test.dart with tests for goal persistence:

Test cases to implement:
1. **loadGoals_withCustomValues**: Set custom daily=100, monthly=3000 in mock StorageService, verify GoalsProvider loads goals with these targets
2. **loadGoals_withDefaults**: Mock StorageService returns null (no saved values), verify defaults daily=50, monthly=1500, weekly=350
3. **weeklyGoal_autoCalculates**: Set daily=75, verify weekly goal target = 525 (75 * 7)
4. **challengeGoals_unchanged**: Verify challenge goals (centurion=100, perfectWeek=7, programComplete=30) remain at predefined values
5. **totalGoal_unchanged**: Verify total goal remains at 5050

Mock setup pattern:
```dart
class MockStorageService extends Mock implements StorageService {
  @override
  int getDailyGoal() => mockDailyGoal ?? 50;

  @override
  int getMonthlyGoal() => mockMonthlyGoal ?? 1500;
}
```

Use mockito package for mocking (already in dev_dependencies).
Run tests after writing to verify all pass.
</action>
  <verify>flutter test push_up_5050/test/providers/goals_provider_test.dart</verify>
  <done>All 5 tests pass: custom values load, defaults work, weekly calculates, challenge/total goals unchanged</done>
</task>

<task type="auto">
  <name>Verify end-to-end goal persistence in running app</name>
  <files>push_up_5050/lib/providers/goals_provider.dart</files>
  <action>
Run the app on Windows emulator to verify the fix works end-to-end:

1. Reset onboarding: clear SharedPreferences or use Settings "Restart Tutorial" if available
2. Launch app, complete onboarding with custom goals (e.g., daily=75, monthly=2250)
3. Navigate to Statistics screen
4. Verify weekly goal shows 525 (75 * 7) and monthly goal shows 2250
5. Close and relaunch app
6. Navigate to Statistics screen again
7. Verify custom goals persist (still showing 525/2250)

If visual verification confirms goals load correctly, the fix is complete.
</action>
  <verify>Manual verification: Statistics screen shows custom weekly/monthly targets after app restart</verify>
  <done>User-configured goals persist across app restart and display correctly in Statistics screen</done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. GoalsProvider._loadSavedGoals() implementation:
   - Calls _storage.getDailyGoal()
   - Calls _storage.getMonthlyGoal()
   - Creates weekly Goal with target = daily * 7
   - Creates monthly Goal with custom target
   - Falls back to defaults (50/1500) when storage returns null

2. Test coverage:
   - Custom values load correctly
   - Default values apply when no saved data
   - Weekly goal auto-calculates
   - Challenge and total goals remain unchanged

3. End-to-end verification:
   - Onboarding saves goals via StorageService.setDailyGoal/setMonthlyGoal
   - GoalsProvider loads them on startup
   - Statistics screen displays custom targets
   - Goals persist across app restart

4. Run all tests: flutter test
</verification>

<success_criteria>
- User who sets daily=75 in onboarding sees weekly goal of 525 (75*7) throughout app
- User who sets monthly=2000 in onboarding sees monthly goal of 2000 throughout app
- New user (no saved goals) sees defaults: weekly=350, monthly=1500
- All goals persist after closing and reopening the app
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02.9-fix-goals-persistence-integration/02.9-01-SUMMARY.md`
</output>
