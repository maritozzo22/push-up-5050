---
phase: 03.5-smart-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/models/notification_time_slot.dart
  - push_up_5050/lib/utils/workout_time_analyzer.dart
  - push_up_5050/lib/repositories/storage_service.dart
  - push_up_5050/lib/providers/notification_preferences_provider.dart
  - push_up_5050/lib/providers/active_workout_provider.dart
autonomous: true

must_haves:
  truths:
    - "User has a personalized notification time based on workout patterns"
    - "System tracks when user completes workouts to calculate optimal notification time"
    - "Fallback to 9:00 AM default when insufficient data (<7 workout days)"
    - "Personalized time recalculates weekly based on new workout patterns"
    - "Workout completion time is saved when workout session finishes"
  artifacts:
    - path: "push_up_5050/lib/models/notification_time_slot.dart"
      provides: "Workout completion time tracking model"
      contains: "class NotificationTimeSlot"
    - path: "push_up_5050/lib/utils/workout_time_analyzer.dart"
      provides: "Personalized time calculation from workout history"
      exports: ["calculatePersonalizedTime"]
    - path: "push_up_5050/lib/repositories/storage_service.dart"
      provides: "Notification time persistence and workout completion time tracking"
      exports: ["saveWorkoutCompletionTime", "getPersonalizedNotificationTime", "setPersonalizedNotificationTime"]
    - path: "push_up_5050/lib/providers/notification_preferences_provider.dart"
      provides: "User-facing notification time preferences state management"
      exports: ["personalizedHour", "personalizedMinute", "updatePersonalizedTime"]
    - path: "push_up_5050/lib/providers/active_workout_provider.dart"
      provides: "Workout completion time tracking integration"
      contains: "saveWorkoutCompletionTime"
  key_links:
    - from: "ActiveWorkoutProvider"
      to: "StorageService.saveWorkoutCompletionTime"
      via: "Call on workout session save"
      pattern: "saveWorkoutCompletionTime"
    - from: "NotificationPreferencesProvider"
      to: "WorkoutTimeAnalyzer.calculatePersonalizedTime"
      via: "Analysis of stored workout times"
      pattern: "calculatePersonalizedTime"
---

<objective>
Build Workout Time Tracking and Personalization Infrastructure

Purpose: Track when users complete workouts to calculate personalized notification times that match their exercise patterns. This increases engagement by delivering notifications when users are most likely to act on them.

Output:
- NotificationTimeSlot model for tracking workout completion times
- WorkoutTimeAnalyzer utility for calculating personalized notification time from workout history
- StorageService methods for persisting workout times and user's personalized notification preference
- NotificationPreferencesProvider for state management of notification preferences
- ActiveWorkoutProvider integration to save workout completion times
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.5-smart-notifications/*-CONTEXT.md
@.planning/phases/03.5-smart-notifications/*-RESEARCH.md

@push_up_5050/lib/repositories/storage_service.dart
@push_up_5050/lib/providers/user_stats_provider.dart
@push_up_5050/lib/services/notification_service.dart
@push_up_5050/lib/providers/active_workout_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Create NotificationTimeSlot model</name>
  <files>push_up_5050/lib/models/notification_time_slot.dart</files>
  <action>
    Create NotificationTimeSlot model with:
    - `final DateTime timestamp` - when workout was completed
    - `final int hour` - hour of day (0-23) for quick binning
    - `final int minute` - minute of hour (0-59)
    - Constructor with required params
    - `toJson()` method for serialization (YYYY-MM-DD HH:mm format)
    - `fromJson()` factory for deserialization
    - `toHourBin()` getter returning (hour ~/ 2) * 2 for 2-hour window binning

    Pattern: Follow existing DailyRecord model structure for JSON serialization
  </action>
  <verify>
    flutter test test/models/notification_time_slot_test.dart (create if needed)
  </verify>
  <done>NotificationTimeSlot model created with serialization support</done>
</task>

<task type="auto">
  <name>Create WorkoutTimeAnalyzer utility</name>
  <files>push_up_5050/lib/utils/workout_time_analyzer.dart</files>
  <action>
    Create WorkoutTimeAnalyzer utility class with:

    1. `calculatePersonalizedTime(List<NotificationTimeSlot> workoutTimes)` method:
       - Returns `(int hour, int minute)?` - null if <7 data points, otherwise (hour, 0)
       - Bins workout times into 2-hour windows (0-1, 2-3, 4-5, etc.)
       - Uses `(time.hour ~/ 2) * 2` to round down to even hour
       - Finds the hour bin with maximum workout count
       - Returns (bestHour, 0) with 0 minutes for consistency

    2. `hasSufficientData(List<NotificationTimeSlot> workoutTimes)` method:
       - Returns true if workoutTimes.length >= 7
       - Used to determine when to switch from fallback to personalized time

    3. Constants:
       - `const int minDataPointsForPersonalization = 7`
       - `const int defaultHour = 9` (9:00 AM fallback)
       - `const int defaultMinute = 0`

    Pattern: Follow existing Calculator utility structure
  </action>
  <verify>
    flutter test test/utils/workout_time_analyzer_test.dart (create if needed)
  </verify>
  <done>WorkoutTimeAnalyzer created with personalized time calculation</done>
</task>

<task type="auto">
  <name>Add notification time tracking to StorageService</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
    Add to StorageService:

    1. Storage keys at top with other keys:
       ```dart
       static const String _keyWorkoutCompletionTimes = 'workout_completion_times';
       static const String _keyPersonalizedNotificationHour = 'personalized_notification_hour';
       static const String _keyPersonalizedNotificationMinute = 'personalized_notification_minute';
       ```

    2. `saveWorkoutCompletionTime(DateTime timestamp)` method:
       - Stores workout completion time as JSON array
       - Maintains last 90 entries (90 days ~ 3 months of data)
       - Uses NotificationTimeSlot.toJson() format
       - Key: `_keyWorkoutCompletionTimes`

    3. `getWorkoutCompletionTimes()` method:
       - Returns `List<NotificationTimeSlot>` from storage
       - Returns empty list if no data
       - Deserializes using NotificationTimeSlot.fromJson()

    4. `getPersonalizedNotificationTime()` method:
       - Returns `(int hour, int minute)` tuple
       - If has sufficient data (>=7 workout times): returns calculated personalized time
       - If insufficient data: returns (9, 0) for 9:00 AM fallback
       - Uses WorkoutTimeAnalyzer.calculatePersonalizedTime()

    5. `setPersonalizedNotificationTime(int hour, int minute)` method:
       - Allows user to manually override personalized time
       - Stores to `_keyPersonalizedNotificationHour` and `_keyPersonalizedNotificationMinute`
       - Use case: Settings screen time picker

    Pattern: Follow existing flag-based storage patterns (weekly review shown, etc.)
  </action>
  <verify>
    flutter test test/repositories/storage_service_notification_test.dart
  </verify>
  <done>StorageService extended with workout time tracking and personalized notification time</done>
</task>

<task type="auto">
  <name>Integrate workout completion time tracking into ActiveWorkoutProvider</name>
  <files>push_up_5050/lib/providers/active_workout_provider.dart</files>
  <action>
    Update ActiveWorkoutProvider to save workout completion time when session finishes:

    1. Add StorageService import if not present:
       ```dart
       import 'package:push_up_5050/repositories/storage_service.dart';
       ```

    2. Add StorageService field (inject via constructor if needed, or access via Provider if already available):
       ```dart
       final StorageService _storage;

       // In constructor or existing initialization
       ActiveWorkoutProvider({required StorageService storage}) : _storage = storage;
       ```

    3. In the method that saves/finishes workout session (e.g., `completeWorkout`, `saveSession`, or similar), add:
       ```dart
       // Save workout completion time for personalized notification calculation
       await _storage.saveWorkoutCompletionTime(DateTime.now());
       ```

    4. If ActiveWorkoutProvider already uses Provider for StorageService via context, ensure the method can access it:
       - Use `context.read<StorageService>()` if available
       - Otherwise, add StorageService as constructor dependency

    Purpose: This ensures every completed workout is timestamped for personalized notification time calculation.

    Pattern: Follow existing session save patterns in ActiveWorkoutProvider
  </action>
  <verify>
    flutter test test/providers/active_workout_provider_test.dart
    grep -n "saveWorkoutCompletionTime" push_up_5050/lib/providers/active_workout_provider.dart
  </verify>
  <done>ActiveWorkoutProvider saves workout completion time when session finishes</done>
</task>

<task type="auto">
  <name>Create NotificationPreferencesProvider</name>
  <files>push_up_5050/lib/providers/notification_preferences_provider.dart</files>
  <action>
    Create NotificationPreferencesProvider extending ChangeNotifier with:

    1. Private fields:
       ```dart
       final StorageService _storage;
       int _personalizedHour = 9;
       int _personalizedMinute = 0;
       bool _isLoading = false;
       List<NotificationTimeSlot> _workoutTimes = [];
       ```

    2. Getters:
       - `int get personalizedHour => _personalizedHour`
       - `int get personalizedMinute => _personalizedMinute`
       - `bool get isLoading => _isLoading`
       - `String get formattedTime => "$_personalizedHour:${_personalizedMinute.toString().padLeft(2, '0')}"`

    3. `loadPreferences()` method:
       - Loads personalized time from StorageService
       - Loads workout completion times
       - Calculates personalized time if sufficient data available
       - Sets _isLoading and notifyListeners()

    4. `updatePersonalizedTime(int hour, int minute)` method:
       - Updates _personalizedHour and _personalizedMinute
       - Saves to StorageService via setPersonalizedNotificationTime()
       - Calls notifyListeners()

    5. `recalculatePersonalizedTime()` method:
       - Re-runs WorkoutTimeAnalyzer.calculatePersonalizedTime() on current workout times
       - Updates personalized time if calculation differs from current
       - Called weekly (e.g., from StatisticsScreen on Sunday)

    Constructor: `NotificationPreferencesProvider({required StorageService storage})`

    Pattern: Follow existing Provider patterns (UserStatsProvider, GoalsProvider)
  </action>
  <verify>
    flutter test test/providers/notification_preferences_provider_test.dart
  </verify>
  <done>NotificationPreferencesProvider created with time preference state management</done>
</task>

</tasks>

<verification>
1. Run `flutter test` - all new tests pass
2. Verify workout completion time is saved when workout session completes
3. Verify personalized time calculation returns 9:00 AM with <7 data points
4. Verify personalized time calculation returns mode hour bin with >=7 data points
5. Verify user can manually override personalized time via provider
6. Verify ActiveWorkoutProvider calls saveWorkoutCompletionTime() on session save
</verification>

<success_criteria>
- Workout completion times are tracked and persisted
- Personalized notification time is calculated from workout patterns
- Fallback to 9:00 AM default when insufficient data
- Provider allows manual override and weekly recalculation
- ActiveWorkoutProvider integrates time tracking on workout completion
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-smart-notifications/03.5-01-SUMMARY.md`
</output>
