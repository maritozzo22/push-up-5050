---
phase: 03.5-smart-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/services/notification_service.dart
  - push_up_5050/lib/l10n/app_it.arb
  - push_up_5050/lib/l10n/app_en.arb
autonomous: true

must_haves:
  truths:
    - "NotificationService has unique IDs for streak, progress, and challenge notifications"
    - "Separate notification channels exist for each notification type"
    - "All notification messages are localized in IT and EN"
    - "Each notification type uses distinct Android channel for user control in system settings"
  artifacts:
    - path: "push_up_5050/lib/services/notification_service.dart"
      provides: "Extended notification scheduling methods for smart notifications"
      contains: "scheduleStreakAtRiskNotification"
      exports: ["scheduleStreakAtRiskNotification", "scheduleProgressNotification", "scheduleWeeklyChallengeNotification"]
    - path: "push_up_5050/lib/l10n/app_it.arb"
      provides: "Italian localization for notification messages"
      contains: "notificationStreakAtRiskTitle"
    - path: "push_up_5050/lib/l10n/app_en.arb"
      provides: "English localization for notification messages"
      contains: "notificationStreakAtRiskTitle"
  key_links:
    - from: "NotificationScheduler"
      to: "NotificationService.scheduleStreakAtRiskNotification"
      via: "Scheduling call with personalized time"
      pattern: "scheduleStreakAtRiskNotification"
    - from: "notification content"
      to: "AppLocalizations"
      via: "Localized strings for title and body"
      pattern: "AppLocalizations.of(context)!"
---

<objective>
Extend NotificationService with Smart Notification Methods and Localization

Purpose: Add scheduling methods for three notification types (streak at risk, progress encouragement, weekly challenge) with unique IDs, separate channels, and full localization support.

Output:
- NotificationService extended with 3 new scheduling methods
- Notification ID constants class for unique identification
- Notification channel constants for Android system settings grouping
- 20+ new localization keys for IT/EN notification messages
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.5-smart-notifications/*-CONTEXT.md
@.planning/phases/03.5-smart-notifications/*-RESEARCH.md

@push_up_5050/lib/services/notification_service.dart
@push_up_5050/lib/l10n/app_it.arb
</context>

<tasks>

<task type="auto">
  <name>Add NotificationIds and NotificationChannels constants</name>
  <files>push_up_5050/lib/services/notification_service.dart</files>
  <action>
    Add at top of NotificationService class (after imports, before class definition):

    1. NotificationIds class:
       ```dart
       /// Unique notification IDs to prevent overwriting
       class NotificationIds {
         static const int dailyReminder = 0;        // Existing
         static const int streakAtRisk = 1;         // NEW - Streak at risk warning
         static const int progressEncouragement = 2; // NEW - Progress encouragement
         static const int weeklyChallenge = 3;      // NEW - Sunday challenge announcement
       }
       ```

    2. NotificationChannels class:
       ```dart
       /// Notification channel IDs for Android system settings
       class NotificationChannels {
         static const String streak = 'streak_channel';
         static const String progress = 'progress_channel';
         static const String challenge = 'challenge_channel';
       }
       ```

    These constants ensure:
    - No notification overwrites another (unique IDs)
    - Users can control each notification type in Android system settings (separate channels)
    - Easy to cancel specific notification types via ID

    Pattern: Follow existing notification ID 0 for dailyReminder
  </action>
  <verify>
    grep -n "NotificationIds\|NotificationChannels" push_up_5050/lib/services/notification_service.dart
  </verify>
  <done>Constants added for unique notification IDs and channels</done>
</task>

<task type="auto">
  <name>Add scheduleStreakAtRiskNotification method</name>
  <files>push_up_5050/lib/services/notification_service.dart</files>
  <action>
    Add method to NotificationService:

    ```dart
    /// Schedule streak at risk notification.
    ///
    /// Sends daily reminder if user hasn't worked out in 2+ days.
    /// Uses [hour] and [minute] for personalized scheduling time.
    /// Message varies by day count (motivational on day 3, urgent on day 4+).
    ///
    /// Returns true if scheduled successfully.
    Future<bool> scheduleStreakAtRiskNotification({
      required int hour,
      required int minute,
    }) async {
      if (!_initialized) {
        await initialize();
      }

      final hasPermission = await requestPermissions();
      if (!hasPermission) {
        debugPrint('NotificationService: POST_NOTIFICATIONS permission not granted');
        return false;
      }

      // Cancel existing streak notification
      await cancel(NotificationIds.streakAtRisk);

      final scheduledTime = _nextInstanceOfTime(hour, minute);

      const androidDetails = AndroidNotificationDetails(
        NotificationChannels.streak,
        'Promemoria Streak',
        channelDescription: 'Avvisi quando la tua streak √® a rischio',
        importance: Importance.high,
        priority: Priority.high,
      );

      const platformDetails = NotificationDetails(
        android: androidDetails,
      );

      try {
        await _plugin.zonedSchedule(
          NotificationIds.streakAtRisk,
          'Non perdere la tua serie! üî•',
          'Hai costruito qualcosa di grande ‚Äî continua con solo 5 flessioni!',
          scheduledTime,
          platformDetails,
          androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
          matchDateTimeComponents: DateTimeComponents.time,
          uiLocalNotificationDateInterpretation: UILocalNotificationDateInterpretation.absoluteTime,
        );
        debugPrint('NotificationService: Streak at risk notification scheduled for $hour:$minute');
        return true;
      } catch (e) {
        debugPrint('NotificationService: Failed to schedule streak at risk: $e');
        return false;
      }
    }
    ```

    Key details:
    - Uses NotificationIds.streakAtRisk (1)
    - Uses NotificationChannels.streak ('streak_channel')
    - Repeats daily via matchDateTimeComponents: DateTimeComponents.time
    - Emoji included for engagement (üî•)
    - Cancel existing before scheduling to avoid duplicates

    Pattern: Follow existing scheduleDailyReminder() method structure
  </action>
  <verify>
    flutter analyze push_up_5050/lib/services/notification_service.dart
  </verify>
  <done>scheduleStreakAtRiskNotification method added</done>
</task>

<task type="auto">
  <name>Add scheduleProgressNotification method</name>
  <files>push_up_5050/lib/services/notification_service.dart</files>
<action>
    Add method to NotificationService:

    ```dart
    /// Schedule progress encouragement notification.
    ///
    /// Sends notification when user is within 5 push-ups of daily goal
    /// AND has completed at least 50% of goal.
    /// Only fires once per day at the scheduled time.
    ///
    /// Returns true if scheduled successfully.
    Future<bool> scheduleProgressNotification({
      required int hour,
      required int minute,
    }) async {
      if (!_initialized) {
        await initialize();
      }

      final hasPermission = await requestPermissions();
      if (!hasPermission) {
        debugPrint('NotificationService: POST_NOTIFICATIONS permission not granted');
        return false;
      }

      // Cancel existing progress notification
      await cancel(NotificationIds.progressEncouragement);

      final scheduledTime = _nextInstanceOfTime(hour, minute);

      const androidDetails = AndroidNotificationDetails(
        NotificationChannels.progress,
        'Promemoria Progresso',
        channelDescription: 'Incoraggiamenti quando sei vicino alÁõÆÊ†á',
        importance: Importance.defaultImportance,
        priority: Priority.defaultPriority,
      );

      const platformDetails = NotificationDetails(
        android: androidDetails,
      );

      try {
        await _plugin.zonedSchedule(
          NotificationIds.progressEncouragement,
          'Ci sei quasi! üí™',
          'Mancano solo 5 flessioni per raggiungere il tuo obiettivo giornaliero.',
          scheduledTime,
          platformDetails,
          androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
          matchDateTimeComponents: DateTimeComponents.time,
          uiLocalNotificationDateInterpretation: UILocalNotificationDateInterpretation.absoluteTime,
        );
        debugPrint('NotificationService: Progress notification scheduled for $hour:$minute');
        return true;
      } catch (e) {
        debugPrint('NotificationService: Failed to schedule progress: $e');
        return false;
      }
    }
    ```

    Key details:
    - Uses NotificationIds.progressEncouragement (2)
    - Uses NotificationChannels.progress ('progress_channel')
    - Lower importance/priority than streak notifications
    - Emoji for engagement (üí™)
    - Condition checking (within 5 of goal, 50% complete) happens in scheduler, not here

    Pattern: Follow scheduleStreakAtRiskNotification structure
  </action>
  <verify>
    flutter analyze push_up_5050/lib/services/notification_service.dart
  </verify>
  <done>scheduleProgressNotification method added</done>
</task>

<task type="auto">
  <name>Add scheduleWeeklyChallengeNotification method</name>
  <files>push_up_5050/lib/services/notification_service.dart</files>
  <action>
    Add method to NotificationService:

    ```dart
    /// Schedule weekly challenge announcement notification.
    ///
    /// Sends notification on Sunday at 8:00 AM announcing new weekly challenge.
    /// Not personalized - always fires at 8:00 AM Sunday.
    ///
    /// Returns true if scheduled successfully.
    Future<bool> scheduleWeeklyChallengeNotification() async {
      if (!_initialized) {
        await initialize();
      }

      final hasPermission = await requestPermissions();
      if (!hasPermission) {
        debugPrint('NotificationService: POST_NOTIFICATIONS permission not granted');
        return false;
      }

      // Cancel existing challenge notification
      await cancel(NotificationIds.weeklyChallenge);

      // Calculate next Sunday 8:00 AM
      final now = tz.TZDateTime.now(tz.local);
      var scheduled = tz.TZDateTime(tz.local, now.year, now.month, now.day, 8, 0);

      // Find next Sunday (weekday 7)
      while (scheduled.weekday != 7) {
        scheduled = scheduled.add(const Duration(days: 1));
      }

      // If Sunday 8AM has passed today, schedule for next Sunday
      if (scheduled.isBefore(now)) {
        scheduled = scheduled.add(const Duration(days: 7));
      }

      const androidDetails = AndroidNotificationDetails(
        NotificationChannels.challenge,
        'Sfida Settimanale',
        channelDescription: 'Annunci nuova sfida disponibile',
        importance: Importance.high,
        priority: Priority.high,
      );

      const platformDetails = NotificationDetails(
        android: androidDetails,
      );

      try {
        await _plugin.zonedSchedule(
          NotificationIds.weeklyChallenge,
          'Nuova sfida disponibile! üèÜ',
          'Controlla i tuoi progressi e scopri la sfida di questa settimana.',
          scheduled,
          platformDetails,
          androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
          matchDateTimeComponents: DateTimeComponents.dayOfWeekAndTime,
          uiLocalNotificationDateInterpretation: UILocalNotificationDateInterpretation.absoluteTime,
        );
        debugPrint('NotificationService: Weekly challenge notification scheduled for Sunday 8:00 AM');
        return true;
      } catch (e) {
        debugPrint('NotificationService: Failed to schedule weekly challenge: $e');
        return false;
      }
    }
    ```

    Key details:
    - Uses NotificationIds.weeklyChallenge (3)
    - Uses NotificationChannels.challenge ('challenge_channel')
    - Fixed time: Sunday 8:00 AM (not personalized)
    - matchDateTimeComponents: dayOfWeekAndTime for weekly repeat
    - Emoji for engagement (üèÜ)

    Pattern: Follow existing notification scheduling but with weekly repeat
  </action>
  <verify>
    flutter analyze push_up_5050/lib/services/notification_service.dart
  </verify>
  <done>scheduleWeeklyChallengeNotification method added</done>
</task>

<task type="auto">
  <name>Add localization keys for all notification messages</name>
  <files>push_up_5050/lib/l10n/app_it.arb, push_up_5050/lib/l10n/app_en.arb</files>
  <action>
    Add to app_it.arb (Italian):

    ```json
    "notificationStreakAtRiskTitle": "Non perdere la tua serie! üî•",
    "notificationStreakAtRiskBodyDay3": "Hai costruito qualcosa di grande ‚Äî continua con solo 5 flessioni!",
    "notificationStreakAtRiskBodyDay4": "Hai {streak} giorni sulla linea ‚Äî non lasciarli sparire!",
    "@notificationStreakAtRiskBodyDay4": {
      "placeholders": {
        "streak": {"type": "int", "example": "10"}
      }
    },
    "notificationProgressTitle": "Ci sei quasi! üí™",
    "notificationProgressBody": "Mancano solo 5 flessioni per raggiungere il tuo obiettivo giornaliero.",
    "notificationChallengeTitle": "Nuova sfida disponibile! üèÜ",
    "notificationChallengeBody": "Controlla i tuoi progressi e scopri la sfida di questa settimana.",
    "notificationStreakChannel": "Promemoria Streak",
    "notificationStreakChannelDesc": "Avvisi quando la tua streak √® a rischio",
    "notificationProgressChannel": "Promemoria Progresso",
    "notificationProgressChannelDesc": "Incoraggiamenti quando sei vicino all'obiettivo",
    "notificationChallengeChannel": "Sfida Settimanale",
    "notificationChallengeChannelDesc": "Annunci nuova sfida disponibile"
    ```

    Add to app_en.arb (English):

    ```json
    "notificationStreakAtRiskTitle": "Don't lose your streak! üî•",
    "notificationStreakAtRiskBodyDay3": "You've built something great ‚Äî keep it going with just 5 push-ups!",
    "notificationStreakAtRiskBodyDay4": "You have {streak} days on the line ‚Äî don't let it disappear!",
    "@notificationStreakAtRiskBodyDay4": {
      "placeholders": {
        "streak": {"type": "int", "example": "10"}
      }
    },
    "notificationProgressTitle": "Almost there! üí™",
    "notificationProgressBody": "Just 5 more push-ups to reach your daily goal.",
    "notificationChallengeTitle": "New weekly challenge available! üèÜ",
    "notificationChallengeBody": "Check your progress and discover this week's challenge.",
    "notificationStreakChannel": "Streak Reminders",
    "notificationStreakChannelDesc": "Notifications when your streak is at risk",
    "notificationProgressChannel": "Progress Reminders",
    "notificationProgressChannelDesc": "Encouragement when you're close to your goal",
    "notificationChallengeChannel": "Weekly Challenge",
    "notificationChallengeChannelDesc": "Announces new weekly challenge available"
    ```

    Then run `flutter pub get` to regenerate localization files.

    Pattern: Follow existing i18n structure with placeholders and metadata
  </action>
  <verify>
    flutter pub get && flutter analyze
  </verify>
  <done>Localization keys added for all notification messages</done>
</task>

</tasks>

<verification>
1. Run `flutter analyze` - no errors
2. Run `flutter pub get` - regenerates localization files successfully
3. Verify NotificationIds class has 4 constants (0-3)
4. Verify NotificationChannels class has 3 constants
5. Verify all 3 scheduling methods exist in NotificationService
6. Verify 12 new localization keys in both app_it.arb and app_en.arb
</verification>

<success_criteria>
- NotificationService extended with 3 new scheduling methods
- Unique notification IDs prevent overwriting
- Separate channels allow user control in Android settings
- All notification messages localized in IT/EN
- Code analysis passes
</success_criteria>

<output>
After completion, create `.planning/phases/03.5-smart-notifications/03.5-02-SUMMARY.md`
</output>
