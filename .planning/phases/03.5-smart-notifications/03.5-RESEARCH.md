# Phase 03.5: Smart Notifications - Research

**Researched:** 2026-01-26
**Domain:** Flutter local notifications, scheduling, personalization algorithms
**Confidence:** HIGH

## Summary

This phase implements contextual push notifications that keep users engaged without spamming. The research confirms that the existing `flutter_local_notifications` ^17.2.3 package is sufficient for all required notification types without needing additional background task packages like `workmanager`.

Key findings:
- **Standard stack**: `flutter_local_notifications` (already installed) + `timezone` (already installed)
- **Scheduling pattern**: Use `zonedSchedule()` with `matchDateTimeComponents` for daily/weekly repeats
- **Notification IDs**: Each notification type requires unique IDs to avoid overwriting
- **Personalization**: Track workout completion times and calculate mode within 2-hour windows
- **No background tasks needed**: Plugin handles scheduling natively via Android AlarmManager

**Primary recommendation:** Extend the existing `NotificationService` with smart notification types (streak at risk, progress, challenge) and add a `NotificationScheduler` for time-based logic. No new dependencies required.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| flutter_local_notifications | ^17.2.3 | Display/schedule notifications | Cross-platform, mature, handles repeat scheduling natively |
| timezone | ^0.9.4 | Timezone-aware scheduling | Required by flutter_local_notifications for zonedSchedule |

**Already installed** - no new dependencies needed.

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| shared_preferences | ^2.2.2 | Store personalized notification time, last sent dates | Persist notification preferences and state |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| flutter_local_notifications | workmanager | Workmanager adds complexity for background execution but not needed - notifications can be scheduled directly |
| Single notification channel | Multiple channels | Multiple channels allow users to manage notification types in system settings |

**Installation:** No changes required - all dependencies already in `pubspec.yaml`.

## Architecture Patterns

### Recommended Project Structure
```
lib/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ notification_service.dart      # Existing - extend with smart methods
â”‚   â””â”€â”€ notification_scheduler.dart    # NEW - handles timing logic
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ notification_preferences_provider.dart  # NEW - user preferences
â”œâ”€â”€ models/
â”‚   â””â”€â”€ notification_time_slot.dart    # NEW - workout time tracking model
â””â”€â”€ utils/
    â””â”€â”€ workout_time_analyzer.dart     # NEW - calculates personalized time
```

### Pattern 1: Zoned Schedule with MatchDateTimeComponents

**What:** Schedules notifications that repeat at a specific time daily or weekly.

**When to use:** All notification types in this phase (daily streak check, progress, weekly Sunday challenge).

**Example:**
```dart
// Source: https://pub.dev/packages/flutter_local_notifications
// Daily repeating notification at personalized time
await flutterLocalNotificationsPlugin.zonedSchedule(
  0, // Unique notification ID
  'Streak at Risk!',
  'Your streak is at risk! Complete a workout today to keep it going.',
  scheduledTime,
  const NotificationDetails(
    android: AndroidNotificationDetails(
      'streak_channel',
      'Streak Reminders',
      channelDescription: 'Notifications about your workout streak',
      importance: Importance.high,
      priority: Priority.high,
    ),
  ),
  androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
  matchDateTimeComponents: DateTimeComponents.time, // Repeat daily at this time
  uiLocalNotificationDateInterpretation: UILocalNotificationDateInterpretation.absoluteTime,
);
```

### Pattern 2: Unique Notification IDs per Type

**What:** Each notification type uses a distinct ID to prevent overwriting.

**When to use:** Whenever scheduling multiple notification types.

**Example:**
```dart
// Notification ID constants
class NotificationIds {
  static const int dailyReminder = 0;        // Existing
  static const int streakAtRisk = 1;         // NEW
  static const int progressEncouragement = 2; // NEW
  static const int weeklyChallenge = 3;      // NEW (Sunday 8AM)
}

// Each ID is unique to avoid conflicts
await plugin.zonedSchedule(NotificationIds.streakAtRisk, ...);
```

### Pattern 3: Time Slot Calculation for Personalization

**What:** Analyze workout completion times to find the 2-hour window with most activity.

**When to use:** When user has 7+ workout days; otherwise fall back to 9:00 AM.

**Example:**
```dart
/// Calculate personalized notification time from workout history
/// Returns the hour (0-23) of the most active 2-hour window
(int hour, int minute)? calculatePersonalizedTime(List<DateTime> workoutTimes) {
  if (workoutTimes.length < 7) return null; // Need 7+ data points

  // Bin workout times into 2-hour windows (0-1, 2-3, 4-5, etc.)
  final Map<int, int> hourCounts = {};
  for (final time in workoutTimes) {
    final hourBin = (time.hour ~/ 2) * 2; // Round down to even hour
    hourCounts[hourBin] = (hourCounts[hourBin] ?? 0) + 1;
  }

  // Find the hour with maximum count
  final bestHour = hourCounts.entries
      .reduce((a, b) => a.value > b.value ? a : b)
      .key;

  return (bestHour, 0); // Return hour with 0 minutes
}
```

### Pattern 4: Notification Channels for Android

**What:** Separate channels for different notification categories.

**When to use:** Required for Android 8.0+; allows user control in system settings.

**Example:**
```dart
// Channel IDs
class NotificationChannels {
  static const String streak = 'streak_channel';
  static const String progress = 'progress_channel';
  static const String challenge = 'challenge_channel';
}

// Channel configuration
const AndroidNotificationDetails streakDetails = AndroidNotificationDetails(
  NotificationChannels.streak,
  'Streak Reminders',
  channelDescription: 'Notifications about your workout streak',
  importance: Importance.high,
  priority: Priority.high,
);
```

### Anti-Patterns to Avoid

- **Reusing notification IDs:** Using the same ID for different notification types causes overwrites. Use unique constants.
- **Ignoring timezone:** Always use `TZDateTime` with `tz.local` for consistent behavior across time zones.
- **Hardcoding times:** Store user's personalized time in SharedPreferences; fall back to 9:00 AM only when no data exists.
- **Scheduling without permission check:** Always call `requestPermissions()` before scheduling on Android 13+.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Exact alarm scheduling | Custom alarm manager logic | `zonedSchedule()` with `AndroidScheduleMode.exactAllowWhileIdle` | Handles Android 12+ SCHEDULE_EXACT_ALARM permission automatically |
| Background task execution | WorkManager integration | flutter_local_notifications scheduling | Plugin schedules via AlarmManager directly; no separate background task needed |
| Timezone handling | Manual DST calculations | `timezone` package's `TZDateTime` | Handles daylight saving time and timezone edge cases |
| Permission requests | Custom platform channels | `requestNotificationsPermission()` | Built-in, tested across Android versions |

**Key insight:** The `flutter_local_notifications` plugin wraps Android's AlarmManager and iOS's UNUserNotificationCenter, providing reliable scheduling without additional background task infrastructure.

## Common Pitfalls

### Pitfall 1: Notifications Not Showing on Android 13+

**What goes wrong:** Notifications scheduled successfully but never appear.

**Why it happens:** Android 13+ requires `POST_NOTIFICATIONS` runtime permission. Without it, notifications are silently blocked.

**How to avoid:**
```dart
// Always request permission before scheduling
final hasPermission = await androidPlugin.requestNotificationsPermission();
if (!hasPermission) {
  debugPrint('Notification permission denied');
  return false;
}
```

**Warning signs:** Test notifications work but scheduled notifications don't appear on Android 13+ devices.

### Pitfall 2: Scheduled Notifications Firing Immediately

**What goes wrong:** Notification appears as soon as scheduled, not at the intended time.

**Why it happens:** Using `DateTime.now()` instead of `TZDateTime` from `timezone` package, or not calculating next occurrence correctly.

**How to avoid:**
```dart
// WRONG
final scheduledTime = DateTime.now().add(Duration(days: 1));

// RIGHT
final scheduledTime = _nextInstanceOfTime(hour, minute);
tz.TZDateTime _nextInstanceOfTime(int hour, int minute) {
  var scheduled = tz.TZDateTime(tz.local, now.year, now.month, now.day, hour, minute);
  if (scheduled.isBefore(now)) {
    scheduled = scheduled.add(const Duration(days: 1));
  }
  return scheduled;
}
```

### Pitfall 3: Samsung 500 Alarm Limit

**What goes wrong:** After scheduling many notifications, older ones stop appearing.

**Why it happens:** Samsung's Android implementation limits AlarmManager to 500 alarms. Exceeding this causes exceptions.

**How to avoid:**
- Cancel old notifications before scheduling new ones
- Use `matchDateTimeComponents` for repeating notifications (one alarm, multiple triggers)
- Keep scheduled notification count low (<50 recommended)

### Pitfall 4: iOS Pending Notifications Limit (64)

**What goes wrong:** On iOS, notifications beyond the first 64 never appear.

**Why it happens:** iOS limits pending notifications to 64.

**How to avoid:**
- For this phase, we only schedule 4 notification types (well under 64)
- Reuse notification IDs instead of creating new ones
- Use `matchDateTimeComponents` for repeating patterns

### Pitfall 5: Notification Content Not Localized

**What goes wrong:** Notification text shows English even when app is in Italian.

**Why it happens:** Direct string literals instead of using `AppLocalizations`.

**How to avoid:**
```dart
// Get localized strings before scheduling
final loc = AppLocalizations.of(context)!;
await plugin.zonedSchedule(
  id,
  loc.dontLoseStreak,
  loc.completePushupsReminder(count),
  ...
);
```

## Code Examples

Verified patterns from official sources:

### Scheduling a Daily Repeating Notification

```dart
// Source: https://pub.dev/packages/flutter_local_notifications
// Existing pattern in NotificationService - extend this

Future<bool> scheduleStreakAtRiskNotification({
  required int hour,
  required int minute,
}) async {
  final scheduledTime = _nextInstanceOfTime(hour, minute);

  const androidDetails = AndroidNotificationDetails(
    'streak_channel',
    'Promemoria Streak',
    channelDescription: 'Avvisi quando la tua streak Ã¨ a rischio',
    importance: Importance.high,
    priority: Priority.high,
  );

  await _plugin.zonedSchedule(
    NotificationIds.streakAtRisk,
    title,
    body,
    scheduledTime,
    const NotificationDetails(android: androidDetails),
    androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
    matchDateTimeComponents: DateTimeComponents.time,
    uiLocalNotificationDateInterpretation: UILocalNotificationDateInterpretation.absoluteTime,
  );

  return true;
}
```

### Canceling a Specific Notification

```dart
// Source: https://pub.dev/packages/flutter_local_notifications
await _plugin.cancel(NotificationIds.streakAtRisk);
```

### Getting Pending Notifications (Debug)

```dart
// Source: Existing codebase - NotificationService.dart
final pending = await _plugin.pendingNotificationRequests();
for (final notification in pending) {
  debugPrint('ID: ${notification.id}, Title: ${notification.title}');
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| `schedule()` method (deprecated) | `zonedSchedule()` with `TZDateTime` | v2.0+ | Required for daylight saving time support |
| `showDailyAtTime()` (deprecated) | `zonedSchedule()` + `matchDateTimeComponents` | v2.0+ | More flexible, supports time zones |
| Manual permission handling | `requestNotificationsPermission()` | v16.0+ | Simplified Android 13+ support |

**Current version (17.2.3):** Stable, supports all required features.

**Latest version (19.5.0):** Not necessary to upgrade - 17.2.3 has all needed functionality.

**Deprecated/outdated:**
- `schedule()` method - replaced by `zonedSchedule()`
- `showDailyAtTime()` - replaced by `zonedSchedule()` with `matchDateTimeComponents: DateTimeComponents.time`
- Manually requesting SCHEDULE_EXACT_ALARM via Intent - use `requestExactAlarmsPermission()` instead

## Open Questions

### 1. Deep Link Behavior When Notification Tapped

**What we know:** `_onNotificationTap` callback exists in `NotificationService` but only logs payload.

**What's unclear:** Which screen should each notification type open to?

**Recommendation:** Map notification types to screens:
- Streak at risk â†’ Home screen (start workout)
- Progress encouragement â†’ Home screen (continue workout)
- Weekly challenge â†’ Statistics screen (view challenge)

### 2. Emoji Usage in Notifications

**What we know:** Some in-app strings use emoji (e.g., "ðŸŽ‰ Obiettivo Raggiunto!")

**What's unclear:** Should notifications include emoji?

**Recommendation:** Yes - emoji increase engagement and are well-supported on Android/iOS. Example: "Non perdere la tua serie! ðŸ”¥" or "Almost there! ðŸ’ª Just 5 more push-ups to reach your daily goal."

### 3. Notification Channel Grouping

**What we know:** Android supports grouping channels into categories.

**What's unclear:** Should all smart notifications be under one group or separate?

**Recommendation:** Single group "Smart Notifications" with three channels (streak, progress, challenge) for cleaner user experience in system settings.

## Sources

### Primary (HIGH confidence)
- [flutter_local_notifications | Flutter package](https://pub.dev/packages/flutter_local_notifications) - Official package documentation, API reference, examples
- [Existing codebase: NotificationService.dart](C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\services\notification_service.dart) - Current implementation patterns
- [Existing codebase: UserStatsProvider.dart](C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\user_stats_provider.dart) - Streak calculation logic, daily records access
- [Existing codebase: StorageService.dart](C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\repositories\storage_service.dart) - Data persistence patterns

### Secondary (MEDIUM confidence)
- [How to schedule irregular local notifications](https://stackoverflow.com/questions/78492138) - Verifies that scheduled notifications persist after app termination
- [Implementing Background Tasks with WorkManager in Flutter](https://vibe-studio.ai/insights/handling-background-tasks-with-workmanager) - Confirms workmanager is for background execution, not needed for scheduled notifications
- [Multiple Daily Notifications Â· Issue #61](https://github.com/MaikuB/flutter_local_notifications/issues/61) - Confirms unique ID requirement
- [Flutter Background task at midnight everyday](https://stackoverflow.com/questions/64223898) - Discusses daily check patterns (not needed for our use case)

### Tertiary (LOW confidence)
- [WorkManager in Flutter â€” Running Background Tasks the Right Way](https://medium.com/@prathamesh.dev004/workmanager-in-flutter-running-background-tasks-the-right-way-c4c37dfbd0ea) - Background task alternatives (not needed)
- Various blog posts on notification scheduling - General patterns, not version-specific

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Using existing installed packages with official documentation
- Architecture: HIGH - Patterns verified from official docs and existing codebase
- Pitfalls: HIGH - Common Android/iOS notification issues well-documented

**Research date:** 2026-01-26

**Valid until:** 2026-02-25 (30 days - notification APIs are stable)

**Key assumptions:**
- Project stays on Flutter 3.x SDK
- Android target SDK remains current (35+)
- No major breaking changes in flutter_local_notifications v17.x
