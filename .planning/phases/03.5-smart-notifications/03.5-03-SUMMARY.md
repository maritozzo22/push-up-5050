---
phase: 03.5-smart-notifications
plan: 03
subsystem: notifications
tags: [flutter_local_notifications, localization, scheduling, deep-links, provider]

# Dependency graph
requires:
  - phase: 03.5-01
    provides: NotificationPreferencesProvider with personalized time tracking
  - phase: 03.5-02
    provides: NotificationService scheduling methods with localization support
provides:
  - NotificationScheduler service with condition checking logic (streak at risk, progress zone)
  - Deep link navigation from notification taps to Home/Statistics screens
  - Provider registration for NotificationScheduler in main.dart
  - Notification trigger calls from HomeScreen on app state changes
affects: [03.5-04, 03.5-05]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - BuildContext parameter for AppLocalizations access in service layer
    - Post-frame callback pattern for one-time notification scheduling
    - Deep link routing via notification payload callbacks
    - Direct StorageService access for missed days calculation (no UserStatsProvider dependency)

key-files:
  created:
    - push_up_5050/lib/services/notification_scheduler.dart
  modified:
    - push_up_5050/lib/services/notification_service.dart
    - push_up_5050/lib/screens/home/home_screen.dart
    - push_up_5050/lib/main.dart
    - push_up_5050/lib/repositories/storage_service.dart
    - push_up_5050/lib/widgets/statistics/weekly_challenge_card.dart

key-decisions:
  - "NotificationScheduler receives BuildContext for AppLocalizations access (service layer needs localized strings)"
  - "Missed days calculated directly from StorageService daily records (no UserStatsProvider dependency)"
  - "Progress zone explicitly documents 50% threshold (dailyGoal * 0.5) per NOTIF-02 requirement"
  - "Deep link navigation: streak/progress -> Home, weekly_challenge -> Statistics"
  - "Notifications scheduled on app startup and after HomeScreen stats refresh"

patterns-established:
  - "Pattern: scheduleAllSmartNotifications() orchestrates all notification types"
  - "Pattern: Cancel notifications when conditions no longer met (prevents stale notifications)"
  - "Pattern: PostFrameCallback for one-time initialization after first frame renders"

# Metrics
duration: 50min
completed: 2026-01-27
---

# Phase 03.5 Plan 03: NotificationScheduler and Wiring Summary

**NotificationScheduler service with condition-based notification scheduling, localized content via AppLocalizations, deep link navigation on tap, provider registration, and HomeScreen integration for complete smart notification system**

## Performance

- **Duration:** 50 min
- **Started:** 2026-01-26T19:26:00Z
- **Completed:** 2026-01-27T10:10:00Z
- **Tasks:** 5
- **Files modified:** 6

## Accomplishments

- **NotificationScheduler service** with condition checking for streak at risk (2+ missed days), progress encouragement (50%+ complete, within 5 of goal), and weekly challenge (Sunday 8:00 AM)
- **AppLocalizations integration** - all notification content retrieved via BuildContext for proper localization (IT/EN)
- **Deep link navigation** - tapping notifications opens correct screen (Home for streak/progress, Statistics for weekly challenge)
- **Provider registration** in main.dart for NotificationScheduler with all dependencies injected
- **HomeScreen triggers** notification scheduling on app startup via post-frame callback
- **Build verification** - APK built successfully (53.1 MB)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create NotificationScheduler service** - `0624e92` (feat)
2. **Task 2: Update NotificationService with deep link handling** - `c3aaeff` (feat)
3. **Task 3: Register providers in main.dart** - `6267cbf` (feat)
4. **Task 4: Add notification triggers to HomeScreen** - `d505ebd` (feat)
5. **Build fixes** - `6b8f8d1` (fix)

**Plan metadata:** (pending final commit)

## Files Created/Modified

### Created
- `push_up_5050/lib/services/notification_scheduler.dart` - Smart notification scheduling with condition checking, localized content, missed days calculation, progress zone detection (50% threshold), and weekly challenge scheduling

### Modified
- `push_up_5050/lib/services/notification_service.dart` - Added NotificationTapCallback typedef, setOnNotificationTapCallback() method, payload parameters to all scheduling methods ('streak_at_risk', 'progress', 'weekly_challenge'), changed const to final for platformDetails
- `push_up_5050/lib/main.dart` - Registered NotificationScheduler provider with NotificationService, NotificationPreferencesProvider, and StorageService dependencies
- `push_up_5050/lib/screens/home/home_screen.dart` - Added _scheduleNotificationsIfNeeded() method called via post-frame callback in initState to trigger notification scheduling on app startup
- `push_up_5050/lib/repositories/storage_service.dart` - Removed goalReached and durationSeconds parameters from DailyRecord constructor (build fix)
- `push_up_5050/lib/widgets/statistics/weekly_challenge_card.dart` - Removed .toString() calls for int parameters in localization (build fix)

## Decisions Made

- **BuildContext for localization**: NotificationScheduler methods receive BuildContext parameter to access AppLocalizations for localized strings. This is necessary because the service layer has no other way to get translations without coupling to specific locales.
- **Direct StorageService access for missed days**: NotificationScheduler calculates consecutive missed days directly from StorageService.loadDailyRecords() instead of using UserStatsProvider. This avoids circular dependencies and keeps the scheduler independent of stats provider logic.
- **Explicit 50% threshold documentation**: Progress notification checkAndScheduleProgress() explicitly documents the halfGoal calculation as `(dailyGoal * 0.5).floor()` to satisfy NOTIF-02 requirement clarity.
- **Deep link routing by payload type**: Notification tap callback routes based on payload string - 'streak_at_risk' and 'progress' navigate to Home (workout screen), 'weekly_challenge' navigates to Statistics (challenge tracking).
- **Cancel when conditions not met**: All notification types cancel existing notifications when conditions no longer apply (e.g., user works out today -> cancel streak warning, outside progress zone -> cancel progress notification). This prevents stale notifications from firing.
- **Sunday 8:00 AM for weekly challenge**: Weekly challenge notification is NOT personalized - always fires at 8:00 AM on Sunday regardless of user's workout patterns. This ensures consistent weekly announcements.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed DailyRecord constructor parameters**
- **Found during:** Build verification (after Task 4)
- **Issue:** DailyRecord constructor was called with goalReached and durationSeconds parameters that don't exist in the model, causing compilation failure
- **Fix:** Removed goalReached and durationSeconds from the constructor call in storage_service.dart
- **Files modified:** push_up_5050/lib/repositories/storage_service.dart
- **Verification:** flutter build apk --release succeeded
- **Committed in:** 6b8f8d1 (build fix commit)

**2. [Rule 1 - Bug] Changed const to final for platformDetails**
- **Found during:** Build verification (after Task 4)
- **Issue:** platformDetails was declared const but NotificationDetails() constructor is not a const constructor, causing compilation error
- **Fix:** Changed const to final in 4 locations within notification_service.dart
- **Files modified:** push_up_5050/lib/services/notification_service.dart
- **Verification:** flutter build apk --release succeeded
- **Committed in:** 6b8f8d1 (build fix commit)

**3. [Rule 1 - Bug] Removed .toString() calls for int parameters**
- **Found during:** Build verification (after Task 4)
- **Issue:** weeklyChallengeTarget() and weeklyChallengeProgress() localization functions expect int parameters directly, but code was calling .toString() on them
- **Fix:** Removed .toString() calls for challengeTarget and weekTotal parameters
- **Files modified:** push_up_5050/lib/widgets/statistics/weekly_challenge_card.dart
- **Verification:** flutter build apk --release succeeded
- **Committed in:** 6b8f8d1 (build fix commit)

---

**Total deviations:** 3 auto-fixed (all Rule 1 - Bug fixes)
**Impact on plan:** All fixes were necessary for compilation - the plan didn't specify these exact implementation details which were discovered during build verification. No scope creep.

## Issues Encountered

- **DailyRecord model mismatch**: The plan's sample code for awarding challenge bonus used goalReached and durationSeconds parameters that don't exist in the actual DailyRecord model. Fixed by removing these non-existent parameters.
- **NotificationDetails not const**: The flutter_local_notifications plugin's NotificationDetails constructor is not const, but plan sample code used const. Fixed by changing to final.
- **Localization parameter types**: ARB files define parameters as int, but code was calling .toString(). Fixed by removing unnecessary string conversion.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- NotificationScheduler complete and wired into app lifecycle
- Deep link navigation functional for all notification types
- Ready for plan 03.5-04 (Notification Settings UI)
- No blockers or concerns

---
*Phase: 03.5-smart-notifications*
*Completed: 2026-01-27*
