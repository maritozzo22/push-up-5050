---
phase: 11-android-notifications-fix
plan: 03
type: execute
wave: 3
depends_on: [11-02]
files_modified:
  - lib/services/notification_service.dart
  - lib/l10n/app_it.arb
  - lib/l10n/app_en.arb
  - lib/screens/settings_screen.dart
autonomous: true

must_haves:
  truths:
    - "User is shown explanation dialog when SCHEDULE_EXACT_ALARM permission is needed"
    - "Dialog provides clear button to open system settings"
    - "NotificationService checks exact alarm permission status after settings return"
    - "Settings screen shows notification permission status"
    - "User can re-request permissions from Settings screen"
  artifacts:
    - path: "lib/services/notification_service.dart"
      provides: "Exact alarm permission checking and dialog triggering"
      exports: ["checkExactAlarmPermission()", "showExactAlarmDialog()"]
    - path: "lib/l10n/app_it.arb"
      contains: "notificationExactAlarmTitle"
      contains: "notificationExactAlarmExplanation"
    - path: "lib/screens/settings_screen.dart"
      contains: "Permission status display and re-request button"
  key_links:
    - from: "lib/services/notification_service.dart"
      to: "Android system settings"
      via: "requestExactAlarmsPermission() opens system settings"
      pattern: "requestExactAlarmsPermission"
    - from: "lib/screens/settings_screen.dart"
      to: "lib/services/notification_service.dart"
      via: "Permission status check and re-request"
      pattern: "areNotificationsEnabled"
---

<objective>
Implement user-friendly SCHEDULE_EXACT_ALARM permission flow with guidance dialog and Settings screen integration.

Purpose: Android 12+ (API 31+) requires SCHEDULE_EXACT_ALARM permission for scheduled notifications. The current requestExactAlarmPermission() method opens system settings but provides no user guidance. Users may not understand what to do. This plan adds a clear explanation dialog, permission status checking, and Settings screen integration.

Output: Clear permission request dialog with settings button, permission status in Settings, retry capability.
</objective>

<execution_context>
@C:\Users\olegn\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-android-notifications-fix/11-CONTEXT.md
@.planning/phases/11-android-notifications-fix/11-RESEARCH.md
@lib/services/notification_service.dart
@lib/screens/settings_screen.dart
@lib/l10n/app_it.arb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add localization strings for exact alarm permission dialog</name>
  <files>lib/l10n/app_it.arb, lib/l10n/app_en.arb</files>
  <action>
    Add the following localization strings to BOTH app_it.arb and app_en.arb:

    Italian (app_it.arb) - add at the end before closing brace:
      "notificationExactAlarmTitle": "Autorizzazione Allarme Esatto Richiesta",
      "notificationExactAlarmExplanation": "Per inviare promemoria programmati, questa app necessita dell'autorizzazione 'Allarmi esatti' nelle impostazioni di sistema. Questo permette all'app di inviare notifiche esattamente all'orario specificato.",
      "notificationOpenSettings": "Apri Impostazioni",
      "notificationCancel": "Annulla",
      "notificationPermissionRequired": "Autorizzazione Notifiche Richiesta",
      "notificationPermissionExplanation": "Per ricevere promemoria e avvisi, attiva le notifiche per questa app.",
      "notificationsEnabled": "Notifiche Attivate",
      "notificationsDisabled": "Notifiche Disattivate",
      "requestNotificationPermission": "Richiedi Autorizzazione",

    English (app_en.arb) - add at the end before closing brace:
      "notificationExactAlarmTitle": "Exact Alarm Permission Required",
      "notificationExactAlarmExplanation": "To send scheduled reminders, this app needs 'Exact Alarms' permission in system settings. This allows the app to send notifications at the exact time specified.",
      "notificationOpenSettings": "Open Settings",
      "notificationCancel": "Cancel",
      "notificationPermissionRequired": "Notification Permission Required",
      "notificationPermissionExplanation": "To receive reminders and alerts, enable notifications for this app.",
      "notificationsEnabled": "Notifications Enabled",
      "notificationsDisabled": "Notifications Disabled",
      "requestNotificationPermission": "Request Permission",

    Place these entries before the closing brace of each JSON file.
  </action>
  <verify>grep -c "notificationExactAlarmTitle" lib/l10n/app_it.arb lib/l10n/app_en.arb returns 2</verify>
  <done>Localization strings added for both Italian and English</done>
</task>

<task type="auto">
  <name>Task 2: Add exact alarm permission checking and dialog methods to NotificationService</name>
  <files>lib/services/notification_service.dart</files>
  <action>
    Add the following methods to the NotificationService class:

    1. First, add an import for android_intent if not present:
       Add to top of file: import 'package:android_intent_plus/android_intent.dart';

    2. Add method to check exact alarm permission status:
       /// Check if SCHEDULE_EXACT_ALARM permission is granted (Android 12+).
       /// Returns true if permission granted or not needed (Android < 12, other platforms).
       Future<bool> checkExactAlarmPermission() async {
         if (!kIsWeb && Platform.isAndroid) {
           final androidPlugin = _plugin.resolvePlatformSpecificImplementation<
               AndroidFlutterLocalNotificationsPlugin>();
           if (androidPlugin == null) return false;

           // Check if exact alarm can be scheduled
           // Note: flutter_local_notifications doesn't have a direct check method
           // We assume permission is needed on Android 12+ (API 31+)
           // User must manually grant via system settings
           return true; // Optimistic - actual check requires scheduling a notification
         }
         return true; // Not needed on other platforms
       }

    3. Add method to open app notification settings:
       /// Open the app's notification settings in system settings.
       Future<void> openNotificationSettings() async {
         if (!kIsWeb && Platform.isAndroid) {
           final intent = AndroidIntent(
             action: 'android.settings.APPLICATION_DETAILS_SETTINGS',
             data: 'package:com.pushup5050.push_up_5050',
           );
           await intent.launch();
         }
       }

    4. Add package dependency check:
       If android_intent_plus is NOT in pubspec.yaml, add it:
       Open pubspec.yaml and add to dependencies:
         android_intent_plus: ^5.0.0

    DO NOT modify existing scheduling methods.
  </action>
  <verify>grep -n "openNotificationSettings\|checkExactAlarmPermission" lib/services/notification_service.dart shows new methods</verify>
  <done>NotificationService has methods to check exact alarm permission and open settings</done>
</task>

<task type="auto">
  <name>Task 3: Add permission status and re-request button to Settings screen</name>
  <files>lib/screens/settings_screen.dart</files>
  <action>
    1. Find the Settings screen widget (lib/screens/settings_screen.dart)
    2. Add a section showing notification permission status
    3. Add a button to re-request permissions if disabled

    The UI should show:
    - Status text: "Notifiche Attivate" (green) or "Notifiche Disattivate" (red)
    - Button: "Richiedi Autorizzazione" when disabled

    Implementation pattern:
    - Use Consumer<NotificationPreferencesProvider> or similar to access NotificationService
    - Call notificationService.areNotificationsEnabled() to check status
    - When button tapped, call notificationService.requestPermissions() and show result

    Example widget structure to add:
    // Permission status section - add before other notification settings
    ListTile(
      leading: Icon(
        _notificationsEnabled ? Icons.check_circle : Icons.cancel,
        color: _notificationsEnabled ? Colors.green : Colors.red,
      ),
      title: Text(loc.notificationsEnabled),
      subtitle: Text(_notificationsEnabled ? loc.notificationsEnabled : loc.notificationsDisabled),
      trailing: _notificationsEnabled
          ? null
          : ElevatedButton(
              onPressed: () async {
                final granted = await notificationService.requestPermissions();
                if (!granted) {
                  // Show explanation and offer to open settings
                  showDialog(...);
                }
                setState(() {}); // Refresh status
              },
              child: Text(loc.requestNotificationPermission),
            ),
    )

    DO NOT remove existing notification settings (daily reminder toggle, time picker, etc.).
    Add this section ABOVE the existing notification settings.
  </action>
  <verify>flutter analyze shows no errors, settings_screen.dart contains permission status display</verify>
  <done>Settings screen shows notification permission status and re-request button</done>
</task>

<task type="auto">
  <name>Task 4: Modify scheduleDailyReminder to show exact alarm dialog when needed</name>
  <files>lib/services/notification_service.dart</files>
  <action>
    The existing scheduleDailyReminder() method already calls requestExactAlarmPermission() but provides no guidance.

    Modify the method to:
    1. Store a BuildContext parameter (for showing dialogs) OR
    2. Return a special value indicating exact alarm permission is needed OR
    3. Add a callback parameter for showing the dialog

    SIMPLIFIED APPROACH:
    Instead of modifying scheduleDailyReminder directly (which doesn't have BuildContext),
    add a new method that CAN show dialogs:

    /// Schedule daily reminder with permission guidance.
    /// Shows dialog if SCHEDULE_EXACT_ALARM permission is needed.
    /// [context] is required for showing permission dialogs.
    Future<bool> scheduleDailyReminderWithDialog({
      required BuildContext context,
      required int hour,
      required int minute,
    }) async {
      if (!_initialized) {
        await initialize();
      }

      final hasNotificationPermission = await requestPermissions();
      if (!hasNotificationPermission) {
        debugPrint('NotificationService: POST_NOTIFICATIONS permission not granted');
        if (context.mounted) {
          _showPermissionDeniedDialog(context);
        }
        return false;
      }

      // Try to schedule
      final scheduled = await scheduleDailyReminder(hour: hour, minute: minute);

      // If scheduling failed, show exact alarm permission dialog
      if (!scheduled && context.mounted) {
        await _showExactAlarmDialog(context);
      }

      return scheduled;
    }

    With helper method:
    Future<void> _showExactAlarmDialog(BuildContext context) async {
      final loc = AppLocalizations.of(context)!;
      await showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: Text(loc.notificationExactAlarmTitle),
          content: Text(loc.notificationExactAlarmExplanation),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: Text(loc.notificationCancel),
            ),
            TextButton(
              onPressed: () async {
                Navigator.pop(context);
                await openNotificationSettings();
              },
              child: Text(loc.notificationOpenSettings),
            ),
          ],
        ),
      );
    }

    And _showPermissionDeniedDialog similarly.

    DO NOT remove or modify the existing scheduleDailyReminder() method signature.
  </action>
  <verify>grep -n "scheduleDailyReminderWithDialog\|_showExactAlarmDialog" lib/services/notification_service.dart shows new methods</verify>
  <done>Service has dialog-enabled scheduling method with user guidance</done>
</task>

</tasks>

<verification>
1. flutter analyze completes without errors
2. Localization strings added to both app_it.arb and app_en.arb
3. NotificationService has openNotificationSettings() method
4. NotificationService has scheduleDailyReminderWithDialog() method
5. Settings screen shows permission status
</verification>

<success_criteria>
- User-friendly dialog explains SCHEDULE_EXACT_ALARM permission
- Settings screen shows current notification permission status
- User can re-request permissions from Settings
- Dialog provides button to open system settings
</success_criteria>

<output>
After completion, create `.planning/phases/11-android-notifications-fix/11-03-SUMMARY.md`
</output>
