---
phase: 11-android-notifications-fix
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - lib/services/notification_service.dart
  - lib/main.dart
autonomous: true

must_haves:
  truths:
    - "POST_NOTIFICATIONS permission is requested on app startup (Android 13+)"
    - "Permission request status is tracked and cached"
    - "NotificationService has method to check if notifications are enabled"
    - "App initializes notification service and requests permissions on first launch"
  artifacts:
    - path: "lib/services/notification_service.dart"
      provides: "Permission checking and caching"
      contains: "areNotificationsEnabled()"
      exports: ["requestPermissions()", "areNotificationsEnabled()"]
    - path: "lib/main.dart"
      contains: "NotificationService initialization on startup"
  key_links:
    - from: "lib/main.dart"
      to: "lib/services/notification_service.dart"
      via: "Initialize and request permissions on app startup"
      pattern: "notificationService\\.initialize\\(\\)"
---

<objective>
Implement POST_NOTIFICATIONS permission request on app startup and add permission status checking.

Purpose: Android 13+ (API 33+) requires runtime POST_NOTIFICATIONS permission. Currently, the permission is only requested when scheduling notifications, which is too late. The permission should be requested on app startup so the user is prompted early, and the status should be cached to avoid repeated prompts.

Output: App requests POST_NOTIFICATIONS permission on startup and caches permission status.
</objective>

<execution_context>
@C:\Users\olegn\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-android-notifications-fix/11-CONTEXT.md
@.planning/phases/11-android-notifications-fix/11-RESEARCH.md
@lib/services/notification_service.dart
@lib/main.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add permission status caching to NotificationService</name>
  <files>lib/services/notification_service.dart</files>
  <action>
    1. Add a private field to cache permission status:
       bool? _cachedPermissionStatus;

    2. Modify the existing requestPermissions() method to cache the result:
       After line 91 (final result = await androidPlugin.requestNotificationsPermission();), add:
       _cachedPermissionStatus = result ?? false;

       Also add caching for iOS after line 104:
       _cachedPermissionStatus = result ?? false;

    3. Add a new public method to check if notifications are enabled (for UI to show status):
       /// Check if notifications are enabled without requesting permission.
       /// Returns cached status or checks system if not cached.
       Future<bool> areNotificationsEnabled() async {
         if (_cachedPermissionStatus != null) return _cachedPermissionStatus!;

         if (!kIsWeb && Platform.isAndroid) {
           final androidPlugin = _plugin.resolvePlatformSpecificImplementation<
               AndroidFlutterLocalNotificationsPlugin>();
           if (androidPlugin == null) return false;
           return await androidPlugin.areNotificationsEnabled() ?? false;
         }

         if (!kIsWeb && Platform.isIOS) {
           final iosPlugin = _plugin.resolvePlatformSpecificImplementation<
               IOSFlutterLocalNotificationsPlugin>();
           if (iosPlugin == null) return false;
           // iOS doesn't have a direct check, assume true if initialized
           return true;
         }

         return true; // Default for other platforms
       }

    DO NOT modify existing notification scheduling methods.
  </action>
  <verify>grep -n "_cachedPermissionStatus" lib/services/notification_service.dart shows the new field and usage</verify>
  <done>Permission status is cached and can be checked without prompting user</done>
</task>

<task type="auto">
  <name>Task 2: Initialize NotificationService and request permissions on app startup</name>
  <files>lib/main.dart</files>
  <action>
    1. Find the main() function in lib/main.dart
    2. After the runApp() call, add initialization logic for notifications

    The initialization should:
    - Create an instance of NotificationService (if not already using provider)
    - Call initialize() method
    - Call requestPermissions() method on Android/iOS

    If the app already has a NotificationService instance (check for existing code), add the permission request there.

    Example pattern to add:
    final notificationService = NotificationService();
    await notificationService.initialize();
    await notificationService.requestPermissions();

    IMPORTANT: Do this INSIDE the runApp() or in the first widget's initState(), NOT before runApp() because NotificationService uses Platform.isAndroid which requires Widgets binding.

    If the app uses Provider for NotificationService, ensure it's initialized early.

    DO NOT create a new NotificationService if one already exists via Provider.
  </action>
  <verify>flutter analyze shows no errors, main.dart contains notification initialization and permission request</verify>
  <done>App requests POST_NOTIFICATIONS permission on first launch (Android 13+)</done>
</task>

</tasks>

<verification>
1. flutter analyze completes without errors
2. NotificationService has _cachedPermissionStatus field
3. NotificationService has areNotificationsEnabled() method
4. main.dart initializes NotificationService and calls requestPermissions()
</verification>

<success_criteria>
- POST_NOTIFICATIONS permission requested on app startup
- Permission status cached to avoid repeated prompts
- areNotificationsEnabled() method available for UI to check status
</success_criteria>

<output>
After completion, create `.planning/phases/11-android-notifications-fix/11-02-SUMMARY.md`
</output>
