---
phase: 03.3-weekly-goals
plan: 01
subsystem: data
tags: [weekly-state, streak, storage-service, provider]

# Dependency graph
requires:
  - phase: 03.2-enhanced-points-anticheat
    provides: points system foundation
provides:
  - Week calculation utilities (getWeekStart, getWeekNumber)
  - Weekly review flag tracking (hasWeeklyReviewBeenShown, markWeeklyReviewShown)
  - Weekly bonus flag tracking (hasWeeklyBonusBeenAwarded, markWeeklyBonusAwarded)
  - Weekly streak calculation (calculateWeeklyStreak)
  - weeklyStreak getter in UserStatsProvider
affects: [weekly-review-popup, weekly-bonus-award]

# Tech tracking
tech-stack:
  added: []
  patterns: [weekly-state-persistence, monday-week-boundaries, flag-based-popup-tracking]

key-files:
  created: []
  modified:
    - push_up_5050/lib/repositories/storage_service.dart
    - push_up_5050/lib/providers/user_stats_provider.dart

key-decisions:
  - "Week boundaries: Monday 00:00:00 to Sunday 23:59:59 (ISO week standard)"
  - "Week number format: 'YYYY-WW' for unique storage keys"
  - "Separate flags for review popup vs bonus award (independent tracking)"
  - "Weekly streak: any push-ups (>0) counts, not full 7 days required"

patterns-established:
  - "Pattern: Weekly state methods in StorageService 'Weekly State' section"
  - "Pattern: Flag-based tracking using _prefs.getBool() with null-coalescing default"
  - "Pattern: Week calculation using DateTime.weekday (1=Mon, 7=Sun)"

# Metrics
duration: 6min
completed: 2026-01-25
---

# Phase 03.3 Plan 01: Weekly State Tracking Infrastructure Summary

**Week calculation utilities, flag-based popup/bonus tracking, and weekly streak calculation using Monday-Sunday week boundaries**

## Performance

- **Duration:** 6 min
- **Started:** 2026-01-25T14:56:50Z
- **Completed:** 2026-01-25T15:02:26Z
- **Tasks:** 2 (combined into 2 commits)
- **Files modified:** 2

## Accomplishments

- **Week utilities:** getWeekStart() returns Monday of any date; getWeekNumber() returns "YYYY-WW" format
- **Flag tracking:** Weekly review popup and bonus award status tracked separately with simple bool flags
- **Weekly streak:** Calculates consecutive weeks with any push-ups (>0), counting backwards from current week
- **Provider integration:** weeklyStreak getter exposed via UserStatsProvider to UI

## Task Commits

Each task was committed atomically:

1. **Task 1-3: Weekly state tracking in StorageService** - `0869088` (feat)
   - Week calculation utilities (getWeekStart, getWeekNumber)
   - Flag tracking methods (hasWeeklyReviewBeenShown, markWeeklyReviewShown, hasWeeklyBonusBeenAwarded, markWeeklyBonusAwarded)
   - Weekly streak calculation (calculateWeeklyStreak)

2. **Task 4: Weekly streak in UserStatsProvider** - `aa077b4` (feat)
   - _weeklyStreak private field
   - weeklyStreak public getter
   - Load in loadStats() method

**Plan metadata:** (pending STATE.md commit)

## Files Created/Modified

- `push_up_5050/lib/repositories/storage_service.dart` - Added "Weekly State" section with 6 methods for week calculation, flag tracking, and streak
- `push_up_5050/lib/providers/user_stats_provider.dart` - Added weeklyStreak field, getter, and loading

## Decisions Made

1. **Monday week boundaries** - Used DateTime.weekday (1=Mon, 7=Sun) for consistent ISO week calculation
2. **Separate flags for review vs bonus** - Review popup status and bonus award status tracked independently (user may see review but not earn bonus)
3. **Any push-ups counts for weekly streak** - Unlike daily streak which requires >=50 push-ups, weekly streak counts ANY activity (>0) to encourage consistency
4. **No intl package** - Used built-in DateTime APIs only for week calculation (no external dependencies)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all code compiled and tests passed on first attempt.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Weekly state infrastructure complete
- Ready for weekly goals review popup implementation (next plan)
- Ready for weekly bonus award logic
- No blockers or concerns

---
*Phase: 03.3-weekly-goals*
*Completed: 2026-01-25*
