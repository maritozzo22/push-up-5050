---
phase: 03.3-weekly-goals
plan: 04
type: execute
wave: 4
depends_on: ["03.3-01", "03.3-02", "03.3-03"]
files_modified:
  - push_up_5050/lib/screens/home/home_screen.dart
  - push_up_5050/lib/main.dart
autonomous: true

must_haves:
  truths:
    - "Weekly review popup appears when app opens on Sunday"
    - "Weekly review popup appears immediately when weekly target is reached (before Sunday)"
    - "Popup shows only once per week (flag tracking prevents duplicates)"
    - "Popup cannot be dismissed without selecting an option"
    - "Bonus points are awarded when popup shows for achieved targets"
  artifacts:
    - path: "push_up_5050/lib/screens/home/home_screen.dart"
      provides: "Weekly review trigger logic"
      contains: "_checkAndShowWeeklyReview", "_weeklyReviewChecked"
    - path: "push_up_5050/lib/main.dart"
      provides: "WeeklyReviewProvider registration"
      contains: "ChangeNotifierProvider", "WeeklyReviewProvider"
  key_links:
    - from: "lib/screens/home/home_screen.dart"
      to: "lib/repositories/storage_service.dart"
      via: "hasWeeklyReviewBeenShown(), getWeekNumber()"
      pattern: "_storage.hasWeeklyReviewBeenShown\\(|_storage.getWeekNumber\\("
    - from: "lib/screens/home/home_screen.dart"
      to: "lib/widgets/weekly/weekly_review_popup.dart"
      via: "showDialog()"
      pattern: "showDialog\\(WeeklyReviewPopup"
    - from: "lib/screens/home/home_screen.dart"
      to: "lib/providers/weekly_review_provider.dart"
      via: "context.read<WeeklyReviewProvider>()"
      pattern: "context.read<WeeklyReviewProvider>"
---

<objective>
Integrate weekly review popup trigger into HomeScreen with one-time flag protection and Sunday/early-achievement detection. Register WeeklyReviewProvider in main app.
</objective>

<execution_context>
@C:\Users\olegn\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-weekly-goals/03.3-CONTEXT.md
@.planning/phases/03.3-weekly-goals/03.3-RESEARCH.md
@.planning/phases/03.3-weekly-goals/03.3-01-SUMMARY.md
@.planning/phases/03.3-weekly-goals/03.3-02-SUMMARY.md
@.planning/phases/03.3-weekly-goals/03.3-03-SUMMARY.md

# Existing patterns:
- HomeScreen initState() with addPostFrameCallback for stats loading
- Provider registration in main.dart (MultiProvider)
- showDialog pattern used in settings_screen.dart
- AchievementPopup integration in WorkoutExecutionScreen
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register WeeklyReviewProvider in main.dart</name>
  <files>push_up_5050/lib/main.dart</files>
<action>
Add WeeklyReviewProvider to MultiProvider in main.dart:

1. **Add import** at top with other provider imports:
   ```dart
   import 'package:push_up_5050/providers/weekly_review_provider.dart';
   ```

2. **Add to MultiProvider** (after other providers, before closing):
   ```dart
   ChangeNotifierProvider(
     create: (context) => WeeklyReviewProvider(
       storage: context.read<StorageService>(),
     ),
   ),
   ```

Place it after GoalsProvider or at the end of the providers list.
The provider needs StorageService from context, which should already be registered.

DO NOT:
- Create a new StorageService instance (use from context)
- Add any initialization logic (provider initializes on first use)
- Place before StorageService registration
  </action>
  <verify>
Run: flutter analyze
Run: flutter run -d windows (quick smoke test)
  </verify>
  <done>
WeeklyReviewProvider registered:
- Import added
- ChangeNotifierProxyProvider or ChangeNotifierProvider added
- Gets StorageService from context
- App compiles and runs
  </done>
</task>

<task type="auto">
  <name>Task 2: Add weekly review trigger to HomeScreen</name>
  <files>push_up_5050/lib/screens/home/home_screen.dart</files>
<action>
Add weekly review popup trigger to HomeScreen:

1. **Add imports** at top with other imports:
   ```dart
   import 'package:push_up_5050/providers/weekly_review_provider.dart';
   import 'package:push_up_5050/widgets/weekly/weekly_review_popup.dart';
   import 'package:push_up_5050/repositories/storage_service.dart';
   ```

2. **Add state flag** in _HomeScreenState (after class declaration):
   ```dart
   bool _weeklyReviewChecked = false;
   ```

3. **Add weekly review check method** in _HomeScreenState:
   ```dart
   Future<void> _checkAndShowWeeklyReview(BuildContext context) async {
     final storage = context.read<StorageService>();
     final stats = context.read<UserStatsProvider>();
     final goals = context.read<GoalsProvider>();
     final reviewProvider = context.read<WeeklyReviewProvider>();

     final now = DateTime.now();
     final weekNumber = storage.getWeekNumber(now);
     final isSunday = now.weekday == 7; // 7 = Sunday

     // Check if review already shown for this week
     if (await storage.hasWeeklyReviewBeenShown(weekNumber)) {
       return;
     }

     // Get weekly progress
     final weeklyTotal = stats.weekTotal;
     final weeklyTarget = goals.weeklyTarget;
     final targetReached = weeklyTotal >= weeklyTarget;

     // Trigger if Sunday OR target reached early
     if (isSunday || targetReached) {
       // Load data into provider
       await reviewProvider.loadWeeklyData(weeklyTotal, weeklyTarget);

       // Award bonus if target reached and not yet awarded
       if (targetReached && !(await storage.hasWeeklyBonusBeenAwarded(weekNumber))) {
         await reviewProvider.awardWeeklyBonus(weekNumber);
       }

       // Show popup
       if (context.mounted) {
         await showDialog(
           context: context,
           barrierDismissible: false,
           builder: (dialogContext) => ChangeNotifierProvider.value(
             value: reviewProvider,
             child: WeeklyReviewPopup(
               onDismiss: () {
                 // Mark review as shown
                 storage.markWeeklyReviewShown(weekNumber);
               },
             ),
           ),
         );
       }
     }
   }
   ```

4. **Call in initState** after existing stats loading (modify existing postFrameCallback):
   ```dart
   @override
   void initState() {
     super.initState();
     WidgetsBinding.instance.addPostFrameCallback((_) async {
       final statsContext = context;
       if (statsContext.mounted) {
         await statsContext.read<UserStatsProvider>().loadStats();
         await statsContext.read<GoalsProvider>().loadGoals();

         // Check weekly review after stats loaded
         if (!_weeklyReviewChecked) {
           _weeklyReviewChecked = true;
           await _checkAndShowWeeklyReview(statsContext);
         }
       }
     });
   }
   ```

DO NOT:
- Call weekly review check before stats are loaded
- Set barrierDismissible to true (must be mandatory)
- Allow multiple popups per week (flag check prevents this)
- Show popup before Sunday UNLESS target reached
  </action>
  <verify>
Run: flutter analyze
Run: flutter test (home screen tests if any)
  </verify>
  <done>
Weekly review trigger added:
- _checkAndShowWeeklyReview() method
- One-time flag _weeklyReviewChecked
- Called in initState after stats loaded
- Triggers on Sunday OR when target reached
- Uses ChangeNotifierProvider.value for popup
  </done>
</task>

<task type="auto">
  <name>Task 3: Update existing streak calculation to use weekly streak</name>
  <files>push_up_5050/lib/screens/home/home_screen.dart</files>
<action>
Update HomeScreen to display weekly streak from UserStatsProvider:

Locate where streak is displayed (likely in profile section or mini stats) and add weekly streak display:

1. **Add weekly streak display** alongside existing daily streak:
   - If there's a streak card/mini stat, add a second one for weekly
   - Or add weekly streak to existing streak display

Example (adjust based on actual screen structure):
```dart
// If you have a streak display like this:
Text('${stats.currentStreak} giorni')

// Add weekly streak nearby or create combined display:
Row(
  children: [
    Text('Giorno: ${stats.currentStreak}'),
    SizedBox(width: 16),
    Text('Settimana: ${stats.weeklyStreak}'),
  ],
)
```

Or as a mini stat card if that pattern exists:
```dart
MiniStat(
  label: 'STREEGHINA',
  value: '${stats.weeklyStreak}',
  icon: Icons.local_fire_department,
)
```

The exact placement depends on the current HomeScreen layout.
Use existing UI patterns (MiniStat, FrostCard, etc.).

DO NOT:
- Remove daily streak display (show both)
- Create new custom widgets (use existing patterns)
- Hardcode values (use stats.weeklyStreak getter)
  </action>
  <verify>
Run: flutter analyze
Run: flutter run -d windows (visual check)
  </verify>
  <done>
Weekly streak displayed:
- Shows alongside daily streak
- Uses existing UI patterns
- Updates when stats refresh
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- flutter analyze passes
- App runs without crashes
- Weekly review popup shows on Sunday
- Weekly review popup shows when target reached early
- Popup only shows once per week
- Weekly streak displays in UI
</verification>

<success_criteria>
1. WeeklyReviewProvider registered in main.dart
2. HomeScreen triggers weekly review check on load
3. Popup appears on Sunday OR when weekly target reached
4. Flag system prevents duplicate popups
5. Weekly streak visible in UI
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-weekly-goals/03.3-04-SUMMARY.md`
</output>
