# Phase 03.3: Weekly Goals System - Research

**Researched:** 2026-01-25
**Domain:** Flutter state management, modal dialogs, week-based calculations, persistence
**Confidence:** HIGH

## Summary

This phase implements a weekly goals review system with Sunday popup, bonus points for weekly target achievement, and dynamic goal adjustment (increase/decrease) based on performance. The key technical challenges are: (1) implementing a mandatory modal popup that triggers on app open, (2) calculating weekly progress across week boundaries, (3) modifying streak logic for weekly preservation, and (4) persisting weekly review state.

The existing codebase has strong foundations for this feature:
- `UserStatsProvider` already computes `weekTotal`, `weekProgress`, `weekSeries` (Monday-Sunday)
- `StorageService` provides `calculateCurrentStreak()` that can be modified
- `AchievementPopup` pattern can be adapted for the weekly review modal
- `Goal` model and `GoalsProvider` already support weekly goals

**Primary recommendation:** Leverage existing patterns - create `WeeklyReviewPopup` as a mandatory `showDialog` modal triggered by `HomeScreen.initState()`, add a flag-based tracking system to prevent duplicate popups, and extend `StorageService` with weekly state persistence.

## Standard Stack

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Flutter SDK | 3.27+ | UI framework, showDialog API | Built-in modal dialogs, Material Design |
| Provider | ^6.1.2 | State management | Already used throughout app for providers |
| shared_preferences | ^2.3.3 | Persistence | Already used in StorageService |

### Supporting

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| intl | ^0.19.0 | Date formatting, week calculation | Use `DateTime.weekday` (Mon=1, Sun=7) |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| showDialog | Custom overlay widget | showDialog is simpler, handles back button automatically, follows Material patterns |
| SharedPreferences | Hive/Isar | Overkill for simple flag storage; SharedPreferences sufficient |

## Architecture Patterns

### Recommended Project Structure

```
push_up_5050/lib/
├── widgets/
│   └── weekly/
│       ├── weekly_review_popup.dart      # NEW: Mandatory modal for Sunday review
│       └── weekly_goal_option_card.dart  # NEW: Goal adjustment option widget
├── providers/
│   └── weekly_review_provider.dart       # NEW: Weekly review state and logic
├── repositories/
│   └── storage_service.dart              # MODIFY: Add weekly review methods
├── models/
│   └── weekly_progress.dart              # NEW: Weekly stats model
└── screens/
    └── home/
        └── home_screen.dart              # MODIFY: Trigger weekly review check
```

### Pattern 1: Mandatory Modal Dialog

**What:** A `showDialog` modal that cannot be dismissed by tapping outside (barrierDismissible: false).

**When to use:** When user MUST make a selection before continuing.

**Example:**
```dart
// From existing settings_screen.dart - AlertDialog pattern
showDialog(
  context: context,
  barrierDismissible: false,  // MANDATORY - user must select
  builder: (dialogContext) => AlertDialog(
    backgroundColor: const Color(0xFF1A1F28),
    shape: RoundedRectangleBorder(
      borderRadius: BorderRadius.circular(20),
    ),
    content: WeeklyReviewContent(...),
    actions: [
      // Option buttons - user MUST click one
    ],
  ),
);
```

### Pattern 2: One-Time Trigger with Flag Persistence

**What:** Use a stored flag to ensure popup shows only once per week.

**When to use:** Preventing duplicate notifications while ensuring weekly review always triggers.

**Example:**
```dart
// In StorageService
static const String _keyWeeklyReviewShown = 'weekly_review_shown';

Future<bool> hasWeeklyReviewBeenShown(int weekNumber) async {
  final key = '$_keyWeeklyReviewShown_$weekNumber';
  return _prefs.getBool(key) ?? false;
}

Future<void> markWeeklyReviewShown(int weekNumber) async {
  final key = '$_keyWeeklyReviewShown_$weekNumber';
  await _prefs.setBool(key, true);
}
```

### Pattern 3: Week Number Calculation

**What:** Calculate ISO week number for weekly tracking.

**When to use:** Identifying unique weeks for flag-based tracking.

**Example:**
```dart
// Utility function for week number
int getWeekNumber(DateTime date) {
  final dayOfYear = int.parse(DateFormat('D').format(date));
  final weekNumber = ((dayOfYear - date.weekday + 10) / 7).floor();
  return weekNumber;
}
```

### Anti-Patterns to Avoid

- **Tapping outside to dismiss:** Always set `barrierDismissible: false` for mandatory reviews
- **Notification-based trigger:** Don't use local notifications - CONTEXT.md specifies "auto-show when user opens app on Sunday"
- **Sunday-only check:** Check for early achievement - popup can show mid-week if target reached
- **Daily streak logic:** Don't reuse existing daily streak - weekly preservation requires separate tracking

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Modal dialogs | Custom overlay with animations | `showDialog()` + `AlertDialog` | Built-in handles back button, focus, accessibility |
| Date/week math | Manual day-of-week calculations | `DateTime.weekday` | ISO standard (Mon=1, Sun=7), handles edge cases |
| Flag persistence | Complex state machines | `SharedPreferences` bool flags | Simple, atomic, already used in StorageService |

**Key insight:** Flutter's `showDialog` already provides 90% of what's needed for mandatory modals. Don't reinvent modal behavior.

## Common Pitfalls

### Pitfall 1: Popup Triggers Multiple Times

**What goes wrong:** Popup shows every time HomeScreen builds, creating infinite dialog stack.

**Why it happens:** initState() runs on every state rebuild if not guarded properly.

**How to avoid:** Use a one-time flag + async guard:

```dart
bool _hasCheckedWeeklyReview = false;

@override
void initState() {
  super.initState();
  WidgetsBinding.instance.addPostFrameCallback((_) async {
    if (_hasCheckedWeeklyReview) return;
    _hasCheckedWeeklyReview = true;
    await _checkAndShowWeeklyReview(context);
  });
}
```

**Warning signs:** Dialog appears multiple times, app becomes unresponsive, console shows "duplicate showDialog call".

### Pitfall 2: Week Boundary Calculation Errors

**What goes wrong:** Week calculation fails at month/year boundaries (e.g., Dec 31 - Jan 1).

**Why it happens:** Using month/day arithmetic instead of week numbers.

**How to avoid:** Use ISO week number calculation or DateTime.weekday consistently:

```dart
// CORRECT: Calculate week start (Monday) for any date
DateTime getWeekStart(DateTime date) {
  final dayOfWeek = date.weekday; // 1=Mon, 7=Sun
  return date.subtract(Duration(days: dayOfWeek - 1));
}
```

**Warning signs:** Weekly total incorrect on Sundays, week resets incorrectly at month boundaries.

### Pitfall 3: Streak Resets Despite Activity

**What goes wrong:** User does push-ups 6 days a week, but streak still resets on Sunday.

**Why it happens:** Reusing daily streak logic that requires consecutive days.

**How to avoid:** Separate weekly streak logic from daily streak:

```dart
// NEW: Weekly streak - any activity in week preserves streak
Future<int> calculateWeeklyStreak() async {
  final records = await loadDailyRecords();
  final now = DateTime.now();
  int streak = 0;

  // Check each week going backwards
  for (int weekOffset = 0; weekOffset < 52; weekOffset++) {
    final weekStart = getWeekStart(now).subtract(Duration(days: weekOffset * 7));
    bool anyActivity = false;

    // Check Mon-Sun for any push-ups
    for (int day = 0; day < 7; day++) {
      final date = weekStart.add(Duration(days: day));
      final key = _formatDate(date);
      if (records.containsKey(key)) {
        final recordData = records[key] as Map<String, dynamic>;
        if ((recordData['totalPushups'] as int) > 0) {
          anyActivity = true;
          break;
        }
      }
    }

    if (anyActivity) {
      streak++;
    } else {
      break; // No activity in this week - streak broken
    }
  }

  return streak;
}
```

**Warning signs:** Users complain streak is unfair, streak counter decreases unexpectedly.

### Pitfall 4: Early Achievement Not Triggering Popup

**What goes wrong:** User reaches weekly target on Wednesday, but popup doesn't appear until Sunday.

**Why it happens:** Only checking for Sunday day-of-week.

**How to avoid:** Check both conditions - Sunday OR weekly target reached:

```dart
Future<void> _checkAndShowWeeklyReview(BuildContext context) async {
  final now = DateTime.now();
  final weeklyProgress = context.read<UserStatsProvider>().weekTotal;
  final weeklyTarget = context.read<GoalsProvider>().weeklyGoal.target;
  final isSunday = now.weekday == 7;
  final targetReached = weeklyProgress >= weeklyTarget;

  if (isSunday || targetReached) {
    await _checkAndShowReviewIfNeeded(context);
  }
}
```

**Warning signs:** Users reach goal early but no feedback, popup only appears on Sunday.

## Code Examples

### Weekly Review Popup Structure

```dart
// lib/widgets/weekly/weekly_review_popup.dart
class WeeklyReviewPopup extends StatelessWidget {
  final int weeklyTotal;
  final int weeklyTarget;
  final bool targetReached;
  final Function(GoalAdjustment) onGoalSelected;

  const WeeklyReviewPopup({
    required this.weeklyTotal,
    required this.weeklyTarget,
    required this.targetReached,
    required this.onGoalSelected,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    final progress = (weeklyTotal / weeklyTarget).clamp(0.0, 1.0);

    return AlertDialog(
      backgroundColor: const Color(0xFF1A1F28),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      contentPadding: const EdgeInsets.all(24),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // Title
          Text(
            targetReached
                ? l10n.weeklyTargetAchieved
                : l10n.weeklyReview,
            style: const TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.w900,
              color: Colors.white,
            ),
          ),
          const SizedBox(height: 16),
          // Progress bar
          _buildProgressBar(progress),
          const SizedBox(height: 16),
          // Stats
          Text(
            '$weeklyTotal / $weeklyTarget',
            style: const TextStyle(
              fontSize: 32,
              fontWeight: FontWeight.w700,
              color: Color(0xFFFFB347),
            ),
          ),
          const SizedBox(height: 8),
          Text(
            '${(progress * 100).toInt()}%',
            style: const TextStyle(
              fontSize: 16,
              color: Colors.white70,
            ),
          ),
          // Bonus points notice if achieved
          if (targetReached) ...[
            const SizedBox(height: 16),
            _buildBonusNotice(l10n),
          ],
          const SizedBox(height: 24),
          // Goal adjustment options
          ..._buildGoalOptions(context, targetReached),
        ],
      ),
    );
  }
}
```

### Bonus Points Calculation

```dart
// In StorageService or Calculator
Future<void> awardWeeklyBonus(int weekNumber, int weeklyTotal, int weeklyTarget) async {
  final baseBonus = 500; // Base bonus for reaching target
  int bonus = baseBonus;

  if (weeklyTotal > weeklyTarget) {
    // Scaled bonus for overachievement
    final excess = weeklyTotal - weeklyTarget;
    final excessBonus = (excess * 0.5).floor(); // 0.5 points per excess pushup
    bonus += excessBonus;
  }

  // Add bonus to today's record (or create new one)
  final today = DateTime.now();
  final existingRecord = await getDailyRecord(today);

  final updatedRecord = DailyRecord(
    date: today,
    totalPushups: existingRecord?.totalPushups ?? 0,
    seriesCompleted: existingRecord?.seriesCompleted ?? 0,
    pointsEarned: (existingRecord?.pointsEarned ?? 0) + bonus,
  );

  await saveDailyRecord(updatedRecord);
  await markWeeklyBonusAwarded(weekNumber);
}
```

### Goal Adjustment with Preview

```dart
enum GoalAdjustment {
  maintain,
  increase10,
  increase20,
  decrease10,
  decrease20,
  decrease30,
}

String calculateTimeToGoal(int currentDailyGoal, GoalAdjustment adjustment) {
  final newGoal = _calculateNewGoal(currentDailyGoal, adjustment);
  final remainingPushups = 5050 - 0; // Would fetch actual total
  final daysNeeded = (remainingPushups / newGoal).ceil();
  final monthsNeeded = (daysNeeded / 30).ceil();

  return monthsNeeded <= 1
      ? 'about ${monthsNeeded} month'
      : 'about $monthsNeeded months';
}

int _calculateNewGoal(int currentGoal, GoalAdjustment adjustment) {
  switch (adjustment) {
    case GoalAdjustment.maintain:
      return currentGoal;
    case GoalAdjustment.increase10:
      return (currentGoal * 1.1).floor();
    case GoalAdjustment.increase20:
      return (currentGoal * 1.2).floor();
    case GoalAdjustment.decrease10:
      return (currentGoal * 0.9).floor();
    case GoalAdjustment.decrease20:
      return (currentGoal * 0.8).floor();
    case GoalAdjustment.decrease30:
      return (currentGoal * 0.7).floor();
  }
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Daily streak only | Weekly streak preservation | Phase 03.3 | User progress less punishing |
| Fixed goals | Dynamic goal adjustment | Phase 03.3 | Goals adapt to user ability |
| No weekly feedback | Weekly review popup | Phase 03.3 | Better engagement, motivation |

**Key insight:** Weekly systems reduce "all-or-nothing" pressure of daily goals while maintaining consistency motivation.

## Open Questions

1. **Overachievement bonus formula**
   - What we know: Base 500 points + scaled bonus for excess
   - What's unclear: Exact scaling rate (0.5x per excess pushup?)
   - Recommendation: Use 0.5 points per excess pushup, cap at 250 bonus points (total 750 max)

2. **Goal adjustment bounds**
   - What we know: Need minimum/maximum limits for goal changes
   - What's unclear: Specific bounds (e.g., minimum 30, maximum 100?)
   - Recommendation: Min 30 (beginners), Max 100 (advanced), enforce in adjustment calculation

3. **Weekly bonus timing**
   - What we know: Award when popup shows
   - What's unclear: Should bonus show in today's points or separately?
   - Recommendation: Add to today's DailyRecord.pointsEarned, show "+500 bonus" notice in popup

## Sources

### Primary (HIGH confidence)

- **Existing codebase analysis:**
  - `UserStatsProvider` - Weekly calculation methods verified
  - `StorageService` - Persistence patterns verified
  - `AchievementPopup` - UI pattern for slide-in notifications
  - `settings_screen.dart` - AlertDialog pattern with `barrierDismissible: false`

- **Flutter documentation:**
  - showDialog API - Modal dialog behavior, barrierDismissible
  - DateTime.weekday - ISO week day values (Mon=1, Sun=7)

### Secondary (MEDIUM confidence)

- CONTEXT.md for Phase 03.3 - User decisions and requirements
- CLAUDE.md - Project architecture and testing approach

### Tertiary (LOW confidence)

None - all findings based on existing codebase patterns.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Based on existing dependencies in pubspec.yaml
- Architecture: HIGH - Based on existing provider pattern and widget structure
- Pitfalls: HIGH - Based on common Flutter dialog mistakes and week calculation edge cases

**Research date:** 2026-01-25
**Valid until:** 30 days (stable API, no major changes expected)

## Implementation Checklist

From research findings, key implementation tasks:

1. **Create `WeeklyReviewPopup` widget**
   - AlertDialog with barrierDismissible: false
   - Progress bar, stats display, bonus notice
   - Goal adjustment option buttons

2. **Create `WeeklyReviewProvider`**
   - Weekly progress calculation (leverage existing UserStatsProvider methods)
   - Weekly streak calculation (separate from daily)
   - Bonus points calculation and storage

3. **Extend `StorageService`**
   - `getWeekStart()` / `getWeekNumber()` utilities
   - `hasWeeklyReviewBeenShown()` / `markWeeklyReviewShown()`
   - `hasWeeklyBonusBeenAwarded()` / `awardWeeklyBonus()`
   - `calculateWeeklyStreak()` new method
   - Save/load weekly goal adjustment history

4. **Modify `HomeScreen`**
   - Add weekly review check in initState()
   - Trigger popup on Sunday OR when weekly target reached
   - Prevent duplicate triggers with one-time flag

5. **Add i18n strings** (app_it.arb, app_en.arb)
   - Weekly review titles, descriptions
   - Goal adjustment option labels
   - Bonus points messages

6. **Write tests** (TDD approach)
   - Weekly number calculation edge cases
   - Weekly streak with partial activity
   - Popup trigger conditions (Sunday, early achievement)
   - Bonus points calculation
   - Goal adjustment bounds enforcement
