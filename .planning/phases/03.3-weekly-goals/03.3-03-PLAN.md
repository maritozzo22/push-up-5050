---
phase: 03.3-weekly-goals
plan: 03
type: execute
wave: 3
depends_on: ["03.3-01", "03.3-02"]
files_modified:
  - push_up_5050/lib/widgets/weekly/weekly_review_popup.dart
  - push_up_5050/lib/providers/weekly_review_provider.dart
  - push_up_5050/lib/l10n/app_it.arb
  - push_up_5050/lib/l10n/app_en.arb
autonomous: true

must_haves:
  truths:
    - "WeeklyReviewPopup is a mandatory dialog (barrierDismissible: false)"
    - "Popup shows weekly progress with percentage and progress bar"
    - "Bonus points notice displays when weekly target is achieved"
    - "Goal adjustment options are shown based on achievement (increase or decrease)"
    - "Months-to-goal preview shows for each adjustment option"
  artifacts:
    - path: "push_up_5050/lib/widgets/weekly/weekly_review_popup.dart"
      provides: "Weekly review modal dialog widget"
      min_lines: 150
      contains: "WeeklyReviewPopup", "barrierDismissible: false", "GoalAdjustment"
    - path: "push_up_5050/lib/providers/weekly_review_provider.dart"
      provides: "Weekly review state and bonus calculation"
      min_lines: 80
      contains: "WeeklyReviewProvider", "calculateWeeklyBonus", "adjustGoal"
  key_links:
    - from: "lib/widgets/weekly/weekly_review_popup.dart"
      to: "lib/providers/weekly_review_provider.dart"
      via: "Consumer<WeeklyReviewProvider>"
      pattern: "Consumer<WeeklyReviewProvider>"
    - from: "lib/providers/weekly_review_provider.dart"
      to: "lib/repositories/storage_service.dart"
      via: "storage service injection"
      pattern: "final StorageService _storage"
---

<objective>
Create WeeklyReviewPopup widget with mandatory dialog behavior, weekly progress display, bonus points calculation, and goal adjustment options. The popup is the core UI for the weekly goals system.
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude\get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-weekly-goals/03.3-CONTEXT.md
@.planning/phases/03.3-weekly-goals/03.3-RESEARCH.md
@.planning/phases/03.3-weekly-goals/03.3-01-SUMMARY.md
@.planning/phases/03.3-weekly-goals/03.3-02-SUMMARY.md

# Existing patterns:
- AchievementPopup widget for slide-in notifications
- AlertDialog with barrierDismissible: false in settings_screen.dart
- FrostCard and design system widgets for consistent UI
- AppLocalizations for bilingual support
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add localization strings for weekly review popup</name>
  <files>push_up_5050/lib/l10n/app_it.arb, push_up_5050/lib/l10n/app_en.arb</files>
  <action>
Add weekly review localization keys to both app_it.arb and app_en.arb:

**Italian (app_it.arb) - add at end before closing brace:**
```json
"weeklyReviewTitle": "Revisione Settimanale",
"weeklyTargetAchieved": "Obiettivo Settimanale Raggiunto!",
"weeklyProgressLabel": "Progresso Settimanale",
"weeklyBonusAwarded": "+{bonus} punti bonus",
"@weeklyBonusAwarded": {
  "placeholders": {
    "bonus": {"type": "int", "example": "500"}
  }
},
"weeklyBonusMessage": "Hai raggiunto il tuo obiettivo settimanale!",
"weeklyMissedMessage": "Non hai raggiunto il tuo obiettivo questa settimana.",
"weeklyGoalMaintain": "Mantieni obiettivo",
"weeklyGoalIncrease10": "Aumenta del 10%",
"weeklyGoalIncrease20": "Aumenta del 20%",
"weeklyGoalDecrease10": "Riduci del 10%",
"weeklyGoalDecrease20": "Riduci del 20%",
"weeklyGoalDecrease30": "Riduci del 30%",
"monthlyToGoal": "{months} mesi per 50 push-up",
"@monthlyToGoal": {
  "placeholders": {
    "months": {"type": "int", "example": "3"}
  }
}
```

**English (app_en.arb) - add at end before closing brace:**
```json
"weeklyReviewTitle": "Weekly Review",
"weeklyTargetAchieved": "Weekly Target Achieved!",
"weeklyProgressLabel": "Weekly Progress",
"weeklyBonusAwarded": "+{bonus} bonus points",
"@weeklyBonusAwarded": {
  "placeholders": {
    "bonus": {"type": "int", "example": "500"}
  }
},
"weeklyBonusMessage": "You've reached your weekly target!",
"weeklyMissedMessage": "You didn't reach your target this week.",
"weeklyGoalMaintain": "Maintain goal",
"weeklyGoalIncrease10": "Increase by 10%",
"weeklyGoalIncrease20": "Increase by 20%",
"weeklyGoalDecrease10": "Decrease by 10%",
"weeklyGoalDecrease20": "Decrease by 20%",
"weeklyGoalDecrease30": "Decrease by 30%",
"monthlyToGoal": "{months} months to 50 push-ups",
"@monthlyToGoal": {
  "placeholders": {
    "months": {"type": "int", "example": "3"}
  }
}
```

Then run: flutter pub get

DO NOT:
- Add placeholder descriptions (they're optional and clutter the file)
- Create separate localization files (add to existing app_it.arb/app_en.arb)
- Forget to run flutter pub get after modifying
  </action>
  <verify>
Run: flutter pub get
Run: flutter analyze (should regenerate app_localizations.dart)
  </verify>
  <done>
Localization strings added:
- All weekly review keys in both IT and EN
- Plural handling for "months" (simple integer for now)
- flutter pub get executed
- No analyzer errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WeeklyReviewProvider for bonus calculation</name>
  <files>push_up_5050/lib/providers/weekly_review_provider.dart</files>
  <action>
Create new provider file for weekly review state and bonus calculation:

**File structure:**
```dart
import 'package:flutter/foundation.dart';
import 'package:push_up_5050/repositories/storage_service.dart';

enum GoalAdjustment {
  maintain,
  increase10,
  increase20,
  decrease10,
  decrease20,
  decrease30,
}

class WeeklyReviewProvider extends ChangeNotifier {
  final StorageService _storage;

  int _weeklyTotal = 0;
  int _weeklyTarget = 0;
  int _weeklyBonus = 0;
  bool _targetReached = false;

  WeeklyReviewProvider({required StorageService storage})
      : _storage = storage;

  // Getters
  int get weeklyTotal => _weeklyTotal;
  int get weeklyTarget => _weeklyTarget;
  int get weeklyBonus => _weeklyBonus;
  bool get targetReached => _targetReached;

  // Current progress percentage (0.0 to 1.0)
  double get progressPercent {
    if (_weeklyTarget == 0) return 0.0;
    return (_weeklyTotal / _weeklyTarget).clamp(0.0, 1.0);
  }

  /// Load weekly data and calculate bonus
  Future<void> loadWeeklyData(int weeklyTotal, int weeklyTarget) async {
    _weeklyTotal = weeklyTotal;
    _weeklyTarget = weeklyTarget;
    _targetReached = weeklyTotal >= weeklyTarget;

    if (_targetReached) {
      _weeklyBonus = calculateWeeklyBonus(weeklyTotal, weeklyTarget);
    }

    notifyListeners();
  }

  /// Calculate weekly bonus points
  /// Base: 500 points for reaching target
  /// Overachievement: 0.5 points per excess pushup
  /// Cap: 250 bonus points for excess (max 750 total)
  int calculateWeeklyBonus(int total, int target) {
    const baseBonus = 500;
    const excessRate = 0.5;
    const maxExcessBonus = 250;

    if (total < target) return 0;

    final excess = total - target;
    final excessBonus = (excess * excessRate).floor().clamp(0, maxExcessBonus);

    return baseBonus + excessBonus;
  }

  /// Calculate new goal based on adjustment selection
  /// Enforces bounds: min 30, max 100
  int calculateAdjustedGoal(int currentGoal, GoalAdjustment adjustment) {
    final minGoal = 30;
    final maxGoal = 100;

    int newGoal;
    switch (adjustment) {
      case GoalAdjustment.maintain:
        newGoal = currentGoal;
        break;
      case GoalAdjustment.increase10:
        newGoal = (currentGoal * 1.1).floor();
        break;
      case GoalAdjustment.increase20:
        newGoal = (currentGoal * 1.2).floor();
        break;
      case GoalAdjustment.decrease10:
        newGoal = (currentGoal * 0.9).floor();
        break;
      case GoalAdjustment.decrease20:
        newGoal = (currentGoal * 0.8).floor();
        break;
      case GoalAdjustment.decrease30:
        newGoal = (currentGoal * 0.7).floor();
        break;
    }

    return newGoal.clamp(minGoal, maxGoal);
  }

  /// Calculate months to reach 50 push-ups at new daily goal
  int calculateMonthsToGoal(int newDailyGoal) {
    const targetPushups = 50;
    const currentPushups = 0; // Simplified - in reality would track progress
    final remaining = targetPushups - currentPushups;
    final daysNeeded = (remaining / newDailyGoal).ceil();
    return (daysNeeded / 30).ceil().clamp(1, 12);
  }

  /// Apply goal adjustment and save to storage
  Future<void> applyGoalAdjustment(GoalAdjustment adjustment) async {
    final currentDailyGoal = _storage.getDailyGoal();
    final newDailyGoal = calculateAdjustedGoal(currentDailyGoal, adjustment);

    await _storage.setDailyGoal(newDailyGoal);
    await _storage.setWeeklyGoal(newDailyGoal * 5);

    notifyListeners();
  }

  /// Award weekly bonus points to today's record
  Future<void> awardWeeklyBonus(int weekNumber) async {
    if (_weeklyBonus == 0) return;

    final today = DateTime.now();
    final existingRecord = await _storage.getDailyRecord(today);

    final updatedRecord = DailyRecord(
      date: today,
      totalPushups: existingRecord?.totalPushups ?? 0,
      seriesCompleted: existingRecord?.seriesCompleted ?? 0,
      pointsEarned: (existingRecord?.pointsEarned ?? 0) + _weeklyBonus,
      multiplier: existingRecord?.multiplier ?? 1.0,
      excessPushups: existingRecord?.excessPushups ?? 0,
    );

    await _storage.saveDailyRecord(updatedRecord);
    await _storage.markWeeklyBonusAwarded(weekNumber);
  }
}
```

DO NOT:
- Add complex state machines (keep it simple)
- Store week-specific state in provider (use StorageService)
- Calculate months-to-goal from actual progress (use simplified formula)
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
WeeklyReviewProvider created:
- GoalAdjustment enum with all options
- Bonus calculation (500 base + 0.5 per excess, capped at 750)
- Goal adjustment with bounds (30-100)
- Months-to-goal calculation
- Bonus awarding to DailyRecord
  </done>
</task>

<task type="auto">
  <name>Task 3: Create WeeklyReviewPopup widget</name>
  <files>push_up_5050/lib/widgets/weekly/weekly_review_popup.dart</files>
  <action>
Create mandatory modal dialog widget for weekly review:

**File: lib/widgets/weekly/weekly_review_popup.dart**

Key requirements:
1. AlertDialog with barrierDismissible: false (mandatory selection)
2. Shows weekly progress with percentage and progress bar
3. Displays bonus notice when target achieved
4. Shows goal adjustment options (increase or decrease based on achievement)
5. Months-to-goal preview for each option

**Widget structure:**
```dart
import 'package:flutter/material.dart';
import 'package:push_up_5050/core/constants/app_colors.dart';
import 'package:push_up_5050/l10n/app_localizations.dart';
import 'package:push_up_5050/providers/weekly_review_provider.dart';
import 'package:provider/provider.dart';

class WeeklyReviewPopup extends StatelessWidget {
  final VoidCallback onDismiss;

  const WeeklyReviewPopup({
    super.key,
    required this.onDismiss,
  });

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    final provider = context.watch<WeeklyReviewProvider>();

    final progress = provider.progressPercent;
    final targetReached = provider.targetReached;

    return AlertDialog(
      backgroundColor: const Color(0xFF1A1F28),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: AppColors.primaryOrange, width: 2),
      ),
      contentPadding: const EdgeInsets.all(24),
      content: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Title
            Text(
              targetReached
                  ? l10n.weeklyTargetAchieved
                  : l10n.weeklyReviewTitle,
              style: const TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.w900,
                color: Colors.white,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),

            // Progress bar
            _buildProgressBar(progress, targetReached),
            const SizedBox(height: 16),

            // Stats
            Text(
              '${provider.weeklyTotal} / ${provider.weeklyTarget}',
              style: const TextStyle(
                fontSize: 32,
                fontWeight: FontWeight.w700,
                color: Color(0xFFFFB347),
              ),
            ),
            const SizedBox(height: 8),

            // Percentage
            Text(
              '${(progress * 100).toInt()}%',
              style: const TextStyle(
                fontSize: 16,
                color: Colors.white70,
              ),
            ),
            const SizedBox(height: 16),

            // Bonus notice if achieved
            if (targetReached) ...[
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: AppColors.primaryOrange.withOpacity(0.2),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Column(
                  children: [
                    Icon(
                      Icons.stars_rounded,
                      color: AppColors.primaryOrange,
                      size: 32,
                    ),
                    const SizedBox(height: 8),
                    Text(
                      l10n.weeklyBonusAwarded(provider.weeklyBonus),
                      style: const TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: AppColors.primaryOrange,
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 24),
            ],

            // Goal adjustment options
            ..._buildGoalOptions(context, provider, targetReached, l10n),
          ],
        ),
      ),
    );
  }

  Widget _buildProgressBar(double progress, bool targetReached) {
    return Container(
      height: 12,
      decoration: BoxDecoration(
        color: Colors.grey[800],
        borderRadius: BorderRadius.circular(6),
      ),
      child: FractionallySizedBox(
        alignment: Alignment.centerLeft,
        widthFactor: progress.clamp(0.0, 1.0),
        child: Container(
          decoration: BoxDecoration(
            color: targetReached ? AppColors.primaryOrange : Colors.grey[600],
            borderRadius: BorderRadius.circular(6),
          ),
        ),
      ),
    );
  }

  List<Widget> _buildGoalOptions(
    BuildContext context,
    WeeklyReviewProvider provider,
    bool targetReached,
    AppLocalizations l10n,
  ) {
    final currentGoal = provider.weeklyTarget ~/ 5; // Approximate daily goal

    if (targetReached) {
      // Show increase options
      return [
        _buildOptionCard(
          context: context,
          title: l10n.weeklyGoalMaintain,
          adjustment: GoalAdjustment.maintain,
          monthsToGoal: provider.calculateMonthsToGoal(currentGoal),
          icon: Icons.block,
          onTap: () => _selectOption(context, GoalAdjustment.maintain),
        ),
        const SizedBox(height: 12),
        _buildOptionCard(
          context: context,
          title: l10n.weeklyGoalIncrease10,
          adjustment: GoalAdjustment.increase10,
          monthsToGoal: provider.calculateMonthsToGoal(
            provider.calculateAdjustedGoal(currentGoal, GoalAdjustment.increase10),
          ),
          icon: Icons.trending_up,
          onTap: () => _selectOption(context, GoalAdjustment.increase10),
        ),
        const SizedBox(height: 12),
        _buildOptionCard(
          context: context,
          title: l10n.weeklyGoalIncrease20,
          adjustment: GoalAdjustment.increase20,
          monthsToGoal: provider.calculateMonthsToGoal(
            provider.calculateAdjustedGoal(currentGoal, GoalAdjustment.increase20),
          ),
          icon: Icons.trending_up,
          onTap: () => _selectOption(context, GoalAdjustment.increase20),
        ),
      ];
    } else {
      // Show decrease options
      return [
        _buildOptionCard(
          context: context,
          title: l10n.weeklyGoalDecrease10,
          adjustment: GoalAdjustment.decrease10,
          monthsToGoal: provider.calculateMonthsToGoal(
            provider.calculateAdjustedGoal(currentGoal, GoalAdjustment.decrease10),
          ),
          icon: Icons.trending_down,
          onTap: () => _selectOption(context, GoalAdjustment.decrease10),
        ),
        const SizedBox(height: 12),
        _buildOptionCard(
          context: context,
          title: l10n.weeklyGoalDecrease20,
          adjustment: GoalAdjustment.decrease20,
          monthsToGoal: provider.calculateMonthsToGoal(
            provider.calculateAdjustedGoal(currentGoal, GoalAdjustment.decrease20),
          ),
          icon: Icons.trending_down,
          onTap: () => _selectOption(context, GoalAdjustment.decrease20),
        ),
        const SizedBox(height: 12),
        _buildOptionCard(
          context: context,
          title: l10n.weeklyGoalDecrease30,
          adjustment: GoalAdjustment.decrease30,
          monthsToGoal: provider.calculateMonthsToGoal(
            provider.calculateAdjustedGoal(currentGoal, GoalAdjustment.decrease30),
          ),
          icon: Icons.trending_down,
          onTap: () => _selectOption(context, GoalAdjustment.decrease30),
        ),
      ];
    }
  }

  Widget _buildOptionCard({
    required BuildContext context,
    required String title,
    required GoalAdjustment adjustment,
    required int monthsToGoal,
    required IconData icon,
    required VoidCallback onTap,
  }) {
    final l10n = AppLocalizations.of(context)!;

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.grey[850],
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: Colors.grey[700]!),
        ),
        child: Row(
          children: [
            Icon(icon, color: Colors.white70, size: 24),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                      color: Colors.white,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    l10n.monthlyToGoal(monthsToGoal),
                    style: const TextStyle(
                      fontSize: 14,
                      color: Colors.white70,
                    ),
                  ),
                ],
              ),
            ),
            const Icon(
              Icons.arrow_forward_ios,
              color: Colors.white54,
              size: 16,
            ),
          ],
        ),
      ),
    );
  }

  void _selectOption(BuildContext context, GoalAdjustment adjustment) async {
    final provider = context.read<WeeklyReviewProvider>();
    await provider.applyGoalAdjustment(adjustment);

    if (context.mounted) {
      Navigator.of(context).pop(); // Close dialog
      onDismiss();
    }
  }
}
```

DO NOT:
- Set barrierDismissible to true (must be mandatory)
- Add close button without selection (user MUST choose)
- Use different colors for achieved/missed (orange theme throughout)
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
WeeklyReviewPopup created:
- Mandatory dialog (barrierDismissible: false)
- Progress bar with percentage
- Bonus notice for achieved targets
- Goal adjustment options (increase/decrease)
- Months-to-goal preview
- Apply goal on selection and dismiss
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- flutter analyze passes
- Localization keys work in both IT and EN
- WeeklyReviewProvider calculates bonus correctly
- Popup shows correct options based on achievement
- Goal adjustment applies and saves to storage
</verification>

<success_criteria>
1. WeeklyReviewPopup is a mandatory dialog
2. Bonus calculated as 500 + 0.5Ã—excess (max 750)
3. Goal options show increase when target achieved
4. Goal options show decrease when target missed
5. Months-to-goal displays for each option
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-weekly-goals/03.3-03-SUMMARY.md`
</output>
