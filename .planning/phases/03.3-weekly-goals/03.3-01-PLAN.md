---
phase: 03.3-weekly-goals
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/repositories/storage_service.dart
  - push_up_5050/lib/providers/user_stats_provider.dart
autonomous: true

must_haves:
  truths:
    - "Weekly number is calculated correctly for any date (including year boundaries)"
    - "Week start (Monday) is computed correctly for week-based tracking"
    - "Weekly review flag system prevents duplicate popup triggers"
    - "Weekly bonus award status is tracked separately from review status"
    - "Weekly streak calculation is separate from daily streak logic"
  artifacts:
    - path: "push_up_5050/lib/repositories/storage_service.dart"
      provides: "Weekly state persistence methods"
      contains: "getWeekStart", "getWeekNumber", "hasWeeklyReviewBeenShown", "markWeeklyReviewShown", "hasWeeklyBonusBeenAwarded", "awardWeeklyBonus", "calculateWeeklyStreak"
    - path: "push_up_5050/lib/providers/user_stats_provider.dart"
      provides: "Weekly streak getter"
      contains: "weeklyStreak"
  key_links:
    - from: "lib/providers/user_stats_provider.dart"
      to: "lib/repositories/storage_service.dart"
      via: "calculateWeeklyStreak()"
      pattern: "_storage.calculateWeeklyStreak\\(\\)"
    - from: "lib/screens/home/home_screen.dart"
      to: "lib/repositories/storage_service.dart"
      via: "hasWeeklyReviewBeenShown()"
      pattern: "_storage.hasWeeklyReviewBeenShown\\(\\)"
---

<objective>
Create weekly state tracking infrastructure in StorageService with week calculation utilities, flag-based popup tracking, and weekly streak calculation. This provides the foundation for the weekly goals review system.
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude\get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.3-weekly-goals/03.3-CONTEXT.md
@.planning/phases/03.3-weekly-goals/03.3-RESEARCH.md
@.planning/phases/03.2-enhanced-points-anticheat/03.2-04-SUMMARY.md

# Existing patterns to follow:
- StorageService date formatting (_formatDate method)
- UserStatsProvider week calculation (_computeWeekTotal pattern)
- SharedPreferences flag pattern (onboarding_completed, daily_goal)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add week calculation utilities to StorageService</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add week calculation methods to StorageService:

1. **getWeekStart(DateTime date)** - Calculate Monday of the week for any date
   - Uses DateTime.weekday (1=Mon, 7=Sun)
   - Returns Monday 00:00:00 of the week containing the input date
   - Formula: date.subtract(Duration(days: date.weekday - 1))

2. **getWeekNumber(DateTime date)** - Calculate ISO week number for tracking
   - Returns week number within the year (1-53)
   - Format: YYYY-WW (e.g., "2026-04" for 4th week of 2026)
   - Used as key for weekly flag storage

3. **Add storage keys** at top of file with other keys:
   - _keyWeeklyReviewShown = 'weekly_review_shown_'
   - _keyWeeklyBonusAwarded = 'weekly_bonus_awarded_'

4. **Format**: Add methods in new "Weekly State" section after "Goals & Onboarding" section
   - Use existing _formatDate() method pattern
   - All methods should be static utilities (no instance state)

DO NOT:
- Create new utility classes (keep in StorageService)
- Use intl package (use built-in DateTime.weekday)
- Modify existing week calculation in UserStatsProvider
  </action>
  <verify>
Run: flutter test
Run: flutter analyze
  </verify>
  <done>
Week utilities added:
- getWeekStart() returns Monday of any date
- getWeekNumber() returns "YYYY-WW" format string
- Storage keys defined for weekly flags
- No analyzer warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Add weekly review flag tracking to StorageService</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add flag-based tracking for weekly review popup and bonus award:

1. **hasWeeklyReviewBeenShown(int weekNumber)** - Check if review popup shown for week
   - Storage key: "weekly_review_shown_{weekNumber}"
   - Returns false if not set (first time)
   - Returns bool from SharedPreferences

2. **markWeeklyReviewShown(int weekNumber)** - Mark review as shown for week
   - Sets flag to true in SharedPreferences
   - Prevents duplicate popup for same week

3. **hasWeeklyBonusBeenAwarded(int weekNumber)** - Check if bonus awarded for week
   - Storage key: "weekly_bonus_awarded_{weekNumber}"
   - Returns false if not awarded yet
   - Separate from review flag (bonus tracks award status)

4. **markWeeklyBonusAwarded(int weekNumber)** - Mark bonus as awarded for week
   - Sets flag to true in SharedPreferences
   - Prevents duplicate bonus awards

5. **Add in "Weekly State" section** after week utilities

DO NOT:
- Combine review and bonus tracking (separate flags required)
- Create new state classes (use simple bool flags)
- Use complex serialization (bool is sufficient)
  </action>
  <verify>
Run: flutter analyze
Run: flutter test (if any storage tests exist)
  </verify>
  <done>
Flag tracking methods added:
- hasWeeklyReviewBeenShown() checks popup status
- markWeeklyReviewShown() saves popup status
- hasWeeklyBonusBeenAwarded() checks bonus status
- markWeeklyBonusAwarded() saves bonus status
- All use simple bool flags
  </done>
</task>

<task type="auto">
  <name>Task 3: Add weekly streak calculation to StorageService</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add weekly streak calculation method (separate from daily streak):

**calculateWeeklyStreak()** - Calculate consecutive weeks with any push-ups (>0)
- Returns int (number of consecutive weeks with activity)
- Counts backwards from current week
- Week boundary: Monday 00:00:00 to Sunday 23:59:59
- Any push-ups (>0) in the week preserves streak
- 0 push-ups for entire week breaks streak

Implementation approach:
1. Get all daily records from loadDailyRecords()
2. Start with current week (use getWeekStart(DateTime.now()))
3. For each week going back (max 52 weeks):
   - Check all 7 days (Mon-Sun) for any push-ups
   - If any day has totalPushups > 0: increment streak
   - If all 7 days have 0 push-ups or no record: break loop
4. Return streak count

Key points:
- Use getWeekStart() to get Monday of each week
- Check days 0-6 (Mon=0, Sun=6) from week start
- Use _formatDate() to build storage keys
- Break immediately on empty week (streak broken)
- Today/week in progress: if no records yet, skip without breaking

Add in "Weekly State" section after flag methods.

DO NOT:
- Reuse calculateCurrentStreak() logic (different behavior)
- Require full 7 days of activity (any push-ups count)
- Break streak for current week with no records yet (future/incomplete)
  </action>
  <verify>
Run: flutter test
Run: flutter analyze
  </verify>
  <done>
Weekly streak calculation:
- calculateWeeklyStreak() returns consecutive weeks with any activity
- Week boundaries: Monday-Sunday
- Any push-ups (>0) in week preserves streak
- Empty week (0 push-ups all 7 days) breaks streak
- Current week with no records doesn't break streak
  </done>
</task>

<task type="auto">
  <name>Task 4: Add weekly streak getter to UserStatsProvider</name>
  <files>push_up_5050/lib/providers/user_stats_provider.dart</files>
  <action>
Add weekly streak getter and loading:

1. **Add private field** after _totalPoints (around line 30):
   - int _weeklyStreak = 0

2. **Add public getter** after totalPoints getter (around line 73):
   - int get weeklyStreak => _weeklyStreak

3. **Load in loadStats()** after _currentStreak line (around line 165):
   - _weeklyStreak = await _storage.calculateWeeklyStreak()

4. **Include in widget update** (_updateWidgets method, around line 225):
   - Add weeklyStreak: _weeklyStreak to buildWidgetData call if it accepts it

Note: If buildWidgetData doesn't accept weeklyStreak yet, skip that part (will be added in later plan).

DO NOT:
- Create separate load method (use existing loadStats)
- Add new notifier call (existing notifyListeners is sufficient)
- Modify existing daily streak behavior
  </action>
  <verify>
Run: flutter analyze
Run: flutter test (provider tests)
  </verify>
  <done>
Weekly streak added to UserStatsProvider:
- _weeklyStreak private field
- weeklyStreak public getter
- Loaded in loadStats() method
- Available via Provider to UI
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- flutter test passes
- flutter analyze passes with no warnings
- Week number calculation handles year boundaries (test with Dec 31 / Jan 1 dates)
- Weekly streak correctly counts weeks with partial activity
- Flag methods return false for unset keys (default behavior)
</verification>

<success_criteria>
1. Week utilities produce correct Monday dates for any input date
2. Week number format is consistent ("YYYY-WW")
3. Flag tracking prevents duplicate popup for same week
4. Weekly streak counts weeks with any push-ups (not full 7 days required)
5. All new methods integrate with existing StorageService patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-weekly-goals/03.3-01-SUMMARY.md`
</output>
