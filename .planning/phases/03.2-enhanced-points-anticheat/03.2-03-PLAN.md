---
phase: 03.2-enhanced-points-anticheat
plan: 03
type: execute
wave: 2
depends_on: [03.2-01, 03.2-02]
files_modified:
  - push_up_5050/lib/providers/user_stats_provider.dart
  - push_up_5050/test/providers/user_stats_provider_test.dart
  - push_up_5050/lib/providers/active_workout_provider.dart
  - push_up_5050/test/providers/active_workout_provider_test.dart
  - push_up_5050/lib/screens/statistics/statistics_screen.dart
  - push_up_5050/test/screens/statistics/statistics_screen_test.dart
autonomous: true

must_haves:
  truths:
    - "UserStats accumulates and exposes totalPoints from all DailyRecords"
    - "Statistics screen displays total points"
    - "ActiveWorkoutProvider calculates points when completing each series"
    - "Points are saved to DailyRecord when workout ends"
  artifacts:
    - path: push_up_5050/lib/providers/user_stats_provider.dart
      provides: "totalPoints aggregation from all records"
      contains: "totalPoints"
    - path: push_up_5050/lib/providers/active_workout_provider.dart
      provides: "Points calculation on series completion"
      contains: "calculatePointsForSeries"
    - path: push_up_5050/lib/screens/statistics/statistics_screen.dart
      provides: "Total points display in UI"
  key_links:
    - from: lib/providers/user_stats_provider.dart
      to: lib/models/daily_record.dart
      via: "loads and aggregates pointsEarned from records"
      pattern: "pointsEarned"
    - from: lib/providers/active_workout_provider.dart
      to: lib/core/utils/calculator.dart
      via: "calls calculateSeriesPoints for each series"
      pattern: "Calculator\\.calculateSeriesPoints"
    - from: lib/screens/statistics/statistics_screen.dart
      to: lib/providers/user_stats_provider.dart
      via: "displays totalPoints from provider"
      pattern: "totalPoints"
---

<objective>
Integrate points calculation into the workout flow and display total points in statistics.

Purpose: POINTS-05 requires UserStats.totalPoints to accumulate all daily points and be displayed in statistics. This plan wires the new formula into the workout session flow and adds UI display.

Output: Total points accumulated from records, calculated during workouts, displayed in statistics screen.
</object>

<execution_context>
@C:\Users\olegn\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@push_up_5050/lib/providers/user_stats_provider.dart
@push_up_5050/lib/providers/active_workout_provider.dart
@push_up_5050/lib/screens/statistics/statistics_screen.dart
@push_up_5050/lib/core/utils/calculator.dart
@push_up_5050/lib/models/daily_record.dart
@.planning/phases/03.2-enhanced-points-anticheat/03.2-01-SUMMARY.md
@.planning/phases/03.2-enhanced-points-anticheat/03.2-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add totalPoints aggregation to UserStatsProvider</name>
  <files>push_up_5050/lib/providers/user_stats_provider.dart</files>
<action>
Add totalPoints field and aggregation to UserStatsProvider:

1. Add private field (around line 29, after _consecutiveMissedDays):
```dart
int _totalPoints = 0;
```

2. Add public getter (around line 70, after consecutiveMissedDays):
```dart
/// Total points earned across all workout sessions
int get totalPoints => _totalPoints;
```

3. In loadStats() method, aggregate totalPoints from all records (around line 156, after the daysCompleted calculation):
```dart
_totalPushupsAllTime = 0;
_daysCompleted = 0;
_totalPoints = 0;  // Add this initialization

for (final entry in allRecords.entries) {
  final recordData = entry.value as Map<String, dynamic>;
  final record = DailyRecord.fromJson(recordData);

  _totalPushupsAllTime += record.totalPushups;
  _totalPoints += record.pointsEarned;  // Add points aggregation
  if (record.goalReached) {
    _daysCompleted++;
  }
}
```

4. Add totalPoints to _updateWidgets() call (around line 214):
```dart
final widgetData = await _widgetUpdateService.buildWidgetData(
  todayPushups: _todayPushups,
  totalPushups: _totalPushupsAllTime,
  goalPushups: 5050,
  streakDays: _currentStreak,
  totalPoints: _totalPoints,  // Add this
  lastWorkoutDate: _allDailyRecords.isNotEmpty
      ? _getLastWorkoutDate()
      : null,
  allDailyRecords: _allDailyRecords,
);
```
  </action>
  <verify>flutter analyze lib/providers/user_stats_provider.dart</verify>
  <done>UserStatsProvider aggregates and exposes totalPoints</done>
</task>

<task type="auto">
  <name>Task 2: Add points calculation to ActiveWorkoutProvider.endWorkout()</name>
  <files>push_up_5050/lib/providers/active_workout_provider.dart</files>
  <action>
Update endWorkout() to calculate and save points when ending a workout:

1. Add import if not present (already imported: Calculator)

2. In endWorkout(), after calculating seriesCompleted (around line 224), add points calculation:
```dart
int seriesCompleted = 0;
int repsCount = 0;
int seriesNum = startingSeries;

while (repsCount + seriesNum <= totalReps) {
  repsCount += seriesNum;
  seriesCompleted++;
  seriesNum++;
}

// NEW: Calculate points for this workout
// Load streak for multiplier
final streak = await _storage.calculateCurrentStreak();

// Calculate points for each completed series
int totalPoints = 0;
double lastMultiplier = 1.0;
int seriesIndex = 0;
repsCount = 0;
seriesNum = startingSeries;

while (repsCount + seriesNum <= totalReps) {
  // Count pushups in this series
  final pushupsInSeries = seriesNum;
  repsCount += seriesNum;

  // Calculate points for this series using new formula
  final seriesPoints = Calculator.calculateSeriesPoints(
    seriesNumber: seriesNum,
    pushupsInSeries: pushupsInSeries,
    consecutiveDays: streak,
  );

  totalPoints += seriesPoints;
  seriesIndex++;
  seriesNum++;
}

// Update streak multiplier for display
lastMultiplier = Calculator.getDayStreakMultiplier(streak);
```

3. Update DailyRecord creation to include points (around line 230):
```dart
final record = DailyRecord(
  date: today,
  totalPushups: totalReps,
  seriesCompleted: seriesCompleted,
  pointsEarned: totalPoints,  // Add calculated points
  multiplier: lastMultiplier,  // Add effective multiplier
);
```

4. Update merge logic to add points (around line 238):
```dart
if (existingRecord != null) {
  // Merge: somma ai dati esistenti per oggi
  final mergedRecord = DailyRecord(
    date: today,
    totalPushups: existingRecord.totalPushups + record.totalPushups,
    seriesCompleted: existingRecord.seriesCompleted + record.seriesCompleted,
    pointsEarned: existingRecord.pointsEarned + record.pointsEarned,  // Add points
    multiplier: record.multiplier,  // Use latest multiplier
  );
  await _storage.saveDailyRecord(mergedRecord);
} else {
  // Nuovo record per oggi
  await _storage.saveDailyRecord(record);
}
```
  </action>
  <verify>flutter analyze lib/providers/active_workout_provider.dart</verify>
  <done>endWorkout() calculates and saves points to DailyRecord</done>
</task>

<task type="auto">
  <name>Task 3: Display totalPoints in StatisticsScreen</name>
  <files>push_up_5050/lib/screens/statistics/statistics_screen.dart</files>
  <action>
Add total points display to the statistics screen:

1. Find where statistics badges/stats are displayed (look for "PUSHUP TOTALI" or similar displays)

2. Add a new statistics badge/row for total points:
```dart
// In the stats section, add after existing stats
MiniStat(
  label: 'PUNTI TOTALI',
  value: userStats.totalPoints.toString(),
  icon: Icons.stars_rounded,
  valueColor: AppColors.accentOrange,
),
```

3. If using a statistics badge widget:
```dart
StatisticsBadge(
  label: 'PUNTI',
  value: userStats.totalPoints.toString(),
);
```

4. The exact placement depends on current screen structure - add it in a logical position with other aggregate stats (total pushups, streak, etc.)
  </action>
  <verify>flutter analyze lib/screens/statistics/statistics_screen.dart</verify>
  <done>Statistics screen displays totalPoints</done>
</task>

<task type="auto">
  <name>Task 4: Add localization keys for points display</name>
  <files>
    push_up_5050/lib/l10n/app_it.arb
    push_up_5050/lib/l10n/app_en.arb
  </files>
  <action>
Add localization keys for the new points display:

**app_it.arb** (add around line 100, in the appropriate section):
```json
"totalPointsLabel": "PUNTI TOTALI",
"pointsLabel": "PUNTI",
"dailyPointsLabel": "Punti Oggi",
```

**app_en.arb** (add in same position):
```json
"totalPointsLabel": "TOTAL POINTS",
"pointsLabel": "POINTS",
"dailyPointsLabel": "Today's Points",
```

Then update statistics_screen.dart to use localized strings:
```dart
MiniStat(
  label: loc.totalPointsLabel,  // or AppLocalizations.of(context)!.totalPointsLabel
  value: userStats.totalPoints.toString(),
  icon: Icons.stars_rounded,
  valueColor: AppColors.accentOrange,
),
```
  </action>
  <verify>flutter pub get && flutter analyze</verify>
  <done>Localization keys added, generated files updated</done>
</task>

<task type="auto">
  <name>Task 5: Add tests for points aggregation and calculation</name>
  <files>
    push_up_5050/test/providers/user_stats_provider_test.dart
    push_up_5050/test/providers/active_workout_provider_test.dart
  </files>
  <action>
Add test cases for the new points functionality:

**In user_stats_provider_test.dart**, add group:
```dart
group('Total Points Aggregation - Phase 03.2', () {
  test('aggregates totalPoints from all daily records', () async {
    // Setup: Create records with points
    final record1 = DailyRecord(
      date: DateTime(2025, 1, 15),
      totalPushups: 50,
      pointsEarned: 100,
    );
    await storage.saveDailyRecord(record1);

    final record2 = DailyRecord(
      date: DateTime(2025, 1, 16),
      totalPushups: 50,
      pointsEarned: 120,
    );
    await storage.saveDailyRecord(record2);

    // Act: Load stats
    await provider.loadStats();

    // Assert: Total points is sum
    expect(provider.totalPoints, 220);
  });

  test('returns 0 totalPoints when no records exist', () async {
    await provider.loadStats();
    expect(provider.totalPoints, 0);
  });
});
```

**In active_workout_provider_test.dart**, add group:
```dart
group('Points Calculation - Phase 03.2', () {
  test('calculates points when workout ends', () async {
    // Setup: Start workout
    await provider.startWorkout(
      startingSeries: 1,
      restTime: 30,
      goalPushups: 10,
    );

    // Simulate completing series 1 (1 pushup) and series 2 (2 pushups)
    provider._session?.countRep();  // Series 1 complete
    provider.advanceToNextSeries();
    provider._session?.countRep();  // First rep of series 2
    provider._session?.countRep();  // Series 2 complete

    // Mock streak to return known value
    // (You may need to mock storage.calculateCurrentStreak)

    // Act: End workout
    await provider.endWorkout();

    // Assert: Points calculated and saved
    final record = await storage.getDailyRecord(DateTime.now());
    expect(record?.pointsEarned, greaterThan(0));
  });
});
```
  </action>
  <verify>flutter test test/providers/user_stats_provider_test.dart test/providers/active_workout_provider_test.dart</verify>
  <done>All new tests pass</done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Run `flutter test test/providers/` - all provider tests pass
2. Run `flutter test test/screens/statistics/statistics_screen_test.dart` - screen tests pass
3. Run `flutter analyze` - no warnings
4. Manual test: Complete a workout, verify points are calculated and saved
5. Manual test: Check statistics screen shows total points correctly
</verification>

<success_criteria>
1. UserStatsProvider exposes totalPoints aggregated from all DailyRecords
2. ActiveWorkoutProvider calculates points using calculateSeriesPoints when workout ends
3. Points and multiplier are saved to DailyRecord
4. Statistics screen displays total points
5. Localization keys added for IT/EN
6. Tests cover points aggregation and calculation
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-enhanced-points-anticheat/03.2-03-SUMMARY.md` with:
- How points are calculated during workout flow
- Where totalPoints is displayed
- Test coverage for points integration
