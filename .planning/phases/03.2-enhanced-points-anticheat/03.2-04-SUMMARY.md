# Phase 03.2-04: Daily Cap Anti-Cheat - SUMMARY

**Status:** Complete
**Date:** 2026-01-24

## Implementation Summary

### 1. Calculator - Daily Cap Calculation

**File:** `lib/core/utils/calculator.dart` (lines 231-261)

```dart
static int calculateDailyCap({
  required int dailyGoal,
  required int totalPoints,
}) {
  final level = calculateLevel(totalPoints);

  final double capMultiplier;
  if (level <= 3) {
    capMultiplier = 1.5;
  } else if (level == 4) {
    capMultiplier = 2.0;
  } else {
    capMultiplier = 2.5;
  }

  return (dailyGoal * capMultiplier).floor();
}
```

**Cap Formula by Level:**
- Level 1-3 (0-9999 points): `dailyGoal × 1.5`
- Level 4 (10000-24999 points): `dailyGoal × 2.0`
- Level 5 (25000+ points): `dailyGoal × 2.5`

**Example Caps (dailyGoal = 50):**
- Level 1-3: 50 × 1.5 = 75 pushups
- Level 4: 50 × 2.0 = 100 pushups
- Level 5: 50 × 2.5 = 125 pushups

### 2. ActiveWorkoutProvider - Cap Enforcement

**File:** `lib/providers/active_workout_provider.dart` (lines 254-320)

The cap is enforced during `endWorkout()` with the following logic:

1. **Get today's existing record** to check pushups already done
2. **Calculate daily cap** based on current total points
3. **Calculate series completed with cap enforcement**:
   - Within cap: Full points awarded
   - Partial series: Points proportional to remaining cap
   - Beyond cap: No points, tracked as excess

```dart
// Example logic:
if (pushupsAfterThis <= dailyCap) {
  // Full points
  earnedPoints += seriesPoints;
  rewardedPushups += pushupsInSeries;
} else if (pushupsAlreadyDone + repsCount < dailyCap) {
  // Partial series - proportional points
  final remainingToCap = dailyCap - (pushupsAlreadyDone + repsCount);
  earnedPoints += ((partialPoints / pushupsInSeries) * remainingToCap).floor();
  rewardedPushups += remainingToCap;
  excessPushups += (pushupsInSeries - remainingToCap);
} else {
  // Beyond cap - no points
  excessPushups += pushupsInSeries;
}
```

### 3. Excess Pushups Tracking

**DailyRecord.excessPushups** tracks push-ups beyond the cap:
- Stored in the record
- Aggregated when merging records
- Serialized to JSON with backward compatibility

### 4. Localization

**app_it.arb** (lines 163-173):
```json
"dailyCapReached": "Limite giornaliero raggiunto",
"dailyCapReachedMessage": "Hai superato il limite di {cap} flessioni...",
"excessPushupsLabel": "Extra (non premiate)"
```

**app_en.arb** (lines 163-173):
```json
"dailyCapReached": "Daily cap reached",
"dailyCapReachedMessage": "You've exceeded your {cap} push-up daily cap...",
"excessPushupsLabel": "Excess (not rewarded)"
```

## Anti-Cheat Behavior

1. **Prevents excessive points farming** - Users can't spam workouts for unlimited points
2. **Scales with user level** - Higher level users get higher caps
3. **Allows continued training** - Users can still complete workouts beyond cap (just no points)
4. **Tracks excess pushups** - Full workout data is preserved for statistics

## Test Coverage

Full test coverage in `test/core/utils/calculator_test.dart` (lines 553-579):

- Level 1-3 cap calculation (1.5x multiplier)
- Level 4 cap calculation (2.0x multiplier)
- Level 5 cap calculation (2.5x multiplier)
- Different daily goals (20, 30, 75, 100)

## Verification

- ✅ Cap formula implemented correctly
- ✅ Cap enforcement in workout end flow
- ✅ Excess pushups tracked but not rewarded
- ✅ User can still train beyond cap
- ✅ Localization keys added for IT/EN
- ✅ Tests cover all cap scenarios
