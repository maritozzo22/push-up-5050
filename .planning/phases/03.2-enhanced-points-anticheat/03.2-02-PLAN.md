---
phase: 03.2-enhanced-points-anticheat
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/models/daily_record.dart
  - push_up_5050/test/models/daily_record_test.dart
autonomous: true

must_haves:
  truths:
    - "DailyRecord has pointsEarned field for daily points"
    - "DailyRecord has multiplier field storing the effective multiplier"
    - "Points persist to JSON and deserialize correctly"
    - "copyWith handles pointsEarned and multiplier"
  artifacts:
    - path: push_up_5050/lib/models/daily_record.dart
      provides: "DailyRecord with points tracking"
      contains: "pointsEarned", "multiplier"
    - path: push_up_5050/test/models/daily_record_test.dart
      provides: "Tests for points persistence"
  key_links:
    - from: lib/models/daily_record.dart
      to: lib/core/utils/calculator.dart
      via: "will use calculateSeriesPoints in provider (future plan)"
      pattern: "Calculator\\.calculateSeriesPoints"
---

<objective>
Add points tracking fields to DailyRecord model to enable points persistence.

Purpose: POINTS-04 requires DailyRecord.pointsEarned and DailyRecord.multiplier to store points and the effective multiplier for each day. This enables tracking daily points accumulation for the statistics display.

Output: DailyRecord model with pointsEarned and multiplier fields, JSON serialization, and tests.
</object>

<execution_context>
@C:\Users\olegn\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@push_up_5050/lib/models/daily_record.dart
@push_up_5050/test/models/daily_record_test.dart
@push_up_5050/lib/core/utils/calculator.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pointsEarned and multiplier fields to DailyRecord</name>
  <files>push_up_5050/lib/models/daily_record.dart</files>
  <action>
Add two new final fields to the DailyRecord class after goalReached (around line 19):

```dart
/// Points earned for this day
final int pointsEarned;

/// Effective multiplier applied to points calculation
final double multiplier;
```

Update the constructor to accept these parameters with defaults:
- pointsEarned defaults to 0
- multiplier defaults to 1.0

```dart
DailyRecord({
  required this.date,
  this.totalPushups = 0,
  this.seriesCompleted = 0,
  double? totalKcal,
  this.pointsEarned = 0,
  this.multiplier = 1.0,
})  : totalKcal = totalKcal ?? Calculator.calculateKcal(totalPushups),
        goalReached = totalPushups >= 50;
```

Also update the fromSession factory to include the new fields (default values for now - calculation happens in provider):
```dart
factory DailyRecord.fromSession(
  DateTime date,
  int pushups,
  int series,
) {
  return DailyRecord(
    date: date,
    totalPushups: pushups,
    seriesCompleted: series,
    // Points calculated by provider using Calculator.calculateSeriesPoints
  );
};
```
  </action>
  <verify>flutter analyze lib/models/daily_record.dart</verify>
  <done>Model compiles with new fields, defaults set correctly</done>
</task>

<task type="auto">
  <name>Task 2: Update JSON serialization and deserialization</name>
  <files>push_up_5050/lib/models/daily_record.dart</files>
  <action>
Update toJson() to include the new fields (after goalReached):

```dart
Map<String, dynamic> toJson() {
  return {
    'date': '${date.year}-${date.month.toString().padLeft(2, '0')}-${date.day.toString().padLeft(2, '0')}',
    'totalPushups': totalPushups,
    'seriesCompleted': seriesCompleted,
    'totalKcal': totalKcal,
    'goalReached': goalReached,
    'pointsEarned': pointsEarned,
    'multiplier': multiplier,
  };
}
```

Update fromJson() to parse the new fields with backward compatibility (handle missing keys for existing records):

```dart
factory DailyRecord.fromJson(Map<String, dynamic> json) {
  final dateString = json['date'] as String;
  final parts = dateString.split('-');
  return DailyRecord(
    date: DateTime(
      int.parse(parts[0]),
      int.parse(parts[1]),
      int.parse(parts[2]),
    ),
    totalPushups: json['totalPushups'] as int,
    seriesCompleted: json['seriesCompleted'] as int,
    totalKcal: json['totalKcal'] as double,
    pointsEarned: json['pointsEarned'] as int? ?? 0,  // Backward compatible
    multiplier: (json['multiplier'] as num?)?.toDouble() ?? 1.0,  // Backward compatible
  );
}
```
  </action>
  <verify>flutter analyze lib/models/daily_record.dart</verify>
  <done>JSON serialization includes new fields, deserialization handles missing keys</done>
</task>

<task type="auto">
  <name>Task 3: Update copyWith method to include new fields</name>
  <files>push_up_5050/lib/models/daily_record.dart</files>
  <action>
Update the copyWith method to support the new fields:

```dart
DailyRecord copyWith({
  DateTime? date,
  int? totalPushups,
  int? seriesCompleted,
  double? totalKcal,
  int? pointsEarned,
  double? multiplier,
}) {
  return DailyRecord(
    date: date ?? this.date,
    totalPushups: totalPushups ?? this.totalPushups,
    seriesCompleted: seriesCompleted ?? this.seriesCompleted,
    totalKcal: totalKcal,
    pointsEarned: pointsEarned ?? this.pointsEarned,
    multiplier: multiplier ?? this.multiplier,
  );
}
```

Note: totalKcal behavior unchanged (recalculated if not provided).
  </action>
  <verify>flutter analyze lib/models/daily_record.dart</verify>
  <done>copyWith supports all fields including new ones</done>
</task>

<task type="auto">
  <name>Task 4: Add tests for pointsEarned and multiplier fields</name>
  <files>push_up_5050/test/models/daily_record_test.dart</files>
  <action>
Add new test group "Points Tracking - Phase 03.2" to daily_record_test.dart:

1. **Test default values** - New record has 0 points, 1.0 multiplier
2. **Test JSON serialization** - toJson() includes new fields
3. **Test JSON deserialization** - fromJson() parses new fields
4. **Test backward compatibility** - fromJson() handles missing keys
5. **Test copyWith** - copyWith() updates pointsEarned and multiplier

Example test structure:
```dart
group('Points Tracking - Phase 03.2', () {
  test('creates record with default points (0) and multiplier (1.0)', () {
    final record = DailyRecord(date: DateTime(2025, 1, 15));
    expect(record.pointsEarned, 0);
    expect(record.multiplier, 1.0);
  });

  test('serializes pointsEarned and multiplier to JSON', () {
    final record = DailyRecord(
      date: DateTime(2025, 1, 15),
      totalPushups: 50,
      pointsEarned: 100,
      multiplier: 1.5,
    );
    final json = record.toJson();
    expect(json['pointsEarned'], 100);
    expect(json['multiplier'], 1.5);
  });

  test('deserializes pointsEarned and multiplier from JSON', () {
    final json = {
      'date': '2025-01-15',
      'totalPushups': 50,
      'seriesCompleted': 5,
      'totalKcal': 22.5,
      'goalReached': true,
      'pointsEarned': 150,
      'multiplier': 1.2,
    };
    final record = DailyRecord.fromJson(json);
    expect(record.pointsEarned, 150);
    expect(record.multiplier, 1.2);
  });

  test('handles missing pointsEarned and multiplier for backward compatibility', () {
    final oldJson = {
      'date': '2025-01-15',
      'totalPushups': 50,
      'seriesCompleted': 5,
      'totalKcal': 22.5,
      'goalReached': true,
      // No pointsEarned or multiplier
    };
    final record = DailyRecord.fromJson(oldJson);
    expect(record.pointsEarned, 0);  // Default
    expect(record.multiplier, 1.0);  // Default
  });

  test('copyWith updates pointsEarned and multiplier', () {
    final record = DailyRecord(
      date: DateTime(2025, 1, 15),
      pointsEarned: 100,
      multiplier: 1.5,
    );
    final updated = record.copyWith(
      pointsEarned: 200,
      multiplier: 2.0,
    );
    expect(updated.pointsEarned, 200);
    expect(updated.multiplier, 2.0);
    expect(record.pointsEarned, 100);  // Original unchanged
  });
});
```
  </action>
  <verify>flutter test test/models/daily_record_test.dart</verify>
  <done>All points tracking tests pass</done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Run `flutter test test/models/daily_record_test.dart` - all tests pass
2. Run `flutter analyze` - no warnings
3. Verify backward compatibility: old JSON without points fields loads with defaults
4. Verify serialization: toJson() includes new fields
5. Verify immutability: copyWith creates new instance, doesn't modify original
</verification>

<success_criteria>
1. DailyRecord has pointsEarned (int) and multiplier (double) fields
2. Fields serialize to JSON and deserialize with backward compatibility
3. copyWith supports updating the new fields
4. All tests pass including new points tracking tests
5. No analyzer warnings
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-enhanced-points-anticheat/03.2-02-SUMMARY.md` with:
- Fields added to DailyRecord
- Backward compatibility approach
- Test coverage details
