---
phase: 03.2-enhanced-points-anticheat
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/core/utils/calculator.dart
  - push_up_5050/test/core/utils/calculator_test.dart
autonomous: true

must_haves:
  truths:
    - "New points formula calculates: Base x (RepMult + SeriesMult) x StreakMult"
    - "Rep multiplier = push-ups in series x 0.3"
    - "Series multiplier = series number x 0.8"
    - "Base = 10 points per series"
    - "All calculation happens in Calculator utility"
  artifacts:
    - path: push_up_5050/lib/core/utils/calculator.dart
      provides: "New aggressive points calculation methods"
      exports: ["calculateSeriesPoints", "getRepMultiplier", "getSeriesMultiplier"]
    - path: push_up_5050/test/core/utils/calculator_test.dart
      provides: "TDD tests for new formula"
  key_links:
    - from: test/core/utils/calculator_test.dart
      to: lib/core/utils/calculator.dart
      via: "imports and tests calculateSeriesPoints"
      pattern: "Calculator\\.calculateSeriesPoints"
---

<objective>
Implement the new aggressive points formula in the Calculator utility using TDD.

Purpose: The new formula (Base x (RepMult + SeriesMult) x StreakMult) provides more aggressive progression to increase user engagement. Rep and Series multipliers grow with each series, making longer workouts more rewarding.

Output: New Calculator methods with full test coverage using TDD Red-Green-Refactor cycle.
</objective>

<execution_context>
@C:\Users\olegn\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Phase 03.1 complete - onboarding provides baseline capacity
@push_up_5050/lib/screens/onboarding/onboarding_data.dart
@push_up_5050/lib/core/utils/calculator.dart
@push_up_5050/test/core/utils/calculator_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests for new aggressive points formula</name>
  <files>push_up_5050/test/core/utils/calculator_test.dart</files>
  <action>
Add test group "Aggressive Points Formula - Phase 03.2" to calculator_test.dart with RED tests for:

1. **getRepMultiplier(int pushupsInSeries)** - Returns pushups x 0.3
   - 0 pushups = 0.0
   - 5 pushups = 1.5
   - 10 pushups = 3.0

2. **getSeriesMultiplier(int seriesNumber)** - Returns series x 0.8
   - Series 1 = 0.8
   - Series 5 = 4.0
   - Series 10 = 8.0

3. **calculateSeriesPoints()** - Full formula: Base x (RepMult + SeriesMult) x StreakMult
   - Base = 10 points per series
   - Example: Series 5, 5 pushups, 3-day streak (1.0x)
     - Base: 10
     - RepMult: 5 x 0.3 = 1.5
     - SeriesMult: 5 x 0.8 = 4.0
     - StreakMult: 1.0 (3 days)
     - Result: 10 x (1.5 + 4.0) x 1.0 = 55 points

4. Edge cases:
   - Series 1, 1 pushup: 10 x (0.3 + 0.8) x 1.0 = 11 points
   - Series 10, 10 pushups, 20-day streak (2.0x):
     - 10 x (3.0 + 8.0) x 2.0 = 220 points

DO NOT implement the methods yet - only write tests that WILL fail.
Run `flutter test test/core/utils/calculator_test.dart` to confirm failures.
  </action>
  <verify>flutter test test/core/utils/calculator_test.dart</verify>
  <done>All new tests fail with "method not found" or compilation errors</done>
</task>

<task type="auto">
  <name>Task 2: Implement getRepMultiplier and getSeriesMultiplier in Calculator</name>
  <files>push_up_5050/lib/core/utils/calculator.dart</files>
  <action>
Add three new static methods to lib/core/utils/calculator.dart:

1. **getRepMultiplier(int pushupsInSeries)** - Returns double
   ```dart
   static double getRepMultiplier(int pushupsInSeries) {
     return pushupsInSeries * 0.3;
   }
   ```

2. **getSeriesMultiplier(int seriesNumber)** - Returns double
   ```dart
   static double getSeriesMultiplier(int seriesNumber) {
     return seriesNumber * 0.8;
   }
   ```

3. **calculateSeriesPoints()** - Add method signature (implementation in next task)
   ```dart
   static int calculateSeriesPoints({
     required int seriesNumber,
     required int pushupsInSeries,
     required int consecutiveDays,
   }) {
     // Stub - implement in next task
     return 0;
   }
   ```

Place these methods after the existing calculatePoints method (around line 137).
  </action>
  <verify>flutter test test/core/utils/calculator_test.dart</verify>
  <done>getRepMultiplier and getSeriesMultiplier tests pass, calculateSeriesPoints still fails</done>
</task>

<task type="auto">
  <name>Task 3: Implement calculateSeriesPoints with full formula</name>
  <files>push_up_5050/lib/core/utils/calculator.dart</files>
  <action>
Implement calculateSeriesPoints in lib/core/utils/calculator.dart:

```dart
static int calculateSeriesPoints({
  required int seriesNumber,
  required int pushupsInSeries,
  required int consecutiveDays,
}) {
  // Base: 10 points per series
  const base = 10;

  // Rep multiplier: push-ups in series x 0.3
  final repMult = getRepMultiplier(pushupsInSeries);

  // Series multiplier: series number x 0.8
  final seriesMult = getSeriesMultiplier(seriesNumber);

  // Streak multiplier: from existing getDayStreakMultiplier method
  final streakMult = getDayStreakMultiplier(consecutiveDays);

  // Formula: Base x (RepMult + SeriesMult) x StreakMult
  final points = base * (repMult + seriesMult) * streakMult;

  return points.floor();
}
```

This method uses the existing getDayStreakMultiplier for streak calculation (1.0x for 0-3 days, 1.2x for 4-7, 1.5x for 8-14, 2.0x for 15+).
  </action>
  <verify>flutter test test/core/utils/calculator_test.dart</verify>
  <done>All calculateSeriesPoints tests pass with correct formula</done>
</task>

<task type="auto">
  <name>Task 4: Refactor and document the new methods</name>
  <files>push_up_5050/lib/core/utils/calculator.dart</files>
  <action>
Add comprehensive Dart documentation comments to all three new methods:

```dart
/// Calculates the rep multiplier for the aggressive points formula.
/// RepMult = push-ups in series x 0.3
/// This rewards completing more reps in each series.
static double getRepMultiplier(int pushupsInSeries) { ... }

/// Calculates the series multiplier for the aggressive points formula.
/// SeriesMult = series number x 0.8
/// This rewards progressing through longer workout sessions.
static double getSeriesMultiplier(int seriesNumber) { ... }

/// Calculates points for a single completed series using aggressive formula.
/// Formula: Base x (RepMult + SeriesMult) x StreakMult
/// - Base: 10 points per series
/// - RepMult: push-ups in series x 0.3
/// - SeriesMult: series number x 0.8
/// - StreakMult: from getDayStreakMultiplier (1.0x to 2.0x)
///
/// Example: Series 5, 5 pushups, 5-day streak (1.2x)
/// = 10 x (1.5 + 4.0) x 1.2 = 66 points
static int calculateSeriesPoints({...}) { ... }
```

Also add a comment deprecating the old calculatePoints method if applicable.
  </action>
  <verify>flutter analyze && flutter test test/core/utils/calculator_test.dart</verify>
  <done>All analysis passes, all tests pass, documentation is complete</done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Run `flutter test test/core/utils/calculator_test.dart` - all tests pass
2. Run `flutter analyze` - no warnings or errors
3. Verify formula produces expected results:
   - Series 5, 5 pushups, 3-day streak = 55 points
   - Series 10, 10 pushups, 20-day streak = 220 points
4. Tests cover edge cases: 0 pushups, series 1, max streak
</verification>

<success_criteria>
1. Three new methods in Calculator: getRepMultiplier, getSeriesMultiplier, calculateSeriesPoints
2. All new methods have full test coverage (RED -> GREEN -> REFACTOR complete)
3. Formula produces aggressive progression: later series worth significantly more points
4. Code analysis passes with no warnings
5. Existing tests still pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-enhanced-points-anticheat/03.2-01-SUMMARY.md` with:
- Methods added to Calculator
- Test coverage achieved
- Example calculations demonstrating aggressive progression
- Any refactoring done during the cycle
