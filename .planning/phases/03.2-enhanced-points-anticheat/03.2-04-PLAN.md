---
phase: 03.2-enhanced-points-anticheat
plan: 04
type: execute
wave: 2
depends_on: [03.2-01, 03.2-03]
files_modified:
  - push_up_5050/lib/core/utils/calculator.dart
  - push_up_5050/test/core/utils/calculator_test.dart
  - push_up_5050/lib/providers/user_stats_provider.dart
  - push_up_5050/lib/providers/active_workout_provider.dart
  - push_up_5050/lib/l10n/app_it.arb
  - push_up_5050/lib/l10n/app_en.arb
autonomous: true

must_haves:
  truths:
    - "Daily cap is calculated based on user level and daily goal"
    - "Points are only awarded up to daily cap"
    - "Excess push-ups are tracked but not rewarded"
    - "User sees message when cap is reached"
  artifacts:
    - path: push_up_5050/lib/core/utils/calculator.dart
      provides: "Daily cap calculation method"
      exports: ["calculateDailyCap"]
    - path: push_up_5050/lib/providers/active_workout_provider.dart
      provides: "Cap enforcement during workout"
      contains: "dailyCapReached"
  key_links:
    - from: lib/core/utils/calculator.dart
      to: lib/core/utils/calculator.dart
      via: "calculateLevel used by calculateDailyCap"
      pattern: "calculateLevel.*calculateDailyCap"
    - from: lib/providers/active_workout_provider.dart
      to: lib/core/utils/calculator.dart
      via: "calls calculateDailyCap to enforce limit"
      pattern: "Calculator\\.calculateDailyCap"
---

<objective>
Implement anti-cheat daily cap system to prevent excessive points farming.

Purpose: ANTCHEAT-01 and ANTCHEAT-02 require enforcing a daily push-up cap based on user level. Push-ups beyond the cap are tracked but not rewarded with points. This prevents abuse while still allowing users to complete longer workouts.

Output: Daily cap calculation, cap enforcement during workouts, user notification when cap reached.
</object>

<execution_context>
@C:\Users\olegn\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/PROJECT.md
@push_up_5050/lib/core/utils/calculator.dart
@push_up_5050/lib/providers/active_workout_provider.dart
@push_up_5050/lib/providers/user_stats_provider.dart
@push_up_5050/lib/repositories/storage_service.dart
@.planning/phases/03.2-enhanced-points-anticheat/03.2-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calculateDailyCap method to Calculator</name>
  <files>push_up_5050/lib/core/utils/calculator.dart</files>
  <action>
Add a new method to lib/core/utils/calculator.dart that calculates the daily cap:

```dart
/// Calculate daily push-up cap based on user level and daily goal.
///
/// Cap formula: daily goal x (1 + (level x 0.1))
/// - Level 1-5: cap = daily goal x 1.5
/// - Level 6-10: cap = daily goal x 2.0
/// - Level 11+: cap = daily goal x 2.5
///
/// This prevents excessive points farming while allowing
/// motivated users to continue training beyond the cap.
static int calculateDailyCap({
  required int dailyGoal,
  required int totalPoints,
}) {
  final level = calculateLevel(totalPoints);

  // Calculate cap multiplier based on level
  final double capMultiplier;
  if (level <= 5) {
    capMultiplier = 1.5;
  } else if (level <= 10) {
    capMultiplier = 2.0;
  } else {
    capMultiplier = 2.5;
  }

  return (dailyGoal * capMultiplier).floor();
}
```

Place this method after calculateLevel (around line 151).
  </action>
  <verify>flutter analyze lib/core/utils/calculator.dart</verify>
  <done>calculateDailyCap method compiles and follows formula specification</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for daily cap calculation</name>
  <files>push_up_5050/test/core/utils/calculator_test.dart</files>
  <action>
Add test group "Daily Cap Calculation - Phase 03.2" to calculator_test.dart:

```dart
group('Daily Cap Calculation - Phase 03.2', () {
  test('calculates cap for level 1-5 (1.5x daily goal)', () {
    // Level 1-5: cap = dailyGoal x 1.5
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 0), 75);    // Level 1
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 500), 75);  // Level 1
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 999), 75);  // Level 1
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 1000), 75); // Level 2
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 4999), 75); // Level 2
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 5000), 75); // Level 3
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 9999), 75); // Level 3
  });

  test('calculates cap for level 6-10 (2.0x daily goal)', () {
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 10000), 100); // Level 4
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 24999), 100); // Level 4
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 25000), 100); // Level 5
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 30000), 100); // Level 5
  });

  test('calculates cap for level 11+ (2.5x daily goal)', () {
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 100000), 125); // Level 5 (max level)
    expect(Calculator.calculateDailyCap(dailyGoal: 100, totalPoints: 50000), 250); // Level 5
  });

  test('handles different daily goals', () {
    expect(Calculator.calculateDailyCap(dailyGoal: 20, totalPoints: 0), 30);   // 20 x 1.5
    expect(Calculator.calculateDailyCap(dailyGoal: 30, totalPoints: 0), 45);   // 30 x 1.5
    expect(Calculator.calculateDailyCap(dailyGoal: 75, totalPoints: 0), 112);  // 75 x 1.5
    expect(Calculator.calculateDailyCap(dailyGoal: 100, totalPoints: 0), 150); // 100 x 1.5
  });
});
```
  </action>
  <verify>flutter test test/core/utils/calculator_test.dart</verify>
  <done>All daily cap tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Add excessPushups field to DailyRecord</name>
  <files>
    push_up_5050/lib/models/daily_record.dart
    push_up_5050/test/models/daily_record_test.dart
  </files>
  <action>
Add excessPushups field to track push-ups beyond the cap:

**In daily_record.dart**, add field after multiplier:
```dart
/// Push-ups completed beyond daily cap (tracked but not rewarded)
final int excessPushups;
```

Update constructor with default:
```dart
DailyRecord({
  required this.date,
  this.totalPushups = 0,
  this.seriesCompleted = 0,
  double? totalKcal,
  this.pointsEarned = 0,
  this.multiplier = 1.0,
  this.excessPushups = 0,  // Add this
})  : totalKcal = totalKcal ?? Calculator.calculateKcal(totalPushups),
        goalReached = totalPushups >= 50;
```

Update toJson():
```dart
'excessPushups': excessPushups,
```

Update fromJson() with backward compatibility:
```dart
excessPushups: json['excessPushups'] as int? ?? 0,
```

Update copyWith():
```dart
int? excessPushups,

// In return:
excessPushups: excessPushups ?? this.excessPushups,
```

**Add test** in daily_record_test.dart:
```dart
test('tracks excessPushups beyond daily cap', () {
  final record = DailyRecord(
    date: DateTime(2025, 1, 15),
    totalPushups: 100,
    excessPushups: 25,  // 25 pushups beyond cap
  );
  expect(record.excessPushups, 25);
});
```
  </action>
  <verify>flutter test test/models/daily_record_test.dart</verify>
  <done>DailyRecord tracks excessPushups with backward compatibility</done>
</task>

<task type="auto">
  <name>Task 4: Enforce daily cap in ActiveWorkoutProvider.endWorkout()</name>
  <files>push_up_5050/lib/providers/active_workout_provider.dart</files>
  <action>
Update endWorkout() to enforce daily cap:

1. Before calculating points, get today's existing record and calculate cap:
```dart
// Get today's existing record to check cap
final today = DateTime.now();
final existingRecord = await _storage.getDailyRecord(today);
final totalPoints = await _storage.getUserStats();  // Or get from UserStatsProvider
final dailyGoal = _storage.getDailyGoal();

// Calculate daily cap
final dailyCap = Calculator.calculateDailyCap(
  dailyGoal: dailyGoal,
  totalPoints: 0,  // TODO: Get from UserStatsProvider
);

// Calculate pushups already done today
final pushupsAlreadyDone = existingRecord?.totalPushups ?? 0;
```

2. Modify points calculation loop to track capped vs excess:
```dart
// Calculate points for this workout with cap enforcement
int rewardedPushups = 0;
int excessPushups = 0;
int totalPoints = 0;

int seriesIndex = 0;
int repsCount = 0;
int seriesNum = startingSeries;

while (repsCount + seriesNum <= totalReps) {
  final pushupsInSeries = seriesNum;
  final pushupsAfterThis = pushupsAlreadyDone + repsCount + pushupsInSeries;

  // Check if this series would exceed cap
  if (pushupsAfterThis <= dailyCap) {
    // Within cap - calculate full points
    final streak = await _storage.calculateCurrentStreak();
    final seriesPoints = Calculator.calculateSeriesPoints(
      seriesNumber: seriesNum,
      pushupsInSeries: pushupsInSeries,
      consecutiveDays: streak,
    );
    totalPoints += seriesPoints;
    rewardedPushups += pushupsInSeries;
  } else if (pushupsAlreadyDone + repsCount < dailyCap) {
    // Partial series - calculate points only up to cap
    final remainingToCap = dailyCap - (pushupsAlreadyDone + repsCount);
    final streak = await _storage.calculateCurrentStreak();
    final partialPoints = Calculator.calculateSeriesPoints(
      seriesNumber: seriesNum,
      pushupsInSeries: remainingToCap,
      consecutiveDays: streak,
    );
    totalPoints += ((partialPoints / seriesNum) * remainingToCap).floor();
    rewardedPushups += remainingToCap;
    excessPushups += (pushupsInSeries - remainingToCap);
  } else {
    // Beyond cap - no points
    excessPushups += pushupsInSeries;
  }

  repsCount += seriesNum;
  seriesIndex++;
  seriesNum++;
}
```

3. Update DailyRecord creation:
```dart
final record = DailyRecord(
  date: today,
  totalPushups: totalReps,
  seriesCompleted: seriesCompleted,
  pointsEarned: totalPoints,
  multiplier: lastMultiplier,
  excessPushups: existingRecord?.excessPushups ?? 0 + excessPushups,
);
```
  </action>
  <verify>flutter analyze lib/providers/active_workout_provider.dart</verify>
  <done>endWorkout() enforces daily cap and tracks excess pushups</done>
</task>

<task type="auto">
  <name>Task 5: Add localization and cap reached notification</name>
  <files>
    push_up_5050/lib/l10n/app_it.arb
    push_up_5050/lib/l10n/app_en.arb
    push_up_5050/lib/providers/active_workout_provider.dart
  </files>
  <action>
Add localization strings for cap reached message:

**app_it.arb** (add around line 80):
```json
"dailyCapReached": "Limite giornaliero raggiunto",
"dailyCapReachedMessage": "Hai superato il limite di {cap} flessioni. Le flessioni extra vengono tracciate ma non premiate.",
"excessPushupsLabel": "Extra (non premiate)",
"@dailyCapReachedMessage": {
  "placeholders": {
    "cap": {
      "type": "int",
      "example": "75"
    }
  }
}
```

**app_en.arb** (add in same position):
```json
"dailyCapReached": "Daily cap reached",
"dailyCapReachedMessage": "You've exceeded your {cap} push-up daily cap. Excess push-ups are tracked but not rewarded.",
"excessPushupsLabel": "Excess (not rewarded)",
"@dailyCapReachedMessage": {
  "placeholders": {
    "cap": {
      "type": "int",
      "example": "75"
    }
  }
}
```

Add a public getter to ActiveWorkoutProvider:
```dart
/// Whether the daily cap has been reached
bool get dailyCapReached => _dailyCapReached;
```

Add tracking in endWorkout() after calculating cap:
```dart
bool _dailyCapReached = false;

// In the calculation loop, after detecting excess:
if (excessPushups > 0 || pushupsAlreadyDone >= dailyCap) {
  _dailyCapReached = true;
}
```
  </action>
  <verify>flutter pub get && flutter analyze</verify>
  <done>Localization keys added, cap tracking available in provider</done>
</task>

<task type="auto">
  <name>Task 6: Add tests for cap enforcement</name>
  <files>push_up_5050/test/providers/active_workout_provider_test.dart</files>
  <action>
Add test group "Daily Cap Enforcement - Phase 03.2":

```dart
group('Daily Cap Enforcement - Phase 03.2', () {
  test('awards full points when under daily cap', () async {
    // Setup: Daily cap of 75, user has done 0 today
    // Start workout with 50 pushups (under cap)
    await provider.startWorkout(
      startingSeries: 1,
      restTime: 30,
      goalPushups: 50,
    );

    // Simulate completing workout
    // ... (implementation depends on test structure)

    await provider.endWorkout();

    final record = await storage.getDailyRecord(DateTime.now());
    expect(record?.pointsEarned, greaterThan(0));
    expect(record?.excessPushups, 0);
  });

  test('tracks excess pushups when cap exceeded', () async {
    // Setup: Daily cap of 75, user has done 50 today
    // Start workout with 50 more pushups (25 excess)

    await provider.startWorkout(
      startingSeries: 1,
      restTime: 30,
      goalPushups: 50,
    );

    await provider.endWorkout();

    final record = await storage.getDailyRecord(DateTime.now());
    expect(record?.excessPushups, greaterThan(0));
    expect(provider.dailyCapReached, true);
  });

  test('calculates cap based on user level', () {
    // Level 1: 50 x 1.5 = 75
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 0), 75);

    // Level 5 (max): 50 x 2.5 = 125
    expect(Calculator.calculateDailyCap(dailyGoal: 50, totalPoints: 25000), 125);
  });
});
```
  </action>
  <verify>flutter test test/providers/active_workout_provider_test.dart</verify>
  <done>Cap enforcement tests pass</done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Run `flutter test test/core/utils/calculator_test.dart` - cap calculation tests pass
2. Run `flutter test test/providers/active_workout_provider_test.dart` - enforcement tests pass
3. Run `flutter analyze` - no warnings
4. Verify cap scales correctly with level (1.5x, 2.0x, 2.5x)
5. Verify excess pushups are tracked but not rewarded
6. Verify user can still complete workouts beyond cap (just no points)
</verification>

<success_criteria>
1. Calculator.calculateDailyCap returns correct cap based on level and goal
2. ActiveWorkoutProvider enforces cap when calculating points
3. DailyRecord.excessPushups tracks push-ups beyond cap
4. Localization keys for cap reached message added
5. Tests cover cap calculation and enforcement scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-enhanced-points-anticheat/03.2-04-SUMMARY.md` with:
- Cap formula implementation
- How enforcement works during workout
- Excess pushup tracking
- User notification approach
