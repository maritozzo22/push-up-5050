# 09-01-PLAN: Fix Proximity Sensor Detection Logic

## Goal

Fix the proximity sensor detection logic so it correctly counts push-ups (farnear transition = 1 rep).

## Requirements

- SENS-01: Proximity sensor correctly counts push-ups (farnear transition = 1 rep)

## Success Criteria

1. Proximity sensor state tracking works correctly (far → near = count)
2. Only counts on transition (not continuous while near)
3. Debounce prevents multiple counts from single push-up
4. Graceful fallback to manual button when sensor unavailable

## Changes Required

### 1. Fix ProximitySensorService Detection Logic

**File:** `lib/services/proximity_sensor_service.dart`

**Current Issues:**
- May not be tracking state transitions correctly
- Need to verify far → near counting logic

**Implementation:**

```dart
class ProximitySensorService {
  bool _isFar = true; // Track far state for transition detection

  void _handleProximityEvent(dynamic distance) {
    final double dist = distance is double ? distance : 0.0;

    // proximity_sensor: event > 0 = far (away), event < 0 = near (close)
    // Wait, this might be reversed - need to verify package behavior

    // Transition detection: count on far → near
    final isNear = dist < 0; // Assuming near < 0, far > 0

    if (isNear && _isFar) {
      // Far → near transition: count one rep
      _applyDebounceAndTrigger();
      _isFar = false;
    } else if (!isNear) {
      // Near → far: reset for next rep
      _isFar = true;
    }
  }

  void _applyDebounceAndTrigger() {
    final now = DateTime.now();
    if (_lastTrigger != null &&
        now.difference(_lastTrigger!).inMilliseconds < _debounceMs) {
      return; // Too soon
    }
    _lastTrigger = now;
    _controller.add(true);
    _callback?.call();
  }
}
```

### 2. Add Logging for Debugging

**File:** `lib/services/proximity_sensor_service.dart`

```dart
void _handleProximityEvent(dynamic distance) {
  // Add debug logging
  debugPrint('Proximity event: $distance (near: ${distance < 0})');

  // ... rest of logic
}
```

### 3. Verify Package Behavior

Check `proximity_sensor` package documentation:
- On Android, `ProximitySensor.events` emits:
  - `0` or positive value: FAR (object away)
  - Negative value: NEAR (object close)
- OR it may be opposite (depends on device)

**Need to test and verify actual behavior.**

### 4. Test Detection

After implementation:
1. Run app on physical Android device
2. Enable proximity sensor
3. Place phone on floor
4. Do push-up with chest approaching phone
5. Verify each rep counts once

## Verification

- [ ] Sensor state tracking (far → near transitions)
- [ ] Debounce prevents double-counting
- [ ] Manual button still works as fallback
- [ ] Debug logging shows sensor events
- [ ] Test on physical device confirms counting

## Notes

- **Physical device required** - cannot test on emulator
- May need to adjust logic based on actual device behavior
- Some devices may have inverted sensor values
