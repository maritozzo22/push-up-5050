---
phase: 02.2-quick-stats-widget
plan: 03a
type: execute
wave: 3
depends_on: [02.2-02b]
files_modified:
  - push_up_5050/android/app/src/main/AndroidManifest.xml
  - push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/MainActivity.kt
  - push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetStatsProvider.kt
autonomous: true
user_setup: []

must_haves:
  truths:
    - "AndroidManifest has deep link intent filter for pushup5050://series_selection"
    - "MainActivity handles deep link intents and forwards to Flutter"
    - "Widget START button uses deep link intent"
  artifacts:
    - path: "push_up_5050/android/app/src/main/AndroidManifest.xml"
      provides: "Deep link intent filter for widget START button"
      contains: "series_selection|pushup5050"
    - path: "push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/MainActivity.kt"
      provides: "Deep link handler with MethodChannel"
      contains: "MethodChannel|getInitialDeepLink|onNewIntent"
    - path: "push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetStatsProvider.kt"
      provides: "Widget with pending intent for deep link"
      contains: "PendingIntent|pushup5050://series_selection"
  key_links:
    - from: "PushupWidgetStatsProvider.kt"
      to: "MainActivity.kt"
      via: "PendingIntent with deep link action"
      pattern: "PendingIntent.*Activity.*Intent.*ACTION_VIEW"
    - from: "AndroidManifest.xml"
      to: "MainActivity"
      via: "intent-filter for deep link scheme"
      pattern: "intent-filter.*pushup5050"
---

# Phase 2.2-03a: Configure Android Deep Link Handling

## Objective
Configure Android-side deep linking: add intent filter to AndroidManifest, update MainActivity to handle deep links, and update widget provider to use deep link intent.

**Purpose:** Enable the widget's START button to open the app via deep link. This plan handles Android configuration; plan 03b handles Flutter routing.

**Output:** Android configured for deep link handling from widget.

## Context
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-quick-stats-widget/02.2-CONTEXT.md

@.planning/phases/02.2-quick-stats-widget/02.2-01-PLAN.md
@.planning/phases/02.2-quick-stats-widget/02.2-02b-PLAN.md
@push_up_5050/android/app/src/main/AndroidManifest.xml
@push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/MainActivity.kt
@push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetStatsProvider.kt

## Tasks

### Task 1: Add Deep Link Intent Filter to AndroidManifest
**type:** auto

**Action:**
Add a deep link intent filter to MainActivity in `AndroidManifest.xml` that handles the `pushup5050://series_selection` URL scheme.

Find the MainActivity activity block and add the intent-filter inside it:

```xml
<activity
    android:name=".MainActivity"
    android:exported="true"
    android:launchMode="singleTop"
    android:taskAffinity=""
    android:theme="@style/LaunchTheme"
    android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
    android:hardwareAccelerated="true"
    android:windowSoftInputMode="adjustResize">
    <!-- Specifies an Android theme to apply to this Activity as soon as
         the Android process has started. This theme is visible to the user
         while the Flutter UI initializes. After that, this theme continues
         to determine the Window background behind the Flutter UI. -->
    <meta-data
      android:name="io.flutter.embedding.android.NormalTheme"
      android:resource="@style/NormalTheme" />
    <intent-filter>
        <action android:name="android.intent.action.MAIN"/>
        <category android:name="android.intent.category.LAUNCHER"/>
    </intent-filter>

    <!-- Deep link for widget START button -->
    <intent-filter android:autoVerify="true">
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <data
            android:scheme="pushup5050"
            android:host="series_selection" />
    </intent-filter>
</activity>
```

**Verification:**
- AndroidManifest.xml contains deep link intent-filter
- Scheme is `pushup5050`
- Host is `series_selection`

**Done:**
- Deep link URL scheme registered in AndroidManifest

---

### Task 2: Update MainActivity to Handle Deep Links
**type:** auto

**Action:**
Modify `MainActivity.kt` to properly handle deep link intents and pass them to Flutter.

Update the MainActivity to:

```kotlin
package com.pushup5050.push_up_5050

import io.flutter.embedding.android.FlutterActivity
import io.flutter.embedding.engine.FlutterEngine
import io.flutter.plugin.common.MethodChannel

class MainActivity: FlutterActivity() {
    companion object {
        private const val CHANNEL = "com.pushup5050.push_up_5050/deep_link"
        const val DEEP_LINK_EXTRA = "deep_link_url"
    }

    override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)

        // Set up method channel for deep link communication
        MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL)
            .setMethodCallHandler { call, result ->
                when (call.method) {
                    "getInitialDeepLink" -> {
                        val deepLink = intent?.data?.toString()
                        result.success(deepLink)
                    }
                    else -> result.notImplemented()
                }
            }
    }

    override fun onNewIntent(intent: android.content.Intent) {
        super.onNewIntent(intent)
        // Update the intent so new deep links are processed
        setIntent(intent)

        // Notify Flutter of the new deep link
        val deepLink = intent.data?.toString()
        if (deepLink != null) {
            flutterEngine?.dartExecutor?.binaryMessenger?.let {
                MethodChannel(it, "com.pushup5050.push_up_5050/deep_link")
                    .invokeMethod("onDeepLink", mapOf("url" to deepLink))
            }
        }
    }
}
```

**Verification:**
- MainActivity has MethodChannel for deep link communication
- `getInitialDeepLink` method returns initial deep link URL
- `onNewIntent` handles deep links while app is running
- Code compiles without errors

**Done:**
- MainActivity configured to handle and forward deep links

---

### Task 3: Update Widget Provider to Use Deep Link Intent
**type:** auto

**Action:**
Update `PushupWidgetStatsProvider.kt` to use deep link intent instead of generic launch intent.

Modify the `updateAppWidget` function's START button pending intent:

```kotlin
// Set click intent for START button to deep link
val deepLinkIntent = Intent(context, MainActivity::class.java).apply {
    action = Intent.ACTION_VIEW
    data = android.net.Uri.parse("pushup5050://series_selection")
    // Start as new task but don't create multiple instances
    flags = Intent.FLAG_ACTIVITY_NEW_TASK or
            Intent.FLAG_ACTIVITY_CLEAR_TOP or
            Intent.FLAG_ACTIVITY_SINGLE_TOP
}

views.setOnClickPendingIntent(R.id.start_button,
    android.app.PendingIntent.getActivity(
        context,
        0,
        deepLinkIntent,
        android.app.PendingIntent.FLAG_UPDATE_CURRENT or android.app.PendingIntent.FLAG_IMMUTABLE
    )
)
```

Replace the existing launch intent code with this deep link version.

**Verification:**
- Widget START button uses deep link intent
- Deep link URL is `pushup5050://series_selection`
- PendingIntent flags prevent duplicate activities

**Done:**
- Widget START button configured to use deep link

---

## Verification
After completing all tasks:
- [ ] AndroidManifest has deep link intent filter
- [ ] MainActivity handles deep links and forwards to Flutter
- [ ] Widget uses deep link intent for START button
- [ ] Code compiles without errors

## Success Criteria
- Android recognizes `pushup5050://series_selection` as valid deep link
- MainActivity forwards deep links to Flutter via MethodChannel
- Widget START button launches deep link intent
- Multiple widget instances can be added and all work correctly

## Output
After completion, create `.planning/phases/02.2-quick-stats-widget/02.2-03a-SUMMARY.md`
