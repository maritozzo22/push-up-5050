---
phase: 02.2-quick-stats-widget
plan: 03b
type: execute
wave: 3
depends_on: [02.2-02b, 02.2-03a]
files_modified:
  - push_up_5050/lib/services/deep_link_service.dart
  - push_up_5050/lib/main.dart
  - push_up_5050/lib/screens/series_selection/series_selection_screen.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tapping START button opens SeriesSelectionScreen"
    - "DeepLinkService handles both cold start and warm start scenarios"
    - "App handles widget intent and routes correctly"
  artifacts:
    - path: "push_up_5050/lib/services/deep_link_service.dart"
      provides: "Deep link service for Flutter"
      contains: "DeepLinkService|initialize|MethodChannel"
    - path: "push_up_5050/lib/screens/series_selection/series_selection_screen.dart"
      provides: "SeriesSelectionScreen with routeName constant"
      contains: "routeName.*series_selection"
    - path: "push_up_5050/lib/main.dart"
      provides: "Deep link route handler in MaterialApp"
      contains: "onGenerateRoute|DeepLinkService|navigatorKey"
  key_links:
    - from: "MainActivity.kt"
      to: "DeepLinkService"
      via: "MethodChannel 'com.pushup5050.push_up_5050/deep_link'"
      pattern: "MethodChannel.*deep_link"
    - from: "DeepLinkService"
      to: "SeriesSelectionScreen"
      via: "Route name constant"
      pattern: "routeName"
    - from: "DeepLinkService"
      to: "MyApp.navigatorKey"
      via: "Navigation callback"
      pattern: "onDeepLink.*pushNamed"
---

# Phase 2.2-03b: Implement Flutter Deep Link Handling

## Objective
Create Flutter deep link service to handle deep links from Android widget and navigate to SeriesSelectionScreen.

**Purpose:** Plan 03a configured Android deep link handling. This plan implements the Flutter side: a service to receive deep links and route them to the correct screen.

**Output:** Flutter navigates to SeriesSelectionScreen when widget START button is tapped.

## Context
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-quick-stats-widget/02.2-CONTEXT.md

@.planning/phases/02.2-quick-stats-widget/02.2-03a-PLAN.md
@push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/MainActivity.kt
@push_up_5050/lib/main.dart
@push_up_5050/lib/main_navigation_wrapper.dart
@push_up_5050/lib/screens/series_selection/series_selection_screen.dart

## Tasks

### Task 1: Add routeName Constant to SeriesSelectionScreen
**type:** auto

**Action:**
Add a `routeName` constant to `SeriesSelectionScreen` so it can be referenced by deep link service.

In `lib/screens/series_selection/series_selection_screen.dart`, add:

```dart
class SeriesSelectionScreen extends StatelessWidget {
  static const String routeName = '/series_selection';

  // ... rest of class
}
```

If the class doesn't already have this constant, add it at the top of the class.

**Verification:**
- SeriesSelectionScreen has `routeName` constant
- Route name is `/series_selection`

**Done:**
- Route name constant added to SeriesSelectionScreen

---

### Task 2: Create Deep Link Service
**type:** auto

**Action:**
Create `lib/services/deep_link_service.dart` to handle deep links from Android widget.

```dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:push_up_5050/screens/series_selection/series_selection_screen.dart';

/// Service for handling deep links from Android widgets
class DeepLinkService {
  static const String _channelName = 'com.pushup5050.push_up_5050/deep_link';
  static const String _seriesSelectionUrl = 'pushup5050://series_selection';

  MethodChannel? _channel;
  final void Function(String route) onDeepLink;

  DeepLinkService({required this.onDeepLink});

  /// Initialize deep link service
  Future<void> initialize() async {
    _channel = const MethodChannel(_channelName);

    // Check for initial deep link (app cold start)
    final initialLink = await _channel?.invokeMethod('getInitialDeepLink');
    if (initialLink != null && initialLink is String) {
      _handleDeepLink(initialLink);
    }

    // Listen for new deep links (app already running)
    _channel?.setMethodCallHandler((call) async {
      if (call.method == 'onDeepLink') {
        final url = call.arguments as Map?;
        final urlString = url?['url'] as String?;
        if (urlString != null) {
          _handleDeepLink(urlString);
        }
      }
    });
  }

  void _handleDeepLink(String url) {
    if (url == _seriesSelectionUrl) {
      onDeepLink(SeriesSelectionScreen.routeName);
    }
  }
}
```

**Verification:**
- DeepLinkService created with initialize() method
- Handles initial deep link (cold start)
- Handles onDeepLink callback (warm start)
- Uses correct channel name matching MainActivity

**Done:**
- Deep link service created

---

### Task 3: Integrate Deep Link Service into main.dart
**type:** auto

**Action:**
Update `MyApp` in `main.dart` to use deep link service with navigator key.

```dart
class _MyAppState extends State<MyApp> {
  final GlobalKey<NavigatorState> _navigatorKey = GlobalKey<NavigatorState>();
  late DeepLinkService _deepLinkService;

  @override
  void initState() {
    super.initState();
    _deepLinkService = DeepLinkService(
      onDeepLink: (route) {
        // Navigate to the deep link route
        _navigatorKey.currentState?.pushNamed(route);
      },
    );
    // Initialize deep link service after first frame
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _deepLinkService.initialize();
    });
  }

  @override
  Widget build(BuildContext context) {
    return Consumer<AppSettingsService>(
      builder: (context, settings, _) {
        return MaterialApp(
          navigatorKey: _navigatorKey,
          title: 'Push-Up 5050',
          debugShowCheckedModeBanner: false,
          theme: AppTheme.darkTheme,
          locale: Locale(settings.appLanguage),
          localizationsDelegates: AppLocalizations.localizationsDelegates,
          supportedLocales: AppLocalizations.supportedLocales,
          initialRoute: '/',
          onGenerateRoute: (settings) {
            // Handle deep link routes
            if (settings.name == SeriesSelectionScreen.routeName) {
              return MaterialPageRoute(
                builder: (_) => const SeriesSelectionScreen(),
              );
            }
            // Default route
            return MaterialPageRoute(
              builder: (_) => const MainNavigationWrapper(),
            );
          },
          home: const MainNavigationWrapper(),
        );
      },
    );
  }
}
```

**Verification:**
- MyApp uses navigatorKey for deep link navigation
- DeepLinkService initialized in initState
- onGenerateRoute handles series_selection route
- Code compiles without errors

**Done:**
- Flutter side configured to handle deep links

---

## Verification
After completing all tasks:
- [ ] SeriesSelectionScreen has routeName constant
- [ ] DeepLinkService exists and is initialized in main.dart
- [ ] MyApp uses navigatorKey for deep link navigation
- [ ] onGenerateRoute handles series_selection route
- [ ] Code compiles without errors

## Success Criteria
- Tapping START button on widget opens SeriesSelectionScreen
- Works when app is closed (cold start)
- Works when app is already running (warm start)
- Deep link URL `pushup5050://series_selection` routes correctly

## Output
After completion, create `.planning/phases/02.2-quick-stats-widget/02.2-03b-SUMMARY.md`
