---
phase: 02.6-widget-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/services/widget_calendar_service.dart
  - push_up_5050/test/services/widget_calendar_service_test.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Calendar service can read DailyRecords from storage"
    - "Calendar service generates 7-day week data (Monday-Sunday)"
    - "Calendar service generates 3-day data for small widget (Yesterday-Today-Tomorrow)"
    - "Calendar service detects completed days (orange), missed days (red X), pending days (gray)"
    - "Calendar service identifies consecutive streak for connecting line display"
    - "All calendar logic tested and passing"
  artifacts:
    - path: "push_up_5050/lib/services/widget_calendar_service.dart"
      provides: "Calendar data generation for widgets"
      min_lines: 150
      exports: ["WidgetCalendarService", "WeekDayData", "CalendarDayStatus"]
    - path: "push_up_5050/test/services/widget_calendar_service_test.dart"
      provides: "TDD tests for calendar logic"
      min_lines: 100
  key_links:
    - from: "WidgetCalendarService"
      to: "StorageService"
      via: "loadDailyRecords() method call"
      pattern: "StorageService.*loadDailyRecords"
    - from: "WidgetCalendarService"
      to: "UserStatsProvider"
      via: "WidgetUpdateService integration"
      pattern: "widgetCalendarService\\.getWeekData"
---

<objective>
Create Calendar Service for Widget Data

Purpose: Centralize calendar data logic for both 4x4 and 2x1 widgets, reading from DailyRecords and providing structured data for rendering

Output: WidgetCalendarService with week data generation, missed day detection, and streak calculation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.6-widget-redesign/02.6-CONTEXT.md
@push_up_5050/lib/providers/user_stats_provider.dart
@push_up_5050/lib/repositories/storage_service.dart
@push_up_5050/lib/models/widget_data.dart
@push_up_5050/lib/models/daily_record.dart
@push_up_5050/lib/core/constants/app_colors.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WeekDayData and CalendarDayStatus models</name>
  <files>push_up_5050/lib/services/widget_calendar_service.dart</files>
  <action>
    Create data models for calendar widget display in widget_calendar_service.dart:

    1. **CalendarDayStatus enum**:
       - completed: Day has >= 1 pushup (orange fill)
       - missed: Day has no record AND is in the past after first workout (red outline with X)
       - pending: Future day or before first workout (gray)
       - today: Current day (special handling)

    2. **WeekDayData class**:
       - day: int (1-31, day of month)
       - dayLabel: String (single letter Italian: L, M, M, G, V, S, D)
       - status: CalendarDayStatus
       - pushups: int (number of pushups, 0 if no record)
       - isPartOfStreak: bool (true if consecutive with previous completed day)

    3. **WeekData class** (for 4x4 widget):
       - days: List&lt;WeekDayData&gt; (7 days, Monday-Sunday)
       - hasStreakLine: bool (true if 2+ consecutive completed days exist)

    Use immutable classes with copyWith, factory constructors, and JSON serialization.
  </action>
  <verify>
    flutter test push_up_5050/test/services/widget_calendar_service_test.dart (after Task 2)
  </verify>
  <done>
    WeekDayData and CalendarDayStatus models exist with proper serialization
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement WidgetCalendarService with TDD</name>
  <files>push_up_5050/lib/services/widget_calendar_service.dart, push_up_5050/test/services/widget_calendar_service_test.dart</files>
  <action>
    Create WidgetCalendarService in widget_calendar_service.dart following TDD:

    **RED phase** (write tests first in widget_calendar_service_test.dart):
    1. test_getWeekData_returns7Days Monday through Sunday
    2. test_getWeekData_completedDaysHaveOrangeStatus
    3. test_getWeekData_missedDaysHaveRedStatus
    4. test_getWeekData_streakLineDetectedForConsecutiveDays
    5. test_getThreeDayData_yesterdayTodayTomorrow
    6. test_getThreeDayData_dynamicLabelsForYesterdayTodayTomorrow
    7. test_getCurrentWeekMonday_returnsCorrectMonday
    8. test_getCurrentWeekMonday_handlesYearBoundary
    9. test_isDayMissed_returnsTrueForPastDaysWithoutRecord
    10. test_isDayMissed_returnsFalseForDaysBeforeFirstWorkout

    **GREEN phase** (implement service):
    1. Constructor takes StorageService dependency
    2. getCurrentWeekMonday(): DateTime - finds Monday of current week
    3. getWeekData(): Future&lt;WeekData&gt; - loads 7 days from Monday to Sunday
       - Calls storage.loadDailyRecords()
       - Maps each day to WeekDayData with correct status
       - Calculates isPartOfStreak based on previous day's completion
    4. getThreeDayData(): Future&lt;List&lt;WeekDayData&gt;&gt; - returns yesterday, today, tomorrow
       - Uses DateTime.now() for today
       - Calculates yesterday/tomorrow dynamically
       - Day labels: "I" (ieri), "O" (oggi), "D" (domani) OR single letter day names
    5. isDayMissed(): bool - checks if day should show as missed
       - True if: day is in past, day has no record, day is after first workout date
       - False if: day is before first workout OR day has any record

    Italian day labels: L (Lunedi), M (Martedi), M (Mercoledi), G (Giovedi), V (Venerdi), S (Sabato), D (Domenica)

    REFACTOR phase: Extract duplicate date logic, simplify status calculation.
  </action>
  <verify>
    flutter test push_up_5050/test/services/widget_calendar_service_test.dart
    All 10 tests pass
  </verify>
  <done>
    WidgetCalendarService implements all calendar logic with 100% test coverage
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend WidgetData with Calendar Week Data</name>
  <files>push_up_5050/lib/models/widget_data.dart</files>
  <action>
    Extend WidgetData model to support the new widget calendar design:

    1. Add new fields to WidgetData class:
       - weekDayData: List&lt;Map&lt;String, dynamic&gt;&gt; - serialized WeekDayData for current week (7 days)
       - threeDayData: List&lt;Map&lt;String, dynamic&gt;&gt; - serialized WeekDayData for yesterday/today/tomorrow (3 days)
       - hasStreakLine: bool - true if 2+ consecutive completed days in week

    2. Update toJson() to include new fields

    3. Update fromJson() to parse new fields with proper defaults

    4. Update copyWith() to handle new fields

    5. Add factory WidgetData.withCalendarData() for easy widget population with calendar info

    Maintain backward compatibility - existing code should work without changes.
  </action>
  <verify>
    flutter test push_up_5050/test/models/widget_data_test.dart (verify existing tests still pass)
    flutter test push_up_5050/test/services/widget_calendar_service_test.dart (verify integration)
  </verify>
  <done>
    WidgetData supports weekDayData and threeDayData for new calendar widgets
  </done>
</task>

</tasks>

<verification>
1. All calendar service tests pass (10+ tests)
2. WidgetData model tests still pass (backward compatibility)
3. Calendar service correctly handles Italian day labels (L M M G V S D)
4. Streak detection works for consecutive days
5. Missed day logic correctly identifies days after first workout without records
</verification>

<success_criteria>
- WidgetCalendarService created with full test coverage
- WeekData, WeekDayData, CalendarDayStatus models implemented
- WidgetData extended with calendar fields (weekDayData, threeDayData, hasStreakLine)
- All calendar logic (missed days, streaks, status) verified with tests
- Ready for integration with WidgetUpdateService in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/02.6-widget-redesign/02.6-01-SUMMARY.md`
</output>
