# Phase 2.6 Plan 01: Calendar Service for Widget Data Summary

**Status:** COMPLETE
**Duration:** ~15 minutes
**Date:** 2026-01-22

## One-Liner
Created WidgetCalendarService with week data generation, missed day detection, streak calculation, and Italian day labels for new widget calendar design.

## Objective Achieved
Centralized calendar data logic for both 4x4 and 2x1 widgets, reading from DailyRecords and providing structured data for rendering.

## Artifacts Delivered

### 1. WidgetCalendarService (`lib/services/widget_calendar_service.dart`)
- **Lines:** 424 (min 150 required)
- **Exports:**
  - `CalendarDayStatus` enum (completed, missed, pending, today)
  - `WeekDayData` class with day, dayLabel, status, pushups, isPartOfStreak
  - `WeekData` class with 7 days and hasStreakLine flag
  - `WidgetCalendarService` class
- **Methods:**
  - `getCurrentWeekMonday(DateTime)`: Finds Monday of current week
  - `getWeekData({DateTime? testDate})`: Generates 7-day calendar (Mon-Sun)
  - `getThreeDayData({DateTime? testDate})`: Generates 3-day data (Ieri/Oggi/Domani)
  - `isDayMissed(DateTime day, DateTime now)`: Detects missed days after first workout

### 2. Calendar Service Tests (`test/services/widget_calendar_service_test.dart`)
- **Lines:** 469 (min 100 required)
- **Tests:** 20 tests, all passing
- **Coverage:**
  - Model tests: WeekDayData, WeekData, CalendarDayStatus
  - Service tests: getWeekData, getThreeDayData, getCurrentWeekMonday, isDayMissed
  - Italian day labels: L, M, M, G, V, S, D

### 3. Extended WidgetData (`lib/models/widget_data.dart`)
- **New Fields:**
  - `weekDayData: List<Map<String, dynamic>>` - 7-day week data
  - `threeDayData: List<Map<String, dynamic>>` - Yesterday/today/tomorrow
  - `hasStreakLine: bool` - Streak line display flag
- **New Factory:**
  - `WidgetData.withCalendarData()` - Easy widget population with calendar info
- **Backward Compatibility:** All existing tests pass

## Key Technical Details

### Italian Day Labels
- Week view: L (Lunedi), M (Martedi), M (Mercoledi), G (Giovedi), V (Venerdi), S (Sabato), D (Domenica)
- 3-day view: I (Ieri), O (Oggi), D (Domani)

### Status Determination Logic
- **completed:** Day has >= 1 pushup (orange fill)
- **missed:** Day has no record AND is in the past after first workout (red outline with X)
- **pending:** Future day or before first workout (gray)
- **today:** Current day (special handling)

### Streak Line Calculation
- `isPartOfStreak: true` when day is consecutive with previous completed day
- `hasStreakLine: true` when 2+ consecutive completed days exist in week
- Used for drawing connection lines between consecutive completed days

## Dependencies

### Requires
- `StorageService.loadDailyRecords()` - Reads workout history
- `DailyRecord` model - Push-up data per day

### Provides
- Calendar data structure for WidgetData model
- Foundation for 4x4 and 2x1 widget rendering
- Integration point for WidgetUpdateService in next plan

## Deviations from Plan

None - plan executed exactly as written.

## Commits

1. `5dac759` feat(02.6-01): create WidgetCalendarService with calendar data models
   - Tasks 1-2: Models and service implementation with TDD
   - 20 tests passing

2. `f657cef` feat(02.6-01): extend WidgetData with calendar week data fields
   - Task 3: Extended model with new calendar fields
   - Backward compatibility maintained

## Next Phase Readiness

**Ready for:** Phase 2.6 Plan 02 - Update WidgetUpdateService to use WidgetCalendarService

**Integration Points:**
- WidgetUpdateService will call `getWeekData()` and `getThreeDayData()`
- WidgetData.withCalendarData() will be used to populate widget data
- Android widgets will render based on weekDayData and threeDayData
