# Phase 04.3: Goal Completion Popup - Research

**Researched:** 2026-01-30
**Domain:** Flutter Dialog/Popup Widgets with Celebration Effects
**Confidence:** HIGH

## Summary

Phase 04.3 requires a congratulations popup that appears when daily push-up goal is achieved. The popup must:
1. Appear immediately when goal is reached during workout
2. Show once when app opens (if goal already completed today)
3. Use confetti celebration effects (no trophy icon)
4. Auto-dismiss after 5 seconds or on tap-outside/button
5. Navigate to statistics screen after dismissal

**Research findings:**
- **Existing pattern to reuse:** `GoalCelebrationWidget` already implements confetti animation with 50 particles
- **Dialog pattern:** Use `showDialog` with `Dialog` widget (centered, dimmed background)
- **Storage:** Use `shared_preferences` for "shown today" flag (simplest approach)
- **State detection:** `ActiveWorkoutProvider.session.goalReached` already tracks goal completion

**Primary recommendation:** Reuse existing `GoalCelebrationWidget` confetti implementation with a new `GoalCompletionDialog` that uses showDialog for modal behavior.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Flutter showDialog | Built-in | Modal dialog with dimmed background | Official Flutter API for dialogs |
| shared_preferences | ^2.2.2 (already in pubspec) | Store "shown today" flag | Already in project, simple key-value storage |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| GoalCelebrationWidget | Existing | Confetti animation code | Reuse existing particle system |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| shared_preferences | DailyRecord flag | DailyRecord already exists but adding non-record data mixes concerns; SharedPreferences is cleaner for UI state |
| showDialog | BottomSheet | Context requires centered dialog, not sheet from bottom |

**Installation:**
No new dependencies needed. All required libraries already in pubspec.yaml.

## Architecture Patterns

### Recommended Project Structure
```
push_up_5050/lib/
├── widgets/
│   └── goal_completion/
│       ├── goal_completion_dialog.dart    # Main dialog widget
│       └── confetti_overlay.dart          # Optional: extracted from GoalCelebrationWidget
├── providers/
│   └── goal_completion_provider.dart      # Tracks "shown today" flag (optional, can use SharedPreferences directly)
└── screens/
    └── workout_execution/
        └── workout_execution_screen.dart  # Trigger popup on goal reached
```

### Pattern 1: showDialog with Confetti
**What:** Show a centered dialog with confetti overlay for celebration
**When to use:** Goal completion during workout, app-open reminder
**Example:**
```dart
// Triggered from WorkoutExecutionScreen when goal reached
showDialog(
  context: context,
  barrierDismissible: true,  // Tap outside to dismiss
  builder: (context) => GoalCompletionDialog(
    onDismiss: () {
      Navigator.of(context).pop();
      // Navigate to statistics after 500ms delay
      Future.delayed(const Duration(milliseconds: 500), () {
        Navigator.of(context).pushReplacementNamed('/statistics');
      });
    },
  ),
);
```

### Pattern 2: "Shown Today" Flag with SharedPreferences
**What:** Store last popup display date, show only once per day
**When to use:** App-open popup check
**Example:**
```dart
// Check if should show popup today
Future<bool> shouldShowGoalPopup() async {
  final prefs = await SharedPreferences.getInstance();
  final lastShown = prefs.getString('goal_popup_last_shown');
  final today = DateTime.now().toIso8601String().split('T')[0];

  if (lastShown == today) {
    return false; // Already shown today
  }

  // Goal was completed, show popup
  await prefs.setString('goal_popup_last_shown', today);
  return true;
}
```

### Anti-Patterns to Avoid
- **Adding goalPopupShown to DailyRecord:** Don't mix UI state with data model; use SharedPreferences instead
- **Creating separate confetti library:** Don't duplicate existing GoalCelebrationWidget code; reuse it
- **Full-screen overlay for dialog:** Don't use full-screen modal; showDialog with Dialog is the standard pattern

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Confetti animation | Custom particle system from scratch | Reuse GoalCelebrationWidget particles | 50-particle system already exists, proven to work |
| Dialog overlay | Custom Stack/Positioned widgets | showDialog with Dialog | Built-in handles barrier, dismissal, animations |
| "Shown today" tracking | Custom file storage | SharedPreferences | Already in project, simple key-value API |

**Key insight:** The codebase already has a working confetti celebration. Reuse it rather than building from scratch.

## Common Pitfalls

### Pitfall 1: Popup Shows Multiple Times
**What goes wrong:** Popup appears every time screen rebuilds or app resumes
**Why it happens:** No tracking of "shown today" state
**How to avoid:** Store last display date in SharedPreferences, check before showing
**Warning signs:** Popup appears repeatedly on same day

### Pitfall 2: Navigation Race Conditions
**What goes wrong:** Statistics screen navigation fails or double-navigates
**Why it happens:** Dialog dismissal and navigation happen simultaneously
**How to avoid:** Use small delay (500ms) after dialog pop before navigation
**Warning signs:** "NoSuchMethodError" or navigation stack errors

### Pitfall 3: Confetti Not Showing on Dialog
**What goes wrong:** Confetti particles appear behind dialog background
**Why it happens:** Dialog content overlay covers confetti Stack
**How to avoid:** Use Stack in dialog with confetti as first layer, content on top
**Warning signs:** Confetti not visible or partially hidden

### Pitfall 4: Goal Check Timing
**What goes wrong:** Popup shows before final rep completes or shows incorrectly
**Why it happens:** Goal check happens at wrong point in workout flow
**How to avoid:** Check `provider.session.goalReached` after series completion, similar to existing celebration logic
**Warning signs:** Popup shows on partial goal completion

## Code Examples

### Goal Completion Dialog Structure
```dart
class GoalCompletionDialog extends StatelessWidget {
  final VoidCallback onDismiss;

  const GoalCompletionDialog({
    super.key,
    required this.onDismiss,
  });

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      child: Stack(
        children: [
          // Confetti overlay (reuse GoalCelebrationWidget particles)
          _ConfettiOverlay(),

          // Dialog content
          Center(
            child: Container(
              width: 320,
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                color: AppColors.background,
                borderRadius: BorderRadius.circular(20),
                border: Border.all(color: AppColors.primaryOrange, width: 3),
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  // Celebration message (Italian)
                  Text(
                    'Complimenti!',
                    style: TextStyle(
                      color: AppColors.primaryOrange,
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 12),
                  Text(
                    'Hai completato il tuo obiettivo di oggi.\nCi vediamo domani!',
                    style: TextStyle(color: Colors.white, fontSize: 16),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 20),
                  // "Continua" button
                  ElevatedButton(
                    onPressed: onDismiss,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primaryOrange,
                    ),
                    child: const Text('Continua'),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}
```

### Trigger from WorkoutExecutionScreen
```dart
// In _handleGoalCompletion method (modify existing)
if (provider.session.goalReached) {
  // Show goal completion dialog
  if (mounted) {
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => GoalCompletionDialog(
        onDismiss: () async {
          Navigator.of(context).pop(); // Close dialog
          await provider.endWorkout();
          // Navigate to statistics after delay
          await Future.delayed(const Duration(milliseconds: 500));
          if (context.mounted) {
            Navigator.of(context).pushReplacementNamed('/statistics');
          }
        },
      ),
    );
  }
}
```

### App-Open Check in Main App Widget
```dart
// In MyApp or home screen initState
void _checkAndShowGoalCompletion() async {
  final userStats = context.read<UserStatsProvider>();

  // Only show if goal is complete
  if (!userStats.isTodayGoalComplete) return;

  // Check if already shown today
  final prefs = await SharedPreferences.getInstance();
  final lastShown = prefs.getString('goal_popup_last_shown');
  final today = DateTime.now().toIso8601String().split('T')[0];

  if (lastShown == today) return;

  // Mark as shown
  await prefs.setString('goal_popup_last_shown', today);

  // Show popup (no navigation after)
  if (mounted) {
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => GoalCompletionDialog(
        onDismiss: () => Navigator.of(context).pop(),
      ),
    );
  }
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Full-screen custom overlay | showDialog with Dialog | Flutter 1.20+ | Standard API, better behavior |
| Manual animation | AnimationController with Curves | Flutter 2.0+ | Smoother, less boilerplate |

**Deprecated/outdated:**
- **showOverlay (non-standard):** Never official, use showDialog instead

## Open Questions

None — all implementation details are clear from existing codebase patterns.

## Sources

### Primary (HIGH confidence)
- Existing codebase: `lib/widgets/workout/achievement_popup.dart` — Slide-in popup pattern
- Existing codebase: `lib/widgets/workout/goal_celebration.dart` — Confetti animation system
- Existing codebase: `lib/providers/active_workout_provider.dart` — goalReached flag tracking
- Flutter docs: showDialog API — Standard dialog pattern

### Secondary (MEDIUM confidence)
- Phase 04.3-CONTEXT.md — User decisions and implementation constraints

### Tertiary (LOW confidence)
- None — all findings from codebase analysis or official Flutter patterns

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already in project or built-in Flutter
- Architecture: HIGH - Patterns from existing codebase (achievement_popup, goal_celebration)
- Pitfalls: HIGH - Common Flutter dialog/navigation issues well-documented

**Research date:** 2026-01-30
**Valid until:** 60 days (stable Flutter APIs, existing patterns)
