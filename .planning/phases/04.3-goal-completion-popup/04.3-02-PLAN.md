# Plan 04.3-02: Popup Trigger on Goal Reached

**Wave:** 1
**Depends on:** 04.3-01
**Files modified:**
- `push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart` (modify)

**Autonomous:** Yes

---

## Objective

Modify WorkoutExecutionScreen to show the goal completion popup when daily goal is reached during workout. The popup appears immediately after the final series completes, then navigates to statistics screen after dismissal.

## Context

@.planning/phases/04.3-goal-completion-popup/04.3-RESEARCH.md
@.planning/phases/04.3-goal-completion-popup/04.3-CONTEXT.md
@.planning/phases/04.3-goal-completion-popup/04.3-01-PLAN.md
@push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart
@push_up_5050/lib/providers/active_workout_provider.dart
@push_up_5050/lib/screens/statistics/statistics_screen.dart

## Tasks

<tasks>
### Task 1: Modify _handleGoalCompletion to show popup

In `workout_execution_screen.dart`, update the `_handleGoalCompletion` method:

1. **Current behavior** (lines 257-279):
   - Calls `provider.endWorkout()`
   - Plays goal achievement sound
   - Navigates back to Home

2. **New behavior**:
   - Show `GoalCompletionDialog` using `showDialog`
   - Dialog's `onDismiss` callback should:
     a. Pop the dialog
     b. Call `provider.endWorkout()`
     c. Play goal achievement sound (already exists)
     d. Navigate to Statistics screen (not Home)
     e. Use 500ms delay between dialog pop and statistics navigation

3. **Implementation**:
```dart
Future<void> _handleGoalCompletion(
  ActiveWorkoutProvider provider,
  BuildContext context,
) async {
  // Prevent double-completion
  if (_isCompleting) return;
  _isCompleting = true;

  // Show goal completion dialog
  if (mounted) {
    await showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => GoalCompletionDialog(
        onDismiss: () async {
          Navigator.of(context).pop(); // Close dialog

          // End workout (saves session, clears active session)
          await provider.endWorkout();

          // Play goal achievement sound
          final settings = context.read<AppSettingsService>();
          final audio = context.read<AudioService>();
          if (settings.soundsEnabled && settings.goalSoundEnabled) {
            audio.playGoalAchieved();
          }

          // Navigate to statistics after short delay
          await Future.delayed(const Duration(milliseconds: 500));
          if (mounted) {
            Navigator.of(context).pushReplacementNamed('/statistics');
          }
        },
      ),
    );
  }
}
```

### Task 2: Add import for GoalCompletionDialog

Add import at top of `workout_execution_screen.dart`:
```dart
import 'package:push_up_5050/widgets/goal_completion/goal_completion_dialog.dart';
```

### Task 3: Remove old GoalCelebrationWidget call (if exists)

Check if there's any remaining `_showCelebration` state or `GoalCelebrationWidget` usage that should be removed. The existing `GoalCelebrationWidget` at line 318-322 shows a temporary "X Push-up Completati!" message. Keep this as-is (it shows during rep counting), but ensure goal completion uses the new dialog instead.

### Task 4: Create integration test

Create `push_up_5050/integration_test/goal_completion_popup_test.dart`:

1. Test flow: Complete workout to goal → verify dialog appears → dismiss → verify navigation to statistics
2. Use test widget setup with mock providers
3. Verify dialog message text
4. Verify statistics screen is shown after dismissal

</tasks>

## Success Criteria

1. GoalCompletionDialog appears when goal is reached during workout
2. Dialog shows Italian message: "Complimenti! Hai completato il tuo obiettivo di oggi. Ci vediamo domani!"
3. "Continua" button or tap-outside dismisses dialog
4. After dismissal, statistics screen opens (not Home screen)
5. 500ms delay between dialog dismissal and navigation (smooth UX)
6. Workout is properly saved (endWorkout called)
7. Integration test passes

## must_haves

- showDialog used for modal dialog
- Navigation goes to Statistics screen, not Home
- endWorkout() called after dialog dismissal (before navigation)
- 500ms delay for smooth transition
- Italian message matches specification exactly
- Integration test covers full flow

## Verification

Run integration test:
```bash
flutter test integration_test/goal_completion_popup_test.dart
```

Manual verification:
1. Start workout with low goal (e.g., 10 push-ups)
2. Complete push-ups to reach goal
3. Verify dialog appears immediately
4. Verify message text is correct Italian
5. Tap "Continua" button
6. Verify statistics screen opens (not Home screen)
7. Check that workout was saved (refresh app, check stats)

## Edge Cases

- User taps outside dialog: should dismiss and navigate to statistics
- User taps "Continua" button: same behavior
- App loses focus during dialog: should resume showing dialog
- Dialog already showing when goal reached again: should not show twice (isCompleting flag)
