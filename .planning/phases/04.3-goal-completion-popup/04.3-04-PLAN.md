# Plan 04.3-04: Navigation to Statistics After Popup

**Wave:** 2
**Depends on:** 04.3-02
**Files modified:**
- `push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart` (verify)

**Autonomous:** Yes

---

## Objective

Verify that the goal completion popup navigation flows correctly to the statistics screen after dismissal. This plan ensures the navigation path is complete and handles edge cases like double-navigation prevention and proper state cleanup.

## Context

@.planning/phases/04.3-goal-completion-popup/04.3-RESEARCH.md
@.planning/phases/04.3-goal-completion-popup/04.3-CONTEXT.md
@.planning/phases/04.3-goal-completion-popup/04.3-02-PLAN.md
@push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart
@push_up_5050/lib/screens/statistics/statistics_screen.dart
@push_up_5050/lib/main.dart

## Tasks

<tasks>
### Task 1: Verify statistics route exists

Check `main.dart` for the statistics route definition:

1. **Find route for statistics screen**:
   - Look for `/statistics` route in routes parameter of MaterialApp
   - Ensure it maps to `StatisticsScreen`
   - If missing, add the route

2. **Expected route**:
```dart
routes: {
  '/': (context) => const HomeScreen(),
  '/workout': (context) => const SeriesSelectionScreen(),
  '/workout/execution': (context) => const WorkoutExecutionScreen(),
  '/statistics': (context) => const StatisticsScreen(),
  // ... other routes
}
```

### Task 2: Verify navigation in _handleGoalCompletion

Review the `_handleGoalCompletion` method from plan 04.3-02:

1. **Check navigation path**:
   - Dialog dismiss → endWorkout() → 500ms delay → pushReplacementNamed('/statistics')
   - Verify `pushReplacementNamed` is used (not `pushNamed`)

2. **Verify mounted checks**:
   - After delay, check `context.mounted` before navigation
   - Prevent navigation if widget is disposed

3. **Verify _isCompleting flag**:
   - Set to true before showing dialog
   - Prevents double-completion if called multiple times

### Task 3: Add navigation guard (if needed)

If statistics route doesn't exist, add it to `main.dart`:

1. **Import statistics screen**:
```dart
import 'package:push_up_5050/screens/statistics/statistics_screen.dart';
```

2. **Add route** (if missing):
```dart
'/statistics': (context) => const StatisticsScreen(),
```

### Task 4: Create integration test for navigation

Create `push_up_5050/integration_test/goal_popup_navigation_test.dart`:

1. **Test setup**:
   - Mock providers with completed goal
   - Pump WorkoutExecutionScreen widget

2. **Test navigation flow**:
   - Trigger goal completion
   - Verify dialog appears
   - Tap dismiss button
   - Verify dialog closes
   - Verify statistics screen is pushed

3. **Test double-navigation prevention**:
   - Try triggering goal completion twice quickly
   - Verify only one dialog appears
   - Verify only one navigation happens

</tasks>

## Success Criteria

1. `/statistics` route exists and maps to StatisticsScreen
2. After goal completion popup dismissal, statistics screen opens
3. Navigation uses `pushReplacementNamed` (replaces workout screen)
4. 500ms delay provides smooth transition
5. Double-navigation prevention works (_isCompleting flag)
6. Integration test verifies full navigation flow

## must_haves

- `/statistics` route defined in main.dart
- pushReplacementNamed used for navigation
- 500ms delay between dialog pop and navigation
- context.mounted check before navigation
- _isCompleting flag prevents double-completion
- Integration test passes

## Verification

Run integration test:
```bash
flutter test integration_test/goal_popup_navigation_test.dart
```

Manual verification:
1. Start workout and complete daily goal
2. Verify popup appears
3. Tap "Continua" button
4. Verify statistics screen opens (workout screen is replaced)
5. Press back → should go to Home screen (not back to workout)
6. Repeat test, verify smooth transition

## Edge Cases

- User dismisses dialog by tapping outside: same navigation flow
- User rapidly taps button: only one navigation happens
- App backgrounded during dialog: navigation still works on resume
- Workout screen disposed during delay: mounted check prevents crash

## Notes

- This plan primarily verifies work from 04.3-02
- If statistics route already exists, this plan is mainly testing
- The 500ms delay is intentional for smooth UX (from CONTEXT.md)
