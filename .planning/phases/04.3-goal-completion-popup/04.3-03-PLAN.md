# Plan 04.3-03: Popup Trigger on App Open After Goal Completion

**Wave:** 2
**Depends on:** 04.3-01
**Files modified:**
- `push_up_5050/lib/screens/home/home_screen.dart` (modify)
- `push_up_5050/lib/repositories/storage_service.dart` (optional - add helper methods)

**Autonomous:** Yes

---

## Objective

Add app-open check that shows the goal completion popup once per day when the app opens and the daily goal has already been completed. The popup stays on current screen (no navigation after dismissal) and tracks "shown today" to prevent re-showing.

## Context

@.planning/phases/04.3-goal-completion-popup/04.3-RESEARCH.md
@.planning/phases/04.3-goal-completion-popup/04.3-CONTEXT.md
@.planning/phases/04.3-goal-completion-popup/04.3-01-PLAN.md
@push_up_5050/lib/screens/home/home_screen.dart
@push_up_5050/lib/providers/user_stats_provider.dart
@push_up_5050/lib/repositories/storage_service.dart

## Tasks

<tasks>
### Task 1: Add "shown today" tracking to StorageService

In `storage_service.dart`, add methods for tracking popup display:

1. **Constants**:
```dart
static const String _keyGoalPopupLastShown = 'goal_popup_last_shown';
```

2. **Method to get last shown date**:
```dart
/// Get the last date (YYYY-MM-DD) when goal completion popup was shown.
Future<String?> getGoalPopupLastShown() async {
  final prefs = await SharedPreferences.getInstance();
  return prefs.getString(_keyGoalPopupLastShown);
}
```

3. **Method to set last shown date**:
```dart
/// Mark that goal completion popup was shown today.
Future<void> setGoalPopupShownToday() async {
  final prefs = await SharedPreferences.getInstance();
  final today = DateTime.now().toIso8601String().split('T')[0];
  await prefs.setString(_keyGoalPopupLastShown, today);
}
```

4. **Method to check if should show popup**:
```dart
/// Check if goal completion popup should be shown today.
/// Returns true only if goal is complete AND popup hasn't been shown today.
Future<bool> shouldShowGoalCompletionPopup() async {
  // Check if today's goal is complete
  final today = DateTime.now();
  final todayRecord = await getDailyRecord(today);
  final goal = getDailyGoal();
  if ((todayRecord?.totalPushups ?? 0) < goal) {
    return false; // Goal not complete
  }

  // Check if already shown today
  final lastShown = await getGoalPopupLastShown();
  final todayStr = today.toIso8601String().split('T')[0];
  if (lastShown == todayStr) {
    return false; // Already shown today
  }

  return true;
}
```

5. **Method to show and mark**:
```dart
/// Show popup and mark as shown for today (convenience method).
Future<bool> showAndMarkGoalCompletionPopup() async {
  if (!await shouldShowGoalCompletionPopup()) {
    return false;
  }
  await setGoalPopupShownToday();
  return true;
}
```

### Task 2: Add app-open check to HomeScreen

In `home_screen.dart`, add popup check on app open:

1. **Import GoalCompletionDialog**:
```dart
import 'package:push_up_5050/widgets/goal_completion/goal_completion_dialog.dart';
```

2. **Add initState check**:
```dart
@override
void initState() {
  super.initState();
  // Delay slightly to allow providers to initialize
  WidgetsBinding.instance.addPostFrameCallback((_) {
    _checkAndShowGoalCompletion();
  });
}
```

3. **Add check method**:
```dart
Future<void> _checkAndShowGoalCompletion() async {
  final storage = context.read<StorageService>();

  // Check if should show (includes goal complete check)
  final shouldShow = await storage.showAndMarkGoalCompletionPopup();
  if (!shouldShow) return;

  // Show popup (no navigation after dismissal)
  if (mounted) {
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => GoalCompletionDialog(
        onDismiss: () {
          Navigator.of(context).pop(); // Just close dialog, stay on Home
        },
      ),
    );
  }
}
```

### Task 3: Handle app lifecycle (resume from background)

Add `WidgetsBindingObserver` to HomeScreen to show popup when app resumes from background:

1. **Mix in WidgetsBindingObserver**:
```dart
class _HomeScreenState extends State<HomeScreen> with WidgetsBindingObserver {
```

2. **In initState**:
```dart
@override
void initState() {
  super.initState();
  WidgetsBinding.instance.addObserver(this);
  // ... existing postFrameCallback
}
```

3. **In dispose**:
```dart
@override
void dispose() {
  WidgetsBinding.instance.removeObserver(this);
  super.dispose();
}
```

4. **Add didChangeAppLifecycleState**:
```dart
@override
void didChangeAppLifecycleState(AppLifecycleState state) {
  if (state == AppLifecycleState.resumed) {
    // Check if should show popup when app resumes
    _checkAndShowGoalCompletion();
  }
}
```

### Task 4: Create widget test

Create test for the "shown today" tracking logic in StorageService:

In `push_up_5050/test/repositories/storage_service_goal_popup_test.dart`:

1. Test `shouldShowGoalCompletionPopup` returns false when goal not complete
2. Test returns true when goal complete and not shown today
3. Test returns false when already shown today
4. Test `setGoalPopupShownToday` stores correct date
5. Test date resets at midnight (use mock dates)

</tasks>

## Success Criteria

1. GoalCompletionDialog appears when app opens if goal was completed earlier today
2. Popup shows only once per day (tracked via SharedPreferences)
3. Popup stays on current screen (no navigation after dismissal)
4. Popup appears when app resumes from background (if not yet shown today)
5. Popup does NOT appear if goal is not yet complete
6. StorageService methods work correctly for tracking
7. Widget tests for tracking logic pass

## must_haves

- SharedPreferences key 'goal_popup_last_shown' for tracking
- StorageService methods: getGoalPopupLastShown, setGoalPopupShownToday, shouldShowGoalCompletionPopup
- HomeScreen checks in initState with postFrameCallback
- HomeScreen implements WidgetsBindingObserver for resume case
- No navigation after app-open popup dismissal
- Popup only shows when goal is complete
- Popup only shows once per day

## Verification

Run tests:
```bash
flutter test test/repositories/storage_service_goal_popup_test.dart
```

Manual verification:
1. Complete daily goal in a workout
2. Close app fully
3. Reopen app → verify popup appears
4. Dismiss popup → verify stays on Home screen
5. Close and reopen app → verify popup does NOT appear again
6. Wait until next day → verify popup can appear again

## Edge Cases

- Goal completed yesterday, not today: no popup
- Goal completed today, app opened multiple times: popup only first time
- App resumes from background: popup appears if not yet shown today
- User hasn't completed goal yet: no popup
- Midnight crossover: resets "shown today" flag

## Notes

- The popup shows on Home screen because that's where users land when opening the app
- No navigation after dismissal because user may want to continue using app from current screen
- The 5-second auto-dismiss still applies
