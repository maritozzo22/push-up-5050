# Phase 03.1: Personalized Onboarding - Research

**Researched:** 2026-01-23
**Domain:** Flutter onboarding flow, multi-step forms, state management, personalized fitness recommendations
**Confidence:** HIGH

## Summary

This phase requires implementing a 4-screen onboarding flow that replaces the existing 3-page onboarding with a personalized fitness assessment. The new flow collects:
1. Activity level (4 options: Sedentary, Lightly Active, Active, Very Active)
2. Max push-up capacity (slider with presets: 5, 10, 20, 30, 40, 50)
3. Workout frequency (1-7 days per week)
4. Daily goal target (slider with presets: 20, 30, 40, 50, 60, 75, 100)

The system calculates personalized recommendations for starting series (1/2/5/10), daily goal, and recovery time (30/45/60s) based on user inputs. Onboarding is mandatory (no skip button) and values persist via the existing `GoalsProvider` and `StorageService`. The existing onboarding at `lib/screens/onboarding/onboarding_screen.dart` will be replaced.

**Primary recommendation:** Use a single StatefulWidget with PageView for the 4 screens, managed state for form data, and leverage existing FrostCard/design system widgets for visual consistency.

## Standard Stack

The project already uses these established libraries and patterns:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Flutter PageView | Built-in | Multi-step onboarding screens | Standard Flutter pattern for onboarding |
| Provider | ^6.x | State management (already in project) | Project already uses Provider for all state |
| shared_preferences | ^2.x | Persistence via StorageService | Existing pattern for onboarding flag and goals |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Slider | Built-in | Capacity and goal selection | Use `divisions` parameter for discrete steps |
| Radio widgets | Built-in | Activity level card selection | Custom card wrapping Radio or RadioListTile |

### Existing Codebase Components to Reuse
| Component | Location | Purpose |
|-----------|----------|---------|
| StorageService | `lib/repositories/storage_service.dart` | Already has `setOnboardingCompleted()`, `isOnboardingCompleted()`, `setDailyGoal()`, `setMonthlyGoal()` |
| GoalsProvider | `lib/providers/goals_provider.dart` | Already manages daily/monthly goals |
| ActiveWorkoutProvider | `lib/providers/active_workout_provider.dart` | Has `saveWorkoutPreferences()` for starting series and rest time |
| OnboardingScreen | `lib/screens/onboarding/onboarding_screen.dart` | Reference for existing patterns (to be replaced) |
| AppColors | `lib/core/constants/app_colors.dart` | Orange theme colors for consistency |
| AppTheme | `lib/core/theme/app_theme.dart` | Dark theme, Montserrat font |
| AppTextStyles | `lib/core/theme/app_theme.dart` | Text style constants |
| FrostCard | `lib/widgets/design_system/frost_card.dart` | Reusable glass-morphism card widget |

**Installation:**
No new packages needed. All required dependencies are already in `pubspec.yaml`.

## Architecture Patterns

### Recommended Project Structure
```
lib/screens/onboarding/
├── personalized_onboarding_screen.dart    # Main entry point, replaces existing onboarding
├── widgets/
│   ├── activity_level_selection.dart      # Screen 1: Activity level cards
│   ├── capacity_slider.dart               # Screen 2: Max push-ups slider
│   ├── frequency_selector.dart            # Screen 3: Days per week
│   └── daily_goal_slider.dart             # Screen 4: Daily goal slider
└── models/
    └── onboarding_data.dart               # Data model for user responses
```

### Pattern 1: Single StatefulWidget with PageView
**What:** A stateful widget that manages a PageView with 4 pages, each collecting one piece of data. State lives in the parent, passed to children.

**When to use:** When you need linear flow with back navigation and shared state across steps.

**Example:**
```dart
// Based on existing OnboardingScreen pattern
class PersonalizedOnboardingScreen extends StatefulWidget {
  const PersonalizedOnboardingScreen({super.key});

  @override
  State<PersonalizedOnboardingScreen> createState() => _PersonalizedOnboardingScreenState();
}

class _PersonalizedOnboardingScreenState extends State<PersonalizedOnboardingScreen> {
  late PageController _pageController;
  int _currentPage = 0;

  // Onboarding data state
  ActivityLevel _activityLevel = ActivityLevel.intermediate;
  int _maxCapacity = 20;
  int _frequencyDays = 5;
  int _dailyGoal = 50;

  @override
  void initState() {
    super.initState();
    _pageController = PageController(initialPage: 0);
  }

  void _goToNext() {
    if (_currentPage < 3) {
      _pageController.nextPage(
        duration: const Duration(milliseconds: 300),
        curve: Curves.easeInOut,
      );
    }
  }

  void _goBack() {
    if (_currentPage > 0) {
      _pageController.previousPage(
        duration: const Duration(milliseconds: 300),
        curve: Curves.easeInOut,
      );
    }
  }

  Future<void> _completeOnboarding() async {
    final storage = context.read<StorageService>();

    // Calculate personalized recommendations
    final recommendations = _calculateRecommendations();

    // Save goals
    await storage.setDailyGoal(recommendations.dailyGoal);
    await storage.setMonthlyGoal(recommendations.dailyGoal * 30);
    await storage.setOnboardingCompleted(true);

    // Save workout preferences (starting series, recovery time)
    final workoutProvider = context.read<ActiveWorkoutProvider>();
    await workoutProvider.saveWorkoutPreferences(
      startingSeries: recommendations.startingSeries,
      restTime: recommendations.recoveryTime,
    );

    if (mounted) {
      Navigator.of(context).pushReplacement(
        MaterialPageRoute(builder: (_) => const MainNavigationWrapper()),
      );
    }
  }

  OnboardingRecommendations _calculateRecommendations() {
    // Starting series based on capacity
    int startingSeries;
    if (_maxCapacity <= 10) {
      startingSeries = 1;
    } else if (_maxCapacity <= 20) {
      startingSeries = 2;
    } else if (_maxCapacity <= 30) {
      startingSeries = 5;
    } else {
      startingSeries = 10;
    }

    // Daily goal from user input
    int dailyGoal = _dailyGoal;

    // Recovery time based on activity level
    int recoveryTime;
    switch (_activityLevel) {
      case ActivityLevel.sedentary:
        recoveryTime = 60;
        break;
      case ActivityLevel.lightlyActive:
        recoveryTime = 45;
        break;
      case ActivityLevel.active:
      case ActivityLevel.veryActive:
        recoveryTime = 30;
        break;
    }

    return OnboardingRecommendations(
      startingSeries: startingSeries,
      dailyGoal: dailyGoal,
      recoveryTime: recoveryTime,
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFF1A1A1A), Color(0xFF0D0D0D)],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              Expanded(
                child: PageView(
                  controller: _pageController,
                  onPageChanged: (index) {
                    setState(() => _currentPage = index);
                  },
                  children: [
                    ActivityLevelSelection(
                      selectedLevel: _activityLevel,
                      onChanged: (level) => setState(() => _activityLevel = level),
                    ),
                    CapacitySlider(
                      value: _maxCapacity,
                      onChanged: (value) => setState(() => _maxCapacity = value),
                    ),
                    FrequencySelector(
                      value: _frequencyDays,
                      onChanged: (value) => setState(() => _frequencyDays = value),
                    ),
                    DailyGoalSlider(
                      value: _dailyGoal,
                      onChanged: (value) => setState(() => _dailyGoal = value),
                    ),
                  ],
                ),
              ),
              _buildBottomControls(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildBottomControls() {
    // Dot indicator (4 dots for 4 screens)
    // Back/Next buttons based on current page
    // Last page shows "Get Started" button
  }
}
```

### Pattern 2: Activity Level Card Selection
**What:** Custom selectable cards that behave like radio buttons. Each card has an icon, title, and description. Selected state is highlighted.

**When to use:** When users need to select one option from 3-4 visual choices.

**Example:**
```dart
// Card selection with visual feedback
class ActivityLevelCard extends StatelessWidget {
  final ActivityLevel level;
  final ActivityLevel selectedLevel;
  final VoidCallback onTap;

  const ActivityLevelCard({
    required this.level,
    required this.selectedLevel,
    required this.onTap,
  });

  bool get isSelected => level == selectedLevel;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        decoration: BoxDecoration(
          gradient: isSelected
              ? const LinearGradient(
                  colors: [Color(0xFFFFB347), Color(0xFFFF5F1F)],
                )
              : null,
          color: isSelected ? null : const Color(0xFF1B1E24).withOpacity(0.55),
          borderRadius: BorderRadius.circular(20),
          border: Border.all(
            color: isSelected
                ? Colors.transparent
                : Colors.white.withOpacity(0.10),
            width: 1,
          ),
        ),
        child: Column(
          children: [
            // Icon
            // Title
            // Description
          ],
        ),
      ),
    );
  }
}
```

### Pattern 3: Slider with Discrete Steps
**What:** Flutter Slider widget with `divisions` parameter for discrete preset values.

**When to use:** For numeric selections within a range (capacity, daily goal).

**Example:**
```dart
// Slider with preset values
class CapacitySlider extends StatelessWidget {
  final int value;
  final ValueChanged<int> onChanged;

  // Preset values map to slider positions
  static const List<int> presetValues = [5, 10, 20, 30, 40, 50];

  int get sliderIndex => presetValues.indexOf(value);

  @override
  Widget build(BuildContext context) {
    return SliderTheme(
      data: SliderTheme.of(context).copyWith(
        activeTrackColor: const Color(0xFFFFB347),
        inactiveTrackColor: Colors.white.withOpacity(0.20),
        thumbColor: const Color(0xFFFFB347),
        overlayColor: const Color(0xFFFFB347).withOpacity(0.20),
        trackHeight: 4,
      ),
      child: Slider(
        value: sliderIndex.toDouble(),
        min: 0,
        max: presetValues.length - 1,
        divisions: presetValues.length - 1,
        onChanged: (index) {
          onChanged(presetValues[index.toInt()]);
        },
      ),
    );
  }
}
```

### Anti-Patterns to Avoid
- **Separate StatefulWidget for each screen:** Makes data passing complex. Use single parent with PageView instead.
- **Form widget with validation keys:** Overkill for simple onboarding. Direct state is simpler.
- **Navigator.push for each step:** Breaks back gesture. Use PageView for swipeable flow.
- **Global state for onboarding data:** Unnecessary complexity. Keep local to the widget tree.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Onboarding completion tracking | Custom SharedPreferences calls | `StorageService.setOnboardingCompleted()` | Already implemented, has `isOnboardingCompleted()` |
| Goal persistence | New storage keys | `StorageService.setDailyGoal()`, `setMonthlyGoal()` | Existing API integrates with GoalsProvider |
| Workout preferences | New storage class | `ActiveWorkoutProvider.saveWorkoutPreferences()` | Already persists startingSeries and restTime |
| Glass effect cards | Custom BackdropFilter each time | `FrostCard` widget from `lib/widgets/design_system/` | Reusable, consistent design |
| Gradient buttons | Custom Container + BoxDecoration | Reuse `_GradientButton` pattern from existing onboarding | Consistent styling, press animations |

**Key insight:** The existing codebase has complete persistence for onboarding data. Don't introduce new storage keys or patterns.

## Common Pitfalls

### Pitfall 1: Not persisting starting series and recovery time
**What goes wrong:** Onboarding sets daily goal, but workout preferences (starting series, recovery time) aren't saved, so users get defaults on first workout.

**Why it happens:** `StorageService` has separate methods for goals vs workout preferences. Easy to forget one.

**How to avoid:** Call both `storage.setDailyGoal()` AND `ActiveWorkoutProvider.saveWorkoutPreferences()` in `_completeOnboarding()`.

**Warning signs:** First workout after onboarding uses starting series of 1 or rest time of 30s instead of personalized values.

### Pitfall 2: Onboarding shows repeatedly
**What goes wrong:** After completing onboarding, user sees it again on next app launch.

**Why it happens:** Forgetting to call `setOnboardingCompleted(true)` or calling it before data is saved.

**How to avoid:** Ensure `setOnboardingCompleted(true)` is the LAST call in `_completeOnboarding()`, after all data is persisted.

**Warning signs:** Check main.dart - it uses `storage.isOnboardingCompleted()` to decide whether to show onboarding or main app.

### Pitfall 3: Dot indicator doesn't sync with PageView
**What goes wrong:** Dot indicators show wrong position or don't update when user swipes.

**Why it happens:** PageView has its own internal page tracking. Need to listen to `onPageChanged`.

**How to avoid:** Use `PageView.onPageChanged` callback to update `_currentPage` state. Use `_currentPage` for dot rendering, not `_pageController.page`.

**Warning signs:** Dots highlight position lags behind actual page or never updates.

### Pitfall 4: Back navigation allows going back from first screen
**What goes wrong:** Back button on first screen goes to a blank screen or crashes.

**Why it happens:** Not checking `_currentPage > 0` before allowing back navigation.

**How to avoid:** Disable back button or check condition before calling `_pageController.previousPage()`.

**Warning signs:** System back button (Android swipe) or on-screen back button works on first screen.

### Pitfall 5: Not updating main.dart for new onboarding
**What goes wrong:** Old onboarding still shows because `main.dart` imports the old screen.

**Why it happens:** Forgetting to update the import when replacing `OnboardingScreen` with `PersonalizedOnboardingScreen`.

**How to avoid:** Update both the import in `main.dart` AND delete/rename the old file to prevent accidental use.

**Warning signs:** Old 3-page onboarding appears instead of new 4-page flow.

## Code Examples

Verified patterns from the existing codebase:

### Onboarding Completion Check (from main.dart)
```dart
// Source: lib/main.dart:134-167
FutureBuilder<bool>(
  future: _checkOnboarding(),
  builder: (context, snapshot) {
    if (snapshot.data == false) {
      return MaterialApp(
        home: const OnboardingScreen(), // Will replace with PersonalizedOnboardingScreen
      );
    }
    return MaterialApp(
      home: const MainNavigationWrapper(),
    );
  },
)

Future<bool> _checkOnboarding() async {
  final storage = context.read<StorageService>();
  return storage.isOnboardingCompleted();
}
```

### PageView with Dot Indicator (from existing onboarding)
```dart
// Source: lib/screens/onboarding/onboarding_screen.dart:278-288
PageView(
  controller: _pageController,
  onPageChanged: (index) {
    setState(() => _currentPage = index);
  },
  children: [
    _buildWelcomePage(),
    _buildHowItWorksPage(),
    _buildGoalsPage(),
  ],
)

// Dot indicator
Row(
  mainAxisAlignment: MainAxisAlignment.center,
  children: List.generate(3, (index) { // Change to 4 for new flow
    final isActive = index == _currentPage;
    return AnimatedContainer(
      duration: const Duration(milliseconds: 200),
      margin: const EdgeInsets.symmetric(horizontal: 6),
      width: isActive ? 24 : 8,
      height: 8,
      decoration: BoxDecoration(
        color: isActive ? const Color(0xFFFFB347) : Colors.white.withOpacity(0.30),
        borderRadius: BorderRadius.circular(4),
      ),
    );
  }),
)
```

### Gradient Button with Press Animation (from existing onboarding)
```dart
// Source: lib/screens/onboarding/onboarding_screen.dart:932-975
class _GradientButton extends StatefulWidget {
  final String text;
  final VoidCallback onTap;

  const _GradientButton({required this.text, required this.onTap});

  @override
  State<_GradientButton> createState() => _GradientButtonState();
}

class _GradientButtonState extends State<_GradientButton> {
  bool _pressed = false;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (_) => setState(() => _pressed = true),
      onTapCancel: () => setState(() => _pressed = false),
      onTapUp: (_) {
        setState(() => _pressed = false);
        widget.onTap();
      },
      child: AnimatedScale(
        scale: _pressed ? 0.98 : 1.0,
        duration: const Duration(milliseconds: 100),
        curve: Curves.easeOut,
        child: Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(24),
            gradient: const LinearGradient(
              colors: [Color(0xFFFFB347), Color(0xFFFF5F1F)],
            ),
          ),
          alignment: Alignment.center,
          child: Text(
            widget.text,
            style: const TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w800,
              color: Colors.white,
            ),
          ),
        ),
      ),
    );
  }
}
```

### FrostCard Glass Effect (from design system)
```dart
// Source: lib/widgets/design_system/frost_card.dart
ClipRRect(
  borderRadius: BorderRadius.circular(24),
  child: BackdropFilter(
    filter: ImageFilter.blur(sigmaX: 12, sigmaY: 12),
    child: Container(
      padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 14),
      decoration: BoxDecoration(
        color: const Color(0xFF161A20).withOpacity(0.60),
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: Colors.white.withOpacity(0.08),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.30),
            blurRadius: 26,
            offset: const Offset(0, 16),
          ),
        ],
      ),
      child: child,
    ),
  ),
)
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Manual widget composition for multi-step | PageView with onPageChanged callback | Flutter 1.x | Standard pattern for onboarding/swipeable flows |
| Stateless onboarding with global storage | StatefulWidget with local state, persist on complete | Project architecture | Cleaner separation, atomic save operation |
| Fixed dot indicators | AnimatedContainer for dot transitions | Existing implementation | Smooth visual feedback |

**Not deprecated (use existing):**
- Provider for state management - project standard
- StorageService with SharedPreferences - working well
- PageView for multi-step screens - Flutter best practice

## Open Questions

1. **Activity level icons:** Need to decide on specific Material Icons for each activity level (Sedentary, Lightly Active, Active, Very Active). Recommendation: `event_seat`, `directions_walk`, `directions_run`, `fitness_center`.

2. **Exact recovery time formula:** CONTEXT.md says beginner=60s, intermediate=45s, advanced=30s, but activity levels are named differently (Sedentary, Lightly Active, Active, Very Active). Need mapping:
   - Sedentary → 60s
   - Lightly Active → 45s
   - Active/Very Active → 30s

3. **Success message wording:** CONTEXT.md leaves this to Claude's discretion. Recommendation: Keep it brief and positive. "Your personalized plan is ready!" or "We've customized your plan based on your answers."

4. **Frequency input method:** CONTEXT.md leaves this to Claude's discretion. Options:
   - Day buttons (M T W T F S S) with toggle
   - Simple "Days per week" counter (1-7)
   - Frequency chips (1-2x, 3-4x, 5-6x, 7x)

   Recommendation: Simple counter (1-7) with tap to increment/decrement, using existing stepper pattern from `SeriesSelectionScreen`.

## Sources

### Primary (HIGH confidence)
- **Existing codebase analysis:**
  - `lib/screens/onboarding/onboarding_screen.dart` - Current 3-page onboarding implementation
  - `lib/repositories/storage_service.dart` - Persistence API
  - `lib/providers/goals_provider.dart` - Goals state management
  - `lib/providers/active_workout_provider.dart` - Workout preferences API
  - `lib/main.dart` - Onboarding check and navigation logic
  - `lib/widgets/design_system/frost_card.dart` - Reusable glass card
  - `lib/core/theme/app_theme.dart` - Theme and text styles
  - `lib/core/constants/app_colors.dart` - Color constants

### Secondary (MEDIUM confidence)
- [Flutter Tutorial: PageView Builder and Riverpod](https://medium.com/@purboyndra/flutter-tutorial-how-to-create-onboarding-screen-using-pageview-builder-and-riverpod-6d17a8ee8382) - PageView patterns for onboarding
- [Building Onboarding Animated Tutorials](https://vibe-studio.ai/insights/building-onboarding-animated-tutorials-in-flutter) - Modern onboarding implementation
- [Slider class - material library - Dart API](https://api.flutter.dev/flutter/material/Slider-class.html) - Official Slider documentation
- [Flutter Selectable Cards Package](https://github.com/ArkOne-Softwares/flutter_selectable_cards) - Card selection pattern reference

### Tertiary (LOW confidence - not directly used, verified with codebase)
- WebSearch results confirmed standard patterns but implementation relies primarily on existing codebase patterns.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All components verified in existing codebase
- Architecture: HIGH - Based on proven existing onboarding pattern
- Pitfalls: HIGH - Derived from existing code analysis
- UI/UX patterns: MEDIUM - Standard Flutter patterns, icon choices may need iteration

**Research date:** 2026-01-23
**Valid until:** 60 days (stable Flutter APIs, existing codebase patterns)
