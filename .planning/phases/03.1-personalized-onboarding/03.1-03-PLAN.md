---
phase: 03.1-personalized-onboarding
plan: 03
type: execute
wave: 2
depends_on: [03.1-01, 03.1-02]
files_modified:
  - push_up_5050/lib/screens/onboarding/personalized_onboarding_screen.dart
  - push_up_5050/lib/main.dart
  - push_up_5050/lib/screens/onboarding/onboarding_screen.dart
  - push_up_5050/lib/l10n/app_en.arb
  - push_up_5050/lib/l10n/app_it.arb
autonomous: false

must_haves:
  truths:
    - "New users complete 4-screen onboarding flow on first launch"
    - "PageView allows swipe navigation between screens"
    - "Dot indicator shows current position (4 dots, one per screen)"
    - "Back navigation works from screens 2-4 (disabled on screen 1)"
    - "Onboarding completes and saves all data on final screen"
    - "Personalized values persist across app sessions"
    - "main.dart imports and uses PersonalizedOnboardingScreen instead of OnboardingScreen"
  artifacts:
    - path: "push_up_5050/lib/screens/onboarding/personalized_onboarding_screen.dart"
      provides: "Main personalized onboarding screen with PageView"
      min_lines: 150
      exports: ["PersonalizedOnboardingScreen"]
    - path: "push_up_5050/lib/main.dart"
      contains: "PersonalizedOnboardingScreen import and usage"
  key_links:
    - from: "personalized_onboarding_screen.dart"
      to: "storage_service.dart"
      via: "Provider<StorageService> context.read"
      pattern: "context.read<StorageService>"
    - from: "personalized_onboarding_screen.dart"
      to: "active_workout_provider.dart"
      via: "Provider<ActiveWorkoutProvider> context.read"
      pattern: "saveWorkoutPreferences"
    - from: "main.dart"
      to: "personalized_onboarding_screen.dart"
      via: "import statement"
      pattern: "import.*personalized_onboarding_screen"
---

<objective>
Create main personalized onboarding screen and integrate with app

This plan assembles the complete onboarding flow by:
1. Creating PersonalizedOnboardingScreen with PageView containing all 4 screens
2. Implementing navigation controls (dot indicator, back/next buttons)
3. Saving personalized data to StorageService and ActiveWorkoutProvider
4. Updating main.dart to use the new onboarding screen
5. Adding final i18n keys for navigation and completion

Purpose: Wire together all widgets into a complete 4-screen onboarding flow that persists user data

**PLANNING DECISION DOCUMENTATION:**

**Conflict Resolution - Skip Button:**
- **Decision:** Option B - No skip button, mandatory onboarding (per CONTEXT.md)
- **Rationale:** Anti-cheat strategy requires baseline data for points system. CONTEXT.md represents user's most recent decision.

**Conflict Resolution - Settings Editing:**
- **Decision:** Option B - No editing allowed after onboarding (per CONTEXT.md)
- **Rationale:** Prevents users from gaming the points system by lowering their baseline after onboarding.

Output: Complete PersonalizedOnboardingScreen, updated main.dart, final i18n keys
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03.1-personalized-onboarding/03.1-CONTEXT.md
@.planning/phases/03.1-personalized-onboarding/03.1-RESEARCH.md

@push_up_5050/lib/screens/onboarding/onboarding_screen.dart
@push_up_5050/lib/repositories/storage_service.dart
@push_up_5050/lib/providers/active_workout_provider.dart
@push_up_5050/lib/main.dart
@push_up_5050/lib/screens/onboarding/onboarding_data.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PersonalizedOnboardingScreen with PageView and state management</name>
  <files>push_up_5050/lib/screens/onboarding/personalized_onboarding_screen.dart</files>
  <action>
Create new file `push_up_5050/lib/screens/onboarding/personalized_onboarding_screen.dart` with:

1. **StatefulWidget** named `PersonalizedOnboardingScreen`

2. **State Variables:**
   - `PageController _pageController` for PageView
   - `int _currentPage = 0` for tracking current screen
   - `ActivityLevel _activityLevel = ActivityLevel.lightlyActive` (default)
   - `int _maxCapacity = 20` (default)
   - `int _frequencyDays = 5` (default)
   - `int _dailyGoal = 50` (default)

3. **PageView Structure:**
   - 4 pages using the 4 widgets created in plans 01-02:
     1. ActivityLevelSelection
     2. CapacitySlider
     3. FrequencySelector
     4. DailyGoalSlider
   - Each widget receives current value and callback to update state
   - `onPageChanged` callback updates `_currentPage`

4. **Navigation Controls:**
   - Dot indicator: 4 dots, current highlighted in orange (Color(0xFFFFB347))
   - AnimatedContainer for smooth dot transitions (200ms duration)
   - Dot size: active = 24px width, inactive = 8px

5. **Bottom Buttons (based on current page):**
   - Page 0: Only "Next" button (orange gradient)
   - Page 1-2: "Back" (outlined) + "Next" (gradient) buttons
   - Page 3: "Back" (outlined) + "Get Started" (gradient) buttons

6. **Navigation Methods:**
   - `_goToNext()`: Animate to next page if not on last page
   - `_goBack()`: Animate to previous page if not on first page
   - Both use `PageController.nextPage()` and `previousPage()` with 300ms duration

7. **Background Styling:**
   - Use same gradient background as existing OnboardingScreen
   - LinearGradient from Color(0xFF1A1A1A) to Color(0xFF0D0D0D)

Reference existing `onboarding_screen.dart` for PageView, dot indicator, and button patterns.

DO NOT implement _completeOnboarding() in this task - that's the next task.
  </action>
  <verify>
File exists at `push_up_5050/lib/screens/onboarding/personalized_onboarding_screen.dart` with:
- PersonalizedOnboardingScreen StatefulWidget
- PageView with 4 pages
- Dot indicator with 4 dots
- Navigation buttons (Back/Next/Get Started)
- State variables for all 4 onboarding data fields
- Smooth page transitions (300ms duration)
  </verify>
  <done>
PersonalizedOnboardingScreen renders PageView with all 4 widgets, allows navigation between screens, and shows correct dot indicator position.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement _completeOnboarding method to save personalized data</name>
  <files>push_up_5050/lib/screens/onboarding/personalized_onboarding_screen.dart</files>
  <action>
Add the `_completeOnboarding()` method to `PersonalizedOnboardingScreen`:

1. **Create OnboardingData instance** from current state values

2. **Calculate recommendations** using OnboardingData getters:
   - `startingSeries`: from OnboardingData.startingSeries getter
   - `recoveryTime`: from OnboardingData.recoveryTime getter
   - `dailyGoal`: use user-selected value

3. **Save to StorageService:**
   - Get StorageService via `context.read<StorageService>()`
   - Call `storage.setDailyGoal(dailyGoal)` with user's daily goal
   - Call `storage.setMonthlyGoal(dailyGoal * 30)` for monthly goal
   - Call `storage.setOnboardingCompleted(true)` - MUST BE LAST CALL

4. **Save workout preferences to ActiveWorkoutProvider:**
   - Get ActiveWorkoutProvider via `context.read<ActiveWorkoutProvider>()`
   - Call `provider.saveWorkoutPreferences(startingSeries: series, restTime: recoveryTime)`

5. **Navigate to main app:**
   - Check `mounted` before navigation
   - Use `Navigator.pushReplacement()` with MaterialPageRoute
   - Navigate to `MainNavigationWrapper()`

6. **Loading State:**
   - Show loading indicator while saving (optional but good UX)
   - Disable "Get Started" button during save

IMPORTANT: `setOnboardingCompleted(true)` must be the LAST call after all data persists, or user will see onboarding again.

Reference the existing `_completeOnboarding()` in `onboarding_screen.dart` for navigation pattern.
  </action>
  <verify>
_completeOnboarding() method exists with:
- OnboardingData creation from state
- All StorageService calls (setDailyGoal, setMonthlyGoal, setOnboardingCompleted)
- ActiveWorkoutProvider.saveWorkoutPreferences call
- Navigation to MainNavigationWrapper
- setOnboardingCompleted is LAST call
  </verify>
  <done>
_completeOnboarding() saves all data to StorageService and ActiveWorkoutProvider, then navigates to main app.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update main.dart to use PersonalizedOnboardingScreen</name>
  <files>push_up_5050/lib/main.dart</files>
  <action>
Update `push_up_5050/lib/main.dart`:

1. **Replace import:**
   - Change: `import 'package:push_up_5050/screens/onboarding/onboarding_screen.dart';`
   - To: `import 'package:push_up_5050/screens/onboarding/personalized_onboarding_screen.dart';`

2. **Replace widget usage:**
   - Find the MaterialApp that uses `OnboardingScreen()` (around line 165)
   - Change: `home: const OnboardingScreen(),`
   - To: `home: const PersonalizedOnboardingScreen(),`

3. **Keep old file for reference:**
   - DO NOT delete the old `onboarding_screen.dart` file yet (will be removed after testing)
   - This allows rollback if issues arise

4. **Verify the change:**
   - Only one occurrence of OnboardingScreen should exist (the import line to replace)
   - The widget is only used in the FutureBuilder where snapshot.data == false

No other changes to main.dart are needed - the onboarding check logic remains the same.
  </action>
  <verify>
main.dart imports PersonalizedOnboardingScreen (not OnboardingScreen)
main.dart uses PersonalizedOnboardingScreen() in the FutureBuilder (around line 165)
flutter analyze passes with no errors
  </verify>
  <done>
main.dart now imports and uses PersonalizedOnboardingScreen for first-time users.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add final i18n keys for navigation and completion</name>
  <files>push_up_5050/lib/l10n/app_en.arb, push_up_5050/lib/l10n/app_it.arb</files>
  <action>
Add the following keys to both `app_en.arb` and `app_it.arb`:

**English (app_en.arb):**
```json
"onboardingGetStartedNew": "Get Started",
"onboardingBackNew": "Back",
"onboardingNext": "Next",
"onboardingPersonalizedReady": "Your personalized plan is ready!",
"onboardingPersonalizedReadyDesc": "We've customized your workout based on your answers. Start your first workout today!"
```

**Italian (app_it.arb):**
```json
"onboardingGetStartedNew": "Inizia",
"onboardingBackNew": "Indietro",
"onboardingNext": "Avanti",
"onboardingPersonalizedReady": "Il tuo piano personalizzato Ã¨ pronto!",
"onboardingPersonalizedReadyDesc": "Abbiamo personalizzato il tuo allenamento in base alle tue risposte. Inizia il tuo primo allenamento oggi!"
```

Run `flutter pub get` after modifying arb files to regenerate AppLocalizations.

Note: Some keys like "onboardingNext", "onboardingBack", "onboardingGetStarted" may already exist. If they exist, you can reuse them. Only add new keys if they don't exist or need different wording.

Place new keys alphabetically in the file to maintain organization.
  </action>
  <verify>
Both arb files contain all new keys with correct translations.
Run `flutter analyze` - no errors related to missing localizations.
  </verify>
  <done>
All final i18n keys added to both EN and IT, AppLocalizations regenerated successfully.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete personalized onboarding flow with 4 screens:
1. Activity Level Selection (4 cards with icons)
2. Max Capacity Slider (preset values: 5, 10, 20, 30, 40, 50)
3. Workout Frequency Selector (1-7 days per week)
4. Daily Goal Slider (preset values: 20, 30, 40, 50, 60, 75, 100)

The flow includes:
- PageView with smooth swipe navigation
- Dot indicator showing current position (4 dots)
- Back/Next navigation buttons
- Data persistence via StorageService and ActiveWorkoutProvider
- Integration with main.dart for first-launch display
  </what-built>
  <how-to-verify>
1. **Reset onboarding status** (if already completed):
   - In app settings, look for "Restart Tutorial" option, OR
   - Clear app data/reinstall to see fresh onboarding

2. **Launch the app** - you should see the new 4-screen onboarding

3. **Test Screen 1 (Activity Level)**:
   - Verify 4 cards display with icons
   - Tap each card - verify orange gradient highlights selection
   - Select "Active" and continue

4. **Test Screen 2 (Max Capacity)**:
   - Verify slider works with preset values
   - Move slider - verify value updates (5, 10, 20, 30, 40, 50)
   - Select "20" and continue

5. **Test Screen 3 (Frequency)**:
   - Verify +/- buttons work
   - Tap + to increase, - to decrease
   - Verify min is 1, max is 7
   - Select "5" and continue

6. **Test Screen 4 (Daily Goal)**:
   - Verify slider works with preset values (20, 30, 40, 50, 60, 75, 100)
   - Move slider - verify progress preview text updates
   - Select "50" and tap "Get Started"

7. **Verify Data Persistence**:
   - Complete onboarding
   - Navigate to Series Selection screen
   - Verify starting series is set correctly (based on capacity of 20 = series 2)
   - Verify recovery time is set correctly (based on Active = 30s)
   - Go to Statistics - verify daily goal shows your selected value

8. **Test Back Navigation**:
   - Reset onboarding again
   - Navigate to screen 2, tap Back - verify returns to screen 1
   - Verify previous selections are preserved

9. **Test Swipe Navigation**:
   - Swipe left/right between screens
   - Verify dot indicator updates correctly
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. flutter analyze passes with no errors
2. PersonalizedOnboardingScreen compiles without errors
3. main.dart correctly imports and uses PersonalizedOnboardingScreen
4. All 4 widgets are included in PageView
5. _completeOnboarding() saves all data before calling setOnboardingCompleted(true)
6. i18n keys exist for all UI text
7. Human verification confirms flow works correctly
</verification>

<success_criteria>
- PersonalizedOnboardingScreen successfully replaces OnboardingScreen
- All 4 screens render correctly with proper widgets
- Navigation (buttons, swipe, back) works smoothly
- Data persists correctly to StorageService and ActiveWorkoutProvider
- First-time users see new onboarding flow
- Returning users skip directly to main app
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-personalized-onboarding/03.1-03-SUMMARY.md`
</output>
