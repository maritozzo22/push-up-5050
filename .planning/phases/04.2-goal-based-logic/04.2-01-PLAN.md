---
phase: 04.2-goal-based-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/providers/active_workout_provider.dart
  - push_up_5050/lib/repositories/storage_service.dart
  - push_up_5050/lib/providers/user_stats_provider.dart
autonomous: true

must_haves:
  truths:
    - "Goal completion is detected during workout when cumulative reps reach daily goal"
    - "Cumulative progress includes reps from all today's sessions, not just current session"
    - "Session marks goalReached=true when total progress >= daily goal"
    - "Goal check happens after each rep in countRep()"
    - "Extra reps in final series are capped at goal (stats don't exceed goal)"
  artifacts:
    - path: "push_up_5050/lib/providers/active_workout_provider.dart"
      provides: "Goal completion detection in countRep()"
      min_lines: 175
      contains: "_checkGoalCompletion"
    - path: "push_up_5050/lib/repositories/storage_service.dart"
      provides: "getDailyRecord() for cumulative progress check"
      exports: ["getDailyRecord", "getDailyGoal"]
    - path: "push_up_5050/lib/providers/user_stats_provider.dart"
      provides: "Cap stats at goal when overshooting"
      contains: "min(_todayPushups, dailyGoal)"
  key_links:
    - from: "ActiveWorkoutProvider.countRep()"
      to: "StorageService.getDailyRecord()"
      via: "async call after each rep"
      pattern: "await _storage\.getDailyRecord"
    - from: "ActiveWorkoutProvider.countRep()"
      to: "WorkoutSession.goalReached"
      via: "session flag set when goal achieved"
      pattern: "goalReached = true"
    - from: "UserStatsProvider.addDailyRecord()"
      to: "todayPushups calculation"
      via: "cap at dailyGoal"
      pattern: "min\(.*dailyGoal\)"
---

<objective>
Goal Completion Detection During Workout

Purpose: Detect when daily goal is reached during active workout session, accounting for cumulative progress across all sessions today, and cap stats at goal
Output: Modified ActiveWorkoutProvider with goal completion check after each rep, and stats capping at goal
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.2-goal-based-logic/04.2-CONTEXT.md
@.planning/phases/04.2-goal-based-logic/04.2-RESEARCH.md

# Prior phase summaries for context
@.planning/phases/04.1-quick-fixes/04.1-01-SUMMARY.md
@.planning/phases/04.1-quick-fixes/04.1-02-SUMMARY.md

# Key implementation files
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\active_workout_provider.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\repositories\storage_service.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\models\workout_session.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\user_stats_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add goal completion check method to ActiveWorkoutProvider</name>
  <files>push_up_5050/lib/providers/active_workout_provider.dart</files>
  <action>
Add a new private method `_checkGoalCompletion()` that:

1. Gets today's date using DateTime.now()
2. Fetches existing daily record via `_storage.getDailyRecord(today)`
3. Calculates todayReps from existing record (or 0 if none)
4. Adds current session's totalReps to get cumulative total
5. Gets daily goal from `_storage.getDailyGoal()`
6. If cumulative >= goal: sets `session.goalReached = true`

Implementation details:
- Use async/await for storage calls
- Handle null session gracefully (early return)
- Handle null goalPushups gracefully (no goal = no check)
- The method should be private (underscore prefix)

Location: Add after `_calculateRepPoints()` method, before `advanceToNextSeries()`
</action>
  <verify>
grep -n "_checkGoalCompletion" push_up_5050/lib/providers/active_workout_provider.dart
flutter test test/providers/active_workout_provider_test.dart 2>&1 || echo "Test file may not exist yet"
</verify>
  <done>
_checkGoalCompletion() method exists and:
- Fetches today's record from storage
- Calculates cumulative progress (existing + session)
- Compares to daily goal
- Sets goalReached flag when threshold met
</done>
</task>

<task type="auto">
  <name>Task 2: Call goal completion check in countRep()</name>
  <files>push_up_5050/lib/providers/active_workout_provider.dart</files>
  <action>
Modify the `countRep()` method to call `_checkGoalCompletion()` after incrementing reps.

Find the existing countRep() method (around line 161) and add:
```dart
// Check for goal completion after counting rep
await _checkGoalCompletion();
```

This should be added AFTER `_session!.countRep()` but BEFORE `_saveSession()`.

Important: The countRep() method is already async, so no signature change needed.
</action>
  <verify>
grep -A 5 "void countRep()" push_up_5050/lib/providers/active_workout_provider.dart | grep "_checkGoalCompletion"
</verify>
  <done>
countRep() now calls _checkGoalCompletion() after each rep, enabling real-time goal detection during workout.
</done>
</task>

<task type="auto">
  <name>Task 3: Add stats capping at goal in UserStatsProvider</name>
  <files>push_up_5050/lib/providers/user_stats_provider.dart</files>
  <action>
Add capping logic to ensure stats never exceed the daily goal, even when user overshoots in the final series.

Find the `addDailyRecord()` method (or where daily stats are accumulated).

When adding reps to today's total, cap the result:
```dart
// Cap today's pushups at daily goal (handles overshoot in final series)
_todayPushups = math.min(_todayPushups + record.totalPushups, dailyGoal);
```

Or if the calculation uses a different pattern:
```dart
_todayPushups = math.min(_todayPushups, dailyGoal);
```

Import dart:math if needed:
```dart
import 'dart:math' as math;
```

This ensures that:
- User at 8 push-ups, goal is 10, does 4-rep series: stats show 10 (not 12)
- The extra 2 reps are "lost" in terms of stats but the workout still completes properly
</action>
  <verify>
grep -n "min.*dailyGoal" push_up_5050/lib/providers/user_stats_provider.dart
grep -B 3 -A 3 "todayPushups.*dailyGoal" push_up_5050/lib/providers/user_stats_provider.dart
</verify>
  <done>
UserStatsProvider caps todayPushups at dailyGoal:
- Uses math.min() to cap accumulated stats
- Stats never exceed daily goal even on overshoot
- Handles final series overshoot scenario correctly
</done>
</task>

<task type="auto">
  <name>Task 4: Add helper method to check if today's goal is already complete</name>
  <files>push_up_5050/lib/providers/active_workout_provider.dart</files>
  <action>
Add a new public getter `isDailyGoalComplete` that returns true if today's goal is already reached BEFORE starting a workout.

This is needed by HomeScreen to disable the start button when goal is complete.

Implementation:
```dart
/// Check if today's daily goal has already been completed.
///
/// Returns true if today's existing record totalPushups >= daily goal.
/// Used by HomeScreen to disable start button when goal complete.
Future<bool> isDailyGoalComplete() async {
  final today = DateTime.now();
  final existingRecord = await _storage.getDailyRecord(today);
  final todayReps = existingRecord?.totalPushups ?? 0;
  final goal = _storage.getDailyGoal();
  return todayReps >= goal;
}
```

Add this getter after the `sessionPoints` getter (around line 72).
</action>
  <verify>
grep -n "isDailyGoalComplete" push_up_5050/lib/providers/active_workout_provider.dart
</verify>
  <done>
isDailyGoalComplete getter exists and returns true when today's existing reps >= daily goal.
</done>
</task>

</tasks>

<verification>
1. Review ActiveWorkoutProvider code to ensure _checkGoalCompletion() exists
2. Verify countRep() calls _checkGoalCompletion() after each rep
3. Verify UserStatsProvider caps stats at dailyGoal
4. Verify isDailyGoalComplete getter is accessible from HomeScreen
5. Run: flutter analyze lib/providers/active_workout_provider.dart
6. Run: flutter analyze lib/providers/user_stats_provider.dart
7. Run: flutter test test/providers/ 2>&1 || echo "Tests may need to be created"
</verification>

<success_criteria>
1. Goal completion check runs after every rep during workout
2. Check accounts for cumulative progress (existing today reps + session reps)
3. session.goalReached flag is set when goal threshold is met
4. Stats cap at dailyGoal even when final series overshoots
5. isDailyGoalComplete getter available for UI consumption
</success_criteria>

<output>
After completion, create `.planning/phases/04.2-goal-based-logic/04.2-01-SUMMARY.md`
</output>
