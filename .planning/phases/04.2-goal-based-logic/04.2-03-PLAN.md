---
phase: 04.2-goal-based-logic
plan: 03
type: execute
wave: 2
depends_on: ["04.2-01"]
files_modified:
  - push_up_5050/lib/screens/home/home_screen.dart
  - push_up_5050/lib/widgets/design_system/start_button_circle.dart
  - push_up_5050/lib/screens/series_selection/series_selection_screen.dart
autonomous: true

must_haves:
  truths:
    - "Start button is disabled when today's goal is already complete"
    - "Disabled button shows 'Obiettivo completato' message when tapped"
    - "Button visually indicates disabled state (opacity, no tap effect)"
    - "Check uses Consumer2<UserStatsProvider, ActiveWorkoutProvider>"
    - "Series selection screen blocks navigation to workout when goal complete"
    - "Navigating manually to workout screen after goal complete shows blocked state"
  artifacts:
    - path: "push_up_5050/lib/screens/home/home_screen.dart"
      provides: "Goal completion check before workout start"
      contains: "Consumer2"
    - path: "push_up_5050/lib/widgets/design_system/start_button_circle.dart"
      provides: "Disabled state support for start button"
      exports: ["isDisabled", "disabledMessage"]
    - path: "push_up_5050/lib/screens/series_selection/series_selection_screen.dart"
      provides: "Navigation guard when goal complete"
      contains: "isGoalCompleted"
  key_links:
    - from: "HomeScreen.build()"
      to: "UserStatsProvider.todayPushups"
      via: "Consumer2 wrapping StartButtonCircle"
      pattern: "Consumer2<UserStatsProvider"
    - from: "HomeScreen"
      to: "Start button tap handler"
      via: "isDisabled check before onTap"
      pattern: "isDisabled.*onTap"
    - from: "SeriesSelectionScreen"
      to: "WorkoutExecutionScreen"
      via: "goal completion check before navigation"
      pattern: "isTodayGoalComplete.*Navigator"
---

<objective>
Prevent Workout Start After Goal Completion

Purpose: Disable start button and block navigation to workout screen when daily goal is already reached
Output: Modified HomeScreen and SeriesSelectionScreen with goal-complete guards
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.2-goal-based-logic/04.2-CONTEXT.md
@.planning/phases/04.2-goal-based-logic/04.2-RESEARCH.md

# Prior plan for dependency
@.planning/phases/04.2-goal-based-logic/04.2-01-SUMMARY.md

# Key implementation files
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\screens\home\home_screen.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\widgets\design_system\start_button_circle.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\screens\series_selection\series_selection_screen.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\user_stats_provider.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\active_workout_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add disabled state support to StartButtonCircle widget</name>
  <files>push_up_5050/lib/widgets/design_system/start_button_circle.dart</files>
  <action>
Modify the StartButtonCircle widget to support disabled state.

First, read the current widget implementation to understand its structure.

Add two new optional parameters:
```dart
final bool isDisabled;
final String? disabledMessage;
```

Update the constructor to accept these:
```dart
const StartButtonCircle({
  super.key,
  required this.onTap,
  this.isDisabled = false,
  this.disabledMessage,
});
```

Modify the build method to:
1. Wrap gesture detector with disabled state check
2. Show visual disabled feedback (reduced opacity)
3. Show snackbar with disabledMessage when tapped while disabled

Implementation pattern for the onTap handler:
```dart
onTap: () {
  if (isDisabled) {
    if (disabledMessage != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(disabledMessage!),
          duration: const Duration(seconds: 2),
        ),
      );
    }
    return;
  }
  onTap();
},
```

For visual feedback, wrap the button content with Opacity:
```dart
Opacity(
  opacity: isDisabled ? 0.5 : 1.0,
  child: // ... existing button content
),
```

Important: Keep all existing animations and glow effects - just add opacity wrapper.
</action>
  <verify>
grep -n "isDisabled" push_up_5050/lib/widgets/design_system/start_button_circle.dart
grep -n "disabledMessage" push_up_5050/lib/widgets/design_system/start_button_circle.dart
</verify>
  <done>
StartButtonCircle widget:
- Accepts isDisabled parameter (default false)
- Accepts disabledMessage parameter (optional)
- Shows reduced opacity when disabled
- Shows snackbar with message when tapped while disabled
- Does not call onTap callback when disabled
</done>
</task>

<task type="auto">
  <name>Task 2: Wrap StartButtonCircle with Consumer2 in HomeScreen</name>
  <files>push_up_5050/lib/screens/home/home_screen.dart</files>
  <action>
Modify the HomeScreen to check goal completion status before allowing workout start.

Current code (around line 233-236) has:
```dart
StartButtonCircle(
  onTap: widget.onStartWorkout ?? () {},
),
```

Change to wrap with Consumer2<UserStatsProvider, ActiveWorkoutProvider>:
```dart
Consumer2<UserStatsProvider, ActiveWorkoutProvider>(
  builder: (context, stats, workoutProvider, child) {
    // Check if today's goal is already complete
    final goalComplete = stats.todayPushups >= UserStatsProvider.dailyGoal;

    return StartButtonCircle(
      onTap: widget.onStartWorkout ?? () {},
      isDisabled: goalComplete,
      disabledMessage: 'Obiettivo completato!',
    );
  },
),
```

CRITICAL: This must use Consumer2 (not Consumer) to access both providers.
The comparison `stats.todayPushups >= UserStatsProvider.dailyGoal` is the key logic.

Note: Import Consumer2 from package:provider/provider.dart (add if not present).
</action>
  <verify>
grep -n "Consumer2" push_up_5050/lib/screens/home/home_screen.dart
grep -B 3 -A 8 "Consumer2<UserStatsProvider" push_up_5050/lib/screens/home/home_screen.dart
grep -n "stats.todayPushups.*dailyGoal" push_up_5050/lib/screens/home/home_screen.dart
</verify>
  <done>
StartButtonCircle is wrapped with Consumer2<UserStatsProvider, ActiveWorkoutProvider>:
- Checks stats.todayPushups >= UserStatsProvider.dailyGoal
- Passes isDisabled=true when goal complete
- Passes disabledMessage showing "Obiettivo completato!"
- Uses Consumer2 (not Consumer) for dual provider access
</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation guard in SeriesSelectionScreen</name>
  <files>push_up_5050/lib/screens/series_selection/series_selection_screen.dart</files>
  <action>
Add goal completion check in SeriesSelectionScreen to prevent navigation to workout when goal is already complete.

First, read the file to find where navigation to WorkoutExecutionScreen happens.

Look for Navigator.push or similar that routes to the workout screen.

Add a guard before the navigation:
```dart
// Check if goal is already complete before navigating
final userStats = context.read<UserStatsProvider>();
if (userStats.todayPushups >= UserStatsProvider.dailyGoal) {
  // Show message and prevent navigation
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(
      content: Text('Obiettivo completato!'),
      duration: Duration(seconds: 2),
    ),
  );
  return;
}

// Existing navigation code
Navigator.push(...);
```

This blocks users who navigate to series selection screen from other routes.
</action>
  <verify>
grep -B 5 -A 5 "todayPushups.*dailyGoal" push_up_5050/lib/screens/series_selection/series_selection_screen.dart
grep -B 3 -A 3 "Obiettivo completato" push_up_5050/lib/screens/series_selection/series_selection_screen.dart
</verify>
  <done>
SeriesSelectionScreen blocks navigation when goal complete:
- Checks userStats.todayPushups >= UserStatsProvider.dailyGoal before navigating
- Shows "Obiettivo completato!" snackbar if goal reached
- Returns early without navigating to workout
- Handles edge case of users navigating via other means
</done>
</task>

<task type="auto">
  <name>Task 4: Add localization key for goal completion message</name>
  <files>
  push_up_5050/lib/l10n/app_it.arb
  push_up_5050/lib/l10n/app_en.arb
  push_up_5050/lib/screens/home/home_screen.dart
  push_up_5050/lib/screens/series_selection/series_selection_screen.dart
  </files>
  <action>
Add the localization keys for the goal completed message.

Edit push_up_5050/lib/l10n/app_it.arb:
Add the line:
```json
"goalCompleted": "Obiettivo completato!",
```

Also add to push_up_5050/lib/l10n/app_en.arb:
```json
"goalCompleted": "Goal completed!",
```

Then update HomeScreen to use the localized string:
```dart
disabledMessage: l10n.goalCompleted,
```

And update SeriesSelectionScreen similarly:
```dart
content: Text(l10n.goalCompleted),
```

This requires importing AppLocalizations (should already be imported in both files).
</action>
  <verify>
grep -n "goalCompleted" push_up_5050/lib/l10n/app_it.arb
grep -n "goalCompleted" push_up_5050/lib/l10n/app_en.arb
grep -n "l10n.goalCompleted" push_up_5050/lib/screens/home/home_screen.dart
grep -n "l10n.goalCompleted" push_up_5050/lib/screens/series_selection/series_selection_screen.dart
</verify>
  <done>
Localization keys added and used:
- app_it.arb has "goalCompleted": "Obiettivo completato!"
- app_en.arb has "goalCompleted": "Goal completed!"
- HomeScreen uses l10n.goalCompleted for disabledMessage
- SeriesSelectionScreen uses l10n.goalCompleted for snackbar
</done>
</task>

</tasks>

<verification>
1. Review StartButtonCircle to verify disabled state support
2. Verify HomeScreen wraps button with Consumer2 (not Consumer)
3. Verify Consumer2 accesses stats.todayPushups and compares to dailyGoal
4. Verify SeriesSelectionScreen has navigation guard
5. Verify goal comparison uses correct values
6. Run: flutter analyze lib/screens/home/home_screen.dart
7. Run: flutter analyze lib/widgets/design_system/start_button_circle.dart
8. Run: flutter analyze lib/screens/series_selection/series_selection_screen.dart
9. Run: flutter test test/widgets/design_system/ 2>&1 || echo "Tests may need to be updated"
</verification>

<success_criteria>
1. Start button disabled when todayPushups >= dailyGoal
2. Tapping disabled button shows localized "Obiettivo completato!" snackbar
3. Button shows reduced opacity when disabled
4. HomeScreen uses Consumer2 for dual provider access
5. SeriesSelectionScreen blocks navigation when goal complete
6. Localization works for both IT and EN
7. Check is synchronous (no loading state)
</success_criteria>

<output>
After completion, create `.planning/phases/04.2-goal-based-logic/04.2-03-SUMMARY.md`
</output>
