---
phase: 04.2-goal-based-logic
plan: 03
type: execute
wave: 2
depends_on: ["04.2-01"]
files_modified:
  - push_up_5050/lib/screens/home/home_screen.dart
  - push_up_5050/lib/widgets/design_system/start_button_circle.dart
autonomous: true

must_haves:
  truths:
    - "Start button is disabled when today's goal is already complete"
    - "Disabled button shows 'Obiettivo completato' message when tapped"
    - "Button visually indicates disabled state (opacity, no tap effect)"
    - "Check happens on every Home screen build via Consumer"
  artifacts:
    - path: "push_up_5050/lib/screens/home/home_screen.dart"
      provides: "Goal completion check before workout start"
      contains: "isDailyGoalComplete"
    - path: "push_up_5050/lib/widgets/design_system/start_button_circle.dart"
      provides: "Disabled state support for start button"
      exports: ["isDisabled", "disabledMessage"]
  key_links:
    - from: "HomeScreen.build()"
      to: "ActiveWorkoutProvider.isDailyGoalComplete()"
      via: "Consumer wrapping StartButtonCircle"
      pattern: "Consumer<ActiveWorkoutProvider>"
    - from: "StartButtonCircle"
      to: "Start button tap handler"
      via: "isDisabled check before onTap"
      pattern: "isDisabled.*onTap"
---

<objective>
Prevent Workout Start After Goal Completion

Purpose: Disable start button when daily goal is already reached, showing message to user
Output: Modified HomeScreen with goal-complete check and disabled button state
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.2-goal-based-logic/04.2-CONTEXT.md
@.planning/phases/04.2-goal-based-logic/04.2-RESEARCH.md

# Prior plan for dependency
@.planning/phases/04.2-goal-based-logic/04.2-01-SUMMARY.md

# Key implementation files
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\screens\home\home_screen.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\widgets\design_system\start_button_circle.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\active_workout_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add disabled state support to StartButtonCircle widget</name>
  <files>push_up_5050/lib/widgets/design_system/start_button_circle.dart</files>
  <action>
Modify the StartButtonCircle widget to support disabled state.

First, read the current widget implementation to understand its structure.

Add two new optional parameters:
```dart
final bool isDisabled;
final String? disabledMessage;
```

Update the constructor to accept these:
```dart
const StartButtonCircle({
  super.key,
  required this.onTap,
  this.isDisabled = false,
  this.disabledMessage,
});
```

Modify the build method to:
1. Wrap gesture detector with disabled state check
2. Show visual disabled feedback (reduced opacity)
3. Show snackbar with disabledMessage when tapped while disabled

Implementation pattern for the onTap handler:
```dart
onTap: () {
  if (isDisabled) {
    if (disabledMessage != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(disabledMessage!),
          duration: const Duration(seconds: 2),
        ),
      );
    }
    return;
  }
  onTap();
},
```

For visual feedback, wrap the button content with Opacity:
```dart
Opacity(
  opacity: isDisabled ? 0.5 : 1.0,
  child: // ... existing button content
),
```

Important: Keep all existing animations and glow effects - just add opacity wrapper.
</action>
  <verify>
grep -n "isDisabled" push_up_5050/lib/widgets/design_system/start_button_circle.dart
grep -n "disabledMessage" push_up_5050/lib/widgets/design_system/start_button_circle.dart
</verify>
  <done>
StartButtonCircle widget:
- Accepts isDisabled parameter (default false)
- Accepts disabledMessage parameter (optional)
- Shows reduced opacity when disabled
- Shows snackbar with message when tapped while disabled
- Does not call onTap callback when disabled
</done>
</task>

<task type="auto">
  <name>Task 2: Wrap StartButtonCircle with ActiveWorkoutProvider Consumer in HomeScreen</name>
  <files>push_up_5050/lib/screens/home/home_screen.dart</files>
  <action>
Modify the HomeScreen to check goal completion status before allowing workout start.

Current code (around line 233-236) has:
```dart
StartButtonCircle(
  onTap: widget.onStartWorkout ?? () {},
),
```

Change to wrap with Consumer<ActiveWorkoutProvider>:
```dart
Consumer<ActiveWorkoutProvider>(
  builder: (context, workoutProvider, child) {
    // Check if today's goal is already complete
    final goalComplete = workoutProvider.isDailyGoalComplete();

    return StartButtonCircle(
      onTap: widget.onStartWorkout ?? () {},
      isDisabled: goalComplete,
      disabledMessage: 'Obiettivo completato!',
    );
  },
),
```

Wait - the isDailyGoalComplete getter returns Future<bool>. We need to handle this differently.

Two options:
A. Make isDailyGoalComplete a synchronous getter that checks cached state
B. Use FutureBuilder

For this implementation, use Option A: Add a synchronous state tracking.

Actually, looking at UserStatsProvider (line 106-107), there's already a static dailyGoal constant.
We can use UserStatsProvider.todayPushups to check synchronously:

```dart
Consumer2<UserStatsProvider, ActiveWorkoutProvider>(
  builder: (context, stats, workoutProvider, child) {
    final goalComplete = stats.todayPushups >= UserStatsProvider.dailyGoal;

    return StartButtonCircle(
      onTap: widget.onStartWorkout ?? () {},
      isDisabled: goalComplete,
      disabledMessage: 'Obiettivo completato!',
    );
  },
),
```

Note: Import Consumer2 from package:provider/provider.dart if needed.
</action>
  <verify>
grep -B 5 -A 10 "StartButtonCircle" push_up_5050/lib/screens/home/home_screen.dart | head -20
</verify>
  <done>
StartButtonCircle is wrapped with Consumer2<UserStatsProvider, ActiveWorkoutProvider>:
- Checks stats.todayPushups >= UserStatsProvider.dailyGoal
- Passes isDisabled=true when goal complete
- Passes disabledMessage showing "Obiettivo completato!"
</done>
</task>

<task type="auto">
  <name>Task 3: Add localization key for goal completion message</name>
  <files>push_up_5050/lib/l10n/app_it.arb</files>
  <action>
Add the Italian localization key for the goal completed message.

Edit push_up_5050/lib/l10n/app_it.arb:
Add the line:
```json
"goalCompleted": "Obiettivo completato!",
```

Also add to push_up_5050/lib/l10n/app_en.arb:
```json
"goalCompleted": "Goal completed!",
```

Then update HomeScreen to use the localized string instead of hardcoded:
```dart
disabledMessage: l10n.goalCompleted,
```

This requires importing AppLocalizations at the top of the file (should already be imported).
</action>
  <verify>
grep -n "goalCompleted" push_up_5050/lib/l10n/app_it.arb
grep -n "goalCompleted" push_up_5050/lib/l10n/app_en.arb
grep -n "l10n.goalCompleted" push_up_5050/lib/screens/home/home_screen.dart
</verify>
  <done>
Localization keys added and used:
- app_it.arb has "goalCompleted": "Obiettivo completato!"
- app_en.arb has "goalCompleted": "Goal completed!"
- HomeScreen uses l10n.goalCompleted for disabledMessage
</done>
</task>

</tasks>

<verification>
1. Review StartButtonCircle to verify disabled state support
2. Verify HomeScreen wraps button with Consumer2
3. Verify goal comparison uses correct values
4. Run: flutter analyze lib/screens/home/home_screen.dart
5. Run: flutter analyze lib/widgets/design_system/start_button_circle.dart
6. Run: flutter test test/widgets/design_system/ 2>&1 || echo "Tests may need to be updated"
</verification>

<success_criteria>
1. Start button disabled when todayPushups >= dailyGoal
2. Tapping disabled button shows "Obiettivo completato!" snackbar
3. Button shows reduced opacity when disabled
4. Localization works for both IT and EN
5. Check is synchronous (no loading state)
</success_criteria>

<output>
After completion, create `.planning/phases/04.2-goal-based-logic/04.2-03-SUMMARY.md`
</output>
