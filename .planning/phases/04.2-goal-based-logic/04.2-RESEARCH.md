# Phase 04.2: Goal-Based Logic - Research

**Researched:** 2026-01-29
**Domain:** Flutter state management, workout completion logic, midnight reset handling
**Confidence:** HIGH

## Summary

This phase implements automatic workout completion when the daily goal is reached. The core requirement is that workouts should auto-complete after finishing the current series when cumulative reps (from all today's sessions) reach or exceed the daily goal. Users cannot start new workouts after goal completion, and the restriction resets at midnight.

The implementation requires changes across three main areas:
1. **ActiveWorkoutProvider** - Detect goal completion and auto-end workout
2. **WorkoutExecutionScreen** - Handle auto-completion flow and navigation
3. **HomeScreen** - Disable start button when daily goal is reached

**Primary recommendation:** Implement goal completion check after each rep, with cumulative progress calculation from storage. Return to Home screen after goal completion (not results screen).

## Standard Stack

This phase uses existing Flutter libraries already in the project. No new dependencies required.

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| provider | ^6.1.2 | State management | Already in use throughout app |
| shared_preferences | ^2.3.2 | Persistence (via StorageService) | Existing storage abstraction |
| flutter | existing | Framework | Core Flutter APIs for DateTime, navigation |

### Supporting
| Component | Purpose | When to Use |
|-----------|---------|-------------|
| AudioService | Play completion sound | When goal is reached |
| StorageService | Check today's cumulative reps | Every rep to calculate progress |
| UserStatsProvider | Refresh stats after completion | Post-workout data sync |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| StorageService cumulative check | In-memory tracking | Would lose data on app close during workout |

**Installation:** No new packages required.

## Architecture Patterns

### Recommended Data Flow

```
User taps countRep()
    ↓
ActiveWorkoutProvider.countRep()
    ↓
StorageService.getDailyRecord(today) → Get existing progress
    ↓
Calculate: todayReps + currentSessionReps >= dailyGoal?
    ↓
If YES: Trigger auto-completion flow
    - Play completion sound
    - Show visual feedback
    - Auto-end workout after brief delay
    - Navigate to Home (not results)
    ↓
If NO: Continue normal workout
```

### Pattern 1: Goal Completion Detection

**What:** Check cumulative progress after each rep, not just session progress.

**When to use:** In `ActiveWorkoutProvider.countRep()` after incrementing reps.

**Example:**
```dart
// In ActiveWorkoutProvider
void countRep() async {
  if (_session == null) return;
  if (_isRecovery) return;

  _session!.countRep();

  // NEW: Check for goal completion
  await _checkGoalCompletion();

  await _calculateRepPoints();
  _saveSession();
  notifyListeners();
}

Future<void> _checkGoalCompletion() async {
  if (_session?.goalPushups == null) return;

  // Get today's existing progress
  final today = DateTime.now();
  final existingRecord = await _storage.getDailyRecord(today);
  final todayReps = existingRecord?.totalPushups ?? 0;

  // Calculate cumulative total
  final cumulativeReps = todayReps + (_session?.totalReps ?? 0);
  final goal = _storage.getDailyGoal();

  if (cumulativeReps >= goal) {
    // Mark goal as reached
    _session?.goalReached = true;
  }
}
```

### Pattern 2: Auto-Completion After Final Series

**What:** Complete the current series before ending workout, not mid-series.

**When to use:** When recovery timer starts after final series that reached goal.

**Example:**
```dart
// In WorkoutExecutionScreen._handleCountRep
void _handleCountRep(ActiveWorkoutProvider provider, BuildContext context) {
  final wasGoalNotReached = provider.session?.goalReached == false;

  provider.countRep();

  // ... existing haptic/audio code ...

  final session = provider.session;
  if (session != null && session.isSeriesComplete()) {
    // Check if goal was just reached
    if (wasGoalNotReached && session.goalReached == true) {
      // Goal reached during this series - will auto-complete after recovery
      _playGoalSound();
    }

    // Start recovery - workout will end after recovery completes
    provider.startRecovery();
    _startRecoveryTimer(provider, context);
  }
}

// In recovery timer completion
void _startRecoveryTimer(ActiveWorkoutProvider provider, BuildContext context) {
  _recoveryTimer?.cancel();
  _recoveryTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
    final complete = provider.tickRecovery();
    if (complete) {
      timer.cancel();
      audio.playBeep();

      // NEW: Check if goal reached - if so, end workout instead of advancing
      if (provider.session?.goalReached == true) {
        _handleGoalCompletion(provider, context);
      } else {
        provider.advanceToNextSeries();
      }
    }
  });
}
```

### Pattern 3: Start Button Disable State

**What:** Disable workout start when daily goal is already complete.

**When to use:** In HomeScreen and SeriesSelectionScreen build methods.

**Example:**
```dart
// In HomeScreen - wrap StartButtonCircle
Consumer<UserStatsProvider>(
  builder: (context, stats, child) {
    final goalCompleted = stats.todayPushups >= UserStatsProvider.dailyGoal;

    return StartButtonCircle(
      onTap: goalCompleted
          ? null // Disable
          : widget.onStartWorkout ?? () {},
      isDisabled: goalCompleted,
      disabledMessage: _l10n.goalCompleted, // "Obiettivo completato"
    );
  },
)
```

### Anti-Patterns to Avoid

- **Mid-series completion:** Don't end workout mid-series. Complete the current series first.
- **Session-only tracking:** Don't track only session reps. Must calculate cumulative from all sessions.
- **Results screen navigation:** Don't navigate to results after goal completion. Return to Home instead.
- **Manual continuation:** Don't allow "continue for bonus" option. Strict stop at goal.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Cumulative daily reps | Manual calculation across sessions | StorageService.getDailyRecord(today) | Handles persistence, app closures, multiple sessions |
| Goal completion check | After every rep in UI | Centralize in ActiveWorkoutProvider | Single source of truth, testable |
| Midnight reset | Custom timer | DateTime comparison on app start | Simpler, handles app being closed |
| Completion sound | Custom audio player | AudioService.playGoalAchieved() | Existing infrastructure, respects settings |

**Key insight:** The StorageService already tracks daily records with `totalPushups`. Use this instead of tracking separately.

## Common Pitfalls

### Pitfall 1: Session-Only Progress Calculation

**What goes wrong:** Goal completion only checks current session reps, ignoring previous workouts today.

**Why it happens:** Easy to check `session.totalReps >= goal` without considering cumulative progress.

**How to avoid:** Always fetch today's existing record and add session reps:
```dart
final todayReps = (await _storage.getDailyRecord(today))?.totalPushups ?? 0;
final cumulative = todayReps + session.totalReps;
```

**Warning signs:** Goal completes at exact goal number (10, 20, 50) even when user did multiple workouts.

### Pitfall 2: Midnight Reset Edge Cases

**What goes wrong:** User with active workout at midnight loses progress or gets wrong goal.

**Why it happens:** Reset logic clears today's progress while workout is in progress.

**How to avoid:** Active workouts at midnight continue with yesterday's goal until completion:
```dart
// When checking goal, use the session's start date, not current time
final sessionDate = session.startTime; // Not DateTime.now()
final existingRecord = await _storage.getDailyRecord(sessionDate);
```

**Warning signs:** Tests fail when simulating app open after midnight.

### Pitfall 3: Recovery Timer Race Condition

**What goes wrong:** Workout ends before recovery animation completes, or user can tap during completion.

**Why it happens:** Async operations (sound, navigation) happen during recovery timer callback.

**How to avoid:** Set a flag during completion to prevent interactions:
```dart
bool _isCompleting = false;

void _handleGoalCompletion(...) async {
  if (_isCompleting) return;
  _isCompleting = true;

  await provider.endWorkout();
  if (mounted) Navigator.pop(context); // Return to Home
}
```

**Warning signs:** Duplicate workouts saved, crash on double-tap.

### Pitfall 4: Overshoot Handling

**What goes wrong:** Extra reps in final series count toward stats, exceeding daily goal.

**Why it happens:** Session `totalReps` includes all reps, even those above goal.

**How to avoid:** Cap stats at goal when saving record:
```dart
final cappedPushups = min(totalReps, goal);
final excessReps = max(0, totalReps - goal);
```

**Warning signs:** Today's progress shows > 100% or > daily goal value.

## Code Examples

Verified patterns from the codebase:

### Getting Today's Progress

```dart
// Source: ActiveWorkoutProvider.endWorkout() - existing pattern
final today = DateTime.now();
final existingRecord = await _storage.getDailyRecord(today);
final pushupsAlreadyDone = existingRecord?.totalPushups ?? 0;
```

### Playing Goal Sound

```dart
// Source: WorkoutExecutionScreen._handleCountRep() - existing pattern
final audio = context.read<AudioService>();
if (settings.soundsEnabled && settings.goalSoundEnabled) {
  audio.playGoalAchieved();
}
```

### Storage Service Daily Goal

```dart
// Source: StorageService.getDailyGoal() - existing method
int dailyGoal = _storage.getDailyGoal(); // Returns 50 by default
```

### Series Completion Detection

```dart
// Source: WorkoutSession model - existing method
bool isSeriesComplete() {
  return repsInCurrentSeries >= currentSeries;
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Goal stored in session only | Goal from StorageService | Phase 04.2 | Goal persists across app restarts |
| Manual workout end | Auto-completion at goal | Phase 04.2 | No user action needed when goal reached |
| Results screen after workout | Home screen after goal | Phase 04.2 | Streamlined flow, clear completion signal |

**Deprecated/outdated:**
- None for this phase - all new behavior.

## Open Questions

1. **Visual feedback during final series**
   - What we know: No special "reps to goal" countdown during final series
   - What's unclear: Should we show any indicator that this is the final series?
   - Recommendation: Show existing GoalCelebrationWidget after recovery, not during series

2. **Completion delay duration**
   - What we know: Some delay needed for sound/visual feedback
   - What's unclear: Exact delay length (1s? 2s?)
   - Recommendation: Use 2-second delay after recovery before navigation

3. **Active workout at midnight behavior**
   - What we know: Continue with yesterday's goal until completion
   - What's unclear: What if user completes goal at 00:01 - which day gets credit?
   - Recommendation: Credit goes to workout start date (yesterday), not completion time

## Sources

### Primary (HIGH confidence)
- `C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\active_workout_provider.dart` - Current workout session management
- `C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\user_stats_provider.dart` - Stats and today's progress tracking
- `C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\repositories\storage_service.dart` - Persistence layer, getDailyGoal/getDailyRecord
- `C:\Script\Android-Apps\Push-up flutter Nuovo test\.planning\phases\04.2-goal-based-logic\04.2-CONTEXT.md` - Implementation decisions

### Secondary (MEDIUM confidence)
- `C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\screens\workout_execution\workout_execution_screen.dart` - Current workout UI flow
- `C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\screens\home\home_screen.dart` - Home screen with start button
- `C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\models\workout_session.dart` - Goal tracking fields already exist

### Tertiary (LOW confidence)
- None - all findings verified from codebase

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already in use, verified from pubspec.yaml
- Architecture: HIGH - Existing patterns analyzed, Provider pattern already used
- Pitfalls: HIGH - Edge cases identified from existing code patterns

**Research date:** 2026-01-29
**Valid until:** 30 days (stable domain, existing codebase patterns)
