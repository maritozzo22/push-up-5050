---
phase: 04.2-goal-based-logic
plan: 04
type: execute
wave: 3
depends_on: ["04.2-01", "04.2-02"]
files_modified:
  - push_up_5050/lib/repositories/storage_service.dart
  - push_up_5050/lib/providers/user_stats_provider.dart
autonomous: true

must_haves:
  truths:
    - "Goal completion status resets at midnight (new day = new workout allowed)"
    - "Active workouts at midnight continue with yesterday's goal until completion"
    - "DailyRecord stores goal completion date for accurate tracking"
    - "Goal check uses correct date (session start date for active sessions)"
  artifacts:
    - path: "push_up_5050/lib/repositories/storage_service.dart"
      provides: "Goal completion date tracking and reset logic"
      exports: ["getDailyRecord", "isGoalCompletedToday"]
    - path: "push_up_5050/lib/providers/user_stats_provider.dart"
      provides: "Today's goal status based on current date"
      contains: "isGoalCompletedToday"
  key_links:
    - from: "StorageService.getDailyRecord()"
      to: "DateTime.now()"
      via: "Date comparison for goal status"
      pattern: "_formatDate\(DateTime\.now\(\)\)"
    - from: "ActiveWorkoutProvider._checkGoalCompletion()"
      to: "session.startTime"
      via: "Use session date for goal check, not current time"
      pattern: "session\.startTime"
---

<objective>
Midnight Reset Logic for Goal Completion

Purpose: Reset goal completion status at midnight while preserving active workout state
Output: Date-based goal tracking with midnight boundary handling
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.2-goal-based-logic/04.2-CONTEXT.md
@.planning/phases/04.2-goal-based-logic/04.2-RESEARCH.md

# Prior plans for dependencies
@.planning/phases/04.2-goal-based-logic/04.2-01-SUMMARY.md
@.planning/phases/04.2-goal-based-logic/04.2-02-SUMMARY.md

# Key implementation files
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\repositories\storage_service.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\active_workout_provider.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\models\workout_session.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\models\daily_record.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add goal completion date tracking to StorageService</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add a method to check if goal was already completed today.

The current implementation uses getDailyRecord() which already returns today's record.
The DailyRecord model has a goalReached field.

Add a convenience method that explicitly checks today's goal status:
```dart
/// Check if today's daily goal has already been completed.
///
/// Returns true if today's record exists and goalReached is true.
/// Uses current date (DateTime.now()) for the check.
Future<bool> isGoalCompletedToday() async {
  final today = DateTime.now();
  final record = await getDailyRecord(today);
  return record?.goalReached ?? false;
}
```

Add this method after the getDailyRecord() method (around line 119).

This provides a clean API for checking goal completion status.
</action>
  <verify>
grep -n "isGoalCompletedToday" push_up_5050/lib/repositories/storage_service.dart
</verify>
  <done>
isGoalCompletedToday() method exists and:
- Fetches today's record using DateTime.now()
- Returns record.goalReached (or false if no record)
- Provides explicit API for goal completion check
</done>
</task>

<task type="auto">
  <name>Task 2: Fix goal completion check to use session start date for active workouts</name>
  <files>push_up_5050/lib/providers/active_workout_provider.dart</files>
  <action>
Update the _checkGoalCompletion() method (from plan 04.2-01) to use session start date instead of current time.

Current implementation uses DateTime.now() which can cause issues if workout spans midnight.

Find _checkGoalCompletion() and modify:
```dart
Future<void> _checkGoalCompletion() async {
  if (_session?.goalPushups == null) return;

  // CRITICAL: Use session start date, not current time
  // This handles workouts that span midnight correctly
  final sessionDate = _session!.startTime;
  final existingRecord = await _storage.getDailyRecord(sessionDate);
  final todayReps = existingRecord?.totalPushups ?? 0;

  // Calculate cumulative total (existing + current session)
  final cumulativeReps = todayReps + (_session?.totalReps ?? 0);
  final goal = _storage.getDailyGoal();

  if (cumulativeReps >= goal) {
    _session?.goalReached = true;
  }
}
```

The key change: use `sessionDate = _session!.startTime` instead of `DateTime.now()`.

This ensures:
- Active workouts at midnight continue with yesterday's goal
- Goal completion is attributed to the workout start date
- No double-counting across day boundary
</action>
  <verify>
grep -A 10 "_checkGoalCompletion" push_up_5050/lib/providers/active_workout_provider.dart | grep "sessionDate\|startTime"
</verify>
  <done>
_checkGoalCompletion() uses session.startTime instead of DateTime.now():
- Session start date used for fetching existing record
- Handles midnight boundary correctly
- Active workouts keep their original day's goal
</done>
</task>

<task type="auto">
  <name>Task 3: Add goal completion check to UserStatsProvider for UI use</name>
  <files>push_up_5050/lib/providers/user_stats_provider.dart</files>
  <action>
Add a convenience getter to UserStatsProvider for checking today's goal completion status.

This provides a synchronous way for the UI to check if today's goal is complete.

Add after the `dailyGoal` constant (around line 108):
```dart
/// Whether today's daily goal has been completed.
///
/// Returns true if todayPushups >= dailyGoal.
/// Synchronous check for UI consumption.
bool get isTodayGoalComplete => _todayPushups >= dailyGoal;
```

This is simpler than calling StorageService and leverages already-loaded stats.

Also add a method to refresh and re-check:
```dart
/// Refresh stats and return goal completion status.
///
/// Useful for checking goal status after app resume or state changes.
Future<bool> checkGoalCompletion() async {
  await refreshStats();
  return _todayPushups >= dailyGoal;
}
```

Add this after the refreshStats() method (around line 435).
</action>
  <verify>
grep -n "isTodayGoalComplete" push_up_5050/lib/providers/user_stats_provider.dart
grep -n "checkGoalCompletion" push_up_5050/lib/providers/user_stats_provider.dart
</verify>
  <done>
UserStatsProvider has:
- isTodayGoalComplete getter (synchronous, uses loaded stats)
- checkGoalCompletion() method (refreshes then checks)
- Both return true when todayPushups >= dailyGoal
</done>
</task>

<task type="auto">
  <name>Task 4: Update DailyRecord model to ensure goalReached is persisted</name>
  <files>push_up_5050/lib/models/daily_record.dart</files>
<action>
First, read the DailyRecord model to verify goalReached field is properly serialized.

Check that:
1. goalReached field exists in the model
2. goalReached is included in toJson()
3. goalReached is parsed in fromJson()
4. goalReached defaults to false when not present

If goalReached is missing or not properly handled, fix the model.

Expected structure:
```dart
class DailyRecord {
  ...
  final bool goalReached;

  DailyRecord({
    ...
    this.goalReached = false,
  });

  Map<String, dynamic> toJson() {
    return {
      ...
      'goalReached': goalReached,
    };
  }

  factory DailyRecord.fromJson(Map<String, dynamic> json) {
    return DailyRecord(
      ...
      goalReached: json['goalReached'] as bool? ?? false,
    );
  }
}
```

If any issues found, fix them to ensure goalReached persists correctly.
</action>
  <verify>
grep -n "goalReached" push_up_5050/lib/models/daily_record.dart
</verify>
  <done>
DailyRecord model:
- Has goalReached field (bool, defaults to false)
- Serializes goalReached in toJson()
- Parses goalReached in fromJson() with proper null handling
</done>
</task>

</tasks>

<verification>
1. Review StorageService for isGoalCompletedToday() method
2. Verify ActiveWorkoutProvider uses session.startTime for goal check
3. Verify UserStatsProvider has isTodayGoalComplete getter
4. Verify DailyRecord properly persists goalReached field
5. Run: flutter analyze lib/repositories/storage_service.dart
6. Run: flutter analyze lib/providers/user_stats_provider.dart
7. Run: flutter analyze lib/models/daily_record.dart
8. Run: flutter test test/models/daily_record_test.dart 2>&1 || echo "Tests may need to be run"
</verification>

<success_criteria>
1. Midnight boundary handled correctly (session date used, not current time)
2. Goal completion status resets on new day
3. Active workouts at midnight continue with correct goal
4. goalReached properly persisted in DailyRecord
5. UI has synchronous way to check goal status
</success_criteria>

<output>
After completion, create `.planning/phases/04.2-goal-based-logic/04.2-04-SUMMARY.md`
</output>
