---
phase: 04.2-goal-based-logic
plan: 02
type: execute
wave: 2
depends_on: ["04.2-01"]
files_modified:
  - push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart
  - push_up_5050/lib/providers/active_workout_provider.dart
autonomous: true

must_haves:
  truths:
    - "Workout auto-completes (ends) after recovery when goal is reached"
    - "Final series completes before workout ends (not mid-series)"
    - "Navigation goes to Home screen after goal completion (not results screen)"
    - "Completion sound plays when goal is reached"
  artifacts:
    - path: "push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart"
      provides: "Auto-completion flow in recovery timer callback"
      contains: "_handleGoalCompletion"
    - path: "push_up_5050/lib/providers/active_workout_provider.dart"
      provides: "endWorkout() method for terminating session"
      exports: ["endWorkout"]
  key_links:
    - from: "WorkoutExecutionScreen._startRecoveryTimer()"
      to: "ActiveWorkoutProvider.session.goalReached"
      via: "check after recovery completes"
      pattern: "session\.goalReached.*true"
    - from: "WorkoutExecutionScreen"
      to: "Home screen"
      via: "Navigator.pop() instead of results screen"
      pattern: "Navigator\.pop\(context\)"
---

<objective>
Auto-Complete Workout at Goal Reached

Purpose: End workout session and return to Home screen when daily goal is reached, after completing the current series
Output: Modified recovery timer flow with goal completion handling
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.2-goal-based-logic/04.2-CONTEXT.md
@.planning/phases/04.2-goal-based-logic/04.2-RESEARCH.md

# Prior plan for dependency
@.planning/phases/04.2-goal-based-logic/04.2-01-SUMMARY.md

# Key implementation files
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\screens\workout_execution\workout_execution_screen.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\providers\active_workout_provider.dart
@C:\Script\Android-Apps\Push-up flutter Nuovo test\push_up_5050\lib\models\workout_session.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add goal completion handler method to WorkoutExecutionScreen</name>
  <files>push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart</files>
  <action>
Add a new private method `_handleGoalCompletion()` that:

1. Takes ActiveWorkoutProvider and BuildContext parameters
2. Calls `await provider.endWorkout()` to save session
3. Plays completion sound via AudioService if enabled
4. Shows brief celebration (optional, reuse _showCelebration flag)
5. Navigates back to Home screen using `Navigator.pop(context)`

Implementation pattern:
```dart
Future<void> _handleGoalCompletion(
  ActiveWorkoutProvider provider,
  BuildContext context,
) async {
  // Prevent double-completion
  if (_isCompleting) return;
  _isCompleting = true;

  // End workout (saves session, clears active session)
  await provider.endWorkout();

  // Play goal achievement sound
  final settings = context.read<AppSettingsService>();
  final audio = context.read<AudioService>();
  if (settings.soundsEnabled && settings.goalSoundEnabled) {
    audio.playGoalAchieved();
  }

  // Navigate back to Home (not results screen)
  if (mounted) {
    Navigator.pop(context);
  }
}
```

Add this method after `_handleEndWorkout()` (around line 241).

Also add the state variable at the top of _WorkoutExecutionScreenState class:
```dart
bool _isCompleting = false;
```

Add it after the existing `bool _showCelebration = false;` line.
</action>
  <verify>
grep -n "_handleGoalCompletion" push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart
grep -n "_isCompleting" push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart
</verify>
  <done>
_handleGoalCompletion() method exists with:
- Double-completion prevention via _isCompleting flag
- endWorkout() call to save session
- Completion sound playback
- Navigation to Home screen
</done>
</task>

<task type="auto">
  <name>Task 2: Modify recovery timer to check goal completion</name>
  <files>push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart</files>
  <action>
Modify the `_startRecoveryTimer()` method to check for goal completion after recovery finishes.

Current code (around line 56-73) does:
```dart
if (complete) {
  timer.cancel();
  // Play beep
  // Auto-advance to next series
  provider.advanceToNextSeries();
}
```

Change to:
```dart
if (complete) {
  timer.cancel();

  // Play beep sound when recovery ends (if enabled)
  final settings = context.read<AppSettingsService>();
  final audio = context.read<AudioService>();
  if (settings.soundsEnabled && settings.beepEnabled) {
    audio.playBeep();
  }

  // Check if goal was reached - if so, end workout instead of advancing
  if (provider.session?.goalReached == true) {
    await _handleGoalCompletion(provider, context);
  } else {
    // Auto-advance to next series when recovery is complete
    provider.advanceToNextSeries();
  }
}
```

The key change: check `provider.session?.goalReached` and call `_handleGoalCompletion()` instead of `advanceToNextSeries()` when true.
</action>
  <verify>
grep -B 5 -A 10 "goalReached.*true" push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart | head -20
</verify>
  <done>
Recovery timer callback checks goalReached flag and:
- Calls _handleGoalCompletion() when goal reached
- Calls advanceToNextSeries() when goal not reached
- Beep still plays in both cases
</done>
</task>

<task type="auto">
  <name>Task 3: Add goal reached tracking to ActiveWorkoutProvider</name>
  <files>push_up_5050/lib/providers/active_workout_provider.dart</files>
  <action>
Ensure the ActiveWorkoutProvider properly tracks and exposes the goalReached state.

The WorkoutSession model already has `goalReached` field. Verify the ActiveWorkoutProvider exposes this correctly.

Add a getter if it doesn't exist:
```dart
/// Whether the daily goal has been reached in this session.
bool get isGoalReached => _session?.goalReached ?? false;
```

This should be added after the `sessionPoints` getter (around line 72).

This getter allows the UI to check goal status without accessing session directly.
</action>
  <verify>
grep -n "isGoalReached" push_up_5050/lib/providers/active_workout_provider.dart
</verify>
  <done>
ActiveWorkoutProvider exposes isGoalReached getter that returns session's goalReached flag (or false if no session).
</done>
</task>

</tasks>

<verification>
1. Review WorkoutExecutionScreen to verify _handleGoalCompletion() exists
2. Verify recovery timer checks goalReached before advancing series
3. Verify navigation goes to Home (Navigator.pop) not results
4. Run: flutter analyze lib/screens/workout_execution/workout_execution_screen.dart
5. Run: flutter test test/screens/workout_execution/ 2>&1 || echo "Tests may need to be updated"
</verification>

<success_criteria>
1. Recovery timer checks goalReached flag when recovery completes
2. Workout ends (endWorkout) when goal reached instead of advancing series
3. Navigation returns to Home screen, not results screen
4. Completion sound plays before navigation
5. Double-completion prevented by _isCompleting flag
</success_criteria>

<output>
After completion, create `.planning/phases/04.2-goal-based-logic/04.2-02-SUMMARY.md`
</output>
