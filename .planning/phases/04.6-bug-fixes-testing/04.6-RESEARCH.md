# Phase 04.6: Bug Fixes & Testing - Research

**Researched:** 2026-01-30
**Domain:** Flutter bug fixes, state management, UI corrections, web testing
**Confidence:** HIGH

## Summary

This phase involves fixing four specific bugs related to onboarding goal persistence, series selection limits, navigation flow after goal completion, and Statistics screen calorie card display. All bugs have been traced to their source code locations and the fixes are straightforward modifications to existing code.

**Primary recommendation:** Fix bugs in order of dependency: 04.6-01 (onboarding goal display) enables 04.6-02 (series cap), then 04.6-03 (navigation), 04.6-04 (UI fix), and finally 04.6-05 (web testing validation).

## Bug Analysis

### BUG-01: Onboarding Daily Goal Not Reflected in Home Screen

**Problem:** Home screen displays hardcoded 50 as daily goal instead of user's selected onboarding value (e.g., 20).

**Root Cause Analysis (HIGH confidence):**

1. **UserStatsProvider.dailyGoal is hardcoded** (`user_stats_provider.dart:109`):
   ```dart
   static const int dailyGoal = 50;
   ```

2. **Home screen uses hardcoded value** (`home_screen.dart:287, 358`):
   ```dart
   final goalComplete = stats.todayPushups >= UserStatsProvider.dailyGoal;
   barValue: (stats.todayPushups / UserStatsProvider.dailyGoal).clamp(0.0, 1.0),
   subtitle: '/ ${UserStatsProvider.dailyGoal}',
   ```

3. **StorageService has dynamic getter** (`storage_service.dart:346-348`):
   ```dart
   int getDailyGoal() {
     return _prefs.getInt(_keyDailyGoal) ?? 50;
   }
   ```

**Files to modify:**
- `push_up_5050/lib/providers/user_stats_provider.dart` - Change dailyGoal from const to dynamic getter
- `push_up_5050/lib/screens/home/home_screen.dart` - Use GoalsProvider instead of UserStatsProvider.dailyGoal

**Fix approach:**
1. Add `_storage` dependency to UserStatsProvider if not present
2. Change `static const int dailyGoal = 50;` to `int get dailyGoal => _storage.getDailyGoal();`
3. Update all usages to access via instance (not static)

### BUG-02: Series Selection Maximum Not Capped at Daily Goal + 10

**Problem:** User can select up to 99 series regardless of daily goal setting. Should be capped at `dailyGoal + 10` to prevent excessive workouts.

**Root Cause Analysis (HIGH confidence):**

**SeriesSelectionScreen has hardcoded maximum** (`series_selection_screen.dart:35-36`):
```dart
static const int _minStartingSeries = 1;
static const int _maxStartingSeries = 99;
```

**Onboarding stores daily goal correctly** (`storage_service.dart:339-348`):
- Key: `'daily_goal'`
- Default: 50 if not set

**Files to modify:**
- `push_up_5050/lib/screens/series_selection/series_selection_screen.dart` - Add dynamic cap calculation

**Fix approach:**
1. Inject StorageService or GoalsProvider into SeriesSelectionScreen
2. Calculate `maxStartingSeries` as `dailyGoal + 10` with upper bound of 99
3. Update `_getNextStartingSeries()` to respect dynamic cap
4. Update `_getPreviousStartingSeries()` if needed
5. Update UI validation in `onPlus` handlers

### BUG-03: Goal Completion Popup Navigation Goes to Statistics Instead of Workout Results

**Problem:** After goal completion popup dismissal, navigation goes to `/statistics` (line 288 in workout_execution_screen.dart) instead of `WorkoutSummaryScreen` (Workout Results).

**Root Cause Analysis (HIGH confidence):**

**Current navigation in _handleGoalCompletion** (`workout_execution_screen.dart:258-294`):
```dart
Future<void> _handleGoalCompletion(...) async {
  await showDialog(
    context: context,
    builder: (context) => GoalCompletionDialog(
      onDismiss: () async {
        Navigator.of(context).pop(); // Close dialog
        await provider.endWorkout();
        await Future.delayed(const Duration(milliseconds: 500));
        if (mounted) {
          Navigator.of(context).pushReplacementNamed('/statistics'); // WRONG ROUTE
        }
      },
    ),
  );
}
```

**Expected behavior:** Navigate to `WorkoutSummaryScreen` like normal workout end (_handleEndWorkout).

**Files to modify:**
- `push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart`

**Fix approach:**
1. Extract workout summary navigation logic from `_handleEndWorkout()` into reusable method
2. Call this method from both `_handleEndWorkout()` and `_handleGoalCompletion()`
3. Ensure session data is captured before `endWorkout()` (session becomes null after)

### BUG-04: Calorie Card Has Unnecessary Bar

**Problem:** Calorie card in Statistics screen displays an unnecessary gradient bar at the bottom (lines 88-99 in calorie_card.dart).

**Root Cause Analysis (HIGH confidence):**

**CalorieCard widget structure** (`calorie_card.dart:31-103`):
```dart
child: Column(
  children: [
    Icon(...),
    SizedBox(height: 4),
    Text('CALORIE BRUCIATE'),
    SizedBox(height: 2),
    Text('$kcal kcal'),
    const Spacer(),
    // Unnecessary bar at bottom (lines 88-99)
    Container(
      height: 3,
      decoration: BoxDecoration(
        gradient: LinearGradient(...),
        borderRadius: BorderRadius.circular(2),
      ),
    ),
  ],
)
```

**Comparison with TotalPushupsCard** (which doesn't have the bar):
- The bar is decorative and serves no functional purpose
- Clutters the UI

**Files to modify:**
- `push_up_5050/lib/widgets/statistics/calorie_card.dart`

**Fix approach:**
1. Remove lines 87-100 (the Spacer and bottom bar Container)
2. Adjust layout if needed (replace Spacer with SizedBox)

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Flutter | 3.x | UI framework | Project's existing framework |
| Provider | 6.x | State management | Already used throughout app |
| shared_preferences | 2.x | Persistence | Already used for storage |

### Testing
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| flutter_test | built-in | Unit/widget tests | All fix validation |
| flutter_web | built-in | Web platform testing | Phase 04.6-05 |

## Architecture Patterns

### Pattern 1: Provider Consumer for Dynamic State Access

**What:** Accessing provider values within widgets using Consumer<T>

**When to use:** Reading provider state that may change (e.g., daily goal from GoalsProvider)

**Example:**
```dart
// Source: Existing codebase (home_screen.dart:284-294)
Consumer2<UserStatsProvider, ActiveWorkoutProvider>(
  builder: (context, stats, workoutProvider, child) {
    final goalComplete = stats.todayPushups >= stats.dailyGoal;
    return StartButtonCircle(
      onTap: widget.onStartWorkout ?? () {},
      isDisabled: goalComplete,
    );
  },
),
```

**For BUG-01 fix:**
```dart
Consumer<GoalsProvider>(
  builder: (context, goals, child) {
    final dailyGoal = goals.dailyGoal.target;
    return MiniStat(
      value: '${stats.todayPushups}',
      barValue: (stats.todayPushups / dailyGoal).clamp(0.0, 1.0),
      subtitle: '/ $dailyGoal',
    );
  },
)
```

### Pattern 2: Dynamic Cap Calculation from Storage

**What:** Calculating UI limits based on persisted user preferences

**When to use:** Series selection cap based on daily goal

**Example for BUG-02:**
```dart
class _SeriesSelectionScreenState extends State<SeriesSelectionScreen> {
  int get _maxStartingSeries {
    final storage = context.read<StorageService>();
    final dailyGoal = storage.getDailyGoal();
    return (dailyGoal + 10).clamp(10, 99); // Min 10, max 99
  }

  @override
  Widget build(BuildContext context) {
    return Consumer<StorageService>(
      builder: (context, storage, child) {
        final maxSeries = _maxStartingSeries;
        // Use maxSeries for validation
      },
    );
  }
}
```

### Anti-Patterns to Avoid

- **Hardcoded constants for user-configurable values:** Never use `const int` for values that users can change in onboarding
- **Direct Provider access in build without Consumer:** Always use Consumer or context.read/watch for reactive state
- **Multiple screens with same hardcoded value:** DRY - centralize in provider or storage

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Dynamic state for daily goal | Custom state management | Provider (GoalsProvider) | Already used throughout app |
| Navigation after goal completion | Complex conditional routing | Reuse _handleEndWorkout pattern | Consistent behavior, DRY |
| Cap calculation | Inline formulas | StorageService.getDailyGoal() | Single source of truth |

## Common Pitfalls

### Pitfall 1: Static const for Dynamic Values

**What goes wrong:** Using `static const int dailyGoal = 50;` when user can configure this value in onboarding. The value never updates from storage.

**Why it happens:** Developer simplified the code by making it a compile-time constant.

**How to avoid:** Use instance getters that read from storage: `int get dailyGoal => _storage.getDailyGoal();`

**Warning signs:** Any user-configurable value as `static const`

### Pitfall 2: Navigation Without Session Data

**What goes wrong:** Calling `provider.endWorkout()` before capturing session data, leaving null values for summary screen.

**Why it happens:** Session is cleared immediately on `endWorkout()`.

**How to avoid:** Always capture session data to local variables BEFORE calling `endWorkout()`:
```dart
final totalReps = session.totalReps;
final totalKcal = session.totalKcal;
await provider.endWorkout(); // Now session is null, but we have the data
```

**Warning signs:** Accessing `provider.session` after `endWorkout()` call

### Pitfall 3: Web Platform Testing Assumptions

**What goes wrong:** Assuming Chrome/web testing behaves identically to physical device testing.

**Why it happens:** Web lacks haptics, proximity sensor, notification permissions.

**How to avoid:** Focus web testing on visual rendering and state flow, not hardware-specific features.

**Warning signs:** Tests failing on web only for hardware-dependent features

## Code Examples

### Fix for BUG-01: Dynamic Daily Goal

```dart
// Before (user_stats_provider.dart:109)
static const int dailyGoal = 50;

// After
/// Get the current daily goal from storage.
///
/// Returns the user's personalized goal from onboarding (default: 50).
int get dailyGoal => _storage.getDailyGoal();
```

```dart
// Before (home_screen.dart:354-361)
child: MiniStat(
  label: 'OGGI',
  value: '${stats.todayPushups}',
  showBar: true,
  barValue: (stats.todayPushups / UserStatsProvider.dailyGoal).clamp(0.0, 1.0),
  subtitle: '/ ${UserStatsProvider.dailyGoal}',
),

// After
Consumer<GoalsProvider>(
  builder: (context, goals, child) {
    final dailyGoal = goals.dailyGoal.target;
    return MiniStat(
      label: 'OGGI',
      value: '${stats.todayPushups}',
      showBar: true,
      barValue: (stats.todayPushups / dailyGoal).clamp(0.0, 1.0),
      subtitle: '/ $dailyGoal',
    );
  },
),
```

### Fix for BUG-02: Series Selection Cap

```dart
// Before (series_selection_screen.dart:35-36)
static const int _minStartingSeries = 1;
static const int _maxStartingSeries = 99;

// After
static const int _minStartingSeries = 1;

/// Calculate maximum starting series based on daily goal.
///
/// Caps at dailyGoal + 10 with absolute max of 99.
int _getMaxStartingSeries(BuildContext context) {
  final storage = context.read<StorageService>();
  final dailyGoal = storage.getDailyGoal();
  return (dailyGoal + 10).clamp(10, 99);
}
```

### Fix for BUG-03: Navigation to Workout Summary

```dart
// Extract shared navigation logic (workout_execution_screen.dart)
Future<void> _navigateToWorkoutSummary({
  required ActiveWorkoutProvider provider,
  required BuildContext context,
}) async {
  final session = provider.session;
  if (session == null) return;

  // Capture data before endWorkout
  final totalReps = session.totalReps;
  final totalKcal = session.totalKcal;
  final seriesCompleted = session.currentSeries - 1;
  final seriesStart = session.startingSeries;
  final duration = DateTime.now().difference(session.startTime);
  final goalReached = session.goalReached;

  await provider.endWorkout();

  // ... (rest of summary logic from _handleEndWorkout)

  if (mounted) {
    await Navigator.pushReplacement(
      context,
      MaterialPageRoute(
        builder: (context) => WorkoutSummaryScreen(...),
      ),
    );
  }
}

// In _handleGoalCompletion, replace the navigation with:
await _navigateToWorkoutSummary(provider: provider, context: context);
```

### Fix for BUG-04: Remove Calorie Card Bar

```dart
// Before (calorie_card.dart:86-100)
const Spacer(),
// Small indicator bar at bottom
Container(
  height: 3,
  decoration: BoxDecoration(
    gradient: const LinearGradient(...),
    borderRadius: BorderRadius.circular(2),
  ),
),

// After
const SizedBox(height: 8), // Just add spacing instead
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Hardcoded daily goal (50) | Storage-based dynamic goal | Onboarding implementation (Phase 03.1) | Goal set in onboarding but not propagated to UI |
| Statistics navigation after goal | Summary screen navigation (normal end) | Phase 04.3 | Goal completion diverged from normal flow |

**Deprecated/outdated:**
- `UserStatsProvider.dailyGoal` as `static const`: Should be instance getter from storage
- Bottom bar on CalorieCard: Decorative element that should be removed

## Open Questions

1. **Should series selection cap be enforced in UI only or also in ActiveWorkoutProvider?**
   - What we know: Current implementation has no cap enforcement at provider level
   - Recommendation: Enforce at UI level for this phase (simpler), provider can be future enhancement

2. **Should the "unnecessary bar" in CalorieCard be removed or made conditional?**
   - What we know: TotalPushupsCard doesn't have the bar
   - Recommendation: Remove entirely for consistency with other stat cards

3. **Web testing scope for Phase 04.6-05**
   - What we know: Some features (haptics, proximity) don't work on web
   - Recommendation: Test visual rendering and state flow only, skip hardware-dependent features

## Sources

### Primary (HIGH confidence)

**Source code analysis:**
- `push_up_5050/lib/providers/user_stats_provider.dart` - Daily goal hardcoded at line 109
- `push_up_5050/lib/providers/goals_provider.dart` - GoalsProvider with dailyGoal getter using storage
- `push_up_5050/lib/screens/home/home_screen.dart` - Home screen daily goal display at lines 287, 358
- `push_up_5050/lib/screens/series_selection/series_selection_screen.dart` - Series selection with hardcoded max at lines 35-36
- `push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart` - Goal completion navigation at line 288
- `push_up_5050/lib/widgets/statistics/calorie_card.dart` - Calorie card with bar at lines 88-99
- `push_up_5050/lib/repositories/storage_service.dart` - StorageService.getDailyGoal() at lines 346-348
- `push_up_5050/lib/screens/workout_summary/workout_summary_screen.dart` - Expected navigation target

### Secondary (MEDIUM confidence)

- Project CLAUDE.md - Architecture documentation confirming Provider pattern usage
- STATE.md - Pending todos and roadmap evolution

## Metadata

**Confidence breakdown:**
- Bug root cause analysis: HIGH - Direct source code inspection
- Fix approach: HIGH - Straightforward code modifications
- Web testing scope: MEDIUM - May discover platform-specific issues during testing

**Research date:** 2026-01-30
**Valid until:** 14 days (codebase changes possible)
