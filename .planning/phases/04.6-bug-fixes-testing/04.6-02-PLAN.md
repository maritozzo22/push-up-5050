---
phase: 04.6-bug-fixes-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/screens/series_selection/series_selection_screen.dart
autonomous: true

must_haves:
  truths:
    - "Series selection maximum is capped at daily goal + 10"
    - "User cannot select starting series higher than (daily goal + 10)"
    - "Cap is calculated dynamically from stored daily goal value"
    - "Maximum cap respects absolute upper bound of 99"
  artifacts:
    - path: "push_up_5050/lib/screens/series_selection/series_selection_screen.dart"
      provides: "Dynamic series selection cap"
      contains: "_getMaxStartingSeries|_maxStartingSeries"
  key_links:
    - from: "push_up_5050/lib/screens/series_selection/series_selection_screen.dart"
      to: "push_up_5050/lib/repositories/storage_service.dart"
      via: "getDailyGoal() call for cap calculation"
      pattern: "storage\\.getDailyGoal\\(\\)|_storage\\.getDailyGoal\\(\\)"
    - from: "_getMaxStartingSeries()"
      to: "_getNextStartingSeries()"
      via: "Cap value used in increment validation"
      pattern: "_maxStartingSeries"
---

<objective>
Fix BUG-02: Series selection maximum not capped at daily goal + 10.

Currently, SeriesSelectionScreen has hardcoded `_maxStartingSeries = 99`, allowing users to select up to 99 starting series regardless of their daily goal setting. This creates mismatched expectations - user sets 20 push-up goal but can select 50+ starting series.

Purpose: Enforce sensible workout limits by capping series selection at daily goal + 10, preventing excessively long workouts that don't match user's fitness level.
Output: Dynamic series cap calculated from stored daily goal, with absolute maximum of 99.
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/04.6-bug-fixes-testing/04.6-RESEARCH.md
@.planning/ROADMAP.md
@.planning/STATE.md
@push_up_5050/lib/screens/series_selection/series_selection_screen.dart
@push_up_5050/lib/repositories/storage_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dynamic max series calculation method</name>
  <files>push_up_5050/lib/screens/series_selection/series_selection_screen.dart</files>
  <action>
    In series_selection_screen.dart:

    1. Remove line 36: `static const int _maxStartingSeries = 99;`

    2. Add a new method to calculate max series dynamically:
       ```dart
       /// Calculate maximum starting series based on daily goal.
       ///
       /// Caps at dailyGoal + 10 with absolute maximum of 99.
       /// This prevents users from selecting excessively long workouts
       /// that don't match their fitness level from onboarding.
       int _getMaxStartingSeries(BuildContext context) {
         final storage = context.read<StorageService>();
         final dailyGoal = storage.getDailyGoal();
         return (dailyGoal + 10).clamp(10, 99);
       }
       ```

    3. Add StorageService import if not present (check existing imports).

    DO NOT modify: _minStartingSeries (stays at 1), _minRestTime, _maxRestTime, _maxGoalPushups.
  </action>
  <verify>Search for "_getMaxStartingSeries" - should exist. Search for "static const int _maxStartingSeries = 99" - should NOT exist.</verify>
  <done>Dynamic max calculation method exists, reading daily goal from storage.</done>
</task>

<task type="auto">
  <name>Task 2: Update series increment logic to use dynamic cap</name>
  <files>push_up_5050/lib/screens/series_selection/series_selection_screen.dart</files>
  <action>
    In series_selection_screen.dart, update the series increment/decrement logic:

    1. Modify `_getNextStartingSeries(int current)` method (around line 69):
       ```dart
       int _getNextStartingSeries(int current) {
         final max = _getMaxStartingSeries(context);
         if (current < 10) return (current + 1).clamp(1, max);
         if (current < max - 5) return current + 5;
         return max;
       }
       ```

    2. Modify `_getPreviousStartingSeries(int current)` method (around line 76):
       ```dart
       int _getPreviousStartingSeries(int current) {
         final max = _getMaxStartingSeries(context);
         if (current <= 11) return (current - 1).clamp(1, max);
         if (current <= 15) return 10;
         if (current % 5 == 0) return current - 5;
         return (current - 5).clamp(1, max);
       }
       ```

    3. Update the onPressed handlers for plus/minus buttons to clamp values:
       - Find `_handleStartingSeriesIncrement` (or similar button handler)
       - Ensure it doesn't exceed `_getMaxStartingSeries(context)`

    TIP: Search for where `_startingSeries` is modified and add clamping.
  </action>
  <verify>Search for usages of "_getMaxStartingSeries(context)" - should exist in increment/decrement methods.</verify>
  <done>Series selection UI respects dynamic cap, preventing selection beyond daily goal + 10.</done>
</task>

</tasks>

<verification>
1. Run `flutter analyze` - no errors in series_selection_screen.dart
2. Verify _getMaxStartingSeries uses StorageService.getDailyGoal()
3. Check that all series increment paths clamp to max value
</verification>

<success_criteria>
1. Hardcoded `_maxStartingSeries = 99` removed
2. Dynamic `_getMaxStartingSeries(BuildContext context)` method exists
3. Series increment/decrement uses dynamic cap
4. Calculation formula: `(dailyGoal + 10).clamp(10, 99)`
</success_criteria>

<output>
After completion, create `.planning/phases/04.6-bug-fixes-testing/04.6-02-SUMMARY.md`
</output>
