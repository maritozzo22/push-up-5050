---
phase: 04.6-bug-fixes-testing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart
autonomous: true

must_haves:
  truths:
    - "After goal completion popup, user navigates to Workout Summary screen"
    - "Workout Summary shows correct session data (reps, kcal, series, duration)"
    - "Navigation is consistent whether goal completed during workout or detected on app open"
  artifacts:
    - path: "push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart"
      provides: "Navigation to Workout Summary after goal completion"
      contains: "_navigateToWorkoutSummary|WorkoutSummaryScreen"
  key_links:
    - from: "workout_execution_screen.dart:_handleGoalCompletion"
      to: "workout_summary_screen.dart"
      via: "Navigator.pushReplacement to WorkoutSummaryScreen"
      pattern: "WorkoutSummaryScreen\\("
    - from: "_navigateToWorkoutSummary"
      to: "provider.endWorkout()"
      via: "Data captured before endWorkout call"
      pattern: "totalReps.*session\\.totalReps"
---

<objective>
Fix BUG-03: Goal completion popup navigates to Statistics instead of Workout Results.

Currently, when goal is completed during workout, the `_handleGoalCompletion` method (line 288 in workout_execution_screen.dart) navigates to `/statistics` route instead of `WorkoutSummaryScreen`. Normal workout end (`_handleEndWorkout`) correctly navigates to summary, but goal completion follows a different path.

Purpose: Provide consistent user experience - both normal workout end and goal completion should show Workout Summary with session stats.
Output: Unified navigation flow to WorkoutSummaryScreen for both workout end scenarios.
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/04.6-bug-fixes-testing/04.6-RESEARCH.md
@.planning/ROADMAP.md
@.planning/STATE.md
@push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart
@push_up_5050/lib/screens/workout_summary/workout_summary_screen.dart
@push_up_5050/lib/providers/active_workout_provider.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared navigation logic from _handleEndWorkout</name>
  <files>push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart</files>
  <action>
    In workout_execution_screen.dart:

    1. First, read the full `_handleEndWorkout` method to understand the complete navigation pattern and data capture.

    2. Extract the workout summary navigation logic into a new private method:
       ```dart
       /// Navigate to workout summary screen with session data.
       ///
       /// Captures session data BEFORE calling endWorkout() because
       /// session becomes null after endWorkout(). Used by both
       /// normal workout end and goal completion scenarios.
       Future<void> _navigateToWorkoutSummary({
         required ActiveWorkoutProvider provider,
         required BuildContext context,
       }) async {
         final session = provider.session;
         if (session == null) return;

         // Capture data before endWorkout (session becomes null after)
         final totalReps = session.totalReps;
         final totalKcal = session.totalKcal;
         final seriesCompleted = session.currentSeries - 1;
         final seriesStart = session.startingSeries;
         final duration = DateTime.now().difference(session.startTime);
         final goalReached = session.goalReached;

         await provider.endWorkout();

         if (context.mounted) {
           await Navigator.pushReplacement(
             context,
             MaterialPageRoute(
               builder: (context) => WorkoutSummaryScreen(
                 totalReps: totalReps,
                 totalKcal: totalKcal,
                 seriesCompleted: seriesCompleted,
                 seriesStart: seriesStart,
                 duration: duration,
                 goalReached: goalReached,
               ),
             ),
           );
         }
       }
       ```

    3. Update `_handleEndWorkout` to call this new method instead of duplicating the logic.

    DO NOT modify: _handleGoalCompletion yet (that's Task 2).
  </action>
  <verify>Search for "_navigateToWorkoutSummary" - method should exist. _handleEndWorkout should call it.</verify>
  <done>Shared navigation method exists, capturing session data before endWorkout.</done>
</task>

<task type="auto">
  <name>Task 2: Update _handleGoalCompletion to navigate to Workout Summary</name>
  <files>push_up_5050/lib/screens/workout_execution/workout_execution_screen.dart</files>
  <action>
    In workout_execution_screen.dart, find the `_handleGoalCompletion` method (around line 258-294):

    1. Read the current implementation - it currently:
       - Shows GoalCompletionDialog
       - Calls `provider.endWorkout()` in onDismiss
       - Navigates to `/statistics` route (line 288)

    2. Replace the `/statistics` navigation with call to `_navigateToWorkoutSummary`:
       ```dart
       Future<void> _handleGoalCompletion(
         ActiveWorkoutProvider provider,
         BuildContext context,
       ) async {
         // Show goal completion dialog first
         await showDialog(
           context: context,
           builder: (dialogContext) => GoalCompletionDialog(
             onDismiss: () async {
               Navigator.of(dialogContext).pop(); // Close dialog
               // Navigate to summary using shared method
               if (context.mounted) {
                 await _navigateToWorkoutSummary(
                   provider: provider,
                   context: context,
                 );
               }
             },
           ),
         );
       }
       ```

    3. Remove any direct `endWorkout()` calls in the dialog onDismiss - let `_navigateToWorkoutSummary` handle it.

    4. Remove the 500ms delay if present (the new method handles transition timing).

    CRITICAL: Session data must be captured before endWorkout() - the extracted method handles this.
  </action>
  <verify>Search for "Navigator.of(context).pushReplacementNamed('/statistics')" in _handleGoalCompletion - should NOT exist. Search for "_navigateToWorkoutSummary" - should be called from _handleGoalCompletion.</verify>
  <done>Goal completion popup navigates to Workout Summary screen, showing session stats.</done>
</task>

</tasks>

<verification>
1. Run `flutter analyze` - no errors in workout_execution_screen.dart
2. Verify no `/statistics` navigation in _handleGoalCompletion
3. Check that _navigateToWorkoutSummary captures data before endWorkout
4. Confirm WorkoutSummaryScreen is imported
</verification>

<success_criteria>
1. _navigateToWorkoutSummary method exists with proper data capture
2. _handleGoalCompletion calls _navigateToWorkoutSummary
3. No direct `/statistics` navigation in goal completion flow
4. Session data (totalReps, totalKcal, etc.) passed to WorkoutSummaryScreen
</success_criteria>

<output>
After completion, create `.planning/phases/04.6-bug-fixes-testing/04.6-03-SUMMARY.md`
</output>
