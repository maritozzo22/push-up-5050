---
phase: 03.4-challenges-streak-freeze
plan: 03
type: execute
wave: 1
depends_on: ["03.4-01"]
files_modified:
  - push_up_5050/lib/repositories/storage_service.dart
  - push_up_5050/lib/providers/user_stats_provider.dart
  - push_up_5050/lib/screens/statistics/statistics_screen.dart
  - push_up_5050/lib/l10n/app_it.arb
  - push_up_5050/lib/l10n/app_en.arb
autonomous: true

must_haves:
  truths:
    - "Streak freeze allowance tracked (1 per month, resets on 1st)"
    - "Streak freeze auto-activates when user has weekly push-ups > 0 but < goal"
    - "Streak freeze prevents streak reset for one week"
    - "Snowflake icon ❄️ displayed next to streak when freeze is active"
    - "Localization keys added for freeze UI text"
  artifacts:
    - path: "push_up_5050/lib/repositories/storage_service.dart"
      provides: "Streak freeze tracking methods"
      contains: "getStreakFreezeAllowance", "useStreakFreeze", "isStreakFreezeActive", "resetMonthlyStreakFreeze"
    - path: "push_up_5050/lib/providers/user_stats_provider.dart"
      provides: "Streak freeze state"
      contains: "streakFreezeActive", "remainingStreakFreezes"
  key_links:
    - from: "lib/screens/statistics/statistics_screen.dart"
      to: "lib/providers/user_stats_provider.dart"
      via: "streakFreezeActive getter"
      pattern: "stats.streakFreezeActive"
    - from: "lib/screens/statistics/statistics_screen.dart"
      to: "lib/providers/user_stats_provider.dart"
      via: "remainingStreakFreezes getter"
      pattern: "stats.remainingStreakFreezes"
    - from: "lib/repositories/storage_service.dart"
      to: "lib/repositories/storage_service.dart"
      via: "resetMonthlyStreakFreeze()"
      pattern: "resetMonthlyStreakFreeze\\(\\)"
---

<objective>
Implement streak freeze system: track 1 freeze per month (resets on 1st), auto-activate when user has weekly activity but misses goal, prevent streak reset, show snowflake ❄️ indicator when active. Add localization for freeze UI text.
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude\get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-CONTEXT.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-01-SUMMARY.md
@.planning/phases/03.3-weekly-goals/03.3-01-SUMMARY.md

# Existing patterns to follow:
- StorageService flag pattern with monthly reset
- calculateWeeklyStreak() for week-based streak calculation
- UserStatsProvider load pattern for loading additional state
- MiniStatCard pattern for displaying stats with icons
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add streak freeze storage keys and basic tracking</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add streak freeze storage infrastructure:

1. **Add storage keys** at top of file with other weekly keys (around line 40):
```dart
static const String _keyStreakFreezeRemaining = 'streak_freeze_remaining';
static const String _keyStreakFreezeActiveWeek = 'streak_freeze_active_week';
static const String _keyStreakFreezeLastMonth = 'streak_freeze_last_month';
```

2. **getStreakFreezeAllowance()** - Get remaining freezes for current month
   - Returns: int (0 or 1, but stored as int for flexibility)
   - Key: _keyStreakFreezeRemaining
   - Default: 1 if not set (user gets 1 freeze per month)
   - Check if month changed and reset if needed

3. **resetMonthlyStreakFreeze()** - Reset freeze allowance on 1st of month
   - Set _keyStreakFreezeRemaining = 1
   - Set _keyStreakFreezeLastMonth = current month (YYYY-MM format)
   - Clear active week flag
   - Call this whenever checking allowance

4. **Add in new "Streak Freeze" section** after "Weekly State" section

DO NOT:
- Allow more than 1 freeze per month
- Reset on app launch (only on month change)
- Use complex state (simple int counter + bool active flag)
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
Streak freeze storage added:
- Storage keys defined
- getStreakFreezeAllowance() returns remaining freezes (0 or 1)
- resetMonthlyStreakFreeze() resets counter on new month
- No analyzer warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Add streak freeze activation and active state methods</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add streak freeze activation and state management:

1. **isStreakFreezeActive()** - Check if freeze is currently active
   - Returns: bool
   - Get active week number from _keyStreakFreezeActiveWeek
   - Compare with current week number (getWeekNumber())
   - Returns true if current week matches active week

2. **useStreakFreeze()** - Activate streak freeze for current week
   - Check if allowance > 0 (getStreakFreezeAllowance())
   - If 0, return false (no freeze available)
   - Decrement remaining count
   - Set active week to current week number (getWeekNumber())
   - Save remaining count and active week
   - Return true on success

3. **getStreakFreezeActiveWeek()** - Get the week number when freeze was activated
   - Returns: String (week number or empty string)
   - Key: _keyStreakFreezeActiveWeek

Add in "Streak Freeze" section after getStreakFreezeAllowance().

DO NOT:
- Allow activation if remaining = 0
- Allow activation if already active for current week
- Forget to decrement remaining count on use
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
Streak freeze activation added:
- isStreakFreezeActive() checks current week vs active week
- useStreakFreeze() decrements counter and sets active week
- getStreakFreezeActiveWeek() returns active week number
- Prevents duplicate activation
  </done>
</task>

<task type="auto">
  <name>Task 3: Add auto-activation logic for streak freeze</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add auto-activation method for streak freeze:

**autoActivateStreakFreezeIfNeeded(int weeklyTotal, int weeklyGoal)** - Auto-activate if conditions met
- Returns: bool (true if freeze was activated)

Conditions for auto-activation:
1. Weekly total > 0 (user did some push-ups)
2. Weekly total < weekly goal (user missed their goal)
3. Freeze is available (getStreakFreezeAllowance() > 0)
4. Freeze is not already active for this week

Implementation:
1. Check if weeklyTotal > 0 and weeklyTotal < weeklyGoal
2. Check if freeze is available (remaining > 0)
3. Check if not already active (!isStreakFreezeActive())
4. If all conditions met, call useStreakFreeze() and return true
5. Return false if conditions not met

This should be called during Sunday weekly review or streak calculation.

Add in "Streak Freeze" section after useStreakFreeze().

DO NOT:
- Auto-activate if weekly total = 0 (user didn't work out at all)
- Auto-activate if goal was reached (no protection needed)
- Allow multiple activations per week
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
Auto-activation added:
- autoActivateStreakFreezeIfNeeded() checks all conditions
- Activates only if user worked out but missed goal
- Prevents duplicate activation
- Returns true if activated
  </done>
</task>

<task type="auto">
  <name>Task 4: Add streak freeze state to UserStatsProvider</name>
  <files>push_up_5050/lib/providers/user_stats_provider.dart</files>
  <action>
Add streak freeze state to provider:

1. **Add private fields** after _weeklyStreak (around line 32):
```dart
bool _streakFreezeActive = false;
int _remainingStreakFreezes = 1;
```

2. **Add public getters** after weeklyStreak getter (around line 78):
```dart
bool get streakFreezeActive => _streakFreezeActive;
int get remainingStreakFreezes => _remainingStreakFreezes;
```

3. **Load in loadStats()** after _weeklyStreak line (around line 170):
```dart
_streakFreezeActive = await _storage.isStreakFreezeActive();
_remainingStreakFreezes = await _storage.getStreakFreezeAllowance();
```

4. **Add method to manually activate freeze**:
```dart
Future<bool> activateStreakFreeze() async {
  if (_remainingStreakFreezes <= 0) return false;
  final activated = await _storage.useStreakFreeze();
  if (activated) {
    _streakFreezeActive = true;
    _remainingStreakFreezes = await _storage.getStreakFreezeAllowance();
    notifyListeners();
  }
  return activated;
}
```

DO NOT:
- Create separate load method (use existing loadStats)
- Modify existing streak calculation
- Forget to notify listeners on state change
  </action>
  <verify>
Run: flutter analyze
Run: flutter test (provider tests)
  </verify>
  <done>
Streak freeze state added to provider:
- _streakFreezeActive and _remainingStreakFreezes fields
- Public getters expose state
- Loaded in loadStats()
- activateStreakFreeze() method for manual activation
  </done>
</task>

<task type="auto">
  <name>Task 5: Add localization keys for streak freeze</name>
  <files>push_up_5050/lib/l10n/app_it.arb, push_up_5050/lib/l10n/app_en.arb</files>
  <action>
Add localization keys for streak freeze UI:

**English (app_en.arb):**
```json
"streakFreeze": "Streak Freeze",
"streakFreezeActive": "Streak Freeze Active",
"streakFreezeRemaining": "Freeze Remaining: {count}",
"streakFreezeUsed": "No freezes remaining",
"streakFreezeDescription": "Protect your streak for one week",
"streakFreezeActivate": "Activate Streak Freeze"
```

**Italian (app_it.arb):**
```json
"streakFreeze": "Protezione Streak",
"streakFreezeActive": "Protezione Attiva",
"streakFreezeRemaining": "Protezioni Rimaste: {count}",
"streakFreezeUsed": "Nessuna protezione rimasta",
"streakFreezeDescription": "Proteggi la tua streak per una settimana",
"streakFreezeActivate": "Attiva Protezione"
```

Add at end of each file, before the closing brace.

DO NOT:
- Modify existing keys
- Use inconsistent naming
- Forget to add to both files
  </action>
  <verify>
Run: flutter pub get (to regenerate localization files)
Run: flutter analyze
  </verify>
  <done>
Localization keys added:
- 6 new keys in both IT and EN
- Keys follow existing naming pattern
- Localization files regenerated
  </done>
</task>

<task type="auto">
  <name>Task 6: Display streak freeze indicator in StatisticsScreen</name>
  <files>push_up_5050/lib/screens/statistics/statistics_screen.dart</files>
  <action>
Add streak freeze visual indicator to statistics screen:

1. **Modify Streak mini stat card** to show snowflake when freeze is active:
   - Add conditional icon: ❄️ when streakFreezeActive is true
   - Or add subtitle showing freeze status

2. **Implementation** - modify _MiniStatCard for Streak (around line 148):
```dart
Expanded(
  child: _MiniStatCard(
    label: 'Streak',
    value: stats.currentStreak.toString(),
    icon: stats.streakFreezeActive ? Icons.ac_unit_rounded : Icons.calendar_today_rounded,
    iconColor: stats.streakFreezeActive ? Color(0xFF64B5F6) : Color(0xFFFF7A18),
    subtitle: stats.streakFreezeActive ? '❄️' : null,
  ),
),
```

3. **Optional: Add separate freeze status card** if space allows:
   - Could replace one of the existing mini cards
   - Or add as a fifth card in the row

DO NOT:
- Remove existing streak display
- Break card layout (4 cards fit in row)
- Use hardcoded colors (use existing AppColors)
  </action>
  <verify>
Run: flutter analyze
Run: flutter run -d windows (visual test)
  </verify>
  <done>
Streak freeze indicator added:
- Snowflake icon ❄️ displays when freeze active
- Streak card color changes to blue when freeze active
- Existing layout preserved
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- flutter test passes
- flutter analyze passes with no warnings
- Streak freeze allowance resets on 1st of month
- Auto-activation works when conditions met
- Snowflake indicator displays when freeze active
- Localization works in both IT and EN
- Streak freeze prevents streak reset (verified via streak calculation)
</verification>

<success_criteria>
1. Streak freeze storage keys and methods added
2. Auto-activation triggers correctly (weekly activity but missed goal)
3. Freeze state loaded and exposed via UserStatsProvider
4. Visual indicator (snowflake) displays when active
5. Localization keys added for freeze UI
6. Streak freeze prevents streak reset for one week
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-challenges-streak-freeze/03.4-03-SUMMARY.md`
</output>
