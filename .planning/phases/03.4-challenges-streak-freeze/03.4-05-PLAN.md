---
phase: 03.4-challenges-streak-freeze
plan: 05
type: execute
wave: 1
depends_on: ["03.4-01", "03.4-02"]
files_modified:
  - push_up_5050/lib/screens/statistics/statistics_screen.dart
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Points display updates immediately after challenge bonus award"
    - "User sees 200 points added to total when challenge completes"
    - "Consumer<UserStatsProvider> rebuilds when loadStats() completes"
    - "No app restart required to see updated points"
  artifacts:
    - path: "push_up_5050/lib/screens/statistics/statistics_screen.dart"
      provides: "Immediate points refresh after bonus award"
      contains: "_checkChallengeCompletion()", "setState(() {})", "Consumer<UserStatsProvider>"
  key_links:
    - from: "lib/screens/statistics/statistics_screen.dart"
      to: "lib/providers/user_stats_provider.dart"
      via: "notifyListeners() in loadStats() triggers Consumer rebuild"
      pattern: "notifyListeners\\(\\)"
    - from: "lib/screens/statistics/statistics_screen.dart"
      to: "lib/providers/user_stats_provider.dart"
      via: "Consumer widget wraps points display"
      pattern: "Consumer<UserStatsProvider>"

verified_facts:
  - "loadStats() calls notifyListeners() at lines 151, 217, 224 in user_stats_provider.dart"
  - "Consumer<UserStatsProvider> at line 83-90 wraps entire content including points display at 217-223"
  - "Points display uses stats.totalPoints.toString() which should update on Consumer rebuild"
---

<objective>
Ensure the "Punti" display updates immediately after awarding the 200-point weekly challenge bonus. Diagnostic has confirmed Consumer is correctly wrapped and notifyListeners() exists. The fix is to add setState() after loadStats() to explicitly trigger StatefulWidget rebuild, ensuring the Consumer rebuilds with fresh data.
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-CONTEXT.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-VERIFICATION.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-01-SUMMARY.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-02-SUMMARY.md

# Verified diagnostic facts:
- UserStatsProvider.loadStats() calls notifyListeners() at lines 151, 217, 224
- Consumer<UserStatsProvider> at statistics_screen.dart:83-90 wraps content
- Points display at statistics_screen.dart:217-223 uses stats.totalPoints.toString()
- _checkChallengeCompletion() at statistics_screen.dart:267-290 calls await stats.loadStats() at line 283

# Root cause diagnosis:
Consumer structure is correct, but timing issue exists. The await stats.loadStats() completes and notifyListeners() is called, but the StatefulWidget may not rebuild immediately because:
1. The Consumer rebuild depends on Provider's listener notification propagation
2. Adding setState(() {}) after loadStats() ensures immediate StatefulWidget rebuild

# Gap reason from VERIFICATION.md:
"Bonus award flow exists (awardWeeklyChallengeBonus adds 200 points, saves record, marks completed) but there is no visual confirmation in UI beyond the popup. Points are awarded correctly but stats display does not show immediate update."
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Consumer widget structure wraps points display</name>
  <files>push_up_5050/lib/screens/statistics/statistics_screen.dart</files>
  <action>
First, verify the diagnostic findings are correct:

1. **Read statistics_screen.dart** lines 80-95 to confirm:
   - Consumer<UserStatsProvider> wraps the entire content
   - The points display at lines 217-223 is inside the Consumer builder

2. **Read user_stats_provider.dart** lines 145-226 to confirm:
   - loadStats() calls notifyListeners() at line 217
   - _totalPoints is updated at line 163 from storage
   - No early returns skip the notification

3. **Expected finding**: Consumer is correctly positioned and notifyListeners() exists.
   This confirms the issue is timing, not structure.

4. **Document the finding**: The fix is to add setState(() {}) after loadStats() to force immediate StatefulWidget rebuild.

DO NOT modify any code in this task - this is a verification/diagnostic task only.
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
Verified:
- Consumer<UserStatsProvider> at line 83-90 wraps points display at 217-223
- loadStats() calls notifyListeners() at lines 151, 217, 224
- _totalPoints field is updated at line 163 before notifyListeners()
- Issue confirmed: timing, not structure
  </done>
</task>

<task type="auto">
  <name>Task 2: Add setState() to force immediate UI rebuild after loadStats()</name>
  <files>push_up_5050/lib/screens/statistics/statistics_screen.dart</files>
  <action>
Modify _checkChallengeCompletion() to add setState(() {}) after loadStats() completes:

1. **Find the existing code** at line 267-290:
```dart
Future<void> _checkChallengeCompletion() async {
  if (_hasCheckedCompletion) return;
  _hasCheckedCompletion = true;

  final stats = context.read<UserStatsProvider>();
  final goals = context.read<GoalsProvider>();
  final storage = context.read<StorageService>();

  final challengeTarget = goals.dailyGoal.target * 7;
  if (stats.weekTotal >= challengeTarget) {
    final weekNumber = storage.getWeekNumber(DateTime.now());
    final alreadyCompleted = await storage.hasWeeklyChallengeBeenCompleted(weekNumber);

    if (!alreadyCompleted) {
      // Award bonus first
      await storage.awardWeeklyChallengeBonus(weekNumber);
      await stats.loadStats(); // Refresh to show new points

      if (mounted) {
        _showChallengeCompletionPopup(challengeTarget);
      }
    }
  }
}
```

2. **Add setState() after loadStats()**:
```dart
Future<void> _checkChallengeCompletion() async {
  if (_hasCheckedCompletion) return;
  _hasCheckedCompletion = true;

  final stats = context.read<UserStatsProvider>();
  final goals = context.read<GoalsProvider>();
  final storage = context.read<StorageService>();

  final challengeTarget = goals.dailyGoal.target * 7;
  if (stats.weekTotal >= challengeTarget) {
    final weekNumber = storage.getWeekNumber(DateTime.now());
    final alreadyCompleted = await storage.hasWeeklyChallengeBeenCompleted(weekNumber);

    if (!alreadyCompleted) {
      // Award bonus first
      await storage.awardWeeklyChallengeBonus(weekNumber);

      // Refresh stats to load the new points total
      await stats.loadStats();

      // Force UI rebuild to show updated points immediately
      if (mounted) {
        setState(() {}); // TRIGGER: Forces StatefulWidget rebuild, Consumer gets fresh totalPoints
        _showChallengeCompletionPopup(challengeTarget);
      }
    }
  }
}
```

3. **Why setState() works**:
   - loadStats() calls notifyListeners() which marks Provider as "changed"
   - setState() forces the StatefulWidget to rebuild immediately
   - During rebuild, Consumer<UserStatsProvider> rebuilds its builder
   - The builder reads stats.totalPoints which now reflects the +200 bonus

DO NOT:
- Remove the existing loadStats() call
- Change the popup timing
- Add delays or sleep calls
  </action>
  <verify>
Run: flutter analyze
Run: flutter test
  </verify>
  <done>
_checkChallengeCompletion() updated:
- awardWeeklyChallengeBonus() completes before loadStats()
- loadStats() is properly awaited
- setState(() {}) forces StatefulWidget rebuild after stats loaded
- Points display at line 217-223 shows updated value immediately
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- flutter analyze passes with no warnings
- flutter test passes
- Awarding challenge bonus triggers immediate UI update
- "Punti" card shows new total +200 immediately after completion
- No app restart required to see updated points
- Consumer<UserStatsProvider> rebuilds triggered by setState()
</verification>

<success_criteria>
1. Consumer structure verified as correct (diagnostic confirms no structural issue)
2. setState(() {}) added after loadStats() to force immediate rebuild
3. _checkChallengeCompletion() properly awaits async operations
4. Points display updates immediately without app restart
5. User sees 200 points added when popup appears
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-challenges-streak-freeze/03.4-05-SUMMARY.md`
</output>
