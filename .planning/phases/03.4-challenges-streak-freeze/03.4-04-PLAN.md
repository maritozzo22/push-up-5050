---
phase: 03.4-challenges-streak-freeze
plan: 04
type: execute
wave: 1
depends_on: ["03.4-01", "03.4-03"]
files_modified:
  - push_up_5050/lib/screens/statistics/statistics_screen.dart
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Streak freeze auto-activates when user has weekly push-ups > 0 but < goal"
    - "Auto-activation is triggered during statistics screen initialization"
    - "Streak freeze state refreshes after auto-activation"
    - "User sees snowflake indicator when freeze is auto-activated"
  artifacts:
    - path: "push_up_5050/lib/screens/statistics/statistics_screen.dart"
      provides: "Auto-activation trigger for streak freeze"
      contains: "_checkStreakFreezeAutoActivation()", "autoActivateStreakFreezeIfNeeded()"
  key_links:
    - from: "lib/screens/statistics/statistics_screen.dart"
      to: "lib/repositories/storage_service.dart"
      via: "autoActivateStreakFreezeIfNeeded()"
      pattern: "autoActivateStreakFreezeIfNeeded\\(\\)"
    - from: "lib/screens/statistics/statistics_screen.dart"
      to: "lib/providers/user_stats_provider.dart"
      via: "loadStats() for state refresh"
      pattern: "loadStats\\(\\)"
---

<objective>
Wire the orphaned `autoActivateStreakFreezeIfNeeded()` method into StatisticsScreen initialization. The method exists with perfect logic (checks weeklyTotal > 0, weeklyTotal < weeklyGoal, allowance > 0, not already active) but has zero callers. This plan calls the method during screen initialization, refreshes state to show the freeze, and ensures the snowflake indicator appears.
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\olegn\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-CONTEXT.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-VERIFICATION.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-01-SUMMARY.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-03-SUMMARY.md

# Existing code to work with:
- autoActivateStreakFreezeIfNeeded() at storage_service.dart:689-716 (28 lines, fully implemented)
- StatisticsScreen.initState() at line 54-62 (already calls loadStats and _checkChallengeCompletion)
- UserStatsProvider.loadStats() loads _streakFreezeActive and _remainingStreakFreezes
- Snowflake icon already wired at statistics_screen.dart:189-194

# Gap reason from VERIFICATION.md:
"autoActivateStreakFreezeIfNeeded() method exists with perfect logic but is never called. The method has all correct logic (checks weeklyTotal > 0, weeklyTotal < weeklyGoal, allowance > 0, not already active) but there is no integration point that invokes it."
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add streak freeze auto-activation check to StatisticsScreen</name>
  <files>push_up_5050/lib/screens/statistics/statistics_screen.dart</files>
  <action>
Add method to check and auto-activate streak freeze:

1. **Add new method** in _StatisticsScreenState after _checkChallengeCompletion():
```dart
/// Check if streak freeze should auto-activate and refresh state.
///
/// Calls StorageService.autoActivateStreakFreezeIfNeeded() which checks:
/// - Weekly total > 0 (user did some push-ups)
/// - Weekly total < weekly goal (user missed their goal)
/// - Freeze is available (remaining > 0)
/// - Freeze is not already active
///
/// If activated, refreshes stats to show the freeze state and snowflake.
Future<void> _checkStreakFreezeAutoActivation() async {
  final stats = context.read<UserStatsProvider>();
  final goals = context.read<GoalsProvider>();
  final storage = context.read<StorageService>();

  final weeklyGoal = goals.weeklyTarget;
  final activated = await storage.autoActivateStreakFreezeIfNeeded(
    stats.weekTotal,
    weeklyGoal,
  );

  if (activated) {
    // Refresh stats to show the freeze state (snowflake icon, remaining count)
    await stats.loadStats();
  }
}
```

2. **Call the method in initState** after _checkChallengeCompletion():
```dart
@override
void initState() {
  super.initState();
  // Load stats on init after first frame
  WidgetsBinding.instance.addPostFrameCallback((_) {
    context.read<UserStatsProvider>().loadStats();
    _checkChallengeCompletion();
    _checkStreakFreezeAutoActivation(); // ADD THIS LINE
  });
}
```

DO NOT:
- Modify the autoActivateStreakFreezeIfNeeded() logic (it's correct)
- Add user-facing confirmation (auto-activation is silent by design)
- Call from multiple places (initiate once per session in initState)
  </action>
  <verify>
Run: flutter analyze
Run: flutter test
  </verify>
  <done>
Auto-activation check added:
- _checkStreakFreezeAutoActivation() method created
- Called in initState after loadStats
- Calls storage.autoActivateStreakFreezeIfNeeded() with correct parameters
- Refreshes stats if activated to show snowflake indicator
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- flutter analyze passes with no warnings
- flutter test passes
- StatisticsScreen calls autoActivateStreakFreezeIfNeeded() during initialization
- State refresh occurs when freeze is activated
- Snowflake indicator (Icons.ac_unit_rounded) appears when freeze is active
- Remaining freezes count decrements after activation
</verification>

<success_criteria>
1. Auto-activation method is called from StatisticsScreen
2. Weekly total > 0 but < goal triggers auto-activation
3. User stats refresh after activation to show updated state
4. Snowflake icon displays in Streak card when freeze is active
5. Remaining freezes count decreases from 1 to 0 after activation
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-challenges-streak-freeze/03.4-04-SUMMARY.md`
</output>
