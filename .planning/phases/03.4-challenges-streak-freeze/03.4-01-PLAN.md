---
phase: 03.4-challenges-streak-freeze
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - push_up_5050/lib/repositories/storage_service.dart
autonomous: true

must_haves:
  truths:
    - "Weekly challenge completion flag tracked per week to prevent duplicate awards"
    - "Weekly challenge target calculated as daily goal × 7"
    - "Challenge completion checked and awarded when weekly total reaches target"
    - "Weekly challenge state persists across app sessions"
  artifacts:
    - path: "push_up_5050/lib/repositories/storage_service.dart"
      provides: "Weekly challenge tracking methods"
      contains: "hasWeeklyChallengeBeenCompleted", "markWeeklyChallengeCompleted", "calculateWeeklyChallengeTarget", "awardWeeklyChallengeBonus"
  key_links:
    - from: "lib/providers/user_stats_provider.dart"
      to: "lib/repositories/storage_service.dart"
      via: "calculateWeeklyChallengeTarget()"
      pattern: "_storage.calculateWeeklyChallengeTarget\\(\\)"
    - from: "lib/providers/weekly_review_provider.dart"
      to: "lib/repositories/storage_service.dart"
      via: "hasWeeklyChallengeBeenCompleted()"
      pattern: "_storage.hasWeeklyChallengeBeenCompleted\\(\\)"
---

<objective>
Create weekly challenge tracking infrastructure in StorageService with per-week completion flags, target calculation (daily goal × 7), and bonus award methods. This enables the weekly challenge system where users earn 200 bonus points and a badge for reaching the higher weekly target.
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude\get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-CONTEXT.md
@.planning/phases/03.3-weekly-goals/03.3-01-SUMMARY.md

# Existing patterns to follow:
- StorageService flag pattern (_keyWeeklyReviewShown, _keyWeeklyBonusAwarded)
- getWeekNumber() for week key generation
- DailyRecord points addition pattern (see WeeklyReviewProvider.awardWeeklyBonus)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add weekly challenge storage key and target calculation</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add weekly challenge storage infrastructure:

1. **Add storage key** at top of file with other weekly keys (around line 40):
   - _keyWeeklyChallengeCompleted = 'weekly_challenge_completed_'

2. **calculateWeeklyChallengeTarget(int dailyGoal)** - Calculate weekly challenge target
   - Returns: int (daily goal × 7)
   - Challenge is harder than weekly goal (7 days vs 5 days)
   - Formula: dailyGoal * 7
   - Add in "Weekly State" section after getWeeklyGoal()

3. **Add in "Weekly State" section** after markWeeklyBonusAwarded()

DO NOT:
- Create new utility classes (keep in StorageService)
- Use complex formulas (simple dailyGoal × 7)
- Modify existing weekly goal calculation
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
Challenge infrastructure added:
- _keyWeeklyChallengeCompleted storage key defined
- calculateWeeklyChallengeTarget() returns daily goal × 7
- No analyzer warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Add weekly challenge completion flag tracking</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add flag-based tracking for weekly challenge completion:

1. **hasWeeklyChallengeBeenCompleted(String weekNumber)** - Check if challenge completed for week
   - Storage key: "weekly_challenge_completed_{weekNumber}"
   - Returns false if not set (first time)
   - Returns bool from SharedPreferences
   - Week number format: "YYYY-WW" from getWeekNumber()

2. **markWeeklyChallengeCompleted(String weekNumber)** - Mark challenge as completed for week
   - Sets flag to true in SharedPreferences
   - Prevents duplicate bonus awards for same week

3. **Add in "Weekly State" section** after calculateWeeklyChallengeTarget()

Follow pattern of hasWeeklyReviewBeenShown()/markWeeklyReviewShown().

DO NOT:
- Combine challenge tracking with other weekly flags (separate required)
- Create new state classes (use simple bool flags)
- Use complex serialization (bool is sufficient)
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
Challenge flag tracking added:
- hasWeeklyChallengeBeenCompleted() checks completion status
- markWeeklyChallengeCompleted() saves completion status
- Follows existing flag pattern
  </done>
</task>

<task type="auto">
  <name>Task 3: Add weekly challenge bonus award method</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add method to award weekly challenge bonus points:

**awardWeeklyChallengeBonus(String weekNumber)** - Award 200 bonus points for challenge completion
- Bonus amount: 200 points (fixed)
- Get today's record via getDailyRecord()
- Add 200 points to existing pointsEarned
- Save updated record via saveDailyRecord()
- Mark challenge as completed via markWeeklyChallengeCompleted()

Implementation:
1. Check if challenge already completed (return early if true)
2. Get today's DailyRecord
3. Create new record with pointsEarned + 200
4. Save record
5. Mark challenge completed
6. Return the points awarded (200) or 0 if already completed

Add in "Weekly State" section after flag methods.

DO NOT:
- Award bonus if already completed (check flag first)
- Use variable bonus amount (fixed 200 points)
- Modify other record fields (only pointsEarned)
  </action>
  <verify>
Run: flutter analyze
Run: flutter test (if any storage tests exist)
  </verify>
  <done>
Challenge bonus award method added:
- awardWeeklyChallengeBonus() adds 200 points to today's record
- Prevents duplicate awards via flag check
- Returns points awarded
  </done>
</task>

<task type="auto">
  <name>Task 4: Add weekly challenge completion check method</name>
  <files>push_up_5050/lib/repositories/storage_service.dart</files>
  <action>
Add method to check and award challenge completion based on weekly total:

**checkWeeklyChallengeCompletion(int weeklyTotal, int dailyGoal)** - Check if challenge completed
- Returns: int (points awarded: 200 or 0)
- Calculates challenge target: dailyGoal × 7
- If weeklyTotal >= challenge target:
  - Check if already completed
  - If not completed, award bonus via awardWeeklyChallengeBonus()
  - Return 200
- Return 0 if not completed or already awarded

Usage: Call after each workout or when weekly stats are refreshed.
Triggers bonus award and marks completion flag.

Add in "Weekly State" section after awardWeeklyChallengeBonus().

DO NOT:
- Award bonus if target not reached
- Allow duplicate awards (flag check inside awardWeeklyChallengeBonus)
- Modify streak or other stats (only points)
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
Challenge completion check added:
- checkWeeklyChallengeCompletion() returns points awarded
- Checks weekly total vs challenge target
- Prevents duplicate awards
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- flutter test passes
- flutter analyze passes with no warnings
- Challenge target correctly calculates as daily goal × 7
- Flag methods return false for unset keys (default behavior)
- Bonus award adds points correctly to today's record
</verification>

<success_criteria>
1. Weekly challenge target calculated correctly (daily goal × 7)
2. Challenge completion flag prevents duplicate awards
3. Bonus points awarded and persisted correctly
4. All new methods integrate with existing StorageService patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-challenges-streak-freeze/03.4-01-SUMMARY.md`
</output>
