---
phase: 03.4-challenges-streak-freeze
plan: 02
type: execute
wave: 1
depends_on: ["03.4-01"]
files_modified:
  - push_up_5050/lib/widgets/statistics/weekly_challenge_card.dart
  - push_up_5050/lib/screens/statistics/statistics_screen.dart
  - push_up_5050/lib/l10n/app_it.arb
  - push_up_5050/lib/l10n/app_en.arb
autonomous: true

must_haves:
  truths:
    - "Weekly challenge card displays in statistics screen with target and progress"
    - "Progress bar shows current week push-ups vs challenge target (0-100%)"
    - "Trophy icon üèÜ displayed on challenge card"
    - "Challenge completion triggers badge notification popup"
    - "Localization keys added for challenge UI text"
  artifacts:
    - path: "push_up_5050/lib/widgets/statistics/weekly_challenge_card.dart"
      provides: "Weekly challenge display widget"
      contains: "WeeklyChallengeCard", "progress bar", "trophy icon"
    - path: "push_up_5050/lib/screens/statistics/statistics_screen.dart"
      provides: "Statistics screen with challenge card"
      contains: "WeeklyChallengeCard integration"
    - path: "push_up_5050/lib/l10n/app_*.arb"
      provides: "Localization strings"
      contains: "weeklyChallenge, weeklyChallengeTarget, weeklyChallengeCompleted"
  key_links:
    - from: "lib/screens/statistics/statistics_screen.dart"
      to: "lib/widgets/statistics/weekly_challenge_card.dart"
      via: "WeeklyChallengeCard widget"
      pattern: "WeeklyChallengeCard\\("
    - from: "lib/screens/statistics/statistics_screen.dart"
      to: "lib/providers/user_stats_provider.dart"
      via: "weekTotal getter"
      pattern: "stats.weekTotal"
    - from: "lib/screens/statistics/statistics_screen.dart"
      to: "lib/providers/goals_provider.dart"
      via: "dailyGoal target"
      pattern: "goals.dailyGoal.target"
---

<objective>
Create WeeklyChallengeCard widget displaying weekly challenge progress (daily goal √ó 7 target) with trophy icon and progress bar. Integrate into StatisticsScreen. Add localization keys. Wire challenge completion check to trigger badge notification popup.
</objective>

<execution_context>
@C:\Users\olegn\.claude\get-shit-done/workflows/execute-plan.md
@C:\Users\olegn\.claude\get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-CONTEXT.md
@.planning/phases/03.4-challenges-streak-freeze/03.4-01-SUMMARY.md

# Existing patterns to follow:
- FrostCard widget for glass-morphism cards
- WeeklyChartCard layout (used in same section)
- AchievementPopup for badge notifications
- MiniStatCard for compact stat display
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add localization keys for weekly challenge</name>
  <files>push_up_5050/lib/l10n/app_it.arb, push_up_5050/lib/l10n/app_en.arb</files>
  <action>
Add localization keys for weekly challenge UI:

**English (app_en.arb):**
```json
"weeklyChallenge": "Weekly Challenge",
"weeklyChallengeTarget": "Complete {target} push-ups this week",
"weeklyChallengeCompleted": "Challenge Completed!",
"weeklyChallengeProgress": "{current} / {target}",
"weeklyChallengeBonus": "+200 bonus points"
```

**Italian (app_it.arb):**
```json
"weeklyChallenge": "Sfida Settimanale",
"weeklyChallengeTarget": "Completa {target} flessioni questa settimana",
"weeklyChallengeCompleted": "Sfida Completata!",
"weeklyChallengeProgress": "{current} / {target}",
"weeklyChallengeBonus": "+200 punti bonus"
```

Add at end of each file, before the closing brace.

DO NOT:
- Modify existing keys
- Use inconsistent naming
- Forget to add to both files
  </action>
  <verify>
Run: flutter pub get (to regenerate localization files)
Run: flutter analyze
  </verify>
  <done>
Localization keys added:
- 5 new keys in both IT and EN
- Keys follow existing naming pattern
- Localization files regenerated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WeeklyChallengeCard widget</name>
  <files>push_up_5050/lib/widgets/statistics/weekly_challenge_card.dart</files>
  <action>
Create new widget file for weekly challenge display:

**File Structure:**
```dart
import 'package:flutter/material.dart';
import 'package:push_up_5050/widgets/design_system/frost_card.dart';
import 'package:push_up_5050/l10n/app_localizations.dart';

class WeeklyChallengeCard extends StatelessWidget {
  final int weekTotal;
  final int dailyGoal;
  final bool isCompleted;

  const WeeklyChallengeCard({
    required this.weekTotal,
    required this.dailyGoal,
    this.isCompleted = false,
  });

  @override
  Widget build(BuildContext context) {
    final loc = AppLocalizations.of(context)!;
    final challengeTarget = dailyGoal * 7;
    final progress = (weekTotal / challengeTarget).clamp(0.0, 1.0);

    return FrostCard(
      padding: EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header row: Trophy icon + Title
          Row(
            children: [
              Text('üèÜ', style: TextStyle(fontSize: 24)),
              SizedBox(width: 12),
              Expanded(
                child: Text(
                  loc.weeklyChallenge,
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w900,
                    color: Colors.white,
                  ),
                ),
              ),
              if (isCompleted)
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: Color(0xFF4CAF50),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Text(
                    loc.weeklyChallengeCompleted,
                    style: TextStyle(
                      fontSize: 10,
                      fontWeight: FontWeight.w700,
                      color: Colors.white,
                    ),
                  ),
                ),
            ],
          ),
          SizedBox(height: 12),

          // Target text
          Text(
            loc.weeklyChallengeTarget(challengeTarget.toString()),
            style: TextStyle(
              fontSize: 12,
              color: Colors.white.withOpacity(0.70),
            ),
          ),
          SizedBox(height: 8),

          // Progress bar
          ClipRRect(
            borderRadius: BorderRadius.circular(6),
            child: LinearProgressIndicator(
              value: progress,
              backgroundColor: Colors.white.withOpacity(0.15),
              valueColor: AlwaysStoppedAnimation<Color>(
                isCompleted ? Color(0xFF4CAF50) : Color(0xFFFF7A18),
              ),
              minHeight: 8,
            ),
          ),
          SizedBox(height: 8),

          // Progress text
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                loc.weeklyChallengeProgress(weekTotal.toString(), challengeTarget.toString()),
                style: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.w700,
                  color: Colors.white,
                ),
              ),
              if (isCompleted)
                Text(
                  loc.weeklyChallengeBonus,
                  style: TextStyle(
                    fontSize: 12,
                    fontWeight: FontWeight.w600,
                    color: Color(0xFF4CAF50),
                  ),
                ),
            ],
          ),
        ],
      ),
    );
  }
}
```

DO NOT:
- Use hardcoded colors (use existing AppColors where applicable)
- Create complex animations (keep it simple)
- Make the card too tall (fit within screen flow)
  </action>
  <verify>
Run: flutter analyze
  </verify>
  <done>
WeeklyChallengeCard widget created:
- Displays trophy icon and title
- Shows target (daily goal √ó 7)
- Progress bar with orange/green color based on completion
- Completed badge and bonus text when finished
- Follows FrostCard pattern
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate WeeklyChallengeCard into StatisticsScreen</name>
  <files>push_up_5050/lib/screens/statistics/statistics_screen.dart</files>
  <action>
Add WeeklyChallengeCard to statistics screen:

1. **Add import** at top with other widget imports:
```dart
import 'package:push_up_5050/widgets/statistics/weekly_challenge_card.dart';
import 'package:push_up_5050/repositories/storage_service.dart';
```

2. **Add StorageService reference** - access via Provider or get from context

3. **Insert card in layout** - add after WeeklyChartCard (around line 142):
```dart
const SizedBox(height: 16),

// Weekly Challenge Card
WeeklyChallengeCard(
  weekTotal: stats.weekTotal,
  dailyGoal: goals.dailyGoal.target,
  isCompleted: _isChallengeCompleted(stats, goals),
),
```

4. **Add helper method** to check challenge completion:
```dart
bool _isChallengeCompleted(UserStatsProvider stats, GoalsProvider goals) {
  final challengeTarget = goals.dailyGoal.target * 7;
  return stats.weekTotal >= challengeTarget;
}
```

Place in _StatisticsScreenState class.

DO NOT:
- Remove or modify existing cards
- Break the layout flow (maintain spacing)
- Forget to add import
  </action>
  <verify>
Run: flutter analyze
Run: flutter run -d windows (visual test)
  </verify>
  <done>
WeeklyChallengeCard integrated:
- Card displays below WeeklyChartCard
- Shows correct target and progress
- Imports added
- Layout spacing preserved
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire challenge completion check to trigger bonus award</name>
  <files>push_up_5050/lib/screens/statistics/statistics_screen.dart</files>
  <action>
Add challenge completion check and bonus award:

1. **Add Provider access** - modify build method to access StorageService:
   - StorageService available via Provider context.read<StorageService>()

2. **Add completion trigger** in initState or build method:
   - Check if challenge just completed (weekly total >= target but not yet awarded)
   - Call awardWeeklyChallengeBonus() if newly completed
   - Trigger AchievementPopup with badge

3. **Implementation approach** - add method in _StatisticsScreenState:
```dart
Future<void> _checkChallengeCompletion() async {
  final stats = context.read<UserStatsProvider>();
  final goals = context.read<GoalsProvider>();
  final storage = context.read<StorageService>();

  final challengeTarget = goals.dailyGoal.target * 7;
  if (stats.weekTotal >= challengeTarget) {
    final weekNumber = storage.getWeekNumber(DateTime.now());
    final alreadyCompleted = await storage.hasWeeklyChallengeBeenCompleted(weekNumber);

    if (!alreadyCompleted) {
      // Award bonus and show popup
      await storage.awardWeeklyChallengeBonus(weekNumber);
      await stats.loadStats(); // Refresh to show new points

      if (mounted) {
        _showChallengeCompletionPopup();
      }
    }
  }
}

void _showChallengeCompletionPopup() {
  // Show achievement popup with challenge badge
  // Use existing AchievementPopup widget pattern
}
```

4. **Call _checkChallengeCompletion()** in initState after postFrameCallback

DO NOT:
- Show popup every time screen opens (check flag first)
- Award bonus multiple times (flag check prevents this)
- Block UI with async operations (use proper async/await)
  </action>
  <verify>
Run: flutter analyze
Run: flutter test
  </verify>
  <done>
Challenge completion check wired:
- Checks for challenge completion on screen load
- Awards bonus points via StorageService
- Shows badge notification popup
- Prevents duplicate awards via flag
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- flutter test passes
- flutter analyze passes with no warnings
- WeeklyChallengeCard displays correctly in statistics screen
- Challenge completion triggers bonus award and popup
- Localization works in both IT and EN
- Progress bar updates correctly with weekly progress
</verification>

<success_criteria>
1. WeeklyChallengeCard widget created and integrated
2. Localization keys added for all UI text
3. Challenge target calculated as daily goal √ó 7
4. Progress bar shows correct progress percentage
5. Completion triggers bonus award and badge notification
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-challenges-streak-freeze/03.4-02-SUMMARY.md`
</output>
