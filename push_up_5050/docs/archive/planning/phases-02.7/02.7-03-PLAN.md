---
phase: 02.7-widget-rebuild-from-templates
plan: 03
type: execute
wave: 2
depends_on: [02.7-01, 02.7-02]
files_modified:
  - push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetQuickStartProvider.kt
  - push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetSmallProvider.kt
  - push_up_5050/android/app/src/main/AndroidManifest.xml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "4x4 provider uses new layout (pushup_widget_4x4.xml)"
    - "2x1 provider uses new layout (pushup_widget_2x1.xml)"
    - "AndroidManifest registers new widget info files"
    - "Deep link for START button uses pushup5050://series_selection"
    - "Day labels are localized (L M M G V S D for Italian, M T W T F S S for English)"
    - "Calendar data parsing handles weekDayData and threeDayData from JSON"
  artifacts:
    - path: push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetQuickStartProvider.kt
      provides: "4x4 widget provider with new layout binding"
      exports: ["updateAppWidget", "updateCalendarDays"]
      contains: "R.layout.pushup_widget_4x4"
    - path: push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetSmallProvider.kt
      provides: "2x1 widget provider with new layout binding"
      exports: ["updateAppWidget", "updateThreeDayIndicators"]
      contains: "R.layout.pushup_widget_2x1"
    - path: push_up_5050/android/app/src/main/AndroidManifest.xml
      provides: "Widget registration with correct info files"
      contains: "pushup_widget_4x4_info, pushup_widget_2x1_info"
  key_links:
    - from: PushupWidgetQuickStartProvider.updateAppWidget
      to: pushup_widget_4x4.xml
      via: "RemoteViews inflates layout"
      pattern: "RemoteViews.*pushup_widget_4x4"
    - from: PushupWidgetSmallProvider.updateAppWidget
      to: pushup_widget_2x1.xml
      via: "RemoteViews inflates layout"
      pattern: "RemoteViews.*pushup_widget_2x1"
    - from: PushupWidgetQuickStartProvider
      to: MainActivity
      via: "Deep link intent for START button"
      pattern: "pushup5050://series_selection"
    - from: PushupWidgetQuickStartProvider.updateCalendarDays
      to: WidgetCalendarService
      via: "WeekDayData JSON parsing"
      pattern: "weekDayData.*JSON"
---

<objective>
Update widget providers to use new layouts and register widgets in AndroidManifest with correct info files.

Purpose: Existing providers work but use old layouts. Must update layout references and ensure AndroidManifest points to new widget info files (4x4_info, 2x1_info) for correct size registration. Deep link and data parsing logic stays the same.

Output: Updated providers referencing new layouts, updated AndroidManifest with new widget registrations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02.7-widget-rebuild-from-templates/02.7-CONTEXT.md
@.planning/phases/02.7-widget-rebuild-from-templates/02.7-01-SUMMARY.md
@.planning/phases/02.7-widget-rebuild-from-templates/02.7-02-SUMMARY.md
@push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetQuickStartProvider.kt
@push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetSmallProvider.kt
@push_up_5050/android/app/src/main/AndroidManifest.xml
@push_up_5050/android/app/src/main/res/xml/pushup_widget_quick_start_info.xml
@push_up_5050/android/app/src/main/res/xml/pushup_widget_small_info.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PushupWidgetQuickStartProvider for 4x4 layout</name>
  <files>push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetQuickStartProvider.kt</files>
  <action>
    Modify PushupWidgetQuickStartProvider.kt:

    1. Change layout reference (line ~73):
       - FROM: R.layout.pushup_widget_quick_start
       - TO: R.layout.pushup_widget_4x4

    2. Add localized day labels (replace hardcoded Italian labels):
       - Add method to get day labels based on locale:
         fun getDayLabels(context: Context): List<String> {
             val locale = context.resources.configuration.locales.get(0)
             return if (locale.language == "it") {
                 listOf("L", "M", "M", "G", "V", "S", "D")
             } else {
                 listOf("M", "T", "W", "T", "F", "S", "S")
             }
         }
       - Use in updateCalendarDays: set day text based on locale

    3. Ensure updateCalendarDays() uses new drawable names:
       - day_indicator_glow -> widget_day_chip_completed
       - day_indicator_missed_new -> widget_day_chip_missed
       - day_indicator_pending -> widget_day_chip_pending
       - Note: If new drawables don't exist yet, keep old names (Plan 01 creates them)

    4. Keep all existing logic intact:
       - JSON parsing (weekDayData)
       - Data loading from HomeWidgetPlugin
       - Deep link intent for START button
       - View IDs (today_count, total_count, day_1-7, start_button_container)

    DO NOT change:
    - Data parsing logic (JSON structure)
    - Deep link URL (pushup5050://series_selection)
    - View IDs
    - Widget class name (must match manifest)
  </action>
  <verify>File references R.layout.pushup_widget_4x4, has getDayLabels() method, updateCalendarDays references correct drawables</verify>
  <done>4x4 provider ready to use new layout with localized day labels</done>
</task>

<task type="auto">
  <name>Task 2: Update PushupWidgetSmallProvider for 2x1 layout</name>
  <files>push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetSmallProvider.kt</files>
  <action>
    Modify PushupWidgetSmallProvider.kt:

    1. Change layout reference (line ~75):
       - FROM: R.layout.pushup_widget_quick_start_small
       - TO: R.layout.pushup_widget_2x1

    2. Update updateThreeDayIndicators() for new layout:
       - Keep existing logic (yesterday/today/tomorrow mapping)
       - Ensure day labels are localized (optional for 2x1 - template uses I/O/D internally)
       - Verify view IDs match new layout:
         * day_yesterday_bg, day_yesterday_text
         * day_today_bg, day_today_text
         * day_tomorrow_bg, day_tomorrow_text

    3. Update updateDayIndicator() drawable references:
       - day_indicator_glow -> widget_day_chip_completed (if unified)
       - day_indicator_missed_new -> widget_day_chip_missed
       - day_indicator_pending -> widget_day_chip_pending
       - day_indicator_in_progress -> keep or create equivalent

    4. Keep all existing logic:
       - JSON parsing (threeDayData)
       - Data loading from HomeWidgetPlugin
       - Deep link intent (today_count click)
       - View IDs

    DO NOT change:
    - Data parsing logic
    - Deep link URL
    - View IDs
    - Widget class name
  </action>
  <verify>File references R.layout.pushup_widget_2x1, view IDs match new layout, drawable references updated</verify>
  <done>2x1 provider ready to use new layout with 3-day calendar</done>
</task>

<task type="auto">
  <name>Task 3: Update AndroidManifest with new widget registrations</name>
  <files>push_up_5050/android/app/src/main/AndroidManifest.xml</files>
  <action>
    Update AndroidManifest.xml widget registrations:

    1. Update PushupWidgetQuickStartProvider receiver (lines 76-87):
       - Change meta-data resource:
         FROM: @xml/pushup_widget_quick_start_info
         TO: @xml/pushup_widget_4x4_info
       - Keep enabled="true"
       - Keep exported="true"

    2. Update PushupWidgetSmallProvider receiver (lines 89-100):
       - Change meta-data resource:
         FROM: @xml/pushup_widget_small_info
         TO: @xml/pushup_widget_2x1_info
       - Keep enabled="true"
       - Keep exported="true"

    3. Keep disabled widgets disabled (Stats, Calendar providers)

    4. Keep WidgetUpdateReceiver unchanged (midnight update)

    CRITICAL: Widget receiver android:name attributes must NOT change:
    - .widget.PushupWidgetQuickStartProvider
    - .widget.PushupWidgetSmallProvider
    These class names are referenced by Flutter's HomeWidgetPlugin.updateWidget()
  </action>
  <verify>AndroidManifest has @xml/pushup_widget_4x4_info for QuickStartProvider, @xml/pushup_widget_2x1_info for SmallProvider, receiver names unchanged</verify>
  <done>Widgets registered with correct info files for proper size display in picker</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. PushupWidgetQuickStartProvider references R.layout.pushup_widget_4x4
2. PushupWidgetSmallProvider references R.layout.pushup_widget_2x1
3. Both providers have localized day label support
4. AndroidManifest references new widget info files
5. Widget class names unchanged (for Flutter compatibility)
6. All view IDs match between layouts and providers
</verification>

<success_criteria>
1. Providers use new layouts
2. Widgets register with correct size info files
3. Deep link and data sync still work
4. Ready for build and test (Plan 04)
</success_criteria>

<output>
After completion, create `.planning/phases/02.7-widget-rebuild-from-templates/02.7-03-SUMMARY.md`
</output>
