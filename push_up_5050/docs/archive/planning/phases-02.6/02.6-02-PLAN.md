---
phase: 02.6-widget-redesign
plan: 02
type: execute
wave: 2
depends_on: [02.6-01]
files_modified:
  - push_up_5050/lib/services/widget_update_service.dart
  - push_up_5050/lib/providers/user_stats_provider.dart
  - push_up_5050/test/services/widget_update_service_test.dart
autonomous: true
user_setup: []

must_haves:
  truths:
    - "WidgetUpdateService integrates WidgetCalendarService for calendar data"
    - "UserStatsProvider calls widget update with calendar data after loadStats()"
    - "WidgetData contains weekDayData, threeDayData, and hasStreakLine fields"
    - "Widget data persists to home_widget storage with calendar information"
    - "All widget update tests pass including calendar data integration"
  artifacts:
    - path: "push_up_5050/lib/services/widget_update_service.dart"
      provides: "Widget updates with calendar data integration"
      min_lines: 200
    - path: "push_up_5050/lib/providers/user_stats_provider.dart"
      provides: "Provider-level widget update integration"
      modifies: "_updateWidgets() method"
  key_links:
    - from: "WidgetUpdateService"
      to: "WidgetCalendarService"
      via: "constructor dependency injection"
      pattern: "final WidgetCalendarService _calendarService"
    - from: "UserStatsProvider"
      to: "WidgetUpdateService"
      via: "existing _updateWidgets() call"
      pattern: "_widgetUpdateService\\.updateAllWidgets"
    - from: "WidgetUpdateService"
      to: "home_widget plugin"
      via: "saveWidgetData() method"
      pattern: "HomeWidget\\.saveWidgetData"
---

<objective>
Integrate Calendar Service with Widget Updates

Purpose: Connect WidgetCalendarService to the existing widget update pipeline so widgets receive calendar day data

Output: Updated WidgetUpdateService and UserStatsProvider with calendar data integration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.6-widget-redesign/02.6-CONTEXT.md
@.planning/phases/02.6-widget-redesign/02.6-01-SUMMARY.md
@push_up_5050/lib/services/widget_update_service.dart
@push_up_5050/lib/services/widget_calendar_service.dart
@push_up_5050/lib/providers/user_stats_provider.dart
@push_up_5050/lib/models/widget_data.dart
@push_up_5050/test/services/widget_update_service_test.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update WidgetUpdateService with CalendarService integration</name>
  <files>push_up_5050/lib/services/widget_update_service.dart</files>
  <action>
    Modify WidgetUpdateService to integrate WidgetCalendarService:

    1. Add WidgetCalendarService as constructor dependency (optional, nullable)
       - final WidgetCalendarService? _calendarService;

    2. Update constructor:
       ```
       WidgetUpdateService({WidgetCalendarService? calendarService})
           : _calendarService = calendarService;
       ```

    3. Create new method buildWidgetData():
       - Takes parameters: todayPushups, totalPushups, goalPushups, streakDays, allDailyRecords
       - Returns Future&lt;WidgetData&gt;
       - If _calendarService is available:
         * Calls _calendarService.getWeekData() to get current week data
         * Calls _calendarService.getThreeDayData() to get 3-day data
         * Serializes WeekDayData objects to Map for JSON storage
       - If _calendarService is null:
         * Uses existing calendarDays fallback logic
       - Returns WidgetData populated with all data including new calendar fields

    4. Update updateAllWidgets() to use buildWidgetData()

    5. Maintain backward compatibility - service works without calendar service (graceful degradation)

    Keep all existing methods: updateQuickStartWidget(), updateSmallWidget(), _saveWidgetData(), etc.
  </action>
  <verify>
    flutter analyze push_up_5050/lib/services/widget_update_service.dart
    No analyzer errors
  </verify>
  <done>
    WidgetUpdateService integrates with WidgetCalendarService for calendar data
  </done>
</task>

<task type="auto">
  <name>Task 2: Update UserStatsProvider to pass calendar data to widgets</name>
  <files>push_up_5050/lib/providers/user_stats_provider.dart</files>
  <action>
    Update UserStatsProvider._updateWidgets() method to use new calendar service integration:

    1. The existing _updateWidgets() method already builds WidgetData with calendarDays
    2. Modify to use WidgetUpdateService.buildWidgetData() if calendar service is available:
       - Pass _allDailyRecords map for calendar processing
       - Pass _todayPushups, _totalPushupsAllTime, _currentStreak
       - Handle the returned WidgetData with new calendar fields

    3. No changes to WidgetCalendarService needed in provider - it's injected via WidgetUpdateService

    4. Ensure the calendar data refreshes when:
       - User completes a workout (after endWorkout)
       - User manually refreshes stats (refreshStats)
       - App loads initial data (loadStats)

    Keep existing widget update trigger points - only enhance the data being sent.
  </action>
  <verify>
    flutter test push_up_5050/test/providers/user_stats_provider_test.dart
    Existing tests still pass
  </verify>
  <done>
    UserStatsProvider sends calendar-enriched data to widgets on all update triggers
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for calendar data in widget updates</name>
  <files>push_up_5050/test/services/widget_update_service_test.dart</files>
  <action>
    Add tests to widget_update_service_test.dart for calendar data integration:

    1. test_buildWidgetData_withoutCalendarService_usesFallback
       - Verify WidgetData is created even when calendar service is null

    2. test_buildWidgetData_withCalendarService_includesWeekData
       - Mock WidgetCalendarService returning WeekData
       - Verify WidgetData.weekDayData is populated correctly
       - Verify WidgetData.hasStreakLine matches calendar service result

    3. test_buildWidgetData_withCalendarService_includesThreeDayData
       - Mock WidgetCalendarService returning 3-day data
       - Verify WidgetData.threeDayData is populated correctly
       - Verify day labels are Italian (L, M, M, G, V, S, D)

    4. test_updateAllWidgets_withCalendarData_savesToStorage
       - Mock HomeWidget.saveWidgetData
       - Verify JSON includes weekDayData and threeDayData fields

    Use mockito for mocking WidgetCalendarService and HomeWidgetPlugin.
    Follow existing test patterns in the file.
  </action>
  <verify>
    flutter test push_up_5050/test/services/widget_update_service_test.dart
    All existing tests pass + 4 new tests pass
  </verify>
  <done>
    Widget update service has full test coverage for calendar data integration
  </done>
</task>

</tasks>

<verification>
1. WidgetUpdateService accepts WidgetCalendarService as optional dependency
2. buildWidgetData() method creates WidgetData with calendar fields when service available
3. UserStatsProvider._updateWidgets() uses new buildWidgetData() method
4. All widget update tests pass (existing + new calendar integration tests)
5. Backward compatibility maintained - widgets work without calendar service
</verification>

<success_criteria>
- WidgetUpdateService integrates with WidgetCalendarService
- UserStatsProvider sends calendar data to widgets
- JSON serialization includes weekDayData, threeDayData, hasStreakLine
- All tests pass (unit + integration)
- Ready for Android widget provider updates in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/02.6-widget-redesign/02.6-02-SUMMARY.md`
</output>
