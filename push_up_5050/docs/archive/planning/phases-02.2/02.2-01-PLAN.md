---
phase: 02.2-quick-stats-widget
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetStatsProvider.kt
  - push_up_5050/android/app/src/main/res/values/widget_strings.xml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Widget loads data from home_widget storage (not SharedPreferences)"
    - "Widget correctly parses WidgetData JSON from Flutter"
    - "Widget displays today's push-up count"
    - "Widget displays total/total goal (e.g., '44 / 5050')"
    - "Labels respect app language setting (IT: OGGI/TOTALE, EN: TODAY/TOTAL)"
  artifacts:
    - path: "push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetStatsProvider.kt"
      provides: "Widget provider that reads from home_widget storage"
      contains: "HomeWidgetPlugin|getWidgetData|WidgetData"
    - path: "push_up_5050/android/app/src/main/res/values/widget_strings.xml"
      provides: "Localized widget strings (IT/EN)"
      contains: "widget_today_label|widget_total_label"
  key_links:
    - from: "PushupWidgetStatsProvider.kt"
      to: "home_widget storage"
      via: "HomeWidgetPlugin.getWidgetData() with 'pushup_json_data' key"
      pattern: "getWidgetData.*pushup_json_data"
    - from: "PushupWidgetStatsProvider.kt"
      to: "lib/services/widget_update_service.dart"
      via: "Shared data key 'pushup_json_data'"
      pattern: "pushup_json_data"
---

# Phase 2.2-01: Implement Widget Data Loading from home_widget

## Objective
Make the Android widget read data from home_widget storage (where Flutter writes) instead of SharedPreferences.

**Purpose:** The existing `PushupWidgetStatsProvider.kt` reads from SharedPreferences with hardcoded keys, but `WidgetUpdateService` writes to home_widget storage. This bridge is missing, so widgets display zeros even when Flutter updates them.

**Output:** Widget provider reads from home_widget storage using the same key (`pushup_json_data`) that Flutter writes.

## Context
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-quick-stats-widget/02.2-CONTEXT.md

@.planning/phases/02.1-foundation-setup/02.1-03-SUMMARY.md
@push_up_5050/lib/services/widget_update_service.dart
@push_up_5050/lib/models/widget_data.dart
@push_up_5050/android/app/src/main/kotlin/com/pushup5050/push_up_5050/widget/PushupWidgetStatsProvider.kt

## Tasks

### Task 1: Create Test for Widget Data Loading (TDD - RED)
**type:** auto

**Action:**
Create a unit test that verifies `PushupWidgetStatsProvider` can load widget data from home_widget storage.

**Note:** Android widget tests require Robolectric or instrumented tests. Since we're developing on Windows, create an integration test in Flutter that verifies the round-trip: Flutter writes data via `WidgetUpdateService`, and we can verify the data structure is correct.

Create `test/services/widget_android_integration_test.dart`:

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:push_up_5050/models/widget_data.dart';
import 'package:push_up_5050/services/widget_update_service.dart';
import 'package:shared_preferences/shared_preferences.dart';

void main() {
  group('Widget Android Integration Tests', () {
    late WidgetUpdateService widgetService;

    setUp(() async {
      SharedPreferences.setMockInitialValues({});
      widgetService = WidgetUpdateService();
      await widgetService.initialize();
    });

    testWidgets('Widget data serialization produces valid JSON for Android',
        (tester) async {
      // Arrange: Create sample widget data
      final widgetData = WidgetData(
        todayPushups: 41,
        totalPushups: 44,
        goalPushups: 5050,
        todayGoalReached: false,
        streakDays: 2,
        lastWorkoutDate: DateTime(2026, 1, 21),
        calendarDays: [],
      );

      // Act: Serialize to JSON string
      final jsonString = widgetData.toJsonString();

      // Assert: JSON contains all required fields with correct values
      expect(jsonString, contains('"todayPushups":41'));
      expect(jsonString, contains('"totalPushups":44'));
      expect(jsonString, contains('"goalPushups":5050'));
      expect(jsonString, contains('"todayGoalReached":false'));
      expect(jsonString, contains('"streakDays":2'));
      expect(jsonString, contains('"lastWorkoutDate":"2026-01-21"'));
    });

    testWidgets('Widget JSON can be deserialized back to WidgetData',
        (tester) async {
      // Arrange: Create JSON string
      final jsonString = '''
      {
        "todayPushups": 41,
        "totalPushups": 44,
        "goalPushups": 5050,
        "todayGoalReached": false,
        "streakDays": 2,
        "lastWorkoutDate": "2026-01-21",
        "calendarDays": []
      }
      ''';

      // Act: Deserialize
      final widgetData = WidgetData.fromJsonString(jsonString);

      // Assert: All fields match
      expect(widgetData.todayPushups, 41);
      expect(widgetData.totalPushups, 44);
      expect(widgetData.goalPushups, 5050);
      expect(widgetData.todayGoalReached, false);
      expect(widgetData.streakDays, 2);
      expect(widgetData.lastWorkoutDate?.day, 21);
    });

    testWidgets('Widget data with zero values serializes correctly',
        (tester) async {
      // Arrange: Empty widget data
      final widgetData = WidgetData.empty();

      // Act: Serialize
      final jsonString = widgetData.toJsonString();

      // Assert: Contains zero values
      expect(jsonString, contains('"todayPushups":0'));
      expect(jsonString, contains('"totalPushups":0'));
      expect(jsonString, contains('"todayGoalReached":false'));
    });
  });
}
```

**Verification:**
```bash
cd push_up_5050 && flutter test test/services/widget_android_integration_test.dart
```
Expected: Tests fail initially (RED) because we're just defining the expected behavior.

**Done:**
- Test file created
- Tests fail (expected - TDD RED phase)

---

### Task 2: Update Kotlin Provider to Read from home_widget (TDD - GREEN)
**type:** auto

**Action:**
Modify `PushupWidgetStatsProvider.kt` to read widget data from home_widget storage instead of SharedPreferences.

First, update the `build.gradle` to ensure home_widget plugin is accessible. Then update the Kotlin provider:

```kotlin
package com.pushup5050.push_up_5050.widget

import android.appwidget.AppWidgetManager
import android.appwidget.AppWidgetProvider
import android.content.Context
import android.content.Intent
import android.widget.RemoteViews
import com.pushup5050.push_up_5050.R
import com.home_widget.HomeWidgetPlugin
import org.json.JSONObject

/**
 * Widget 1: Quick Stats
 * Shows today's push-ups and total progress with START button
 *
 * Data source: home_widget storage (shared with Flutter)
 */
class PushupWidgetStatsProvider : AppWidgetProvider() {

    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray
    ) {
        for (appWidgetId in appWidgetIds) {
            updateAppWidget(context, appWidgetManager, appWidgetId)
        }
    }

    override fun onEnabled(context: Context) {
        // Called when first widget is added
    }

    override fun onDisabled(context: Context) {
        // Called when last widget is removed
    }

    companion object {
        private const val DATA_KEY = "pushup_json_data"

        fun updateAppWidget(
            context: Context,
            appWidgetManager: AppWidgetManager,
            appWidgetId: Int
        ) {
            val views = RemoteViews(context.packageName, R.layout.pushup_widget_stats)

            // Load widget data from home_widget storage
            val jsonData = HomeWidgetPlugin.getData(context, DATA_KEY)

            // Parse JSON data
            val todayPushups: Int
            val totalPushups: Int
            val goalPushups: Int

            if (!jsonData.isNullOrEmpty()) {
                try {
                    val json = JSONObject(jsonData)
                    todayPushups = json.optInt("todayPushups", 0)
                    totalPushups = json.optInt("totalPushups", 0)
                    goalPushups = json.optInt("goalPushups", 5050)
                } catch (e: Exception) {
                    // Fallback to zeros if JSON parsing fails
                    todayPushups = 0
                    totalPushups = 0
                    goalPushups = 5050
                }
            } else {
                // No data available - use defaults
                todayPushups = 0
                totalPushups = 0
                goalPushups = 5050
            }

            // Update views
            views.setTextViewText(R.id.today_count, todayPushups.toString())
            views.setTextViewText(R.id.total_count, "$totalPushups / $goalPushups")

            // Set click intent for START button
            val intent = context.packageManager.getLaunchIntentForPackage(context.packageName)
            intent?.let {
                views.setOnClickPendingIntent(R.id.start_button,
                    android.app.PendingIntent.getActivity(
                        context,
                        0,
                        it,
                        android.app.PendingIntent.FLAG_UPDATE_CURRENT or android.app.PendingIntent.FLAG_IMMUTABLE
                    )
                )
            }

            // Update widget
            appWidgetManager.updateAppWidget(appWidgetId, views)
        }
    }
}
```

**Verification:**
```bash
cd push_up_5050 && flutter test test/services/widget_android_integration_test.dart
```
Expected: Tests now pass (GREEN) because the Flutter side correctly serializes data.

**Done:**
- Kotlin provider reads from `HomeWidgetPlugin.getData()`
- JSON parsing with fallback to zero values
- Tests pass

---

### Task 3: Create Localized Widget Strings
**type:** auto

**Action:**
Create `android/app/src/main/res/values/widget_strings.xml` for default (English) strings and `android/app/src/main/res/values-it/widget_strings.xml` for Italian strings.

**Create `android/app/src/main/res/values/widget_strings.xml`:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="widget_today_label">TODAY:</string>
    <string name="widget_total_label">TOTAL:</string>
    <string name="widget_pushups">push-ups</string>
    <string name="widget_start">START</string>
</resources>
```

**Create `android/app/src/main/res/values-it/widget_strings.xml`:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="widget_today_label">OGGI:</string>
    <string name="widget_total_label">TOTALE:</string>
    <string name="widget_pushups">push-ups</string>
    <string name="widget_start">START</string>
</resources>
```

**Verification:**
- Files exist at correct paths
- XML is valid

**Done:**
- Localized string resources created
- Labels will display based on device language

---

## Verification
After completing all tasks:
- [ ] `flutter test test/services/widget_android_integration_test.dart` passes
- [ ] Kotlin code compiles without errors
- [ ] String resources exist for both EN and IT

## Success Criteria
- Widget data flows from Flutter → home_widget → Android widget
- JSON serialization/deserialization is tested
- Localized labels exist (will be applied in plan 02)
- Widget displays correct values (not zeros) when Flutter updates data

## Output
After completion, create `.planning/phases/02.2-quick-stats-widget/02.2-01-SUMMARY.md`
