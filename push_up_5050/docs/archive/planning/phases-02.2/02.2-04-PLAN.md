---
phase: 02.2-quick-stats-widget
plan: 04
type: execute
wave: 4
depends_on: [02.2-01, 02.2-02b, 02.2-03b]
files_modified:
  - integration_test/widget_1_quick_stats_test.dart
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Widget displays today's push-ups correctly"
    - "Widget displays total/total goal correctly"
    - "Widget labels match app language (IT/EN)"
    - "Widget updates when app state changes"
    - "Widget START button opens SeriesSelectionScreen"
  artifacts:
    - path: "integration_test/widget_1_quick_stats_test.dart"
      provides: "End-to-end integration tests for Widget 1"
      contains: "testWidgets.*Widget.*Quick Stats"
  key_links:
    - from: "integration_test/widget_1_quick_stats_test.dart"
      to: "lib/services/widget_update_service.dart"
      via: "Calls updateWidget1() and verifies data"
      pattern: "widgetUpdateService\\.updateWidget1"
    - from: "integration_test/widget_1_quick_stats_test.dart"
      to: "lib/models/widget_data.dart"
      via: "Creates WidgetData for testing"
      pattern: "WidgetData\\("
---

# Phase 2.2-04: Integration Tests for Widget 1

## Objective
Create comprehensive integration tests to verify Widget 1 (Quick Stats) functions correctly end-to-end.

**Purpose:** Integration tests verify the complete flow: Flutter updates widget data -> home_widget stores data -> Android widget reads and displays data -> Tap actions work correctly.

**Output:** Integration test suite covering all Widget 1 functionality.

## Context
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.2-quick-stats-widget/02.2-CONTEXT.md

@.planning/phases/02.2-quick-stats-widget/02.2-01-SUMMARY.md
@.planning/phases/02.2-quick-stats-widget/02.2-02b-SUMMARY.md
@.planning/phases/02.2-quick-stats-widget/02.2-03b-SUMMARY.md
@push_up_5050/lib/services/widget_update_service.dart
@push_up_5050/lib/models/widget_data.dart
@integration_test/widget_update_integration_test.dart

## Tasks

### Task 1: Create Widget 1 Integration Test File
**type:** auto

**Action:**
Create `integration_test/widget_1_quick_stats_test.dart` with comprehensive tests for Widget 1.

```dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:home_widget/home_widget.dart';
import 'package:provider/provider.dart';
import 'package:push_up_5050/main.dart' as app;
import 'package:push_up_5050/models/widget_data.dart';
import 'package:push_up_5050/providers/user_stats_provider.dart';
import 'package:push_up_5050/repositories/storage_service.dart';
import 'package:push_up_5050/services/widget_update_service.dart';
import 'package:shared_preferences/shared_preferences.dart';

void main() {
  group('Widget 1: Quick Stats Integration Tests', () {
    late WidgetUpdateService widgetService;

    setUp(() async {
      SharedPreferences.setMockInitialValues({});
      widgetService = WidgetUpdateService();
      await widgetService.initialize();
    });

    testWidgets('Widget data flows to home_widget storage',
        (tester) async {
      // Arrange: Create sample widget data
      final widgetData = WidgetData(
        todayPushups: 41,
        totalPushups: 44,
        goalPushups: 5050,
        todayGoalReached: false,
        streakDays: 2,
        lastWorkoutDate: DateTime(2026, 1, 21),
        calendarDays: [],
      );

      // Act: Update widget via service
      final success = await widgetService.updateWidget1(widgetData);

      // Assert: Data was saved to home_widget
      final savedData =
          await HomeWidget.getWidgetData<String>('pushup_json_data');
      expect(savedData, isNotNull);
      expect(savedData!.contains('"todayPushups":41'), true);
      expect(savedData.contains('"totalPushups":44'), true);
    });

    testWidgets('Widget displays correct today push-up count',
        (tester) async {
      // Arrange: Create widget data with specific today count
      final widgetData = WidgetData(
        todayPushups: 25,
        totalPushups: 100,
        goalPushups: 5050,
        todayGoalReached: false,
        streakDays: 1,
        calendarDays: [],
      );

      // Act: Update widget
      await widgetService.updateWidget1(widgetData);

      // Assert: JSON contains correct today value
      final savedData =
          await HomeWidget.getWidgetData<String>('pushup_json_data');
      expect(savedData, contains('"todayPushups":25'));
    });

    testWidgets('Widget displays correct total format with goal',
        (tester) async {
      // Arrange: Create widget data with total and goal
      final widgetData = WidgetData(
        todayPushups: 0,
        totalPushups: 44,
        goalPushups: 5050,
        todayGoalReached: false,
        calendarDays: [],
      );

      // Act: Update widget
      await widgetService.updateWidget1(widgetData);

      // Assert: JSON contains total and goal
      final savedData =
          await HomeWidget.getWidgetData<String>('pushup_json_data');
      expect(savedData, contains('"totalPushups":44'));
      expect(savedData, contains('"goalPushups":5050'));
    });

    testWidgets('Widget handles zero values gracefully', (tester) async {
      // Arrange: Empty widget data
      final widgetData = WidgetData.empty();

      // Act: Update widget
      await widgetService.updateWidget1(widgetData);

      // Assert: JSON contains zeros
      final savedData =
          await HomeWidget.getWidgetData<String>('pushup_json_data');
      expect(savedData, contains('"todayPushups":0'));
      expect(savedData, contains('"totalPushups":0'));
    });

    testWidgets('Widget data persists across updates', (tester) async {
      // Arrange: First update
      final firstData = WidgetData(
        todayPushups: 10,
        totalPushups: 20,
        goalPushups: 5050,
        calendarDays: [],
      );

      // Act: Update twice
      await widgetService.updateWidget1(firstData);

      final secondData = WidgetData(
        todayPushups: 50,
        totalPushups: 70,
        goalPushups: 5050,
        todayGoalReached: true,
        calendarDays: [],
      );
      await widgetService.updateWidget1(secondData);

      // Assert: Final data is the second update
      final savedData =
          await HomeWidget.getWidgetData<String>('pushup_json_data');
      expect(savedData, contains('"todayPushups":50'));
      expect(savedData, contains('"totalPushups":70'));
      expect(savedData, contains('"todayGoalReached":true'));
    });

    testWidgets('Widget updates trigger successfully', (tester) async {
      // Arrange: Widget data
      final widgetData = WidgetData.forWidgets(
        todayPushups: 30,
        totalPushups: 500,
        goalPushups: 5050,
      );

      // Act: Update widget
      final result = await widgetService.updateWidget1(widgetData);

      // Assert: Update returns success (may be false on Windows)
      // On Windows, home_widget returns false but data is still saved
      expect(result is bool, true);
    });

    testWidgets('App launches without crash with widget integration',
        (tester) async {
      // Act: Launch app
      await tester.pumpWidget(const app.MyApp());
      await tester.pumpAndSettle();

      // Assert: App renders without errors
      expect(find.byType(app.MaterialApp), findsOneWidget);
    });

    testWidgets('UserStatsProvider integration with widget updates',
        (tester) async {
      // Arrange: Mock storage and widget service
      SharedPreferences.setMockInitialValues({});
      final storageService = await StorageService.create();

      final provider = UserStatsProvider(
        storage: storageService,
        widgetUpdateService: widgetService,
      );

      // Act: Load stats (which should trigger widget update)
      await provider.loadStats();

      // Assert: Provider loaded successfully
      expect(provider.isLoading, false);
    });
  });
}
```

**Verification:**
- Test file created at `integration_test/widget_1_quick_stats_test.dart`
- File imports all necessary dependencies
- Tests cover all Widget 1 functionality

**Done:**
- Integration test file created with comprehensive tests

---

### Task 2: Run Integration Tests
**type:** auto

**Action:**
Run the integration tests to verify they pass.

```bash
cd push_up_5050 && flutter test integration_test/widget_1_quick_stats_test.dart
```

**Verification:**
- All tests pass
- No exceptions or errors

**Done:**
- Integration tests passing

---

### Task 3: Verify Widget on Android Device
**type:** checkpoint:human-verify
**gate:** blocking

**What was built:**
Complete Widget 1 (Quick Stats) implementation:
- Data loading from home_widget storage
- Visual styling matching mockup
- Deep link navigation to SeriesSelectionScreen
- Integration tests passing

**How to verify:**
1. Build Android APK: `flutter build apk --release`
2. Install on Android device
3. Add Widget 1 (Quick Stats) to home screen
4. Open app, complete some push-ups
5. Verify widget shows correct today count
6. Verify widget shows correct total/total goal
7. Tap START button on widget
8. Verify app opens to SeriesSelectionScreen
9. Change app language (IT/EN) and verify labels update

**Resume signal:** Type "approved" or describe any issues found

---

## Verification
After completing all tasks:
- [ ] Integration test file created with 8+ tests
- [ ] All integration tests pass
- [ ] Widget verified on physical Android device
- [ ] Widget updates when app state changes
- [ ] START button navigates to SeriesSelectionScreen

## Success Criteria
- Widget displays correct data from app
- Visual style matches mockup
- Tap navigation works correctly
- Language localization works
- All integration tests pass

## Output
After completion, create `.planning/phases/02.2-quick-stats-widget/02.2-04-SUMMARY.md`
